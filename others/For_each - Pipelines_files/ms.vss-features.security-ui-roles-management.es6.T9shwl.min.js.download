"use strict";define("VSS/Features/SecurityUI/Roles",["require","exports","VSS/Platform/Context","VSS/Features/SecurityUI/Models","VSS/Features/SecurityUI/RestClient/SecurityRoles","VSS/Platform/Feature","react","VSS/Core/Observable","VSS/Platform/Layout","VSSUI/Button","VSSUI/Dropdown","VSSUI/Observer","VSSUI/Table","VSSUI/TooltipEx","VSSUI/Util","VSSUI/Utilities/DropdownSelection","VSSUI/VssPersona","VSSUI/ButtonGroup","VSSUI/FocusZone","VSSUI/Menu","VSSUI/MessageCard"],(function(e,t,s,n,o,i,r,l,a,c,d,m,u,g,h,p,A,C,R,b,S){var v,I,x,f,D,y;v=t[y="Resources"]={},t[y].AddActionText="Add",t[y].AddActionDescription="Add user",t[y].UndoActionText="Undo",t[y].UndoActionDescription="Undo changes",t[y].SaveActionText="Save",t[y].SaveActionDescription="Save changes",t[y].InheritanceOnActionText="On",t[y].InheritanceOffActionText="Off",t[y].InheritanceActionText="Inheritance",t[y].InheritanceActionDescription="Change inheritance",t[y].UserColumnText="User",t[y].RoleColumnText="Role",t[y].AccessColumnText="Access",t[y].DeleteUserText="Delete user",t[y].CannotEditRolesMessage="You do not have permission to edit roles for this resource.",function(e){I=t[e]={};class r extends s.VssService{constructor(){super(...arguments),this.globaAgentPoolRoleScope="distributedtask.globalagentpoolrole",this.globaAgentQueueRoleScope="distributedtask.globalagentqueuerole",this.agentCloudScope="agentclouds",this.agentCloudAdminRoleName="Administrator",this.orgPoolAdminRoleName="Administrator",this.queueCreatorRoleName="Creator"}getRoleAssignments(e,t,s,o,i){const r=new n.RoleAssignmentsModel;return this.getRolesClient(e,i).then((e=>{const n=e.getRoleAssignments(t,s),o=e.getRoleDefinitions(t);return Promise.all([n,o])})).then((e=>r.initialize(e[0],e[1],o))).catch((e=>r.setError(e))),r}saveRoleAssignments(e,t,s,n,o){this.getRolesClient(e,o).then((e=>{const o=t.getDeletedRoleAssignments(),r=t.getChangedRoleAssignments(),l=o.length>0?e.removeRoleAssignments(o,s,n):Promise.resolve(void 0),a=r.length>0?e.setRoleAssignments(r,s,n):Promise.resolve([]);let c=Promise.resolve([]),d=Promise.resolve(void 0);return!(0,i.isFeatureFlagEnabled)(this.pageContext,"WebAccess.DistributedTask.AllowSettingAgentCloudPermissionsFromOrgPoolSettings",!1)||s!==this.globaAgentPoolRoleScope&&s!==this.globaAgentQueueRoleScope||(c=this.GetAgentCloudAddAdminPermissionsPromise(r,s,e,n),d=this.GetAgentCloudDeleteAdminPermissionsPromise(r,o,s,e,n)),Promise.all([l,a,c,d]).then((()=>e))})).then((e=>e.getRoleAssignments(s,n))).then((e=>t.setRoleAssignments(e))).catch((e=>t.setError(e)))}resetRoleAssignments(e){e.resetRoleAssignments()}setInheritance(e,t,s,n,o,i){this.getRolesClient(e,i).then((e=>e.changeInheritance(n,o,s).then((()=>e)))).then((e=>e.getRoleAssignments(n,o))).then((e=>t.setRoleAssignments(e))).catch((e=>t.setError(e)))}getRolesClient(e,t){return new Promise(((s,n)=>{try{s((0,o.getSecurityRolesClient)(e,{serviceInstanceType:t}))}catch(e){n(e)}}))}GetAgentCloudAddAdminPermissionsPromise(e,t,s,n){let o=Promise.resolve([]);if(t==this.globaAgentPoolRoleScope?this.isOrgPoolAdminRole(e,t):this.isQueueCreatorRole(e,t)){let i=t==this.globaAgentPoolRoleScope?this.orgPoolAdminRoleName:this.queueCreatorRoleName;const r=e.filter((e=>e.roleName===i));if(r){let e=[];r.forEach((t=>{const i={userId:t.userId,roleName:this.agentCloudAdminRoleName};e.push(i),o=s.setRoleAssignments(e,this.agentCloudScope,n)}))}}return o}GetAgentCloudDeleteAdminPermissionsPromise(e,t,s,n,o){let i=Promise.resolve(void 0);if((null==t?void 0:t.length)>0||this.isChangeToNonPoolOrgAdmin(e,s)||this.isChangeToNonQueueCreator(e,s)){let r=s==this.globaAgentPoolRoleScope?e.filter((e=>e.roleName!==this.orgPoolAdminRoleName)).map((e=>e.userId)):e.filter((e=>e.roleName!==this.queueCreatorRoleName)).map((e=>e.userId));r.push(...t),i=n.removeRoleAssignments(r,this.agentCloudScope,o)}return i}isChangeToNonPoolOrgAdmin(e,t){let s=e.filter((e=>e.roleName!==this.orgPoolAdminRoleName));return t===this.globaAgentPoolRoleScope&&s.length>0}isChangeToNonQueueCreator(e,t){let s=e.filter((e=>e.roleName!==this.queueCreatorRoleName));return t===this.globaAgentQueueRoleScope&&s.length>0}isOrgPoolAdminRole(e,t){return t===this.globaAgentPoolRoleScope&&e.some((e=>e.roleName===this.orgPoolAdminRoleName))}isQueueCreatorRole(e,t){return t===this.globaAgentQueueRoleScope&&e.some((e=>e.roleName===this.queueCreatorRoleName))}}const l="IRolesManagementService";t[e].getService=function(e){return e.getService(l)},s.Services.add(l,{serviceFactory:r})}("RolesManagementService"),function(e){x=t[e]={};class s{constructor(e){this.roleDefinitions=e}get length(){return this.roleDefinitions.length}get value(){return this.roleDefinitions.map((e=>({data:e,id:e.identifier,text:e.displayName})))}}class n extends a.VssComponent{constructor(e){super(e),this.getColumns=()=>(this.columns||(this.columns=[{id:"user",name:v.UserColumnText,onSize:this.onColumnSize,renderCell:this.renderUserCell,width:new l.ObservableValue(-70)},{id:"role",name:v.RoleColumnText,onSize:this.onColumnSize,renderCell:this.renderRoleCell,width:new l.ObservableValue(150)},{id:"delete",renderCell:this.renderDeleteCell,width:new l.ObservableValue(40)}]),this.columns),this.tableBreakpoints=[{breakpoint:1,columnWidths:[-70,130,40]},{breakpoint:600,columnWidths:[-70,170,40]}],this.renderUserCell=(e,t,s,n)=>{const i={getDisplayName:()=>n.displayName,getIdentityImageUrl:e=>n.getIdentityImageUrl(this.context.pageContext)};return r.createElement(o,{columnIndex:t,dataItem:n,key:`col-${t}`,rowIndex:e,tableColumn:s},this.props.showAvatars&&r.createElement(A.VssPersona,{className:"avatar",size:"small",identityDetailsProvider:i}),r.createElement(g.Tooltip,{overflowOnly:!0,text:i.getDisplayName()},r.createElement("div",{className:"wrap-text"},i.getDisplayName(),r.createElement("div",{className:"body-s"},v.AccessColumnText,": ",n.accessDisplayName))))},this.renderRoleCell=(e,t,s,n)=>r.createElement(o,{columnIndex:t,dataItem:n,key:`col-${t}`,rowIndex:e,tableColumn:s},r.createElement(d.Dropdown,{items:this.roleDefinitionsProvider,key:`dropdown-${(new Date).getTime()}`,onSelect:(e,t)=>this.props.model.changeRoleAssignment(n,t.data),renderExpandable:e=>r.createElement(d.DropdownExpandableTextField,Object.assign({},e,{className:"flex-grow",disabled:this.props.disabled||this.isMyRow(n),excludeTabStop:!0,inputClassName:"roles-dropdown-input"})),selection:this.getRoleDropdownSelection(n)})),this.renderDeleteCell=(e,t,s,n)=>{const o=this.props.model;return r.createElement(u.TableCell,{className:"bolt-table-cell-side-action",columnIndex:t,key:`col-${t}`,tableColumn:s},r.createElement("div",{className:"bolt-list-cell-content flex-column"},r.createElement(m.Observer,{deleted:n.isDeleted(),inheritanceOff:o.isInheritanceOff()},(e=>{const t=this.props.disabled||this.isMyRow(n)||e.deleted||2===n.access,s=!t&&!e.deleted;return r.createElement(c.Button,{ariaLabel:v.DeleteUserText,className:(0,h.css)(s&&"bolt-table-cell-content-reveal",t&&"invisible"),excludeTabStop:!0,iconProps:{iconName:"Delete"},onClick:e=>{o.deleteRoleAssignment(n),e.preventDefault()},subtle:!0})}))))},this.onColumnSize=(e,t,s)=>{this.getColumns()[t].width.value=s},this.roleDefinitionsProvider=new s(this.props.model.getRoleDefinitions())}render(){return r.createElement(u.Table,{className:"security-role-table",columns:this.getColumns(),itemProvider:this.props.model.getRoleAssignments(),tableBreakpoints:this.tableBreakpoints})}getRoleDropdownSelection(e){const t=this.props.model.getRoleDefinitions().findIndex((t=>t.identifier===e.role.identifier)),s=new p.DropdownSelection;return s.select(t),s}isMyRow(e){const{userId:t}=this.props;return void 0!==t&&t===e.userId}}t[e].RoleAssignmentTable=n;const o=e=>r.createElement(m.Observer,{deleted:e.dataItem.isDeleted(),dirty:e.dataItem.isDirty()},(t=>r.createElement(u.SimpleTableCell,{className:(0,h.css)(t.deleted&&"cell-deleted",t.dirty&&"cell-dirty"),columnIndex:e.columnIndex,tableColumn:e.tableColumn},e.children)))}("ComponentsRoleAssignmentTable"),function(e){f=t[e]={};class s extends a.VssComponent{constructor(){super(...arguments),this.onUndoClick=()=>{(0,I.getService)(this.context.pageContext).resetRoleAssignments(this.props.model)},this.onSaveClick=()=>{const{model:e,resourceId:t,scopeId:s,serviceInstanceId:n}=this.props,{pageContext:o}=this.context;(0,I.getService)(o).saveRoleAssignments(o,e,s,t,n)},this.onSetInheritanceOn=()=>{const{model:e,resourceId:t,scopeId:s,serviceInstanceId:n}=this.props,{pageContext:o}=this.context;(0,I.getService)(o).setInheritance(o,e,!0,s,t,n)},this.onSetInheritanceOff=()=>{const{model:e,resourceId:t,scopeId:s,serviceInstanceId:n}=this.props,{pageContext:o}=this.context;(0,I.getService)(o).setInheritance(o,e,!1,s,t,n)}}render(){const{className:e,disabled:t,enableToggleInheritence:s,model:n,onAddUserClick:o}=this.props;let i=[{id:"inheritance-on",text:v.InheritanceOnActionText,checked:n.isInheritanceOn(),onActivate:this.onSetInheritanceOn},{id:"inheritance-off",text:v.InheritanceOffActionText,checked:n.isInheritanceOff(),onActivate:this.onSetInheritanceOff}];return r.createElement(R.FocusZone,{direction:1},r.createElement("div",{className:(0,h.css)("security-role-toolbar flex-row bolt-default-horizontal-spacing",e)},r.createElement(C.ButtonGroup,{role:"toolbar"},r.createElement(c.Button,{ariaLabel:v.AddActionDescription,disabled:t,iconProps:{iconName:"Add"},onClick:o,subtle:!0},v.AddActionText),r.createElement(m.Observer,{dirty:n.isDirty()},(e=>r.createElement(r.Fragment,null,r.createElement(c.Button,{ariaLabel:v.UndoActionDescription,disabled:t||!e.dirty,iconProps:{iconName:"Undo"},onClick:this.onUndoClick,subtle:!0},v.UndoActionText),r.createElement(c.Button,{ariaLabel:v.SaveActionDescription,disabled:t||!e.dirty,iconProps:{iconName:"Save"},onClick:this.onSaveClick,subtle:!0},v.SaveActionText)))),s&&r.createElement(b.MenuButton,{ariaLabel:v.InheritanceActionDescription,contextualMenuProps:{menuProps:{id:"inheritance",items:i}},disabled:t,subtle:!0},v.InheritanceActionText))))}}t[e].RoleAssignmentToolbar=s}("ComponentsRoleAssignmentToolbar"),function(e){D=t[e]={};class s extends a.VssComponent{constructor(){super(...arguments),this.showAddUserDialog=new l.ObservableValue(!1),this.onAddUserClick=()=>{this.showAddUserDialog.value=!0},this.onAddUserDismiss=()=>{this.showAddUserDialog.value=!1}}render(){var e;const{addUserDialogUserLabel:t,canEdit:s,enableToggleInheritence:n,hideRoleDescriptions:o,manageRolesPermission:i,noPermissionMessage:l,operationScopes:c=["ims","source"],resourceId:d,scopeId:u,serviceInstanceId:g,showAvatars:p=!0,userId:A}=this.props,C=null!==(e=this.props.identityTypes)&&void 0!==e?e:["user","group"],{pageContext:R}=this.context,b=(0,I.getService)(R).getRoleAssignments(R,u,d,{canEdit:s,manageRolesPermission:i,userId:A},g);return r.createElement("div",{className:(0,h.css)("security-role-assignment",this.props.className)},r.createElement(m.Observer,{userCanManageRoles:b.userCanManageRoles()},(e=>e.userCanManageRoles?null:r.createElement(S.MessageCard,{severity:"Warning"},l||v.CannotEditRolesMessage))),r.createElement(m.Observer,{ready:b.isReady(),userCanManageRoles:b.userCanManageRoles()},(e=>r.createElement(f.RoleAssignmentToolbar,{disabled:!e.userCanManageRoles||!e.ready,enableToggleInheritence:n,model:b,onAddUserClick:this.onAddUserClick,resourceId:d,scopeId:u,serviceInstanceId:g}))),r.createElement(m.Observer,{error:b.getError()},(e=>e.error?r.createElement(S.MessageCard,{severity:"Error",onDismiss:()=>b.setError(null)},e.error.message):null)),r.createElement(m.Observer,{ready:b.isReady(),userCanManageRoles:b.userCanManageRoles()},(e=>e.ready?r.createElement(x.RoleAssignmentTable,{model:b,disabled:!e.userCanManageRoles,showAvatars:p,userId:A}):null)),r.createElement(m.Observer,{showAddUserDialog:this.showAddUserDialog},(e=>e.showAddUserDialog?r.createElement(a.WrappedComponent,{dependencies:["ms.vss-features.security-ui-roles-add-dialog"],wrappedProps:{addUserDialogUserLabel:t,hideRoleDescriptions:o,identityTypes:C,model:b,onDismiss:this.onAddUserDismiss,operationScopes:c},wrappedType:"vss-security-ui.add-role-assignment"}):null)))}}t[e].RoleAssignment=s,a.VssComponent.register("vss-security-ui.role-assignment",s)}("ComponentsRoleAssignment"),function(e){t[e]={},__exportStar(D,t[e])}("RoleAssignment")}),["Resources","RolesManagementService","Components/RoleAssignmentTable","Components/RoleAssignmentToolbar","Components/RoleAssignment","RoleAssignment"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-features.security-ui-roles-management"}}));
"use strict";define("VSS/ProofOfPresence",["require","exports","@azure/msal-browser","VSS/Msal/MsalAuthentication","VSS/Platform/Context","VSS/Platform/Feature","VSS/Platform/Util/Object","VSS/Platform/RestClient/ProofOfPresence","VSS/Platform/Trace"],(function(e,t,o,r,n,a,s,i,c){var l,p;l=t[p="Resources"]={},t[p].ProofOfPresenceAttemptFailed="Failed to provide proof of presence.",t[p].ProofOfPresenceNoToken="Token acquisition canceled.",t[p].ProofOfPresenceWrongTenant="The acquired token did not match the selected tenant.",function(){t.ProofOfPresence={};const e="WebPlatform",p="ProofOfPresenceService";class d extends n.VssService{async verifyProofOfPresence(t,n,d){var f;const u=this.pageContext.getService("IVssContributionService").getData("ms.vss-web.proof-of-presence-config-data");if(!u)throw new Error("Missing proof of presence configuration");const P=this.pageContext.getService("IVssPageService").getData(),v=null==P?void 0:P.sessionId,g=(0,r.getMsalConfiguration)(this.pageContext);if(!g)throw new Error("Missing MSAL.js configuration");const m=this.pageContext.getService("IPublicClientApplicationFactory").getPublicClientApplication(g.configuration);let h;await m.initialize();const C=window.location.search.includes("_useRedirectForPop=true"),S=window.location.origin,T=null==P?void 0:P.hostPath;let y=u.claimsRequest;if(null==d?void 0:d.claimsChallenge)if(y){const e=JSON.parse(y),t=JSON.parse(d.claimsChallenge),o=(0,s.deepMerge)(e,t);y=JSON.stringify(o)}else y=d.claimsChallenge;const I={correlationId:v,authority:(null==d?void 0:d.authority)||u.authority,storeInCache:{accessToken:!1,idToken:!1,refreshToken:!1},scopes:u.scopes||["499b84ac-1321-427f-aa17-267ca6975798/user_impersonation"],claims:y,domainHint:null==d?void 0:d.domainHint,extraQueryParameters:u.extraQueryParameters};if((0,a.isFeatureFlagEnabled)(this.pageContext,"VisualStudio.Services.WebPlatform.ATPoPTokensEnabled",!1)&&"release-proof-of-presence"!=t&&(I.authenticationScheme=o.AuthenticationScheme.POP,I.resourceRequestMethod="POST",I.resourceRequestUri=S+T+"_apis/ProofOfPresence/Attestation"),(null==d?void 0:d.tenantId)===(null===(f=null==g?void 0:g.authenticatedUser)||void 0===f?void 0:f.tenantId)){if(C){const e=(0,r.getMsalState)(this.pageContext,"redirect",g.accessMapping,{serviceInstanceType:null==d?void 0:d.serviceInstanceType,redirectHandler:"proof-of-presence-redirect-handler",providerName:t,payload:n,variant:null==d?void 0:d.variant});return I.state=e,await m.acquireTokenRedirect(I),{success:!1,errorCode:"no_token",message:l.ProofOfPresenceNoToken}}try{I.state=(0,r.getMsalState)(this.pageContext,"popup",g.accessMapping),h=await m.acquireTokenPopup(I)}catch(o){return(0,c.traceException)(this.pageContext,e,p,o,{correlationId:v,providerName:t}),{success:!1,errorCode:"no_token",message:l.ProofOfPresenceNoToken}}}else{if(C){const e=(0,r.getMsalState)(this.pageContext,"redirect",g.accessMapping,{serviceInstanceType:null==d?void 0:d.serviceInstanceType,redirectHandler:"proof-of-presence-redirect-handler",providerName:t,payload:n,variant:null==d?void 0:d.variant});return I.prompt=u.prompt||"select_account",I.state=e,await m.acquireTokenRedirect(I),{success:!1,errorCode:"no_token",message:l.ProofOfPresenceNoToken}}try{I.prompt=u.prompt||"select_account",I.state=(0,r.getMsalState)(this.pageContext,"popup",g.accessMapping),h=await m.acquireTokenPopup(I)}catch(o){return(0,c.traceException)(this.pageContext,e,p,o,{correlationId:v,providerName:t}),{success:!1,errorCode:"no_token",message:l.ProofOfPresenceNoToken}}}const O=h.tenantId;if((0,c.trace)(this.pageContext,{area:e,feature:p,level:3,message:"Completed token acquisition for proof of presence",properties:{correlationId:v,providerName:t,tenantId:O,expectedTenantId:null==d?void 0:d.tenantId}}),(null==d?void 0:d.tenantId)&&d.tenantId.toLowerCase()!==(null==O?void 0:O.toLowerCase()))return{success:!1,errorCode:"wrong_tenant",message:l.ProofOfPresenceWrongTenant};const x=(0,i.getProofOfPresenceClient)(this.pageContext,{serviceInstanceType:null==d?void 0:d.serviceInstanceType});try{await x.attestProofOfPresence({providerName:t,token:h.accessToken,payload:n})}catch(o){return(0,c.traceException)(this.pageContext,e,p,o,{correlationId:v,providerName:t}),{success:!1,errorCode:"pop_failed",message:l.ProofOfPresenceAttemptFailed}}return{success:!0}}}n.Services.add("IProofOfPresenceService",{serviceFactory:d});class f extends n.VssService{get name(){return"proof-of-presence-redirect-handler"}async invoke(t,o){const r=(0,i.getProofOfPresenceClient)(this.pageContext,{serviceInstanceType:o.serviceInstanceType});try{await r.attestProofOfPresence({providerName:o.providerName,token:t.accessToken,payload:o.payload})}catch(t){throw(0,c.traceException)(this.pageContext,e,p,t),t}}}n.Services.add("IProofOfPresenceRedirectHandler",{serviceFactory:f})}()}),["Resources","ProofOfPresence"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-web.proof-of-presence-content"}}));
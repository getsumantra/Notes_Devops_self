"use strict";define("Build/Designer",["require","exports","VSS/Core/Observable","VSS/Platform/Context","VSS/Platform/FPS","Tfs/Platform/Page","Build/SourceProviders/Common","VSS/Core/Util/String","react","VSSUI/Icon","VSSUI/List","VSSUI/Utilities/Provider","VSSUI/Status","VSSUI/Util","VSSUI/Panel","VSSUI/Spinner","VSS/Platform/Layout","Build/Common/Library/Navigation","VSS/Features/PlatformUI/FPSLink","VSS/Platform/Components/Format","VSS/Platform/Location","VSSUI/Button","VSSUI/Image","VSSUI/MessageCard","VSS/Platform/Feature","VSSUI/Header","VSSUI/Dialog","Build/Common/Library/Resources","VSSUI/ButtonGroup","VSSUI/Checkbox","VSSUI/FormItem","VSSUI/Link","VSSUI/TextField","react-dom","Build/Common/Library/Components/CopyToClipboardButton","VSS/Core/TimerManagement","VSSUI/TooltipEx","VSSUI/RadioButton","Build/Common/Library/Legacy/Components/BranchDropdown","VSSUI/Callout","VSSUI/HeaderCommandBar","VSSUI/VssIcon","Build/Common/Library/Components/CommandComponent","Build/Common/Library/Constants","Build/Common/Library/Legacy/Components/PipelineSettingsPanel","Build/Common/Library/StateHandler","Build/Queue-Panel/QueuePanel","VSSUI/Page","VSSUI/SplitButton","VSSUI/Pill","VSS/Platform/Util/Url","VSSUI/Observer","VSSUI/PillGroup","OfficeFabric/Selection","VSS/Platform/Trace","VSSUI/Ago","VSSUI/FilterBar","VSSUI/PickList","VSSUI/TextFilterBarItem","VSSUI/Utilities/Filter","Build/DesignerExtensions/YamlSnippetForm/Utilities/EndpointHelper","OfficeFabric/ProgressIndicator","VSSUI/Wizard"],(function(e,t,i,s,a,n,r,o,l,c,d,h,p,m,u,g,v,S,b,f,y,C,E,P,w,_,x,T,N,I,F,D,V,B,L,A,R,k,M,O,U,Y,z,j,W,H,q,K,G,Q,J,$,X,Z,ee,te,ie,se,ae,ne,re,oe,le){var ce,de,he,pe,me,ue,ge,ve,Se,be,fe,ye,Ce,Ee,Pe,we,_e,xe,Te,Ne,Ie,Fe,De,Ve,Be,Le,Ae;ce=t[Ae="Resources"]={},t[Ae].AddedSnippet="Added task",t[Ae].AuthorizeAndRunButtonText="Authorize resources and run",t[Ae].AuthorizeButtonText="Authorize",t[Ae].AuthorizeWithExternalIdentity="To continue, authorize a connection using your {0} identity",t[Ae].AuthorizingMessage="Authorizing...",t[Ae].AuthorizingWithProviderMessage="Authorizing with {0}...",t[Ae].AutoAuthorizeErrorMessage="An unspecified error occurred while attempting to authorize resources.",t[Ae].AzurePipelinesApp="Azure Pipelines GitHub App",t[Ae].Branch="Branch",t[Ae].BranchDataProviderErrorMessage="Error retrieving branches for repository {0}.",t[Ae].BranchNameErrorInvalidCharacter="A branch name cannot contain '{0}'.",t[Ae].BranchNameErrorInvalidLeadCharacter="A branch name cannot start with '{0}'.",t[Ae].BranchNameErrorInvalidTrailCharacter="A branch name cannot end with '{0}'.",t[Ae].BranchNameErrorSameAsTarget="The branch name cannot be the same as the target branch.",t[Ae].BranchNameErrorTooLong="The branch name cannot be longer than {0} characters.",t[Ae].BringYourOwnYamlTitle="Existing Azure Pipelines YAML file",t[Ae].BringYourOwnYamlTitleShort="Select an existing YAML file",t[Ae].BringYourOwnYamlDesc="Select an Azure Pipelines YAML file in any branch of the repository.",t[Ae].BuildInSimpleSteps="Build your code in a few easy steps",t[Ae].BuildNumberFormat="#{0}",t[Ae].BuildQueuedMessage="Build {0} has been queued.",t[Ae].BuildQueuingMessage="Queuing a build...",t[Ae].BuildsHubName="Builds",t[Ae].Cancel="Cancel",t[Ae].SaveAnyway="Save anyway",t[Ae].ReviewErrors="Review errors",t[Ae].ChooseSubscription="Azure subscription",t[Ae].Close="Close",t[Ae].CommandRunWithParameters="Run with parameters",t[Ae].CommandSettings="Settings",t[Ae].CommandTriggers="Triggers",t[Ae].CommandVariables="Variables",t[Ae].CommitMessage="Commit message",t[Ae].Configure="Configure",t[Ae].Configuring="Configuring...",t[Ae].ConfigureYourPipeline="Configure your pipeline",t[Ae].ConfiguringYourPipelineAndGeneratingYaml="Configuring resources and generating YAML",t[Ae].ConfigFileDataProviderErrorMessage="Error retrieving config files for repository {0}.",t[Ae].ConfigFileNotFound="File not found.",t[Ae].ConfigFileInvalid="File is not a valid Dockerfile or YAML file.",t[Ae].ConfirmLosingUnsavedChange="You have unsaved changes which will be lost if you navigate away. Are you sure you want to discard these changes?",t[Ae].ConfirmLosingUnsavedChangeTitle="Are you sure you want to leave?",t[Ae].Connect="Connect",t[Ae].Continue="Continue",t[Ae].CreatingPipeline="Creating pipeline...",t[Ae].DefaultBranch="default",t[Ae].DisabledSecretCheckboxTooltip="Once marked secret, a variable's value will always be kept secret.",t[Ae].EditInOldDesigner="Use the classic editor",t[Ae].EditorDefaultTitle="Pipeline editor",t[Ae].EditorErrorDefaultPipelineFetch="An error occurred while fetching the pipeline. {0}",t[Ae].EditorErrorGitRepoNotFound="{0} You can use the classic editor to select the repository in the YAML source settings.",t[Ae].EditorErrorNotYamlPipeline="{0} You can use the classic editor to view and edit pipelines without YAML.",t[Ae].EditorErrorServiceConnection="{0} You can use the classic editor to fix the service connection in the YAML source settings.",t[Ae].ErrorMessage="Error: {0}",t[Ae].ExistingFileFound="An existing YAML file was found",t[Ae].FilesToBeAdded="Files to be added to your repository ({0})",t[Ae].FileInvalidCharacters='The file name cannot contain any of the following characters: \\ : * ? " < > |',t[Ae].FileInvalidDoubleSlash="The file name cannot contain //",t[Ae].FileInvalidEmpty="The file name cannot be empty",t[Ae].FileInvalidEndCharacters="The file or folder name cannot end with any of the following characters: / .",t[Ae].FullYaml="Download full YAML",t[Ae].HostedMacWarning="Using a hosted macOS pool affects your data storage and security. {0}",t[Ae].ImageName="Image name",t[Ae].GetFileContentErrorMessage="An unspecified error occurred while fetching file {0} from branch {1}.",t[Ae].LearnMore="Learn more",t[Ae].Leave="Leave",t[Ae].LoadingEditor="Loading the editor...",t[Ae].LoadingYAMLFiles="Loading existing YAML files...",t[Ae].LoginUrlNotSpecified="Could not login to view this YAML file",t[Ae].InvalidServiceConnection="Unable to fetch any repositories. Please ensure the service connection is valid.",t[Ae].MoreOptions="More options",t[Ae].Name="Name",t[Ae].NameColumnHeader="Name",t[Ae].NewLabel="New",t[Ae].NewPipeline="New pipeline",t[Ae].OK="OK",t[Ae].OldDesignerFallbackFormat="{0} to create a pipeline without YAML.",t[Ae].OldDesignerLinkText="Use the classic editor",t[Ae].OptionalExtendedDescription="Optional extended description",t[Ae].OrFormat="Or, {0}",t[Ae].Path="Path",t[Ae].PipelineHostedOn="This pipeline's YAML is hosted on {0}",t[Ae].PipelineSavedMessage="Changes applied to the pipeline for all runs",t[Ae].PipelineSettingsPanelTitle="Pipeline settings",t[Ae].PipelineSettingsSubheaderStatus="Processing of new run requests",t[Ae].PipelineSettingsStatusEnabled="Enabled",t[Ae].PipelineSettingsStatusDisabled="Disabled",t[Ae].PipelineSettingsStatusPaused="Paused",t[Ae].PipelineSettingsYamlDiscard="This will discard unsaved changes in the current YAML file",t[Ae].PipelineSettingsYamlFetchError="An unspecified error occurred while fetching existing YAML files.",t[Ae].PipelineSettingsYamlFilePath="YAML file path",t[Ae].PipelineStatusCIDisabled="CI Disabled",t[Ae].PipelineStatusDisabled="Disabled",t[Ae].PipelineStatusPaused="Paused",t[Ae].QueueResourceName="Agent pool",t[Ae].Recommended="Recommended",t[Ae].Rename="Rename",t[Ae].RepositoryAlreadyMapped="The repository {0} is in use with the {1} in another Azure DevOps organization. {2}",t[Ae].RepositoryAnalyzing="Analyzing your repository to suggest a compatible template...",t[Ae].RepositorySelectorFetchingRepositories="Fetching repositories...",t[Ae].RepositorySelectorFilterPlaceholder="Filter by keywords",t[Ae].RepositorySelectorFilterReset="Reset",t[Ae].RepositorySelectorNoneFoundDescription="No matching repositories were found.",t[Ae].RepositorySelectorProvideAccessDescription="If you can't find a repository, make sure you {0}.",t[Ae].RepositorySelectorProvideAccessDescriptionLink="provide access",t[Ae].RepositorySelectorTagFork="fork",t[Ae].RepositorySelectorTagPrivate="private",t[Ae].RepositorySelectorTitle="Select a repository",t[Ae].ResourcesVariables="Variables",t[Ae].ResourcesAuthorizedResources="Authorized resources",t[Ae].Review="Review",t[Ae].ReviewYourPipelineYAML="Review your pipeline YAML",t[Ae].RunBuildErrorMessage="An unspecified error occurred while queuing the build.",t[Ae].RunButtonLabel="Run",t[Ae].SaveAndRunButtonLabel="Save and run",t[Ae].SaveButtonLabel="Save",t[Ae].ValidateAndSaveButtonLabel="Validate and save",t[Ae].ValidateAndSavePanelValidationLabel="Validation",t[Ae].SaveWithoutValidationButtonLabel="Save without validating",t[Ae].ValidateSpinnerLabel="Validating pipeline...",t[Ae].ValidationResultErrorsDetected="Errors detected in pipeline validation. Pipeline may fail.",t[Ae].ValidationResultSuccess="Pipeline is valid",t[Ae].ValidationResultErrorsDetectedLabel="Errors detected",t[Ae].SaveErrorMessage="An unspecified error occurred while saving the file.",t[Ae].SavePanelCommitDescriptionPlaceholder="Add an optional description...",t[Ae].SavePanelCommitMessage="Set up CI with Azure Pipelines",t[Ae].SavePanelCommitMessageForAdd="Add {0} for Azure Pipelines",t[Ae].SavePanelCommitMessageForEdit="Update {0} for Azure Pipelines",t[Ae].SavePanelCommitToDefault="Commit directly to the {0} branch",t[Ae].SavePanelCommitToNewBranch="Create a new branch for this commit",t[Ae].SavePanelCreatePullRequest="Start a pull request",t[Ae].SavePanelDescription="Saving will commit {0} to the repository.",t[Ae].ValidateAndSavePanelDescription="Validate and commit {0} to the repository.",t[Ae].ValidatePanelDescription="Validate {0}",t[Ae].ValidatePanelTitle="Validate",t[Ae].SavePanelNewBranchMessage="Based on the {0} branch",t[Ae].SavePanelNewBranchName="azure-pipelines",t[Ae].SavePanelTitleSave="Save",t[Ae].SavePanelTitleSaveAndRun="Save and run",t[Ae].SavePanelTitleValidateAndSave="Validate and save",t[Ae].SavingChanges="Saving changes...",t[Ae].SecureFileResourceName="Secure file",t[Ae].Select="Select",t[Ae].SelectAzureSubscription="Select an Azure subscription",t[Ae].SelectYamlDescription="Select a file from the dropdown or type in the path to your file",t[Ae].ServiceEndpointResourceName="Service connection",t[Ae].ServicePort="Service port",t[Ae].ShowMore="Show more",t[Ae].SidePanelClose="Hide",t[Ae].SidePanelOpen="Show assistant",t[Ae].Stay="Stay",t[Ae].StepTemplate="Template",t[Ae].StepSubscription="Subscription",t[Ae].Template="Template",t[Ae].TemplateRequiresMoreInfo="The selected template requires the following information",t[Ae].TestPanelCommandName="TestPanel",t[Ae].TypeColumnHeader="Type",t[Ae].UnauthorizeButtonText="Unauthorize",t[Ae].UnableToInstallMarketplaceApp="The {0} is not installed to repository {1}. {2}",t[Ae].Validate="Validate",t[Ae].ValidateAndConfigureButtonLabel="Validate and configure",t[Ae].Validation="Validation",t[Ae].Value="Value",t[Ae].VariableGroupResourceName="Variable group",t[Ae].ViewOnExternalSite="view it on {0}",t[Ae].VisibilityMismatchProjectSettings="project settings",t[Ae].VisibilityMismatchRepoPrivate="You selected a private repository, but this is a public project. Go to {0} to change the visibility of the project. {1}",t[Ae].VisibilityMismatchRepoPublic="You selected a public repository, but this is not a public project. Go to {0} to change the visibility of the project. {1}",t[Ae].VariableColumnHeaderName="Name",t[Ae].VariableColumnHeaderValue="Value",t[Ae].VariableColumnHeaderSecret="Secret variable",t[Ae].VariableColumnHeaderIcon="Variable error message",t[Ae].VariableErrorNameIsRequired="Variable name is required",t[Ae].VariableErrorNameIsAlreadyDefined="Variable '{0}' is already defined",t[Ae].VariableSecretTooltipChangeToSecret="Change variable type to secret",t[Ae].VariableSecretTooltipChangeToPlainText="Change variable type to plain text",t[Ae].VariableAddButtonText="Add variable",t[Ae].VariableDeleteButtonTooltipText="Delete variable",t[Ae].VariableEditPanelTitleNew="New variable",t[Ae].VariableEditPanelTitleUpdate="Update variable",t[Ae].VariableEditPanelToReferenceText="{0}, prefix it with a dollar sign and enclose it in parentheses.  For example: {1}",t[Ae].VariableEditPanelToReferenceText0="To reference a variable in YAML",t[Ae].VariableEditPanelToUseText="{0}, use environment variable syntax.",t[Ae].VariableEditPanelToUseText0="To use a variable in a script",t[Ae].VariableEditPanelToUseTextMore="Replace {0} and space with {1}, capitalize the letters, and then use your platform's syntax for referencing an environment variable. Examples:",t[Ae].VariableEditPanelToUseExBatch="Batch script: {0}",t[Ae].VariableEditPanelToUseExPowerShell="PowerShell script: {0}",t[Ae].VariableEditPanelToUseExBash="Bash script: {0}",t[Ae].VariableEditPanelToUseSecret="{0}, you must explicitly map it as an environment variable.",t[Ae].VariableEditPanelToUseSecret0="To use a secret variable in a script",t[Ae].VariableEditPanelIsSecret="Keep this value secret",t[Ae].VariableEditPanelIsDuplicate="Variable '{0}' is already defined",t[Ae].VariableEditPanelAllowOverride="Let users override this value when running this pipeline",t[Ae].VariablesPanelCommandCopy="Copy",t[Ae].VariablesPanelCommandDelete="Delete variable",t[Ae].VariablesPanelCommandUndoDelete="Undo deletion",t[Ae].VariablesPanelEmptyText="Use variables to store values or encrypted secrets separately from your repository.",t[Ae].VariablesPanelLearnMore="Learn about variables",t[Ae].VariablesPanelNewVariable="New variable",t[Ae].VariablesPanelSaveComment="Update variables",t[Ae].VariablesPanelSearch="Search variables",t[Ae].VariablesPanelTitle="Variables",t[Ae].VariableReferencePlaceholderName="variable-name",t[Ae].WhereIsYourCode="Where is your code?",t[Ae].Yaml="YAML",t[Ae].YamlFileDescription="Pipeline process",function(e){de=t[e]={},function(e){e.ElementToFocusOnEscape="ci-editor-escape-focus-element",e.ToastDuration=5e3,e.YamlAssistantToggleElement="yaml-assistant-toggle-element"}(t[e].EditorConstants||(t[e].EditorConstants={})),function(e){e.AzurePipelinesDocs="https://go.microsoft.com/fwlink/?linkid=2024748",e.LearnMoreVariables="https://go.microsoft.com/fwlink/?linkid=2098718"}(t[e].FwLinks||(t[e].FwLinks={})),function(e){e.Triggers="Tab_Triggers",e.Variables="Tab_Variables",e.Yaml="Tab_Tasks"}(t[e].LegacyDesignerTabKeys||(t[e].LegacyDesignerTabKeys={})),function(e){e.TemplateIdKey="templateid",e.RepositoryNameKey="repositoryName",e.K8sConnectionKey="k8sConnection",e.SubscriptionId="subscriptionId"}(t[e].TemplateConstants||(t[e].TemplateConstants={})),function(e){e.AzureSubscription="connectedService:azureRM",e.DataSourcePicklist="dataSourcePicklist",e.KubernetesEndpoint="endpoint:kubernetes"}(t[e].TemplateRequiredConstants||(t[e].TemplateRequiredConstants={})),function(e){e.AzureContainerRegistry="endpoint:containerRegistry",e.AzureRmEndpoint="endpoint:azureRm",e.Boolean="boolean",e.DataSourcePickList="dataSourcePicklist",e.KubernetesResource="environmentResource:kubernetes",e.PickList="picklist",e.String="string",e.MarkDown="markdown"}(t[e].TemplateParameterTypes||(t[e].TemplateParameterTypes={})),function(e){e.File="file"}(t[e].TemplateAssetTypes||(t[e].TemplateAssetTypes={})),function(e){e.DefinitionTypeNotSupportedException="DefinitionTypeNotSupportedException",e.GitRepositoryNotFoundException="GitRepositoryNotFoundException",e.ServiceEndpointNotFoundException="ServiceEndpointNotFoundException"}(t[e].WellKnownExceptions||(t[e].WellKnownExceptions={})),function(e){e.ConnectionId="connectionId",e.RepositoryId="repositoryId"}(t[e].WizardStateKeys||(t[e].WizardStateKeys={}))}("Constants"),function(e){he=t[e]={},function(e){e.Area="Build"}(t[e].PerformanceConstants||(t[e].PerformanceConstants={})),function(e){e.Sources="PLT.CI.AcquisitionWizard.Sources",e.YamlEditor="PLT.CI.YamlEditor",e.Repository="CI.Designer.Repository",e.Templates="CI.Designer.Templates"}(t[e].PageLoadScenarios||(t[e].PageLoadScenarios={}))}("Performance"),function(){t.PipelineEditorBreadcrumbService={};class e extends s.VssService{constructor(){super(...arguments),this.items=new i.ObservableArray}getBreadcrumbItems(e){return this.items}setPipeline(e){const t="pipeline-editor-breadcrumb";this.items.removeAll();const i=this.buildLinkingService.getDefinitionUrl();if(this.items.push({key:"pipeline-editor-builds-breadcrumb",text:ce.BuildsHubName,href:i,onClick:e=>{(0,a.onClickFPS)(this.pageContext,i,!0,e,{telemetrySource:t})}}),e){const i=this.buildLinkingService.getDefinitionUrl(e.id);this.items.push({key:"pipeline-editor-definition-breadcrumb",text:e.name,href:i,onClick:e=>{(0,a.onClickFPS)(this.pageContext,i,!0,e,{telemetrySource:t})}},{key:"pipeline-editor-pipeline-yaml-breadcrumb",text:ce.Yaml})}}clearPipeline(){this.items.removeAll()}get buildLinkingService(){return this.pageContext.getService("IBuildLinkingService")}}s.Services.add("pipeline-editor-breadcrumb-service",{serviceFactory:e})}(),function(e){pe=t[e]={},t[e].getFileName=function(e){if(e){const t=e.lastIndexOf("/");return t>=0?e.substr(t+1):e}return""},t[e].getParentPath=function(e){let t;const i=r(n(e));if(i){t="/";const e=i.lastIndexOf("/");e>=0&&(t+=i.substr(0,e))}return t};const i=new Set(["\\",":","*","?",'"',"<",">","|"]),s=new Set(["/","."]);function a(e){return(e||"").split("/").map((e=>(e||"").trim())).join("/")}function n(e){for(;e&&"/"===e[0];)e=e.substr(1);return e}function r(e){for(;e&&"/"===e[e.length-1];)e=e.substr(0,e.length-1);return e}t[e].getInvalidFileNameMessage=function(e){return(e=a(e)).indexOf("//")>-1?ce.FileInvalidDoubleSlash:(e=n(e))?Array.from(e).some((e=>i.has(e)))?ce.FileInvalidCharacters:e.split("/").some((e=>!e||s.has(e.substr(e.length-1))))?ce.FileInvalidEndCharacters:void 0:ce.FileInvalidEmpty},t[e].trimFilePath=a,t[e].trimLeadingSlashes=n,t[e].trimTrailingSlashes=r,t[e].ensureYamlExtension=function(e){const t=e.toLocaleLowerCase();return t.endsWith(".yml")||t.endsWith(".yaml")||(e+=".yml"),e}}("UtilFile"),function(e){me=t[e]={},t[e].clearWarning=function(e,t){const i=e.getService("IGlobalMessagesService"),s=i.getBanner();s&&s.settingId===t&&i.closeBanner()},t[e].showWarning=function(e,t){e.getService("IGlobalMessagesService").addBanner({messageFormat:t.messageFormat,messageLinks:t.links,level:1,settingId:t.id},!1,!1)}}("WarningBanner"),function(e){function i(e){const t=e.properties&&e.properties.isPrivate;return!(!t||"true"!==t.toLowerCase())}t[e]={},t[e].bannerId="_warnIfVisibilityMismatch",t[e].isVisibilityMismatch=function(e,t){return function(e){const t=(0,n.getTFSPageData)(e);if(t&&t.project&&t.project.visibility){return 2===t.project.visibility}return!1}(e)!=!i(t)},t[e].getBannerContent=function(s,a){const n=i(a),r=s.getService("IBuildLinkingService");return{id:t[e].bannerId,messageFormat:n?ce.VisibilityMismatchRepoPrivate:ce.VisibilityMismatchRepoPublic,links:[{name:ce.VisibilityMismatchProjectSettings,href:r.getProjectSettingsUrl()},{name:ce.LearnMore,href:"https://go.microsoft.com/fwlink/?linkid=2027430"}]}}}("VisibilityMismatchWarning"),function(){t.YamlFileService={};class e extends s.VssService{commitFile(e,t,i,s,a,n){const r=[{content:s,path:i,oldObjectId:n||""}];return this.commitFiles(e,t,r,a)}commitFiles(e,t,i,s){s.skipCi&&this._suppressCIBuild(s);const a="ms.vss-build-web.commit-file-data-provider",n={connectionId:e.connectionId,sourceProviderType:e.sourceProviderType,repositoryId:e.id,projectId:e.projectId||"",files:i,targetBranch:t,sourceBranch:s.createNewBranch?s.newBranchName:"",createPullRequest:s.createNewBranch&&s.createPullRequest,message:s.message,description:s.description};if(e.projectId){const t={contributionIds:[a],context:{properties:n}};t.context.properties.projectId=e.projectId;return this.pageContext.getRestClient("IContributionsRestClient").queryDataProviders(t,"project",e.projectId).then((e=>{if(e.resolvedProviders&&e.resolvedProviders.length){if(e.exceptions&&e.exceptions[a])throw new Error(e.exceptions[a].message);{const t=e.data[a]||{};return Object.assign(Object.assign({},t),{commitDescriptorName:s.message})}}throw new Error(ce.SaveErrorMessage)}),(e=>{throw new Error(e&&e.message||ce.SaveErrorMessage)}))}{const e=this.pageContext.getService("IVssContributionService");return e.getDataAsync(a,n,!0).then((t=>{if(t){return Object.assign(Object.assign({},t),{commitDescriptorName:s.message})}{const t=e.getDataProviderExceptions()[a],i=t&&t.message||ce.SaveErrorMessage;throw new Error(i)}}))}}getFileContentData(e,t,i){const s="ms.vss-build-web.file-content-data-provider",a={connectionId:e.connectionId,sourceProvider:e.sourceProviderType,repository:e.id,path:i,branch:t},n=this.pageContext.getService("IVssContributionService");return n.getDataAsync(s,a).then((a=>{if(a)return a;{const a=n.getDataProviderExceptions()[s];let r=a&&a.message||(0,o.format)(ce.GetFileContentErrorMessage,i,t);throw r=this._processErrorMessage(r,e),new Error(r)}}))}_suppressCIBuild(e){let t=e.description||"";const s=((e.message||"")+"|"+t).toLocaleLowerCase();a.every((e=>-1===s.indexOf(e)))&&(t+=(t?" ":"")+i,e.description=t)}_processErrorMessage(e,t){let i=e||"";return(0,o.equals)(t.sourceProviderType,r.RepositoryTypes.TfsGit,!0)&&t.name&&t.id&&(i=e.replace(t.id,t.name)),i}}const i="[skip ci]",a=["***no_ci***",i,"[ci skip]","skip-checks: true","skip-checks:true","[skip azp]","[azp skip]","[skip azpipelines]","[azpipelines skip]","[skip azurepipelines]","[azurepipelines skip]"];s.Services.add("IYamlFileService",{serviceFactory:e})}(),function(e){t[e]={};t[e].AvailableResourcesModel=class{constructor(e){const t=e&&e.queues||[];this._queues=new i.ObservableArray(t.map((e=>({id:e.id,name:e.alias}))))}get queues(){return this._queues}};class a extends s.VssObservableService{getVariables(){if(!this._variables){const e=this.pageContext.getService("IVssContributionService").getData(a.PipelineDataProviderKey),t=e&&e.definition&&e.definition.variables||{};this._variables=Object.keys(t).map((e=>Object.assign({name:e},t[e]))).sort(((e,t)=>e.name.toLowerCase().localeCompare(t.name.toLowerCase(),navigator.language))),this._originalJson=JSON.stringify(this._variables)}return[...this._variables]}isVariablesChanged(){return JSON.stringify(this._variables.sort(((e,t)=>e.name.toLowerCase().localeCompare(t.name.toLowerCase(),navigator.language))))!==this._originalJson}getAvailableQueues(){const e=new i.ObservableArray,t=this.pageContext.getService("IVssContributionService").getData(a.ContributionKey);return t&&(e.value=t.queues),e}updateVariables(e){this._variables=e,this._notify([...this._variables],"updateVariables".toString())}getBuildDefinitionVariables(){return this._variables.reduce(((e,t)=>(e[t.name]=Object.assign({},t),e)),{})}}a.ContributionKey="ms.vss-build-web.pipeline-resources-data-provider",a.PipelineDataProviderKey="ms.vss-build-web.pipeline-editor-data-provider",s.Services.add("IYamlResourcesService",{serviceFactory:a})}("YamlResourcesService"),function(e){ue=t[e]={},function(e){e.Yaml="FileYML",e.Other="FileCode"}(t[e].FileType||(t[e].FileType={}));t[e].FileList=e=>{const t=new h.ArrayItemProvider(e.files);return l.createElement("div",{className:"fileList flex-column"},l.createElement("label",{className:"fileList-label"},(0,o.format)(ce.FilesToBeAdded,e.files.length)),l.createElement(d.List,{className:"section-content",itemProvider:t,renderRow:(e,t,i,s)=>l.createElement(d.ListItem,{key:s||"list-item"+e,index:e,details:i},l.createElement(c.Icon,{className:"fileList-icon body-xl",iconName:t.type}),l.createElement("div",{className:"fileList-info flex-column"},l.createElement("div",{className:"fileList-name body-m"},t.name),l.createElement("div",{className:"fileList-description body-s secondary-text"},t.description))),width:"100%"}))}}("ComponentsFileList"),function(e){ge=t[e]={};t[e].ValidationErrors=e=>{const{errors:t}=e;return l.createElement("div",{className:"validation-errors flex-column flex-grow scroll-auto"},t.map(((e,i)=>l.createElement("div",{className:(0,m.css)("flex-row flex-center full-width padding-vertical-12 padding-horizontal-12","separator-line-top",i==t.length-1&&"separator-line-bottom"),tabIndex:i,key:`validation-error-${i}`},l.createElement(p.Status,Object.assign({},p.Statuses.Failed,{key:`failed-error-${i}`,size:"16"})),l.createElement("p",{className:"word-break padding-left-12"},e)))))}}("ComponentsValidationErrors"),function(e){ve=t[e]={};t[e].ValidationPanel=e=>{const{onValidate:t,onDismiss:i,postValidation:s,filePath:a,isValidationFromDownloadYAML:n}=e,[r,c]=(0,l.useState)(!0),[d,h]=(0,l.useState)([]);return(0,l.useEffect)((()=>{!async function(){var e;try{const e=await t();n||(e.errors&&h(e.errors.split("\n")),s(e))}catch(t){n&&(h(null===(e=null==t?void 0:t.message)||void 0===e?void 0:e.split("\n")),s(t.message))}c(!1)}()}),[]),l.createElement(u.CustomPanel,{ariaLabel:ce.ValidatePanelTitle,size:1,onDismiss:i,lightDismiss:!0},l.createElement(u.PanelHeader,{titleProps:{text:ce.ValidatePanelTitle,size:1},description:(0,o.format)(ce.ValidatePanelDescription,a),onDismiss:i}),l.createElement(u.PanelContent,null,r?l.createElement(g.Spinner,{label:ce.ValidateSpinnerLabel,orientation:1,className:"flex-self-center full-width"}):d.length>0?l.createElement("div",null,l.createElement("label",{className:"bolt-textfield-label secondary-text"},ce.ValidationResultErrorsDetectedLabel),l.createElement("div",{className:"section-content padding-top-8"},l.createElement(ge.ValidationErrors,{errors:d}))):l.createElement("div",{className:"flex-column full-height full-width flex-center justify-center"},l.createElement(p.Status,Object.assign({},p.Statuses.Success,{key:"success",size:"32",className:"margin-bottom-8"})),ce.ValidationResultSuccess)),l.createElement(u.PanelFooter,{buttonProps:[{text:ce.Close,onClick:i,primary:!1}]}))}}("ComponentsValidationPanel"),function(e){Se=t[e]={};class i extends v.VssComponent{constructor(e,t){super(e,t),this._createAuthRequest=()=>{this.props.loginUrl&&(0,S.openLinkSecurely)(this.props.loginUrl)},this._sourceProvider=s(this.context.pageContext,this.props.sourceProvider.getKey())||{};const i=this.context.pageContext.getService("ITfsPageService").getData();this.state={projectId:i.project.id,yamlLink:this.props.yamlFileLink}}componentDidMount(){if(null==this.state.yamlLink){const e={branchName:this.props.repository.defaultBranch,repositoryName:this.props.repository.name};this.props.sourceProvider.fetchLinks([e]).then((e=>{if(e&&e.length>0){const t=e[0];t&&t.repositoryLink&&this.setState({yamlLink:t.repositoryLink})}}))}}componentWillUnmount(){}render(){const e=(0,o.format)(ce.PipelineHostedOn,this._sourceProvider.name),t=(0,o.format)(ce.AuthorizeWithExternalIdentity,this._sourceProvider.name),i=(0,o.format)(ce.ViewOnExternalSite,this._sourceProvider.name);return l.createElement("div",{className:"ci-designer-auth-landing-page-body flex-grow flex-column justify-center flex-center"},l.createElement("div",{className:"circle flex flex-center"},(e=>e.iconAsset?l.createElement(E.Image,{className:"source-provider-icon",src:(0,y.getAssetLocation)(this.context.pageContext,e.iconAsset),alt:e.iconAssetAltText||""}):l.createElement(c.Icon,{className:"source-provider-icon",iconName:this.props.sourceProvider.getRepoIconName()}))(this._sourceProvider)),l.createElement("div",{className:"primary-text"},e),l.createElement("div",{className:"secondary-text"},t),l.createElement(C.Button,{className:"authorize-button",primary:!0,text:ce.AuthorizeButtonText,onClick:this._createAuthRequest}),l.createElement(f.FormatComponent,{format:ce.OrFormat},l.createElement(b.FPSLink,{href:this.state.yamlLink,telemetrySource:"pipeline-editor.auth-landing-page",telemetryProperties:{clickedOn:"viewOnGitHub"},"aria-label":i},i)))}}function s(e,t){const i=e.getService("IVssContributionService").getContributionsByType("ms.vss-build-web.acquisition-source-provider-tile"),s=Object.keys(i).map((e=>i[e])).filter((e=>e.key===t));return s.length>0?s[0]:void 0}t[e].EditorAuthLandingPage=i,t[e].getSourceProviderTile=s}("EditorAuthLandingPage"),function(e){be=t[e]={};class i extends v.VssComponent{constructor(e,t){super(e,t),this._gotoPipelineResults=e=>{const t=this.buildLinkingService.getDefinitionUrl(this.props.definition&&this.props.definition.id);this._gotoUrl(t,e)},this._gotoLegacyDesigner=(e,t)=>{const i=this.buildLinkingService.getDefinitionEditUrl(this.props.definition.id,e);this._gotoUrl(i,t)},this.state={},this._isVariablesPanelEnabled=!(0,w.isFeatureFlagEnabled)(t.pageContext,"Build2.DisableYamlEditorVariables",!1)}render(){return l.createElement(l.Fragment,null,l.createElement(_.Header,{className:"ci-editor-header",title:this._getTitle(),titleSize:1,backButtonProps:{onClick:this._gotoPipelineResults},commandBarItems:this._getCommandBarItems()}),this._getMessages())}_getTitle(){const e=this.props.definition&&this.props.definition.queueStatus||0;let t="";return 2===e?t=ce.PipelineStatusDisabled:1===e?t=ce.PipelineStatusPaused:this.props.definition&&!this._isCIEnabled()&&(t=ce.PipelineStatusCIDisabled),l.createElement(l.Fragment,null,l.createElement("span",null,this.props.title),t&&l.createElement("span",{className:"pipeline-status"},t))}_getCommandBarItems(){const e=[];if(this._isVariablesPanelEnabled){const t={id:"variablesPanel",text:ce.CommandVariables,important:!0,disabled:!this.props.definition,isPrimary:!1,onActivate:this.props.onVariablesOpen};e.push(t)}const t={id:"runsave",className:de.EditorConstants.ElementToFocusOnEscape,text:this.props.actionButtonLabel,important:!0,disabled:this.props.actionDisabled,isPrimary:!0,onActivate:this.props.onActionClick};e.push(t);const i={id:"settings",text:ce.CommandSettings,important:!1,disabled:!this.props.definition,iconProps:{iconName:"Settings"},onActivate:this.props.onSettingsOpen};e.push(i);e.push({id:"sep1",itemType:1,important:!1});const s={id:"validate",text:ce.Validate,important:!1,disabled:!this.props.definition,iconProps:{iconName:"CheckMark"},onActivate:this.props.onValidateYaml};e.push(s);const a={id:"fullyaml",text:ce.FullYaml,important:!1,disabled:!this.props.definition,iconProps:{iconName:"FileYML"},onActivate:this.props.onFullYaml};e.push(a);e.push({id:"sep2",itemType:1,important:!1});const n={id:"triggers",text:ce.CommandTriggers,important:!1,disabled:!this.props.definition,iconProps:{iconName:"LightningBolt"},onActivate:(e,t)=>this._gotoLegacyDesigner(de.LegacyDesignerTabKeys.Triggers,t)};if(e.push(n),!this._isVariablesPanelEnabled){const t={id:"variables",text:ce.CommandVariables,important:!1,disabled:!this.props.definition,iconProps:{iconName:"Variable"},onActivate:(e,t)=>this._gotoLegacyDesigner(de.LegacyDesignerTabKeys.Variables,t)};e.push(t)}return e}_gotoUrl(e,t){t&&(t.ctrlKey||t.shiftKey)?(0,S.openLinkSecurely)(e,!0):(0,a.onClickFPS)(this.context.pageContext,e,!0)}_getMessages(){const e=this._getErrorBar(),t=this._getBuildMessageBar();if(e||t)return l.createElement("div",{className:"page-content flex-row flex-noshrink"},e,t)}_getErrorBar(){if(this.props.errorMessage)return l.createElement(P.MessageCard,{className:"flex-grow",severity:"Error",buttonProps:this.props.errorActions,onDismiss:this.props.onErrorMessageDismissed},this.props.errorMessage)}_getBuildMessageBar(){if(this.props.buildMessageInfo){const e=this.props.buildMessageInfo,t=e.id>0?this.buildLinkingService.getBuildUrl(e.id):"";return l.createElement(P.MessageCard,{className:"flex-grow",severity:"Info",onDismiss:this.props.onBuildMessageDismissed},e.isQueuing?ce.BuildQueuingMessage:l.createElement(f.FormatComponent,{format:ce.BuildQueuedMessage},l.createElement(b.FPSLink,{href:t},(0,o.format)(ce.BuildNumberFormat,e.number))))}}_isCIEnabled(){const e=this.props.definition.triggers;return!!(e&&e.find((e=>2===e.triggerType)))}get buildLinkingService(){return this.context.pageContext.getService("IBuildLinkingService")}}t[e].EditorHeader=i}("EditorHeader"),function(e){function i(e,t){return l.createElement(x.Dialog,{titleProps:{text:ce.ConfirmLosingUnsavedChangeTitle},onDismiss:t,footerButtonProps:[{primary:!0,onClick:e,text:ce.Leave},{onClick:t,text:ce.Stay}],lightDismiss:!1},ce.ConfirmLosingUnsavedChange)}fe=t[e]={},t[e].addNavigateAwayListener=function(e){document.body.addEventListener("fpsStarting",e),window.addEventListener("beforeunload",e)},t[e].removeNavigateAwayListener=function(e){document.body.removeEventListener("fpsStarting",e),window.removeEventListener("beforeunload",e)},t[e].showLoseChangesDialog=function(e,t){const s=t.detail;if(s&&s.href){if(s.data&&s.data.isPageSwitchConfirmed)return;t.preventDefault();e.getService("IVssLayoutManager").renderCallout((e=>i((()=>{e(),s.data=s.data||{},s.data.isPageSwitchConfirmed=!0,(0,a.FastPageSwitch)(s.pageContext,s.href,s.recordHistoryEntry,s.data)}),(()=>{e()}))))}else t.returnValue=ce.ConfirmLosingUnsavedChange},t[e].getLoseChangesDialog=i}("LoseChangesDialog"),function(e){ye=t[e]={};class i extends v.VssComponent{constructor(e){super(e),this._onNameChanged=(e,t)=>{this.setState({name:t})},this._onValueChanged=(e,t)=>{this.setState({value:t})},this._onIsSecretChanged=(e,t)=>{this.setState({isSecret:t||void 0})},this._onAllowOverrideChanged=(e,t)=>{this.setState({allowOverride:t||void 0})},this._onUpdate=()=>{const e=Object.assign({},this.state);e.name=e.name.trim(),e.value=e.isSecret?e.value||null:e.value,this.props.onUpdate(e)};const t=Object.assign({},e.variable);t.isDirty=!1,t.name=t.name||"",t.value=t.value||"",this.state=t,this._otherVariableNames={},this.props.allVariables.forEach((e=>{this._otherVariableNames[e.name.toLocaleLowerCase()]=!0})),this.props.variable.name&&(this._otherVariableNames[this.props.variable.name.toLocaleLowerCase()]=!1)}componentDidUpdate(e,t){super.componentDidUpdate(e,t);const i=this._isDirty();this.state.isDirty!==i&&this.setState({isDirty:i})}render(){const e=this.props.variable.isNew&&!this.props.variable.name?ce.VariableEditPanelTitleNew:ce.VariableEditPanelTitleUpdate;return l.createElement(u.CustomPanel,{ariaLabel:e,className:"pipeline-editor-variable-edit-panel",calloutClassName:"pipeline-editor-variable-edit-callout",defaultActiveElement:this.state.name?".variable-value-container input":".variable-name-container input",onDismiss:this.props.onDismiss,lightDismiss:!this.state.isDirty},l.createElement(u.PanelHeader,{backButtonProps:{onClick:this.props.onDismiss},titleProps:{text:e,size:1},onDismiss:this.props.onDismiss,showCloseButton:!1}),l.createElement(u.PanelContent,null,this._renderBody()),this._renderFooter())}_renderBody(){const e=this.props.variable.isSecret,t=e&&!this.props.variable.isNew&&!this.props.variable.isSecretDirty;let i="";const s="$("+(this.state.name||ce.VariableReferencePlaceholderName)+")",a=(this.state.name||ce.VariableReferencePlaceholderName).toLocaleUpperCase().replace(/[ \.]/g,"_");if(this._isDuplicateName()){const e=this._getDuplicateVariable();i=e?(0,o.format)(ce.VariableEditPanelIsDuplicate,e.name):""}return l.createElement("div",{className:"flex-grow"},l.createElement(F.FormItem,{className:"variable-edit-name-container",label:ce.Name,message:i,error:!!i},l.createElement(V.TextField,{value:this.state.name,disabled:t,className:"variable-name-container",required:!0,onChange:this._onNameChanged})),l.createElement(F.FormItem,{label:ce.Value},l.createElement(V.TextField,{value:this.state.value||"",className:"variable-value-container",inputType:this.state.isSecret?"password":"text",placeholder:e&&this.state.isSecret&&!this.state.value?T.VariableSecretMask:void 0,onChange:this._onValueChanged})),l.createElement(I.Checkbox,{className:"variable-edit-checkbox first-checkbox",label:ce.VariableEditPanelIsSecret,checked:this.state.isSecret,onChange:this._onIsSecretChanged,disabled:t,tooltipProps:t?{text:ce.DisabledSecretCheckboxTooltip}:void 0}),l.createElement(I.Checkbox,{className:"variable-edit-checkbox",label:ce.VariableEditPanelAllowOverride,checked:this.state.allowOverride,onChange:this._onAllowOverrideChanged}),l.createElement("div",{className:"body-m variable-help-container"},l.createElement("div",{className:"variable-help-section"},l.createElement("div",{className:"variable-reference-text"},l.createElement(f.FormatComponent,{format:ce.VariableEditPanelToReferenceText},l.createElement("span",{className:"font-weight-semibold"},ce.VariableEditPanelToReferenceText0),l.createElement("span",{className:"code-format"},s)))),l.createElement("div",{className:"variable-help-section"},l.createElement("div",null,l.createElement(f.FormatComponent,{format:ce.VariableEditPanelToUseText},l.createElement("span",{className:"font-weight-semibold"},ce.VariableEditPanelToUseText0))),l.createElement("div",null,l.createElement(f.FormatComponent,{format:ce.VariableEditPanelToUseTextMore},l.createElement("span",{className:"code-format"},"."),l.createElement("span",{className:"code-format"},"_")))),l.createElement("div",{className:"variable-help-section"},l.createElement("div",null,l.createElement(f.FormatComponent,{format:ce.VariableEditPanelToUseExBatch},l.createElement("span",{className:"code-format"},"%"+a+"%"))),l.createElement("div",null,l.createElement(f.FormatComponent,{format:ce.VariableEditPanelToUseExPowerShell},l.createElement("span",{className:"code-format"},"${env:"+a+"}"))),l.createElement("div",null,l.createElement(f.FormatComponent,{format:ce.VariableEditPanelToUseExBash},l.createElement("span",{className:"code-format"},"$("+a+")")))),this.state.isSecret&&l.createElement("div",{className:"variable-help-section"},l.createElement("div",null,l.createElement(f.FormatComponent,{format:ce.VariableEditPanelToUseSecret},l.createElement("span",{className:"font-weight-semibold"},ce.VariableEditPanelToUseSecret0))))))}_renderFooter(){return l.createElement(u.PanelFooter,{className:"flex-row flex-center",showSeparator:!0},l.createElement(D.Link,{className:"flex-grow",href:de.FwLinks.LearnMoreVariables,target:"_blank",rel:"noopener noreferrer"},ce.VariablesPanelLearnMore),l.createElement(N.ButtonGroup,{className:"flex-grow justify-end"},l.createElement(C.Button,{key:"cancel",text:ce.Cancel,onClick:this.props.onDismiss}),l.createElement(C.Button,{key:"ok",text:ce.OK,primary:!0,disabled:!this.state.isDirty||this._isEmptyName()||this._isDuplicateName(),onClick:this._onUpdate})))}_isDirty(){const e=this.props.variable||{};return this.state.name!==(e.name||"")||this.state.value!==(e.value||"")||this.state.isSecret!==e.isSecret||this.state.allowOverride!==e.allowOverride}_isEmptyName(){return!this.state.name.trim()}_isDuplicateName(){const e=this.state.name.trim().toLocaleLowerCase();return!(!e||!this._otherVariableNames[e])}_getDuplicateVariable(){const e=this.state.name.trim().toLocaleLowerCase();return this.props.allVariables.find((t=>t.name.toLocaleLowerCase()===e))}}t[e].PipelineVariableEditPanel=i}("PipelineVariableEditPanel"),function(e){Ce=t[e]={};class s extends v.VssComponent{constructor(e,t){super(e,t),this._selection=new d.ListSelection(!0),this._renderRow=(e,t,i,s)=>{const a=t.isDeleted?"Delete":t.isSecret?"Lock":"Variable",n=t.isDeleted?"Deleted":t.isSecret?T.VariableSecretMask:"= "+t.value,r=t.isDeleted?"is-deleted":t.isDirty?"font-weight-semibold":"",o=t.isDeleted?ce.VariablesPanelCommandUndoDelete:ce.VariablesPanelCommandDelete;return l.createElement(d.ListItem,{key:s||"list-item"+e,index:e,details:i,className:t.isDeleted?"deleted-variable-row":""},l.createElement("div",{className:"variable-row full-size"},l.createElement(c.Icon,{iconName:a,size:"medium",className:"variable-icon"}),l.createElement("div",{className:(0,v.css)("variable-content flex-column h-scroll-hidden flex-grow",r)},l.createElement(R.Tooltip,{overflowOnly:!0},l.createElement("span",{className:"text-ellipsis primary-text"},t.name)),l.createElement(R.Tooltip,{overflowOnly:!0},l.createElement("span",{className:"font-size text-ellipsis secondary-text"},n))),l.createElement(N.ButtonGroup,{className:"flex-noshrink justify-end bolt-list-cell-content-reveal"},!t.isDeleted&&l.createElement(L.CopyToClipboardButton,{onClickStopPropagation:!0,textToCopy:()=>"$("+t.name+")"}),l.createElement(C.Button,{key:"delete",ariaLabel:o,iconProps:{iconName:t.isDeleted?"Undo":"Delete"},tooltipProps:{text:o},subtle:!0,onClick:e=>{this._setDeleted(t,!t.isDeleted),e&&e.stopPropagation()}}))))},this._onNewFromEmptyScenario=()=>{const e=B.findDOMNode(this),t=e&&e.querySelector(".bolt-panel-focus-element");t&&t.focus&&t.focus(),this._newVariable()},this._editPanelDismissed=()=>{this.setState({isEditPanelOpen:!1,variableToEdit:void 0})},this._updateVariable=e=>{const t=this._originalVariables.find((t=>t.key===e.key));e.isDirty=this._isVariableDirty(e,t),e.isSecretDirty=this._isSecretDirty(e,t);const i=this._getIndex(e);i>-1?this._modifiedVariables.splice(i,1,e):this._modifiedVariables.splice(0,0,e),this._editPanelDismissed(),this._onVariablesUpdated()},this._rowClicked=(e,t)=>{const i=Object.assign({},t.data);i&&!i.isDeleted&&this._editVariable(i)},this._onSearchTextChanged=(e,t)=>{this._throttledSearch(t),this.setState({searchText:t})},this._newVariable=()=>{const e={key:String(this._modifiedVariables.length),name:"",value:"",isNew:!0,isDeleted:!1};this._editVariable(e)},this._editVariable=e=>{this.setState({isEditPanelOpen:!0,variableToEdit:e})},this._onDismiss=()=>{this.props.onDismiss()},this._onSave=()=>{this.props.onSave(this._getUpdatedPipelineVariables())},this._onNavigateAway=e=>{this.state.isDirty&&(0,fe.showLoseChangesDialog)(this.context.pageContext,e)},this.state={isDirty:!1,isEditPanelOpen:!1,searchText:""},this._originalVariables=this._getExistingVariables(),this._modifiedVariables=this._originalVariables.map((e=>Object.assign({},e))),this._filteredVariables=new i.ObservableArray([...this._modifiedVariables]),this._timerManagement=new A.TimerManagement,this._throttledSearch=this._timerManagement.debounce((e=>this._updateFilteredList(e)),250)}componentDidMount(){super.componentDidMount(),(0,fe.addNavigateAwayListener)(this._onNavigateAway)}componentWillUnmount(){super.componentWillUnmount(),(0,fe.removeNavigateAwayListener)(this._onNavigateAway)}render(){const e=this.state.isDirty,t=ce.VariablesPanelTitle,i=this._modifiedVariables.length||this.state.variableToEdit;return l.createElement(u.CustomPanel,{ariaLabel:t,className:"pipeline-editor-variables-panel",defaultActiveElement:i?".variables-search-input input":".empty-new-button",onDismiss:this._onDismiss,escDismiss:!e&&!this.props.isSaving,lightDismiss:!e&&!this.props.isSaving},l.createElement(u.PanelHeader,{titleProps:{text:t,size:1},onDismiss:this._onDismiss}),i?l.createElement(l.Fragment,null,l.createElement(u.PanelContent,null,this._renderBody()),this._renderFooter()):this._renderEmptyScenario())}_renderBody(){return l.createElement("div",{className:"variables-content-body flex-column flex-grow"},this.props.errorMessage&&l.createElement(P.MessageCard,{className:"error-message",severity:"Error"},this.props.errorMessage),l.createElement("div",{className:"variables-controls-container flex-row"},l.createElement(V.TextField,{value:this.state.searchText,className:"variables-search-input",containerClassName:"flex-grow",placeholder:ce.VariablesPanelSearch,ariaLabel:ce.VariablesPanelSearch,prefixIconProps:{iconName:"Search"},onChange:this._onSearchTextChanged,style:1}),l.createElement(C.Button,{iconProps:{iconName:"Add"},onClick:this._newVariable,ariaLabel:ce.VariablesPanelNewVariable,tooltipProps:{text:ce.VariablesPanelNewVariable},className:"variable-commands"})),l.createElement(d.ScrollableList,{itemProvider:this._filteredVariables,renderRow:this._renderRow,selection:this._selection,width:"100%",singleClickActivation:!0,onActivate:this._rowClicked}),this.state.isEditPanelOpen&&this.state.variableToEdit&&l.createElement(ye.PipelineVariableEditPanel,{allVariables:this._modifiedVariables,variable:this.state.variableToEdit,onDismiss:this._editPanelDismissed,onUpdate:this._updateVariable}))}_renderFooter(){const e=this.state.isDirty;return l.createElement(u.PanelFooter,{className:"flex-row flex-center",showSeparator:!0},l.createElement(D.Link,{className:"flex-grow",href:de.FwLinks.LearnMoreVariables,target:"_blank",rel:"noopener noreferrer"},ce.VariablesPanelLearnMore),l.createElement(N.ButtonGroup,{className:"flex-grow justify-end"},l.createElement(C.Button,{key:"cancel",text:e?ce.Cancel:ce.Close,disabled:this.props.isSaving,onClick:this._onDismiss}),l.createElement(C.Button,{key:"save",text:ce.SaveButtonLabel,primary:!0,disabled:this.props.isSaving||!e,onClick:this._onSave})))}_renderEmptyScenario(){return l.createElement("div",{className:"empty-variables-view flex-column flex-grow flex-self-center"},l.createElement("div",{className:"flex-column flex-grow flex-noshrink justify-center flex-center text-center"},l.createElement("div",{className:"circle flex-center flex-self-center"},l.createElement(c.Icon,{className:"empty-icon",iconName:"Variable"})),l.createElement("div",{className:"empty-text"},ce.VariablesPanelEmptyText),l.createElement(C.Button,{className:"empty-new-button",text:ce.VariablesPanelNewVariable,primary:!0,onClick:this._onNewFromEmptyScenario}),l.createElement(D.Link,{href:de.FwLinks.LearnMoreVariables,target:"_blank",rel:"noopener noreferrer"},ce.VariablesPanelLearnMore)),l.createElement("div",{className:"flex-grow no-width"}))}_setDeleted(e,t){const i=Object.assign(Object.assign({},e),{isDeleted:t}),s=this._getIndex(e);this._modifiedVariables.splice(s,1,i),this._onVariablesUpdated()}_isVariableDirty(e,t){return!t||e.name!==t.name||e.value!==t.value||e.isSecret!==t.isSecret||e.allowOverride!==t.allowOverride}_isSecretDirty(e,t){return!t||e.isSecret!==t.isSecret}_getIndex(e){return this._modifiedVariables.findIndex((t=>t.key===e.key))}_getExistingVariables(){const e=this.props.variables||{};return Object.keys(e||{}).map(((t,i)=>{const s=e[t];return{key:String(i),name:t,value:s.value,isSecret:s.isSecret,allowOverride:s.allowOverride,isDeleted:!1,isNew:!1}})).sort(((e,t)=>e.name.toLocaleLowerCase().localeCompare(t.name.toLocaleLowerCase(),navigator.language)))}_getUpdatedPipelineVariables(){const e={};return this._modifiedVariables.filter((e=>!e.isDeleted)).sort(((e,t)=>e.name.toLocaleLowerCase().localeCompare(t.name.toLocaleLowerCase(),navigator.language))).forEach((t=>e[t.name]=Object.assign({value:t.value,isSecret:t.isSecret,allowOverride:t.allowOverride}))),e}_onVariablesUpdated(){this._updateFilteredList(this.state.searchText),this._updateOverallDirtyState()}_updateFilteredList(e){e?(e=e.toLocaleLowerCase(),this._filteredVariables.value=this._modifiedVariables.filter((t=>t.name.toLocaleLowerCase().indexOf(e)>-1)).sort(((t,i)=>{const s=t.name.toLocaleLowerCase(),a=i.name.toLocaleLowerCase();return(s===e?0:s.startsWith(e)?1:2)-(a===e?0:a.startsWith(e)?1:2)}))):this._filteredVariables.value=[...this._modifiedVariables]}_updateOverallDirtyState(){const e=!!this._modifiedVariables.find((e=>e.isNew?!e.isDeleted:e.isDirty||e.isDeleted));this.state.isDirty!==e&&this.setState({isDirty:e})}}t[e].PipelineVariablesPanel=s}("PipelineVariablesPanel"),function(e){var i;Ee=t[e]={},function(e){e.DefaultBranch="DefaultBranch",e.NewBranch="NewBranch"}(i||(i={}));class s extends v.VssComponent{constructor(e,t){super(e,t),this._maxGitRefNameLength=400,this._invalidRefNameStrings=["~","^",":"," ","?","*","[","\\","/.",".lock/","//","..","@{"],this._invalidLeadNameStrings=["/","."],this._invalidTrailNameStrings=[".lock",".","/"],this._commitInputId="commitInputId",this._handleSaveAnywayButton=()=>{this.setState({saveAnywayClicked:!this.state.saveAnywayClicked})},this._renderValidateAndSaveFooter=()=>{const e=this.props.saveAndRun?ce.SaveAndRunButtonLabel:ce.SaveButtonLabel,t=!(this.props.isSaving||this.props.isRunning)&&this.state.fetchedValidationErrors;var i={className:"primary-action-button",disabled:!this._isValidInput(),onClick:this._onSaveClick,primary:!0,text:e};this.state.validationErrors.length>0&&!this.state.saveAnywayClicked&&(i={className:"primary-action-button",disabled:!this._isValidInput(),onClick:this._handleSaveAnywayButton,text:ce.SaveAnyway});var s={onClick:this.props.onDismiss,text:ce.Cancel};this.state.validationErrors.length>0&&this.state.saveAnywayClicked&&(s={onClick:this._handleSaveAnywayButton,text:ce.ReviewErrors});const a=t?this.props.showCancelButton?[s,i]:[i]:void 0,n=ce.SavingChanges;return l.createElement(u.PanelFooter,{buttonProps:a},!t&&this.props.isSaving&&l.createElement("div",{className:"ci-designer-save-panel-footer flex-row justify-end"},l.createElement(g.Spinner,{className:"loading-indicator",orientation:0,label:n})))},this._renderSaveFooter=()=>{const e=this.props.saveAndRun?ce.SaveAndRunButtonLabel:ce.SaveButtonLabel,t=!(this.props.isSaving||this.props.isRunning),i={className:"primary-action-button",disabled:!this._isValidInput(),onClick:this._onSaveClick,primary:!0,text:e},s={onClick:this.props.onDismiss,text:ce.Cancel},a=t?this.props.showCancelButton?[s,i]:[i]:void 0,n=this.props.isSaving?ce.SavingChanges:ce.CreatingPipeline;return l.createElement(u.PanelFooter,{buttonProps:a},!t&&l.createElement("div",{className:"ci-designer-save-panel-footer flex-row justify-end"},l.createElement(g.Spinner,{className:"loading-indicator",orientation:0,label:n})))},this._checkMessage=()=>{0===this.state.message.length&&this.setState({message:ce.SavePanelCommitMessage})},this._setMessage=(e,t)=>{this.setState({message:t})},this._setDescription=(e,t)=>{this.setState({description:t})},this._checkNewBranchName=()=>{0===this.state.newBranchName.length&&this.setState({newBranchName:ce.SavePanelNewBranchName})},this._setNewBranchName=(e,t)=>{this.setState({newBranchName:t,newBranchNameErrorMessage:this._getBranchNameValidationError(t)})},this._onCommitToOptionSelect=e=>{this.setState({createNewBranch:e===i.NewBranch})},this._onCreatePullRequestToggle=()=>{this.setState({createPullRequest:!this.state.createPullRequest})},this._onSaveClick=()=>{this.props.onSave({description:this.state.description.trim(),createNewBranch:this.state.createNewBranch,message:this.state.message.trim(),newBranchName:this.state.createNewBranch?this.state.newBranchName.trim():"",createPullRequest:this.state.createNewBranch&&this.props.canCreatePr&&this.state.createPullRequest})},this.state={message:this.props.commitMessage||ce.SavePanelCommitMessage,description:"",createNewBranch:!1,newBranchName:ce.SavePanelNewBranchName,newBranchNameErrorMessage:"",createPullRequest:!0,validationErrors:[],fetchedValidationErrors:!1,saveAnywayClicked:!1}}componentDidMount(){var e={};this.props.isValidateAndSave&&this.props.onValidate?this.props.onValidate().then((t=>{var i=t.errors?t.errors.split("\n"):[];this.setState({fetchedValidationErrors:!0,validationErrors:i}),e[a]=!0,e[n]=i.length}),(()=>{e[a]=!1})).finally((()=>{this._publishTelemetry(c.ValidateAndSave,e)})):this._publishTelemetry(c.SaveWithoutValidation)}componentDidUpdate(e,t,i){super.componentDidUpdate(e,t,i),e.defaultBranch&&e.defaultBranch!==this.props.defaultBranch&&this.setState({createNewBranch:!1,newBranchNameErrorMessage:this._getBranchNameValidationError(this.state.newBranchName)})}render(){const e=this.props.saveAndRun?ce.SavePanelTitleSaveAndRun:this.props.isValidateAndSave?ce.SavePanelTitleValidateAndSave:ce.SavePanelTitleSave,t=this.props.filesAdded&&this.props.filesAdded.length>1?"":(0,o.format)(this.props.isValidateAndSave?ce.ValidateAndSavePanelDescription:ce.SavePanelDescription,this.props.fileName);return l.createElement("div",null,this.props.isOpen&&l.createElement(u.CustomPanel,{ariaLabel:e,size:1,onDismiss:this.props.onDismiss,lightDismiss:!this.props.isSaving,defaultActiveElement:(0,m.getSafeIdSelector)(this._commitInputId)},l.createElement(u.PanelHeader,{titleProps:{text:e,size:1},description:t,onDismiss:this.props.onDismiss}),l.createElement(u.PanelContent,null,this.props.isValidateAndSave?this._renderValidateAndSaveBody():this._renderSaveBody()),this.props.isValidateAndSave?this._renderValidateAndSaveFooter():this._renderSaveFooter()))}_renderCommitInputFields(){const e=this.props.isSaving||this.props.isRunning,t=this._normalizeBranchName(this.props.defaultBranch),s=(0,o.format)(ce.SavePanelCommitToDefault,t),a=ce.SavePanelCommitToNewBranch,n=(0,o.format)(ce.SavePanelNewBranchMessage,t);return l.createElement(l.Fragment,null,l.createElement(V.TextField,{className:"commit-message section-content",inputId:this._commitInputId,label:ce.CommitMessage,disabled:e,value:this.state.message,onBlur:this._checkMessage,onChange:this._setMessage}),l.createElement(V.TextField,{className:"commit-description section-content",label:ce.OptionalExtendedDescription,ariaLabel:ce.OptionalExtendedDescription,disabled:e,placeholder:ce.SavePanelCommitDescriptionPlaceholder,value:this.state.description,multiline:!0,rows:6,resizable:!1,onChange:this._setDescription}),this.props.filesAdded&&this.props.filesAdded.length>1&&l.createElement(ue.FileList,{files:this.props.filesAdded}),l.createElement(k.RadioButtonGroup,{className:"commit-to",selectedButtonId:this.state.createNewBranch?i.NewBranch:i.DefaultBranch,onSelect:this._onCommitToOptionSelect},[l.createElement(k.RadioButton,{id:i.DefaultBranch,key:i.DefaultBranch,text:s,disabled:e}),l.createElement(k.RadioButton,{id:i.NewBranch,key:i.NewBranch,text:a,disabled:e})]),this.state.createNewBranch&&l.createElement("div",{className:"commit-new-branch"},l.createElement(F.FormItem,{message:this.state.newBranchNameErrorMessage||n,error:!!this.state.newBranchNameErrorMessage},l.createElement(V.TextField,{disabled:e||!this.state.createNewBranch,value:this.state.newBranchName,onBlur:this._checkNewBranchName,onChange:this._setNewBranchName})),this.props.canCreatePr&&l.createElement(I.Checkbox,{className:"margin-top-8",disabled:e||!this.state.createNewBranch,label:ce.SavePanelCreatePullRequest,checked:this.state.createPullRequest,onChange:this._onCreatePullRequestToggle})))}_renderValidationResult(){const e=this.props.isValidateAndSave&&this.state.fetchedValidationErrors&&this.state.validationErrors.length>0,t=e?p.Statuses.Failed:p.Statuses.Success;return l.createElement("div",{className:"ci-designer-save-panel-body"},l.createElement("label",{className:"bolt-textfield-label"},ce.ValidateAndSavePanelValidationLabel),l.createElement("div",{className:"section-content flex-row flex-center margin-top-8"},l.createElement(p.Status,Object.assign({},t,{key:e?"failed":"success",size:"16",className:"icon-margin"})),e?ce.ValidationResultErrorsDetected:ce.ValidationResultSuccess+"."))}_renderValidateAndSaveBody(){return this.state.fetchedValidationErrors?this.state.validationErrors.length>0&&!this.state.saveAnywayClicked?l.createElement("div",{className:"ci-designer-save-panel-body flex-grow"},l.createElement("label",{className:"bolt-textfield-label secondary-text"},ce.ValidationResultErrorsDetectedLabel),l.createElement("div",{className:"section-content padding-top-8"},l.createElement(ge.ValidationErrors,{errors:this.state.validationErrors}))):l.createElement("div",{className:"ci-designer-save-panel-body flex-grow"},this.props.errorMessage&&l.createElement(P.MessageCard,{className:"error-message",severity:"Error"},this.props.errorMessage),this._renderValidationResult(),this._renderCommitInputFields()):l.createElement("div",{className:"ci-designer-save-panel-body full-size full-width"},l.createElement(g.Spinner,{label:ce.ValidateSpinnerLabel,orientation:1,className:"flex-self-center full-width"}))}_renderSaveBody(){return l.createElement("div",{className:"ci-designer-save-panel-body flex-grow"},this.props.errorMessage&&l.createElement(P.MessageCard,{className:"error-message",severity:"Error"},this.props.errorMessage),this._renderCommitInputFields())}_normalizeBranchName(e){const t="refs/heads/";return e&&e.startsWith(t)?e.substring(11):e}_isValidInput(){return this.state.message.length>0&&!(this.state.createNewBranch&&(!this.state.newBranchName||this.state.newBranchNameErrorMessage))}_getBranchNameValidationError(e){if(!e||0===e.length)return"";if(("refs/heads/"+e).length>this._maxGitRefNameLength)return(0,o.format)(ce.BranchNameErrorTooLong,this._maxGitRefNameLength);const t=this._normalizeBranchName(this.props.defaultBranch);if((0,o.equals)(e,t,!0))return ce.BranchNameErrorSameAsTarget;let i=null;return this._invalidRefNameStrings.some((t=>e.indexOf(t)>-1&&(i=t,!0))),i?(0,o.format)(ce.BranchNameErrorInvalidCharacter,i):(this._invalidLeadNameStrings.some((t=>0===e.lastIndexOf(t,0)&&(i=t,!0))),i?(0,o.format)(ce.BranchNameErrorInvalidLeadCharacter,i):(this._invalidTrailNameStrings.some((t=>{const s=e.length-t.length;return s>=0&&e.indexOf(t,s)===s&&(i=t,!0)})),i?(0,o.format)(ce.BranchNameErrorInvalidTrailCharacter,i):""))}_publishTelemetry(e,t={}){const i=this.context.pageContext.getService("IVssTelemetryService");void 0!==this.props.definitionId&&(t[r]=this.props.definitionId),i.publishEvent("Build",e,t)}}t[e].SavePanel=s;const a="IsValidationSuccessful",n="ValidationErrorCount",r="DefinitionId";var c;!function(e){e.SaveWithoutValidation="SaveWithoutValidation",e.ValidateAndSave="ValidateAndSave"}(c||(c={}))}("SavePanel"),function(e){Pe=t[e]={};class i extends v.VssComponent{constructor(e,t){super(e,t),this._disposables=[],this._onEditorCreated=e=>{if(e){this._editor=e,this._disposables.push(this._editor);const t=this._editor;(0,w.isFeatureFlagEnabled)(this.context.pageContext,"Build2.ImproveYamlAutocompletion",!1)?t.addCommand(monaco.KeyCode.Enter,(()=>{e.trigger("keyboard","type",{text:"\n"}),e.trigger("","jumpToNextSnippetPlaceholder",{})}),"hasNextTabstop && inSnippetMode && textInputFocus"):t.addCommand(monaco.KeyCode.Enter,(()=>{e.trigger("keyboard","type",{text:"\n"}),e.trigger("","editor.action.triggerSuggest",{})}),"!suggestWidgetVisible && !markersNavigationVisible && !parameterHintsVisible && !findWidgetVisible"),this.props.onEditorCreated&&this.props.onEditorCreated(e);this.context.pageContext.getService("IVssContributionService").getService("ms.vss-build-web.language-editor-service").then((e=>{e.initializeEditor(t,this.props.codeLensOptions),t.layout()})),this.setState({isEditorLoaded:!0})}},this._onResizeHandler=()=>{this._editor&&this._editor.layout()},this._onThemeChanged=()=>{const e=this._getEditorTheme();this.setState({monacoTheme:e})},this.state={isEditorLoaded:!1,monacoTheme:this._getEditorTheme()}}render(){return l.createElement(l.Fragment,null,this.props.spinnerMessage?this._getSpinner(this.props.spinnerMessage):l.createElement(l.Fragment,null,l.createElement(s,{content:this.props.content,errorMessage:this.props.errorMessage,isReadOnly:this.props.isReadOnly,elementToFocusOnEscape:this.props.elementToFocusOnEscape,monacoTheme:this.state.monacoTheme,onEditorContentUpdated:this.props.onEditorContentUpdated,onEditorCreated:this._onEditorCreated}),!this.state.isEditorLoaded&&this._getSpinner(ce.LoadingEditor)))}componentDidMount(){window.addEventListener("resize",this._onResizeHandler),this._themeService.subscribe(this._onThemeChanged,"themeChanged")}componentWillUnmount(){window.removeEventListener("resize",this._onResizeHandler),this._themeService.unsubscribe(this._onThemeChanged,"themeChanged"),this._editor&&(this.props.onEditorDisposing&&this.props.onEditorDisposing(this._editor),this._disposables.forEach((e=>e.dispose())),this._editor=void 0)}componentDidUpdate(e,t,i){super.componentDidUpdate(e,t,i),this._editor&&this.props.sidePanelIsOpen!==e.sidePanelIsOpen&&(this._editor.updateOptions({minimap:{enabled:!this.props.sidePanelIsOpen}}),this._editor.layout())}_getSpinner(e){return l.createElement(g.Spinner,{className:"absolute-fill",size:"large",label:e})}_getEditorTheme(){const e=this._themeService.getCurrentTheme();return e&&e.isDark?"vs-dark":"vs"}get _themeService(){return this.context.pageContext.getService("IVssThemeService")}}t[e].YamlEditor=i;class s extends l.PureComponent{constructor(e){super(e),this._editorOptions=Object.assign(Object.assign({fontSize:14,lineNumbersMinChars:8,readOnly:this.props.isReadOnly,renderWhitespace:"all",fixedOverflowWidgets:!0,quickSuggestions:{comments:!1,strings:!0,other:!0},quickSuggestionsDelay:200,suggestOnTriggerCharacters:!0},{wordBasedSuggestions:!1}),{minimap:{enabled:!1}})}render(){const e=Object.assign(Object.assign({},this._editorOptions),{readOnly:this.props.isReadOnly});return l.createElement(v.WrappedComponent,{dependencies:["ms.vss-features.editor"],wrappedType:"code-editor",wrappedProps:{className:"ci-editor-host"+(this.props.errorMessage?" ci-show-error":""),monacoTheme:this.props.monacoTheme,editorOptions:e,elementToFocusOnEscape:this.props.elementToFocusOnEscape,editorRef:this.props.onEditorCreated,onContentUpdated:this.props.onEditorContentUpdated,content:{content:this.props.content,contentType:"application/x-yaml"}}})}}}("YamlEditor"),function(e){function i(){const e=document.querySelector("."+de.EditorConstants.YamlAssistantToggleElement);e&&e.focus&&!e.hasAttribute("disabled")&&!e.classList.contains("disabled")&&"hidden"!==e.style.visibility&&"none"!==e.style.display&&e.focus()}we=t[e]={},t[e].focusYamlAssistantButton=i;class s extends l.Component{render(){const e=this.props,t=e.sidePanelIsOpen;return l.createElement("div",{className:"ci-yaml-editor-header flex-row absolute-fill"},this.props.fileName&&l.createElement(l.Fragment,null,this._getBranchPicker(),l.createElement("div",{className:"subheader-items flex-row flex-grow scroll-hidden"},this._getRepository(),l.createElement(a,{fileName:e.fileName,fileUrl:e.fileUrl,supportsFPS:e.supportFPS,isYamlDirty:e.isYamlDirty,onFileNameChanged:e.onFileNameChanged})),!t&&l.createElement(U.HeaderCommandBar,{items:[{id:"show-hide-tasks",className:(0,v.css)("show-yaml-side-panel-button",de.EditorConstants.YamlAssistantToggleElement),text:t?"":ce.SidePanelOpen,onActivate:e.onSidePanelButtonClick,important:!0,iconProps:{iconName:t?"ClosePane":"OpenPane"},subtle:!0}]})))}_getBranchPicker(){const e=this.props.definition&&this.props.definition.repository;if(e)return l.createElement(M.BranchDropdown,{className:"branch-picker",ariaLabel:ce.Branch,repositoryType:e.type,repositoryId:e.id,defaultBranch:this.props.branchName,connectionId:e.properties&&e.properties.connectedServiceId,isDrodownFullWidth:!1,comboBoxMinWidth:120,comboBoxMaxWidth:350,onBranchSelected:this.props.onBranchSelected,onError:this.props.onBranchPickerError})}_getRepository(){return l.createElement(l.Fragment,null,l.createElement("div",{className:"subheader-item ci-hover-behavior flex-row flex-center"},this.props.repositoryIconName&&l.createElement(Y.VssIcon,{iconName:this.props.repositoryIconName}),l.createElement(R.Tooltip,{text:this.props.repositoryName,overflowOnly:!0},this.props.repositoryUrl?l.createElement(b.FPSLink,{className:"repository-name text-ellipsis",supportsFPS:this.props.supportFPS,href:this.props.repositoryUrl},this.props.repositoryName):l.createElement("span",{className:"repository-name text-ellipsis"},this.props.repositoryName))),l.createElement("div",{className:"flex-row flex-center"},l.createElement("span",{className:"separator"},"/")))}}t[e].YamlEditorHeader=s;class a extends l.Component{constructor(e){super(e),this._textField=l.createRef(),this._textDiv=l.createRef(),this._editModeOn=()=>{this.setState({isEditMode:!0},(()=>{this._textField.current&&this._textField.current.select()}))},this._editModeOff=(e,t)=>{const i=e?void 0:this.state.errorMessage,s=e?this.props.fileName:this._cleanupFileName(this.state.fileName);i||this.setState({fileName:s,errorMessage:i,isEditMode:!1},(()=>{this.props.onFileNameChanged&&s!==this.props.fileName&&this.props.onFileNameChanged(s),t&&t()}))},this._onKeyDown=e=>{if(13===e.which||27===e.which){e.preventDefault(),e.stopPropagation();const t=27===e.which;this._editModeOff(t,i)}},this._onFilePathChanged=(e,t)=>{const i=(0,pe.getInvalidFileNameMessage)(t);this.setState({fileName:t,errorMessage:i})},this.state={isEditMode:!1,fileName:e.fileName}}render(){return l.createElement(l.Fragment,null,this.state.isEditMode?this._renderFilePathTextField():this._renderFilePath())}_renderFilePathTextField(){return l.createElement("div",{ref:this._textDiv,className:"flex-grow"},l.createElement(F.FormItem,{error:!!this.state.errorMessage,className:"flex-grow"},l.createElement(V.TextField,{containerClassName:"file-path-text flex-grow",className:"editable-file-path",value:this.state.fileName,autoFocus:!0,ref:this._textField,onChange:this._onFilePathChanged,onKeyDown:this._onKeyDown,onBlur:this._editModeOff})),this.state.errorMessage&&l.createElement(O.Callout,{contentShadow:!0,anchorElement:this._textDiv.current,anchorOrigin:{horizontal:"start",vertical:"end"},calloutOrigin:{horizontal:"start",vertical:"start"},anchorOffset:{horizontal:8,vertical:4}},l.createElement("div",{className:"file-path-error"},this.state.errorMessage)))}_renderFilePath(){let e=this.props.fileName;e=e.replace(/\\/g,"/"),e=e.startsWith("./")?e.substr(2):e,e=e.startsWith("/")?e.substr(1):e;const t=this.props.isYamlDirty?" *":"",i=e.lastIndexOf("/"),s=i>0?e.substr(0,i):"",a=(i>0?e.substr(i+1):e)+t,n=!!this.props.onFileNameChanged;return l.createElement(R.Tooltip,{text:n?ce.Rename:void 0},l.createElement("div",Object.assign({className:(0,v.css)("editable-path-container flex-center flex-row text-ellipsis",n&&"editable")},n?{tabIndex:0,onClick:this._editModeOn,onFocus:this._editModeOn}:{}),s&&l.createElement(l.Fragment,null,l.createElement("div",{className:"file-path flex-row flex-center"},l.createElement(R.Tooltip,{text:e,overflowOnly:!0},l.createElement("span",{className:"text-ellipsis white-space-pre"},s))),l.createElement("div",{className:"flex-row flex-center"},"/")),l.createElement("div",{className:"subheader-item ci-hover-behavior flex-row flex-center"},l.createElement(R.Tooltip,{text:e,overflowOnly:!0},l.createElement(l.Fragment,null,this.props.fileUrl?l.createElement(b.FPSLink,{className:"file-name text-ellipsis",supportsFPS:this.props.supportsFPS,href:this.props.fileUrl},a):l.createElement("span",{className:"file-name text-ellipsis"},a),n&&l.createElement(c.Icon,{className:"rename-icon",iconName:"Rename",size:"medium"}))))))}_cleanupFileName(e){return e=(0,pe.trimFilePath)(e),e=(0,pe.trimLeadingSlashes)(e),(0,pe.ensureYamlExtension)(e)}}}("YamlEditorHeader"),function(e){_e=t[e]={};const i=["ms.vss-build-web.designer-extensions.yaml-assistant","ms.vss-build-web.yaml-assistant-data-provider"];class s extends v.VssComponent{constructor(){super(...arguments),this._onYamlGenerated=e=>{let t="";e.eventType,t=ce.AddedSnippet,this._insertText(e.yamlString,t)},this._insertText=(e,t)=>{e.endsWith("\r\n")&&(e=e.slice(0,-2));const i=e.split("\r\n"),s=this.props.editor.getSelection(),a=i.length,n=i[a-1].length+1,r=this.props.editor.getModel().getLineContent(s.startLineNumber);s.startColumn===s.endColumn&&s.startLineNumber===s.endLineNumber?/\S/.test(r)?this._moveCursorToEndOfLineAndInsert(e,t,s,a,n):this._insertWhilePreservingTabDepth(e,i,t,r,s,a,n):s.startLineNumber!==s.endLineNumber&&1===s.startColumn&&r.indexOf(i[0])>=0?this._replaceTask(e,i,t,r,s,n):this._replaceCurrentlySelectedText(e,t,s,a,n)}}componentDidUpdate(e,t){if(super.componentDidUpdate(e,t),this.props.editor&&!this._yamlAssistantDependenciesPromise){const e=this.context.pageContext.getService("IVssContributionService");this._yamlAssistantDependenciesPromise=e.getContributionsAsync(i)}}render(){return this.props.isOpen&&this.props.editor?l.createElement("div",{className:(0,m.css)("flex-noshrink flex-column yaml-side-panel",!this.props.isOpen&&"hidden")},l.createElement(v.WrappedComponent,{dependencies:i,wrappedType:"yaml-assistant-view",wrappedProps:{onYamlGenerated:this._onYamlGenerated,onDismiss:this.props.onDismiss}})):null}_moveCursorToEndOfLineAndInsert(e,t,i,s,a){const n=this.props.editor.getModel().getLineMaxColumn(i.startLineNumber);e="\r\n"+e;const r=this._createRange(i.startLineNumber,n,i.startLineNumber,n),o=this._createSelection(i.startLineNumber+1,1,i.startLineNumber+s,a+1);this._insertTextToMonaco(e,t,r,o)}_insertWhilePreservingTabDepth(e,t,i,s,a,n,r){const o=this.props.editor.getModel().getLineMaxColumn(a.startLineNumber),l=s.substr(0,a.startColumn-1);e=t.join("\r\n"+l);const c=this._createRange(a.startLineNumber,a.startColumn,a.endLineNumber,o),d=this._createSelection(a.startLineNumber,1,a.startLineNumber+n-1,r+l.length+1);this._insertTextToMonaco(e,i,c,d)}_replaceTask(e,t,i,s,a,n){const r=s.trim(),o=s.substr(0,s.indexOf(r[0]));e=o+t.slice(1).join("\r\n"+o);let l=-1,c=-1;const d=this.props.editor.getModel(),h=o+"  ";for(let e=a.startLineNumber;e<=a.endLineNumber;++e)if(d.getLineContent(e)===h+"inputs:")l=e;else if(l>0){const t=d.getLineContent(e),i=t.trim();if(t.substr(0,t.indexOf(i[0]))===h){c=e-1;break}}if(-1===c&&-1===l){""!=e&&(e+="\r\n");const s=this._createRange(a.startLineNumber+1,1,a.startLineNumber+1,1),n=9999,r=this._createSelection(a.startLineNumber,a.startColumn,a.startLineNumber+t.length-1,n);this._insertTextToMonaco(e,i,s,r)}else{-1===l&&(l=a.startLineNumber),-1===c&&(c=a.endLineNumber);const s=this._createRange(l,1,c,d.getLineMaxColumn(c)),n=t.length-1-(c-l+1),r=a.endLineNumber-a.startLineNumber+1,o=9999,h=this._createSelection(a.startLineNumber,a.startColumn,a.startLineNumber+r+n-1,o);this._insertTextToMonaco(e,i,s,h)}}_replaceCurrentlySelectedText(e,t,i,s,a){const n=this._createRange(i.startLineNumber,i.startColumn,i.endLineNumber,i.endColumn),r=this._createSelection(i.startLineNumber,i.startColumn,i.startLineNumber+s-1,a+1);this._insertTextToMonaco(e,t,n,r)}_insertTextToMonaco(e,t,i,s){const a={identifier:{major:1,minor:1},range:i,text:e,forceMoveMarkers:!0};this.props.editor.executeEdits(t,[a],[s]),this.props.editor.focus(),this._sendToast(t)}_sendToast(e){const t=this.context&&this.context.pageContext.getService("IGlobalMessagesService");t&&t.addToast({message:e,duration:2e3})}_createRange(e,t,i,s){return new monaco.Range(e,t,i,s)}_createSelection(e,t,i,s){return new monaco.Selection(e,t,i,s)}}t[e].YamlSidePanel=s}("YamlSidePanel"),function(e){xe=t[e]={};class i extends v.VssComponent{constructor(e,t){super(e,t),this._onEditorContentUpdated=e=>{if(e&&this.props.onContentUpdated){const t=e.getValue()||"";this.props.onContentUpdated(t)}},this._onSidePanelButtonClick=()=>{this.setState((e=>({sidePanelIsOpen:!e.sidePanelIsOpen})),(()=>{(0,we.focusYamlAssistantButton)()}))},this._openSidePanel=()=>{this.state.sidePanelIsOpen||this.setState({sidePanelIsOpen:!0})},this.state={sidePanelIsOpen:e.sidePanelInitiallyOpen}}render(){const e=this.props;return l.createElement("div",{className:"ci-yaml-editor-tab flex-grow flex-row"},l.createElement("div",{className:"flex-row absolute-fill"},l.createElement("div",{className:"flex-column flex-grow relative"},l.createElement("div",{className:"ci-yaml-header-container relative"},l.createElement(we.YamlEditorHeader,{branchName:e.branchName,definition:e.definition,fileName:e.fileName,fileUrl:e.fileUrl,repositoryIconName:e.repositoryIconName,repositoryName:e.repositoryName,repositoryUrl:e.repositoryUrl,supportFPS:e.supportFPS,sidePanelIsOpen:this.state.sidePanelIsOpen,isYamlDirty:e.isYamlDirty,onBranchSelected:e.onBranchSelected,onBranchPickerError:e.onBranchPickerError,onSidePanelButtonClick:this._onSidePanelButtonClick,onFileNameChanged:this.props.onFileNameChanged})),l.createElement("div",{className:"relative flex-grow"},l.createElement("div",{className:"absolute-fill"},l.createElement(Pe.YamlEditor,{content:e.content,spinnerMessage:e.spinnerMessage,errorMessage:"",isReadOnly:!1,elementToFocusOnEscape:"."+de.EditorConstants.ElementToFocusOnEscape,onEditorContentUpdated:this._onEditorContentUpdated,onEditorCreated:e.onEditorCreated,onEditorDisposing:e.onEditorDisposing,sidePanelIsOpen:this.state.sidePanelIsOpen,codeLensOptions:{onEditTask:this._openSidePanel}})))),l.createElement(_e.YamlSidePanel,{editor:e.editor,isOpen:this.state.sidePanelIsOpen,onDismiss:this._onSidePanelButtonClick})))}}t[e].YamlTab=i}("YamlTab"),function(){t.EditorView={};class e extends v.VssComponent{constructor(e,t){super(e,t),this._ttiRecorded=!1,this._lastCleanContent="",this._authorizeAfterSave=!1,this._onNavigateAway=e=>{(this.state.isYamlDirty||this.state.isPipelineSaving)&&(0,fe.showLoseChangesDialog)(this.context.pageContext,e)},this._clearBuildMessage=()=>{this.state.buildMessageInfo&&this.setState({buildMessageInfo:void 0},this._resizeEditor)},this._clearErrorMessage=()=>{this.state.errorMessage&&this.setState({errorMessage:"",errorActions:void 0},this._resizeEditor)},this._closeConnectionCard=()=>{this.setState({useAppConnectionAction:void 0},this._resizeEditor)},this._switchToAppConnection=async e=>{const t=this.state.definition;t.repository.properties=t.repository.properties||[],t.repository.properties.connectedServiceId=e,this._closeConnectionCard(),this.setState({isPipelineSaving:!0,settingsErrorMessage:""});try{await this.pipelineService.savePipeline(t);const e=this.context.pageContext.getService("IVssContributionService");await e.getDataAsync("ms.vss-build-web.pipeline-edit-continuation-data-provider",{complete:!0},!0),this.setState({definition:t,isPipelineSaving:!1},this._closeConnectionCard);this.context.pageContext.getService("IVssTelemetryService").publishEvent("Build","Editor.AppConnectionUpgradeFromOAuth",{GitHubApp:"AddAppConnection",GitHubAppRepo:t.repository.id,action:"ChangeConnectionToGitHubApp"}),this.state.connection.autoUpgradeToAppConnection||this.globalMessageService.addToast({message:T.ConnectionChanged,duration:de.EditorConstants.ToastDuration})}catch(e){const t=e&&e.message||T.SavePipelineErrorMessage;this._handleSettingsError(t)}},this._installApp=async(e,t,i,s)=>{this.context.pageContext.getService("IInstallAppService").installAppForEdit(e,t,i,s)},this._onEditorCreated=e=>{e&&(this._editor=e,e.focus(),this.setState({isEditorReady:!0}),this._markTimeToInteractive())},this._onEditorDisposing=e=>{let t="";e&&(t=e.getValue()||""),this._editor=null,this.setState({yamlContent:t,isEditorReady:!1})},this._resizeEditor=()=>{this._editor&&this._editor.layout()},this._onYamlContentUpdated=e=>{this.state.yamlContent!==e&&this.setState({yamlContent:e,isYamlDirty:e!==this._lastCleanContent})},this._showSavePanel=()=>{const e=this._editor&&this._editor.getValue()||this.state.yamlContent||"";this.setState({yamlContent:e,savePanelIsOpen:!0,isYamlSaving:!1})},this._onYamlSave=e=>{if(this.state.definition){this.setState({isYamlSaving:!0,saveErrorMessage:""});const t=this.state.definition,i={connectionId:this.state.connection.connectionId,id:t.repository.id,sourceProviderType:t.repository.type};this.yamlFileService.commitFile(i,this.state.yamlBranch,t.process.yamlFilename,this.state.yamlContent,e,this.state.yamlFileObjectId).then((e=>{this._lastCleanContent=this.state.yamlContent;const t=this._authorizeAfterSave?this._authorizeAndRun:void 0;this.setState({isYamlDirty:!1,isYamlSaving:!1,yamlBranch:e.branch,yamlFileObjectId:e.objectId,yamlFileUrl:e.url},(()=>{this._dismissSavePanel(),this._updateUrl(),t&&t()}))}),(e=>{this._handleYamlSaveError(e.message)})).then((()=>{this._checkForHostedMac()}))}},this._dismissSavePanel=()=>{this.state.isYamlSaving||(this._authorizeAfterSave=!1,this.setState({saveErrorMessage:"",savePanelIsOpen:!1}))},this._showRunPanel=()=>{this.setState({runPanelIsOpen:!0})},this._runBuild=()=>{this.state.definition&&(this._onRunBuild(),this._onBuildQueuing(),this.pipelineService.runPipeline(this.state.definition,this.state.yamlBranch).then(this._onBuildQueued,(e=>{this._handleRunBuildError(e)})))},this._runBuildWithParameters=()=>{if(!this.state.definition)return;this._onRunBuild();const e=this.state.definition;this.layoutManager.renderCallout((t=>{this._onQueueDialogDismiss=t;const i={definition:e,repository:e.repository,processType:e.process.type,pageContext:this.context.pageContext,project:e.project.id,source:"yamlEditor",onSuccess:this._onBuildQueued,onClosed:this._onQueueBuildDialogClosed,definitionVariables:e.variables,queue:e.queue,defaultSourceBranch:this.state.yamlBranch,onDismiss:t};return l.createElement(z.CommandComponent,Object.assign({commandType:"ciQueueBuildComponent"},i),null)}))},this._fullYaml=async()=>{if(!this.state.definition)return;const e=this.state.definition.name.concat(".yml");try{const t=await this._getYaml(this.state.definition);this._downloadFile(e,t.finalYaml)}catch(t){this.setState({validationDialogOpen:!0,validationDialogMessage:t.message}),this._downloadFile(e,t.message)}},this._validateYaml=async()=>{if(this.state.definition)try{await this._getYaml(this.state.definition),this.setState({validationDialogOpen:!0,validationDialogMessage:ce.OK})}catch(e){this.setState({validationDialogOpen:!0,validationDialogMessage:e.message})}},this._getYaml=async e=>{const t={stagesToSkip:void 0,resources:{pipelines:{},repositories:{self:{refName:this.state.yamlBranch}},builds:{},containers:{},packages:{}},templateParameters:{},variables:e.variables,previewRun:!0,yamlOverride:this.state.yamlContent};return this.context.pageContext.getRestClient("IPipelinesRestClient").runPipeline(t,e.project.id,e.id)},this._onBuildQueued=e=>{if(e){const t={id:e.id,number:e.buildNumber};this.setState({buildMessageInfo:t,isBuildRunning:!1},this._resizeEditor)}else this._handleRunBuildError()},this._onQueueBuildDialogClosed=()=>{if(this._onQueueDialogDismiss){const e=this._onQueueDialogDismiss;this._onQueueDialogDismiss=void 0,e()}this.state.isBuildRunning&&this.setState({isBuildRunning:!1})},this._onRunPanelClosed=()=>{this.setState({runPanelIsOpen:!1})},this._autoAuthorizeResources=()=>this.context.pageContext.getService("IPipelineResourcesService").autoAuthorizeResources(this.state.definition.id,this.state.yamlBranch).then((e=>{}),(e=>{console.warn("YAML editor: Error while auto-authorizing resources: "+e&&e.message)})),this._authorizeAndRun=()=>{this._clearErrorMessage(),this.state.isYamlDirty?(this._authorizeAfterSave=!0,this._showSavePanel()):this._autoAuthorizeResources().then((()=>this._runBuild()))},this._showPipelineSettingsPanel=()=>{this.setState({settingsPanelIsOpen:!0})},this._onSavePipelineSettings=e=>{if(!e||!Object.keys(e).length)return;let t=!1;const i=[],s=Object.assign({},this.state.definition);if(this.setState({isPipelineSaving:!0,settingsErrorMessage:""}),void 0!==e.status)switch(s.queueStatus=e.status,e.status){case 2:i.push(T.SavePipelineCommentDisable);break;case 0:i.push(T.SavePipelineCommentEnable);break;case 1:i.push(T.SavePipelineCommentPause);break;default:i.push(T.SavePipelineCommentUnknownStatus)}if(void 0!==e.yamlFilePath){t=!0;const a=Object.assign({},s.process);a.yamlFilename=e.yamlFilePath,s.process=a,i.push((0,o.format)(T.SavePipelineCommentYamlFile,e.yamlFilePath))}if(void 0!==e.witLinkingEnabled||e.witLinkingBranchFilter){s.options||(s.options=[]);let t=s.options.filter((e=>(0,o.equals)(e.definition.id,j.BuildOptionGUIDs.WitLinkingOptionGUID)))[0];e.witLinkingBranchFilter&&(i.push((0,o.format)(T.SavePipelineCommentUpdateAutoLinkBranch,e.witLinkingBranchFilter)),t?t.inputs={branchFilters:JSON.stringify([e.witLinkingBranchFilter])}:(t={definition:{id:j.BuildOptionGUIDs.WitLinkingOptionGUID},inputs:{branchFilters:JSON.stringify([e.witLinkingBranchFilter])},enabled:!0},s.options.push(t))),void 0!==e.witLinkingEnabled&&t&&(i.push((0,o.format)(T.SavePipelineCommentEnableAutoLink,e.witLinkingEnabled)),t.enabled=e.witLinkingEnabled)}s.comment=i.join(". "),this.pipelineService.savePipeline(s).then((e=>{this._showPipelineSavedToast(),t?this.setState({isYamlDirty:!1,isPipelineSaving:!1},(()=>(0,a.FastPageSwitch)(this.context.pageContext,window.location.href,!1))):this.setState({definition:e,isPipelineSaving:!1},this._dismissPipelineSettingsPanel)}),(e=>{const t=e&&e.message||T.SavePipelineErrorMessage;this._handleSettingsError(t)}))},this._dismissPipelineSettingsPanel=()=>{this.state.isPipelineSaving||this.setState({settingsPanelIsOpen:!1,settingsErrorMessage:"",isPipelineSaving:!1})},this._handleSettingsError=e=>{this.setState({settingsErrorMessage:e,isPipelineSaving:!1,settingsPanelIsOpen:!0})},this._showPipelineVariablesPanel=()=>{this.setState({variablesPanelIsOpen:!0})},this._dismissPipelineVariablesPanel=()=>{this.state.isPipelineSaving||this.setState({variablesPanelIsOpen:!1,variablesErrorMessage:"",isPipelineSaving:!1})},this._onSavePipelineVariables=e=>{const t=[],i=Object.assign({},this.state.definition);this.setState({isPipelineSaving:!0,variablesErrorMessage:""}),i.variables=e,t.push(ce.VariablesPanelSaveComment),i.comment=t.join(". "),this.pipelineService.savePipeline(i).then((e=>{this._showPipelineSavedToast(),this.setState({definition:e,isPipelineSaving:!1},this._dismissPipelineVariablesPanel)}),(e=>{const t=e&&e.message||T.SavePipelineErrorMessage;this._handleVariablesError(t)}))},this._handleVariablesError=e=>{this.setState({variablesErrorMessage:e,isPipelineSaving:!1,variablesPanelIsOpen:!0})},this._handleRunBuildError=e=>{this.setState({isBuildRunning:!1});let t,i=e&&e.message||ce.RunBuildErrorMessage;const s=e;if(s&&s.serverError&&s.serverError.customProperties){const e=s.serverError.customProperties.ValidationResults;if(e&&e.length>0){i+="\n"+e.map((e=>e.message)).join("\n");const s="https://aka.ms/yamlauthz";i.indexOf(s)>0&&(t=[{primary:!0,text:ce.AuthorizeAndRunButtonText,onClick:this._authorizeAndRun}])}}this._handleError(i,!0,t)},this._handleError=(e,t,i)=>{this._clearBuildMessage(),this.setState({errorMessage:e,isErrorMessageDismissable:t,errorActions:i},this._resizeEditor)},this._handleYamlSaveError=e=>{this.setState({saveErrorMessage:e,isYamlSaving:!1,savePanelIsOpen:!0})},this._markTimeToInteractive=()=>{this._ttiRecorded||(this._ttiRecorded=!0,this.context.pageContext.getService("IVssPerformanceService").markTimeToInteractive(he.PerformanceConstants.Area,he.PageLoadScenarios.YamlEditor))},this._onChangeVariables=(e,t)=>{this.setState({isVariablesDirty:this._yamlResourceService.isVariablesChanged()})},this._onBranchSelected=e=>{e!==this.state.yamlBranch&&(this.state.isYamlDirty?this.layoutManager.renderCallout((t=>(0,fe.getLoseChangesDialog)((()=>{t(),this._switchBranch(e)}),(()=>{t()})))):this._switchBranch(e))},this._switchBranch=e=>{this.setState({yamlContent:"",yamlFileObjectId:"",yamlBranch:e,yamlFileUrl:""}),this._clearErrorMessage();const t=this.historyService,i=t.generateUrl({branch:e});t.pushState(void 0,i);const s=this.state.definition,a=s.process.yamlFilename,n=s.repository,r={connectionId:n.properties&&n.properties.connectedServiceId,id:n.id,name:n.name,sourceProviderType:n.type};this.yamlFileService.getFileContentData(r,e,a).then((e=>{this._updateFileInfo(e)}),(t=>{this._updateFileInfo({content:"",branch:e,path:a,objectId:"",url:""}),this._handleError(t.message,!1)})).then((()=>{this._checkForHostedMac()}))};const i={isEditorReady:!1,connection:{},savePanelIsOpen:!1,runPanelIsOpen:!1,isYamlSaving:!1,yamlContent:"",yamlFileUrl:"",yamlBranch:"",yamlFileObjectId:"",isYamlDirty:!1,errorMessage:"",isErrorMessageDismissable:!1,settingsPanelIsOpen:!1,variablesPanelIsOpen:!1,isPipelineSaving:!1,isBuildRunning:!1,useAppConnectionAction:void 0,authentication:{isLoginRequired:!1,shouldShowLandingPage:!1}},s="ms.vss-build-web.pipeline-editor-data-provider",n=this.context.pageContext.getService("IVssContributionService"),c=n.getData(s);if(c){if(this._lastCleanContent=c.content||"",i.definition=c.definition,i.yamlBranch=c.branch||(c.definition.repository.defaultBranch||"").replace("refs/heads/",""),i.yamlContent=c.content,i.yamlFileUrl=c.yamlFileUrl,i.yamlFileObjectId=c.objectId,i.errorMessage=c.fileErrorMessage,i.errorMessage){const e=i.definition.repository;(0,o.equals)(e.type,r.RepositoryTypes.TfsGit,!0)&&e.id&&e.name&&(i.errorMessage=i.errorMessage.replace(e.id,e.name))}if(i.authentication=c.authenticationRequirements,i.connection=c.serviceConnection||{},i.authentication.isLoginRequired){if(i.yamlBranch="",i.authentication.shouldShowLandingPage)i.errorMessage="";else{const e=(0,Se.getSourceProviderTile)(this.context.pageContext,i.definition.repository.type.toLowerCase());this._sourceProviderName=e?e.name:""}i.authentication.loginUrl||(i.errorMessage=ce.LoginUrlNotSpecified)}}else{const e=n.getDataProviderExceptions()[s];this._handleEditorDataProviderError(e,i)}this._yamlResourceService=t.pageContext.getService("IYamlResourcesService"),this.state=i,i.yamlBranch&&i.yamlBranch!==this.historyService.getState().branch&&this._updateUrl()}componentDidMount(){super.componentDidMount(),(0,z.prefetch)(this.context.pageContext),this.navigationService.setPageTitle(this._getTitle()),this.breadcrumbService.setPipeline(this.state.definition),this.state.authentication.isLoginRequired&&!this.state.authentication.shouldShowLandingPage&&this.state.authentication.loginUrl?(0,S.openLinkSecurely)(this.state.authentication.loginUrl):(this._yamlResourceService.subscribe(this._onChangeVariables),(0,fe.addNavigateAwayListener)(this._onNavigateAway),this._checkForAppConnectionUpgrade()),this._checkForHostedMac()}componentWillUnmount(){super.componentWillUnmount(),this._yamlResourceService.unsubscribe(this._onChangeVariables),this.breadcrumbService.clearPipeline(),(0,fe.removeNavigateAwayListener)(this._onNavigateAway),(0,H.clearTreeStateOnUnmount)(this.context.pageContext)}render(){return this.state.definition?this._shouldShowLandingPage()?this._getAuthLandingPage():this._getEditorPage():this._getEmptyPage()}_shouldShowLandingPage(){return this.state.authentication.isLoginRequired&&this.state.authentication.shouldShowLandingPage}_getEmptyPage(){return l.createElement(K.Page,{className:i},this._getHeader())}_getAuthLandingPage(){const e=this.state.definition;return l.createElement(K.Page,{className:i},this._getHeader(),l.createElement(Se.EditorAuthLandingPage,{loginUrl:this.state.authentication.loginUrl,yamlFileLink:this.state.yamlFileUrl,repository:e.repository,sourceProvider:this._getSourceProvider()}))}_getEditorPage(){const e=this.state.definition,t=e.process.yamlFilename,s=this._getFileName(t),a=s?(0,o.format)(ce.SavePanelCommitMessageForEdit,s):"",n=this._getSourceProvider(),c=!(0,o.equals)(e.repository.type,r.RepositoryTypes.Bitbucket,!0)||(0,w.isFeatureFlagEnabled)(this.context.pageContext,"Build2.BitbucketAzurePipelinesOAuthClient",!1);let d="";this.state.authentication.isLoginRequired&&(d=this._sourceProviderName?(0,o.format)(ce.AuthorizingWithProviderMessage,this._sourceProviderName):ce.AuthorizingMessage);const h={onDismiss:()=>{this.setState({validationDialogOpen:!1})},lightDismiss:!0,modal:!0,contentSize:3,titleProps:{text:ce.Validation},footerButtonProps:[{text:ce.OK,onClick:()=>{this.setState({validationDialogOpen:!1})},primary:!0}]};let p=e.repository&&e.repository.properties&&e.repository.properties.manageUrl;return p&&!p.toLowerCase().startsWith("http")&&(p=""),l.createElement(K.Page,{className:i},this._getHeader(),l.createElement(xe.YamlTab,{content:this.state.yamlContent,editor:this._editor,spinnerMessage:d,onContentUpdated:this._onYamlContentUpdated,onEditorCreated:this._onEditorCreated,onEditorDisposing:this._onEditorDisposing,sidePanelInitiallyOpen:!0,repositoryName:e.repository.name,repositoryIconName:n.getRepoIconName(),repositoryUrl:p,branchName:this.state.yamlBranch,fileName:t,fileUrl:this.state.yamlFileUrl,supportFPS:(0,o.equals)(e.repository.type,r.RepositoryTypes.TfsGit,!0),isYamlDirty:this.state.isYamlDirty,definition:e,onBranchSelected:this._onBranchSelected}),l.createElement(Ee.SavePanel,{errorMessage:this.state.saveErrorMessage,fileName:t,commitMessage:a,defaultBranch:this.state.yamlBranch,isOpen:this.state.savePanelIsOpen,isSaving:this.state.isYamlSaving,saveAndRun:!1,canCreatePr:c,onSave:this._onYamlSave,onDismiss:this._dismissSavePanel,showCancelButton:!0}),this.state.runPanelIsOpen&&l.createElement(q.QueuePanel,{showPanel:this.state.runPanelIsOpen,pageContext:this.context.pageContext,projectId:e.project.id,definitionId:e.id,buildRepository:e.repository,sourceBranch:this.state.yamlBranch||"",runtimeVariables:this._getOverridableVariables(e.variables),onDismiss:this._onRunPanelClosed}),l.createElement(W.PipelineSettingsPanel,{key:e.revision,definition:e,branch:this.state.yamlBranch,isYamlDirty:this.state.isYamlDirty,errorMessage:this.state.settingsErrorMessage,isOpen:this.state.settingsPanelIsOpen,isSaving:this.state.isPipelineSaving,onSave:this._onSavePipelineSettings,onDismiss:this._dismissPipelineSettingsPanel,onError:e=>this.setState({settingsErrorMessage:e})}),this.state.variablesPanelIsOpen&&l.createElement(Ce.PipelineVariablesPanel,{variables:e.variables,errorMessage:this.state.variablesErrorMessage,isSaving:this.state.isPipelineSaving,onSave:this._onSavePipelineVariables,onDismiss:this._dismissPipelineVariablesPanel}),this.state.validationDialogOpen&&l.createElement(x.Dialog,Object.assign({},h),this.state.validationDialogMessage))}_getOverridableVariables(e){return Object.keys(e||{}).filter((t=>e[t].allowOverride)).map((t=>({name:t,variable:Object.assign({},e[t])})))}_getFileName(e){let t=e||"";const i=t.lastIndexOf("/")+1;return i>0&&t.length>i&&(t=t.substr(i)),t}_getHeader(){return l.createElement(l.Fragment,null,l.createElement(be.EditorHeader,{definition:this.state.definition,isYamlDirty:this.state.isYamlDirty,actionButtonLabel:this.state.isYamlDirty?ce.SaveButtonLabel:ce.RunButtonLabel,actionDisabled:!!this.state.errorMessage||this.state.isBuildRunning||this.state.isPipelineSaving,onActionClick:this.state.isYamlDirty?this._showSavePanel:this._showRunPanel,onFullYaml:this._fullYaml,onRunWithParameters:this._runBuildWithParameters,onSettingsOpen:this._showPipelineSettingsPanel,onValidateYaml:this._validateYaml,onVariablesOpen:this._showPipelineVariablesPanel,buildMessageInfo:this.state.buildMessageInfo,onBuildMessageDismissed:this._clearBuildMessage,errorMessage:this.state.errorMessage,errorActions:this.state.errorActions,onErrorMessageDismissed:this.state.isErrorMessageDismissable?this._clearErrorMessage:void 0,title:this._getTitle()}),this._getAppUpgradeHeader())}_getAppUpgradeHeader(){return(0,w.isFeatureFlagEnabled)(this.context.pageContext,"Build2.SwitchToAppConnection",!1)&&this.state.useAppConnectionAction?l.createElement("div",{className:"page-content flex-row flex-noshrink"},l.createElement(P.MessageCard,{className:"flex-grow",severity:"Info",onDismiss:this._closeConnectionCard,buttonProps:[this.state.useAppConnectionAction]},l.createElement(f.FormatComponent,{format:this.state.useAppConnectionDescription},l.createElement(b.FPSLink,{href:this.state.connection.appHelpLink},this.state.connection.appName)))):l.createElement(l.Fragment,null)}async _checkForAppConnectionUpgrade(){if((0,w.isFeatureFlagEnabled)(this.context.pageContext,"Build2.SwitchToAppConnection",!1)&&!this._shouldShowLandingPage()&&!this.state.connection.isAppConnection&&this.state.connection.appName)try{const e=this.state.definition,t=this.state.connection.nonce,i=await this._getRecommendedServiceConnection(e,t),s=i.commonConnectionId;if(s)if(this.state.connection.autoUpgradeToAppConnection)this._switchToAppConnection(s);else{const e={text:T.ChangeToAppConnection,onClick:()=>this._switchToAppConnection(s)};this.setState({useAppConnectionAction:e,useAppConnectionDescription:T.PreferAppConnectionChange})}else if(!i.appInstalledForRepository&&i.userCanInstall){const s={text:T.InstallApp,onClick:()=>this._installApp(e.id,t,i.installAppUrlRoot,e.repository)};this.setState({useAppConnectionAction:s,useAppConnectionDescription:T.PreferAppConnectionInstall})}}catch(e){this.context.pageContext.getService("IVssTelemetryService").publishEvent("Build","Editor.CheckForAppConnectionUpgradeError",{message:e&&e.message,error:e})}}_getRecommendedServiceConnection(e,t){const i=this.context.pageContext.getService("IVssContributionService"),s="ms.vss-build-web.app-serviceconnections-recommendation-data-provider",a={sourceProvider:this._getSourceProvider().getKey(),repositoryId:e.repository.id,repositoryName:e.repository.name,connectionId:this.state.connection.connectionId,strongBoxKey:"useWellKnownStrongBoxLocation",createOAuthConnectionIfNeeded:!1,login:this.state.connection.login};return i.getDataAsync(s,a,!0).then((e=>{if(!e){const e=i.getDataProviderExceptions()[s];throw new Error(e&&e.message)}return e}))}_getSourceProvider(){const e=this.context.pageContext.getService("ISourceProviderService");return this.state.definition&&e.getSourceProvider(this.state.definition.repository.type)}_getTitle(){return this.state.definition&&this.state.definition.name||ce.EditorDefaultTitle}_updateUrl(){const e=this.historyService,t=e.generateUrl({branch:this.state.yamlBranch});e.replaceState(void 0,t)}_downloadFile(e,t){let i=new Blob([t],{type:"text/plain"});if(window.navigator&&window.navigator.msSaveBlob)window.navigator.msSaveBlob(i,e);else{let t=document.createElement("a");t.href=URL.createObjectURL(i),t.setAttribute("download",e),document.body.appendChild(t),t.click(),document.body.removeChild(t)}}_onRunBuild(){this.setState({isBuildRunning:!0}),this._clearErrorMessage(),this._clearBuildMessage()}_onBuildQueuing(){this.setState({buildMessageInfo:{id:-1,number:"",isQueuing:!0}},this._resizeEditor)}_showPipelineSavedToast(){this.globalMessageService.addToast({message:ce.PipelineSavedMessage,duration:de.EditorConstants.ToastDuration})}_handleEditorDataProviderError(e,t){let i,s=(0,o.format)(ce.EditorErrorDefaultPipelineFetch,e&&e.message||"");if(e&&e.exceptionType){const t=Number(this.historyService.getState().pipelineId);if(t>0){let a=!0;switch(e.exceptionType){case de.WellKnownExceptions.ServiceEndpointNotFoundException:s=(0,o.format)(ce.EditorErrorServiceConnection,e.message);break;case de.WellKnownExceptions.GitRepositoryNotFoundException:s=(0,o.format)(ce.EditorErrorGitRepoNotFound,e.message);break;case de.WellKnownExceptions.DefinitionTypeNotSupportedException:s=(0,o.format)(ce.EditorErrorNotYamlPipeline,e.message);break;default:a=!1}if(a){const e=this.buildLinkingService.getDefinitionEditUrl(t,de.LegacyDesignerTabKeys.Yaml);i=[{text:ce.EditInOldDesigner,href:e}]}}}t.errorMessage=s,t.errorActions=i}_updateFileInfo(e){this._lastCleanContent=e.content,this.setState({isYamlDirty:!1,isYamlSaving:!1,yamlBranch:e.branch,yamlFileObjectId:e.objectId,yamlContent:e.content,yamlFileUrl:e.url})}_checkForHostedMac(){if(this.state.definition){const e="ms.vss-build-web.check-for-hosted-mac-data-provider",t={pipelineId:this.state.definition.id,sourceBranch:this.state.yamlBranch};this.context.pageContext.getService("IVssContributionService").getDataAsync(e,t,!0).then((e=>{if(e)if(e.usingHostedMac){const e=this.globalMessageService.getBanner();if(!e||e.settingId!==s){const e={id:s,links:[{href:n,name:ce.LearnMore,supportsFPS:!1}],messageFormat:ce.HostedMacWarning};(0,me.showWarning)(this.context.pageContext,e)}}else(0,me.clearWarning)(this.context.pageContext,s)}))}}get breadcrumbService(){return this.context.pageContext.getService("pipeline-editor-breadcrumb-service")}get buildLinkingService(){return this.context.pageContext.getService("IBuildLinkingService")}get historyService(){return this.context.pageContext.getService("IVssHistoryService")}get layoutManager(){return this.context.pageContext.getService("IVssLayoutManager")}get navigationService(){return this.context.pageContext.getService("ITfsNavigationService")}get pipelineService(){return this.context.pageContext.getService("IPipelineService")}get globalMessageService(){return this.context.pageContext.getService("IGlobalMessagesService")}get yamlFileService(){return this.context.pageContext.getService("IYamlFileService")}}const i="pipeline-editor-view bolt-page-grey flex-column flex-grow",s="hosted-mac-warning",n="https://go.microsoft.com/fwlink/?linkid=870426";v.Components.add("ci-designer-editor-view",e)}(),function(e){Te=t[e]={};const a="hosted-mac-warning",l="ms.vss-build-web.pipeline-editor-data-provider";class c extends s.VssService{constructor(){super(...arguments),this.editorError=new i.ObservableValue(void 0),this.isYamlDirty=new i.ObservableValue(!1),this.spinnerMessage="",this.yamlContent=new i.ObservableValue(""),this.yamlFileInfo=new i.ObservableValue({}),this._serviceEnd=e=>{super._serviceEnd(e),(0,fe.removeNavigateAwayListener)(this.onNavigateAway)},this.onNavigateAway=e=>{this.isYamlDirty.value&&(0,fe.showLoseChangesDialog)(this.pageContext,e)}}_serviceStart(e){super._serviceStart(e),this.historyService=this.pageContext.getService("IVssHistoryService");const t=this.pageContext.getService("IVssContributionService"),i=t.getData(l);if(!i)return void(this.editorError.value=this.getDataProviderError(t.getDataProviderExceptions()[l]));const{repository:s}=i;if(i.authenticationRequirements.isLoginRequired){if(i.authenticationRequirements.shouldShowLandingPage)this.editorError.value=void 0;else{const e=(0,Se.getSourceProviderTile)(this.pageContext,s.type.toLowerCase()),t=e?e.name:"";this.spinnerMessage=t?(0,o.format)(ce.AuthorizingWithProviderMessage,t):ce.AuthorizingMessage}i.authenticationRequirements.loginUrl||(this.editorError.value={message:ce.LoginUrlNotSpecified})}this.data=i,this.definition=i.definition,this.yamlContent.value=i.content||"";const a=i.definition.process;if(this.yamlFileInfo.value={path:this.data.templatePath?this.data.templatePath:a.yamlFilename,branch:i.branch||(s.defaultBranch||"").replace("refs/heads/",""),content:this.yamlContent.value,objectId:this.data.objectId,url:this.data.yamlFileUrl},this.data.templatePath&&this.data.fileErrorMessage&&!a.yamlFilename){let e=this.data.fileErrorMessage;(0,o.equals)(s.type,r.RepositoryTypes.TfsGit,!0)&&s.id&&s.name&&(e=e.replace(s.id,s.name)),this.editorError.value={message:e,isDismissable:!0}}this.getBranch()&&this.getBranch()!==this.historyService.getState().branch&&this.updateUrl();e.getService("ITfsNavigationService").setPageTitle(this.getPageTitle()),(0,fe.addNavigateAwayListener)(this.onNavigateAway),this.checkForHostedMac()}clearEditorError(){this.editorError.value=void 0}getAuthentication(){return!!this.data&&this.data.authenticationRequirements}getBranch(){return this.yamlFileInfo.value.branch}getConnection(){return this.data.serviceConnection||{}}getDefinition(){return this.definition}getEditorError(){return this.editorError}getIsYamlDirty(){return this.isYamlDirty}getRepository(){return this.data.repository}getSourceProvider(){const e=this.pageContext.getService("ISourceProviderService");return this.data.repository&&e.getSourceProvider(this.data.repository.type)}getSpinnerMessage(){return this.spinnerMessage}getYamlContent(){return this.yamlContent}getYamlFileUrl(){return this.yamlFileInfo.value.url}getIsTemplate(){return!!this.data&&!!this.data.templatePath}getTemplatePath(){return this.data.templatePath}getDefinitionYamlEditorUrl(){const e=(0,n.getTFSPageData)(this.pageContext);return(0,y.routeUrl)(this.pageContext,"ms.vss-build-web.ci-definition-designer-route",{project:e.project.name,pipelineId:this.getDefinition().id.toString(),branch:this.getBranch()})}getYamlPath(){return this.yamlFileInfo.value.path}getYamlObjectId(){return this.yamlFileInfo.value.objectId}getIsNewFile(){return!!this.data.templatePath&&!!this.data.fileErrorMessage}handleRunBuildError(e){let t=e&&e.message||ce.RunBuildErrorMessage;const i=e;if(i&&i.serverError&&i.serverError.customProperties){const e=i.serverError.customProperties.ValidationResults;if(e&&e.length>0){t+="\n"+e.map((e=>e.message)).join("\n");const i="https://aka.ms/yamlauthz";if(t.indexOf(i)>0)return void(this.editorError.value={message:t,proposeAuthorizeAndRun:!0})}}this.editorError.value={message:t}}setYamlContent(e){if(this.yamlContent.value!==e){this.yamlContent.value=e;const t=e!==this.yamlFileInfo.value.content;t!==this.isYamlDirty.value&&(this.isYamlDirty.value=t)}}shouldShowLandingPage(){const e=this.getAuthentication();return e.isLoginRequired&&e.shouldShowLandingPage}switchBranch(e){if(e!==this.getBranch()){if(!this.isYamlDirty.value)return this.loadYaml(e);this.pageContext.getService("IVssLayoutManager").renderCallout((t=>{const i=t;return(0,fe.getLoseChangesDialog)((()=>{t(),this.loadYaml(e)}),i)}))}}updateSavedDefinition(e){this.definition=e}updateSavedYaml(e,t){this.isYamlDirty.value=!1,this.yamlFileInfo.value=Object.assign(Object.assign({},this.yamlFileInfo.value),{content:t,branch:e.branch,objectId:e.objectId,url:e.url}),this.updateUrl(),this.checkForHostedMac()}getPageTitle(){var e;return this.getIsTemplate()&&(0,pe.getFileName)(this.data.templatePath)||(null===(e=this.definition)||void 0===e?void 0:e.name)||ce.EditorDefaultTitle}loadYaml(e){const t=this.getYamlPath(),i=this.data.repository,s={connectionId:i.properties&&i.properties.connectedServiceId,id:i.id,name:i.name,sourceProviderType:i.type};this.yamlContent.value="",this.yamlFileInfo.value={},this.editorError.value=void 0;const a=this.historyService,n=a.generateUrl({branch:e});return a.pushState(void 0,n),this.pageContext.getService("IYamlFileService").getFileContentData(s,e,t).then((e=>{this.updateFileInfo(e),this.yamlContent.value=e.content}),(i=>{this.editorError.value={message:i.message,isDismissable:!0},this.updateFileInfo({content:"",branch:e,path:t,objectId:"",url:""})}))}updateFileInfo(e){this.yamlFileInfo.value=e,this.checkForHostedMac()}checkForHostedMac(){const e={pipelineId:this.getDefinition().id,sourceBranch:this.getBranch()};this.pageContext.getService("IVssContributionService").getDataAsync("ms.vss-build-web.check-for-hosted-mac-data-provider",e,!0).then((e=>{if(e)if(e.usingHostedMac){const e=this.pageContext.getService("IGlobalMessagesService").getBanner();if(!e||e.settingId!==a){const e={id:a,links:[{href:"https://go.microsoft.com/fwlink/?linkid=870426",name:ce.LearnMore,supportsFPS:!1}],messageFormat:ce.HostedMacWarning};(0,me.showWarning)(this.pageContext,e)}}else(0,me.clearWarning)(this.pageContext,a)}))}getDataProviderError(e){if(e&&e.exceptionType)switch(e.exceptionType){case de.WellKnownExceptions.ServiceEndpointNotFoundException:return{message:(0,o.format)(ce.EditorErrorServiceConnection,e.message),proposeClassicDesigner:!0};case de.WellKnownExceptions.GitRepositoryNotFoundException:return{message:(0,o.format)(ce.EditorErrorGitRepoNotFound,e.message),proposeClassicDesigner:!0};case de.WellKnownExceptions.DefinitionTypeNotSupportedException:return{message:(0,o.format)(ce.EditorErrorNotYamlPipeline,e.message),proposeClassicDesigner:!0}}return{message:(0,o.format)(ce.EditorErrorDefaultPipelineFetch,e&&e.message||"")}}updateUrl(){const e=this.historyService.generateUrl({branch:this.getBranch()});this.historyService.replaceState(void 0,e)}}const d="IPipelineEditorViewService";t[e].getPipelineEditorViewService=function(e){return e.getService(d)},s.Services.add(d,{serviceFactory:c})}("ServicesPipelineEditorViewService"),function(e){Ne=t[e]={};class i extends v.VssComponent{constructor(e,t){super(e,t),this.gotoPipelineResults=e=>{const t=this.buildLinkingService.getDefinitionUrl(this.props.definition&&this.props.definition.id);this.gotoUrl(t,e)},this.gotoLegacyDesigner=(e,t)=>{const i=this.buildLinkingService.getDefinitionEditUrl(this.props.definition.id,e);this.gotoUrl(i,t)},this.state={},this.viewService=(0,Te.getPipelineEditorViewService)(t.pageContext),this.isTemplate=this.viewService.getIsTemplate(),this.isVariablesPanelEnabled=!(0,w.isFeatureFlagEnabled)(t.pageContext,"Build2.DisableYamlEditorVariables",!1)}render(){return l.createElement(l.Fragment,null,l.createElement(_.Header,{className:"ci-editor-header",title:this.getTitle(),titleSize:1,backButtonProps:{onClick:this.gotoPipelineResults},commandBarItems:this.getCommandBarItems()}),this.getMessages())}getTitle(){const e=this.props.definition&&this.props.definition.queueStatus||0;let t="";return 2===e?t=ce.PipelineStatusDisabled:1===e?t=ce.PipelineStatusPaused:this.props.definition&&!this.isCIEnabled()&&(t=ce.PipelineStatusCIDisabled),l.createElement(l.Fragment,null,l.createElement("span",null,this.props.title),t&&l.createElement("span",{className:"pipeline-status"},t))}getCommandBarItems(){const e=[];if(this.isTemplate){const t={id:"save",className:de.EditorConstants.ElementToFocusOnEscape,text:this.props.actionButtonLabel,important:!0,disabled:this.props.actionDisabled,isPrimary:!0,onActivate:this.props.onActionClick};return e.push(t),e}if(this.isVariablesPanelEnabled){const t={id:"variablesPanel",text:ce.CommandVariables,important:!0,disabled:!this.props.definition,isPrimary:!1,onActivate:this.props.onVariablesOpen};e.push(t)}var t={id:"runsave",className:de.EditorConstants.ElementToFocusOnEscape,text:this.props.actionButtonLabel,important:!0,disabled:this.props.actionDisabled,isPrimary:!0,onActivate:this.props.onActionClick};this.props.isYamlDirty&&(t={id:"runsave",important:!0,disabled:this.props.actionDisabled,renderButton:()=>l.createElement(G.SplitButton,{primary:!0,disabled:this.props.actionDisabled,key:"runsave",className:(0,v.css)("runsave-with-validation-button",de.EditorConstants.ElementToFocusOnEscape),buttonProps:{text:this.props.actionButtonLabel,onClick:this.props.onActionClick,id:"runsave-with-validation-button",role:"menuitem"},menuButtonProps:{subtle:!0,iconProps:{iconName:"ChevronDown"},role:"menuitem",contextualMenuProps:{menuProps:{id:"runsave-menu",items:[{id:"runsave-without-validation-menu-item-button",onActivate:this.props.onSaveWithoutValidationClick,text:ce.SaveWithoutValidationButtonLabel}]}}}}),onActivate:this.props.onActionClick}),e.push(t);const i={id:"settings",text:ce.CommandSettings,important:!1,disabled:!this.props.definition,iconProps:{iconName:"Settings"},onActivate:this.props.onSettingsOpen};e.push(i);e.push({id:"sep1",itemType:1,important:!1});const s={id:"validate",text:ce.Validate,important:!1,disabled:!this.props.definition,iconProps:{iconName:"CheckMark"},onActivate:this.props.onValidateYaml};e.push(s);const a={id:"fullyaml",text:ce.FullYaml,important:!1,disabled:!this.props.definition,iconProps:{iconName:"FileYML"},onActivate:this.props.onFullYaml};e.push(a);e.push({id:"sep2",itemType:1,important:!1});const n={id:"triggers",text:ce.CommandTriggers,important:!1,disabled:!this.props.definition,iconProps:{iconName:"LightningBolt"},onActivate:(e,t)=>this.gotoLegacyDesigner(de.LegacyDesignerTabKeys.Triggers,t)};if(e.push(n),!this.isVariablesPanelEnabled){const t={id:"variables",text:ce.CommandVariables,important:!1,disabled:!this.props.definition,iconProps:{iconName:"Variable"},onActivate:(e,t)=>this.gotoLegacyDesigner(de.LegacyDesignerTabKeys.Variables,t)};e.push(t)}return e}gotoUrl(e,t){t&&(t.ctrlKey||t.shiftKey)?(0,S.openLinkSecurely)(e,!0):(0,a.onClickFPS)(this.context.pageContext,e,!0)}getMessages(){const e=this.getErrorBar(),t=this.getBuildMessageBar();if(e||t)return l.createElement("div",{className:"page-content flex-row flex-noshrink"},e,t)}getErrorBar(){if(this.props.errorMessage)return l.createElement(P.MessageCard,{className:"flex-grow",severity:"Error",buttonProps:this.props.errorActions,onDismiss:this.props.onErrorMessageDismissed},this.props.errorMessage)}getBuildMessageBar(){if(this.props.buildMessageInfo){const e=this.props.buildMessageInfo,t=e.id>0?this.buildLinkingService.getBuildUrl(e.id):"";return l.createElement(P.MessageCard,{className:"flex-grow",severity:"Info",onDismiss:this.props.onBuildMessageDismissed},e.isQueuing?ce.BuildQueuingMessage:l.createElement(f.FormatComponent,{format:ce.BuildQueuedMessage},l.createElement(b.FPSLink,{href:t},(0,o.format)(ce.BuildNumberFormat,e.number))))}}isCIEnabled(){const e=this.props.definition.triggers;return!!(e&&e.find((e=>2===e.triggerType)))}get buildLinkingService(){return this.context.pageContext.getService("IBuildLinkingService")}}t[e].NewEditorHeader=i}("NewEditorHeader"),function(e){function i(){const e=document.querySelector("."+de.EditorConstants.YamlAssistantToggleElement);e&&e.focus&&!e.hasAttribute("disabled")&&!e.classList.contains("disabled")&&"hidden"!==e.style.visibility&&"none"!==e.style.display&&e.focus()}Ie=t[e]={},t[e].focusYamlAssistantButton=i;class s extends v.VssComponent{constructor(e,t){super(e,t),this.viewService=(0,Te.getPipelineEditorViewService)(t.pageContext)}render(){const e=this.props,t=e.sidePanelIsOpen,i=this.viewService.getYamlPath(),s=this.viewService.getIsTemplate(),n=this.viewService.getRepository();return l.createElement("div",{className:"ci-yaml-editor-header flex-row absolute-fill rhythm-horizontal-8"},i&&l.createElement(l.Fragment,null,this._getBranchPicker(n),l.createElement("div",{className:"subheader-items flex-row flex-grow scroll-hidden margin-left-8"},this._getRepository(n),l.createElement(a,{fileName:i,fileUrl:this.viewService.getYamlFileUrl(),supportsFPS:(0,o.equals)(n.type,r.RepositoryTypes.TfsGit,!0),isYamlDirty:this.viewService.getIsYamlDirty().value,onFileNameChanged:e.onFileNameChanged}),s&&l.createElement(Q.Pill,{variant:1,className:"template-pill margin-4"},ce.Template)),!t&&l.createElement(U.HeaderCommandBar,{items:[{id:"show-hide-tasks",className:(0,v.css)("show-yaml-side-panel-button",de.EditorConstants.YamlAssistantToggleElement),text:t?"":ce.SidePanelOpen,onActivate:e.onSidePanelButtonClick,important:!0,iconProps:{iconName:t?"ClosePane":"OpenPane"},subtle:!0}]})))}_getBranchPicker(e){if(e)return l.createElement(M.BranchDropdown,{className:"branch-picker",ariaLabel:ce.Branch,repositoryType:e.type,repositoryId:e.id,defaultBranch:this.viewService.getBranch(),connectionId:e.properties&&e.properties.connectedServiceId,isDrodownFullWidth:!1,comboBoxMinWidth:120,comboBoxMaxWidth:350,onBranchSelected:e=>this.viewService.switchBranch(e),onError:this.props.onBranchPickerError})}_getRepository(e){if(e){const t=this.viewService.getSourceProvider().getRepoIconName(),i=e.name;let s=e.properties&&e.properties.manageUrl;return s&&!s.toLowerCase().startsWith("http")&&(s=""),l.createElement(l.Fragment,null,l.createElement("div",{className:"subheader-item ci-hover-behavior flex-row flex-center"},t&&l.createElement(Y.VssIcon,{iconName:t}),l.createElement(R.Tooltip,{text:i,overflowOnly:!0},s?l.createElement(b.FPSLink,{className:"repository-name text-ellipsis",supportsFPS:(0,o.equals)(e.type,r.RepositoryTypes.TfsGit,!0),href:s},i):l.createElement("span",{className:"repository-name text-ellipsis"},i))),l.createElement("div",{className:"flex-row flex-center"},l.createElement("span",{className:"separator"},"/")))}}}t[e].NewYamlEditorHeader=s;class a extends l.Component{constructor(e){super(e),this._textField=l.createRef(),this._textDiv=l.createRef(),this._editModeOn=()=>{this.setState({isEditMode:!0},(()=>{this._textField.current&&this._textField.current.select()}))},this._editModeOff=(e,t)=>{const i=e?void 0:this.state.errorMessage,s=e?this.props.fileName:this._cleanupFileName(this.state.fileName);i||this.setState({fileName:s,errorMessage:i,isEditMode:!1},(()=>{this.props.onFileNameChanged&&s!==this.props.fileName&&this.props.onFileNameChanged(s),t&&t()}))},this._onKeyDown=e=>{if(13===e.which||27===e.which){e.preventDefault(),e.stopPropagation();const t=27===e.which;this._editModeOff(t,i)}},this._onFilePathChanged=(e,t)=>{const i=(0,pe.getInvalidFileNameMessage)(t);this.setState({fileName:t,errorMessage:i})},this.state={isEditMode:!1,fileName:e.fileName}}render(){return l.createElement(l.Fragment,null,this.state.isEditMode?this._renderFilePathTextField():this._renderFilePath())}_renderFilePathTextField(){return l.createElement("div",{ref:this._textDiv,className:"flex-grow"},l.createElement(F.FormItem,{error:!!this.state.errorMessage,className:"flex-grow"},l.createElement(V.TextField,{containerClassName:"file-path-text flex-grow",className:"editable-file-path",value:this.state.fileName,autoFocus:!0,ref:this._textField,onChange:this._onFilePathChanged,onKeyDown:this._onKeyDown,onBlur:this._editModeOff})),this.state.errorMessage&&l.createElement(O.Callout,{contentShadow:!0,anchorElement:this._textDiv.current,anchorOrigin:{horizontal:"start",vertical:"end"},calloutOrigin:{horizontal:"start",vertical:"start"},anchorOffset:{horizontal:8,vertical:4}},l.createElement("div",{className:"file-path-error"},this.state.errorMessage)))}_renderFilePath(){let e=this.props.fileName;e=e.replace(/\\/g,"/"),e=e.startsWith("./")?e.slice(2):e,e=e.startsWith("/")?e.slice(1):e;const t=this.props.isYamlDirty?" *":"",i=e.lastIndexOf("/"),s=i>0?e.slice(0,i):"",a=(i>0?e.slice(i+1):e)+t,n=!!this.props.onFileNameChanged;return l.createElement(R.Tooltip,{text:n?ce.Rename:void 0},l.createElement("div",Object.assign({className:(0,v.css)("editable-path-container flex-center flex-row text-ellipsis",n&&"editable")},n?{tabIndex:0,onClick:this._editModeOn,onFocus:this._editModeOn}:{}),s&&l.createElement(l.Fragment,null,l.createElement("div",{className:"file-path flex-row flex-center"},l.createElement(R.Tooltip,{text:e,overflowOnly:!0},l.createElement("span",{className:"text-ellipsis white-space-pre"},s))),l.createElement("div",{className:"flex-row flex-center"},"/")),l.createElement("div",{className:"subheader-item ci-hover-behavior flex-row flex-center"},l.createElement(R.Tooltip,{text:e,overflowOnly:!0},l.createElement(l.Fragment,null,this.props.fileUrl?l.createElement(b.FPSLink,{className:"file-name text-ellipsis",supportsFPS:this.props.supportsFPS,href:this.props.fileUrl},a):l.createElement("span",{className:"file-name text-ellipsis"},a),n&&l.createElement(c.Icon,{className:"rename-icon",iconName:"Rename",size:"medium"}))))))}_cleanupFileName(e){return e=(0,pe.trimFilePath)(e),e=(0,pe.trimLeadingSlashes)(e),(0,pe.ensureYamlExtension)(e)}}}("NewYamlEditorHeader"),function(e){Fe=t[e]={};class i extends v.VssComponent{constructor(e,t){super(e,t),this._onEditorContentUpdated=e=>{if(e&&this.props.onContentUpdated){const t=e.getValue()||"";this.props.onContentUpdated(t)}},this._onSidePanelButtonClick=()=>{this.setState((e=>({sidePanelIsOpen:!e.sidePanelIsOpen})),(()=>{(0,Ie.focusYamlAssistantButton)()}))},this._openSidePanel=()=>{this.state.sidePanelIsOpen||this.setState({sidePanelIsOpen:!0})},this.state={sidePanelIsOpen:e.sidePanelInitiallyOpen},this.viewService=(0,Te.getPipelineEditorViewService)(t.pageContext)}render(){var e,t,i;const s=this.props;return l.createElement("div",{className:"ci-yaml-editor-tab flex-grow flex-row"},l.createElement("div",{className:"flex-row absolute-fill"},l.createElement("div",{className:"flex-column flex-grow relative"},l.createElement("div",{className:"ci-yaml-header-container relative"},l.createElement(Ie.NewYamlEditorHeader,{sidePanelIsOpen:this.state.sidePanelIsOpen,onBranchPickerError:s.onBranchPickerError,onSidePanelButtonClick:this._onSidePanelButtonClick,onFileNameChanged:this.props.onFileNameChanged})),l.createElement("div",{className:"relative flex-grow"},l.createElement("div",{className:"absolute-fill"},l.createElement(Pe.YamlEditor,{content:s.content,spinnerMessage:this.viewService.getSpinnerMessage(),errorMessage:"",isReadOnly:!1,elementToFocusOnEscape:"."+de.EditorConstants.ElementToFocusOnEscape,onEditorContentUpdated:this._onEditorContentUpdated,onEditorCreated:s.onEditorCreated,onEditorDisposing:s.onEditorDisposing,sidePanelIsOpen:this.state.sidePanelIsOpen,codeLensOptions:{onEditTask:this._openSidePanel,onOpenTemplate:null===(e=s.codeLensOptions)||void 0===e?void 0:e.onOpenTemplate,onValidate:null===(t=s.codeLensOptions)||void 0===t?void 0:t.onValidate,checkTemplate:null===(i=s.codeLensOptions)||void 0===i?void 0:i.checkTemplate}})))),l.createElement(_e.YamlSidePanel,{editor:s.editor,isOpen:this.state.sidePanelIsOpen,onDismiss:this._onSidePanelButtonClick})))}}t[e].NewYamlTab=i}("NewYamlTab"),function(e){De=t[e]={};t[e].TemplateDetails=class{};class n extends s.VssService{constructor(){super(...arguments),this.isBuildRunning=new i.ObservableValue(!1),this.panelErrorMessage=new i.ObservableValue(""),this.isYamlDirty=new i.ObservableValue(!1),this.isSaving=new i.ObservableValue(!1),this.recommendSwitchToAppConnection=new i.ObservableValue(!1),this.recommendInstallApp=new i.ObservableValue(!1),this.templates={},this.openTemplate=e=>{var t;const i=this.viewService.getDefinitionYamlEditorUrl(),s=new J.Uri(i);let a=this.templates[e];if(a){if(s.addQueryParam("template",a.path),a.endpoint?s.addQueryParam("endpoint",a.endpoint):this.validateAndUpdateExternalSources&&a.repo===this.viewService.getRepository().name&&"git"!==a.type.toLowerCase()&&s.addQueryParam("endpointId",null===(t=this.viewService.getConnection())||void 0===t?void 0:t.connectionId.toString()),a.repo&&s.addQueryParam("repo",a.repo),a.type&&s.addQueryParam("type",a.type),a.ref){s.removeQueryParam("branch");const e=a.ref.replace("refs/heads/","");s.addQueryParam("branch",e)}window.open(s.absoluteUri,"_blank","noopener")}},this.checkTemplate=e=>{var t;return null===(t=this.templates[e])||void 0===t?void 0:t.exists}}_serviceStart(e){super._serviceStart(e),this.layoutManager=this.pageContext.getService("IVssLayoutManager"),this.pipelineService=this.pageContext.getService("IPipelineService"),this.viewService=(0,Te.getPipelineEditorViewService)(e),this.validateAndUpdateExternalSources=(0,w.isFeatureFlagEnabled)(this.pageContext,"Build2.ValidateAndUpdateExternalSources",!1)}async authorizeAndRun(){var e;this.isYamlDirty.value&&await this.showValidateAndSavePanel();const t=this.pageContext.getService("IPipelineResourcesService");await t.autoAuthorizeResources(this.viewService.getDefinition().id,this.viewService.getBranch()).then((()=>{}),(e=>{console.warn("YAML editor: Error while auto-authorizing resources: "+e&&e.message)})),this.isBuildRunning.value=!0,this.viewService.clearEditorError(),this.buildMessageInfo={id:-1,number:"",isQueuing:!0},null===(e=this.editor)||void 0===e||e.layout(),this.pipelineService.runPipeline(this.viewService.getDefinition(),this.viewService.getBranch()).then((e=>{e?this.buildMessageInfo={id:e.id,number:e.buildNumber}:this.viewService.handleRunBuildError(),this.isBuildRunning.value=!1}),(e=>{this.isBuildRunning.value=!1,this.viewService.handleRunBuildError(e)}))}canSwitchToAppConnection(){return this.recommendSwitchToAppConnection}canInstallApp(){return this.recommendInstallApp}canValidate(){return this.validateAndUpdateExternalSources||(0,o.equals)(this.viewService.getDefinition().repository.type,r.RepositoryTypes.TfsGit,!0)}async checkForAppConnectionUpgrade(){const e=this.viewService.getConnection();if((0,w.isFeatureFlagEnabled)(this.pageContext,"Build2.SwitchToAppConnection",!1)&&!this.viewService.shouldShowLandingPage()&&!e.isAppConnection&&e.appName)try{this.connectionRecommendation=await this.getRecommendedServiceConnection(),this.connectionRecommendation.commonConnectionId?e.autoUpgradeToAppConnection?this.switchToAppConnection():this.recommendSwitchToAppConnection.value=!0:!this.connectionRecommendation.appInstalledForRepository&&this.connectionRecommendation.userCanInstall&&(this.recommendInstallApp.value=!0)}catch(e){this.pageContext.getService("IVssTelemetryService").publishEvent("Build","Editor.CheckForAppConnectionUpgradeError",{message:e&&e.message,error:e})}}dismissAppConnectionRecommendations(){var e;this.recommendSwitchToAppConnection.value&&(this.recommendSwitchToAppConnection.value=!1),this.recommendInstallApp.value&&(this.recommendInstallApp.value=!1),null===(e=this.editor)||void 0===e||e.layout()}async installApp(){const e=this.viewService.getDefinition(),t=this.viewService.getConnection();this.pageContext.getService("IInstallAppService").installAppForEdit(e.id,t.nonce,this.connectionRecommendation.installAppUrlRoot,e.repository)}async switchToAppConnection(){const e=this.connectionRecommendation.commonConnectionId,t=Object.assign({},this.viewService.getDefinition());t.repository.properties=t.repository.properties||[],t.repository.properties.connectedServiceId=e,this.dismissAppConnectionRecommendations(),this.isSaving.value=!0;try{const e=await this.pipelineService.savePipeline(t),i=this.pageContext.getService("IVssContributionService");await i.getDataAsync("ms.vss-build-web.pipeline-edit-continuation-data-provider",{complete:!0},!0),this.isSaving.value=!1,this.viewService.updateSavedDefinition(e),this.dismissAppConnectionRecommendations();this.pageContext.getService("IVssTelemetryService").publishEvent("Build","Editor.AppConnectionUpgradeFromOAuth",{GitHubApp:"AddAppConnection",GitHubAppRepo:e.repository.id,action:"ChangeConnectionToGitHubApp"});this.viewService.getConnection().autoUpgradeToAppConnection||this.showToast(T.ConnectionChanged)}catch(e){this.showToast(e&&e.message||T.SavePipelineErrorMessage)}}dismissBuildMessage(){this.buildMessageInfo=void 0}getBuildMessage(){return this.buildMessageInfo}getIsRunning(){return this.isBuildRunning}getIsSaving(){return this.isSaving}runBuildWithParameters(){const e=this.viewService.getDefinition();e&&(this.isBuildRunning.value=!0,this.viewService.clearEditorError(),this.buildMessageInfo=void 0,this.layoutManager.renderCallout((t=>l.createElement(z.CommandComponent,{commandType:"ciQueueBuildComponent",definition:e,repository:this.viewService.getRepository(),processType:e.process.type,pageContext:this.pageContext,project:e.project.id,source:"yamlEditor",onSuccess:e=>{var t;e?(this.buildMessageInfo={id:e.id,number:e.buildNumber},null===(t=this.editor)||void 0===t||t.layout()):this.viewService.handleRunBuildError()},onClosed:()=>{this.isBuildRunning.value=!1,t()},definitionVariables:e.variables,queue:e.queue,defaultSourceBranch:this.viewService.getBranch(),onDismiss:t}))))}showQueuePanel(){const e=this.viewService.getDefinition();this.layoutManager.renderCallout((t=>{return l.createElement(q.QueuePanel,{showPanel:!0,pageContext:this.pageContext,projectId:e.project.id,definitionId:e.id,buildRepository:this.viewService.getRepository(),sourceBranch:this.viewService.getBranch(),runtimeVariables:(i=e.variables,Object.keys(i||{}).filter((e=>i[e].allowOverride)).map((e=>({name:e,variable:Object.assign({},i[e])})))),onDismiss:t});var i}))}showSavePanel(){this.isSaving.value=!1;const e=this.viewService.getIsNewFile(),t=(0,pe.getFileName)(this.viewService.getYamlPath()),i=e?ce.SavePanelCommitMessageForAdd:ce.SavePanelCommitMessageForEdit,s=t?(0,o.format)(i,t):"",a=!(0,o.equals)(this.viewService.getRepository().type,r.RepositoryTypes.Bitbucket,!0)||(0,w.isFeatureFlagEnabled)(this.pageContext,"Build2.BitbucketAzurePipelinesOAuthClient",!1),n=this.viewService.getDefinition();this.layoutManager.renderCallout((e=>l.createElement($.Observer,{isSaving:this.isSaving,errorMessage:this.panelErrorMessage},(({errorMessage:t,isSaving:i})=>l.createElement(Ee.SavePanel,{errorMessage:t,fileName:this.viewService.getYamlPath(),commitMessage:s,defaultBranch:this.viewService.getBranch(),isOpen:!0,isSaving:i,saveAndRun:!1,canCreatePr:a,onSave:t=>this.saveYaml(t,e),onDismiss:()=>{i||(this.panelErrorMessage.value="",e())},showCancelButton:!0,definitionId:n.id})))))}showValidateAndSavePanel(){this.isSaving.value=!1;const e=this.viewService.getIsNewFile(),t=(0,pe.getFileName)(this.viewService.getYamlPath()),i=e?ce.SavePanelCommitMessageForAdd:ce.SavePanelCommitMessageForEdit,s=t?(0,o.format)(i,t):"",a=!(0,o.equals)(this.viewService.getRepository().type,r.RepositoryTypes.Bitbucket,!0)||(0,w.isFeatureFlagEnabled)(this.pageContext,"Build2.BitbucketAzurePipelinesOAuthClient",!1),n=this.viewService.getDefinition();this.layoutManager.renderCallout((e=>l.createElement($.Observer,{isSaving:this.isSaving,errorMessage:this.panelErrorMessage},(({errorMessage:t,isSaving:i})=>l.createElement(Ee.SavePanel,{isValidateAndSave:!0,onValidate:()=>this.validateYaml(),errorMessage:t,fileName:this.viewService.getYamlPath(),commitMessage:s,defaultBranch:this.viewService.getBranch(),isOpen:!0,isSaving:i,saveAndRun:!1,canCreatePr:a,onSave:t=>this.saveYaml(t,e),onDismiss:()=>{i||(this.panelErrorMessage.value="",e())},showCancelButton:!0,definitionId:n.id})))))}showSettingsPanel(){const e=this.viewService.getDefinition();this.layoutManager.renderCallout((t=>l.createElement($.Observer,{isSaving:this.isSaving,errorMessage:this.panelErrorMessage},(({errorMessage:i,isSaving:s})=>l.createElement(W.PipelineSettingsPanel,{key:e.revision,branch:this.viewService.getBranch(),definition:e,errorMessage:i,isOpen:!0,isSaving:s,isYamlDirty:this.isYamlDirty.value,onDismiss:()=>{s||(this.panelErrorMessage.value="",t())},onError:e=>this.panelErrorMessage.value=e,onSave:e=>this.onSavePipelineSettings(e,t)})))))}async downloadYaml(){const e=this.viewService.getDefinition().name.concat(".yml"),t=async()=>{const t=await this.getYaml();this.downloadFile(e,t.finalYaml)},i=async t=>{this.downloadFile(e,t)};this.layoutManager.renderCallout((e=>l.createElement(ve.ValidationPanel,{filePath:this.viewService.getYamlPath(),onDismiss:e,onValidate:()=>t(),postValidation:e=>i(e),isValidationFromDownloadYAML:!0})))}async validateYaml(){if(!this.canValidate())return;const e=this.pageContext.getService("IVssContributionService"),t=this.viewService.getYamlContent().value,i=this.viewService.getDefinition(),s={projectId:i.project.id,pipelineId:i.id,branch:this.viewService.getBranch(),yaml:t,yamlFileName:this.viewService.getTemplatePath()};return await e.getDataAsync("ms.vss-build-web.yaml-schema-data-provider",s,!0)}async validateAndUpdateSchema(){let e=await this.validateYaml();if(e.schema&&!e.errors){this.pageContext.getService("IVssContributionService").getService("ms.vss-build-web.language-editor-service").then((t=>{null==t||t.useSchema(e.schema)}))}return this.updateTemplateListFromValidationResult(e),e.templates}updateTemplateListFromValidationResult(e){!e.errors&&e.templates&&(this.templates=e.templates)}showYamlDialog(){}showVariablesPanel(){const e=this.viewService.getDefinition();this.layoutManager.renderCallout((t=>l.createElement($.Observer,{isSaving:this.isSaving,errorMessage:this.panelErrorMessage},(({errorMessage:i,isSaving:s})=>l.createElement(Ce.PipelineVariablesPanel,{errorMessage:i,isSaving:s,onDismiss:()=>{s||(this.panelErrorMessage.value="",t())},onSave:e=>this.onSavePipelineVariables(e,t),variables:e.variables})))))}setEditor(e){this.editor&&!e&&this.viewService.setYamlContent(this.editor.getValue()),this.editor=e}async showValidationPanel(){this.layoutManager.renderCallout((e=>l.createElement(ve.ValidationPanel,{filePath:this.viewService.getYamlPath(),onDismiss:e,onValidate:()=>this.validateYaml(),postValidation:e=>this.updateTemplateListFromValidationResult(e)})))}showDialog(e){this.layoutManager.renderCallout((t=>l.createElement(x.Dialog,{onDismiss:t,lightDismiss:!0,modal:!0,contentSize:3,titleProps:{text:ce.Validation},footerButtonProps:[{text:ce.OK,onClick:t,primary:!0}]},e)))}downloadFile(e,t){const i=new Blob([t],{type:"text/plain"});if(window.navigator&&window.navigator.msSaveBlob)window.navigator.msSaveBlob(i,e);else{const t=document.createElement("a");t.href=URL.createObjectURL(i),t.setAttribute("download",e),document.body.appendChild(t),t.click(),document.body.removeChild(t)}}async getYaml(){const e=this.viewService.getDefinition(),t=this.viewService.getIsYamlDirty().value,i={stagesToSkip:void 0,resources:{pipelines:{},repositories:{self:{refName:this.viewService.getBranch()}},builds:{},containers:{},packages:{}},templateParameters:{},variables:e.variables,previewRun:!0,yamlOverride:t?this.viewService.getYamlContent().value:""};return this.pageContext.getRestClient("IPipelinesRestClient").runPipeline(i,e.project.id,e.id)}saveYaml(e,t){this.isSaving.value=!0,this.panelErrorMessage.value="";const i={connectionId:this.viewService.getConnection().connectionId,id:this.viewService.getRepository().id,sourceProviderType:this.viewService.getRepository().type},s=this.editor.getValue();return this.pageContext.getService("IYamlFileService").commitFile(i,this.viewService.getBranch(),this.viewService.getYamlPath(),s,e,this.viewService.getYamlObjectId()).then((e=>{this.viewService.updateSavedYaml(e,s),this.isSaving.value=!1,this.panelErrorMessage.value="",t()}),(e=>{this.panelErrorMessage.value=e.message,this.isSaving.value=!1}))}onSavePipelineSettings(e,t){if(!e||!Object.keys(e).length)return;let i=!1;const s=[],n=Object.assign({},this.viewService.getDefinition());if(this.isSaving.value=!0,this.panelErrorMessage.value="",void 0!==e.status)switch(n.queueStatus=e.status,e.status){case 2:s.push(T.SavePipelineCommentDisable);break;case 0:s.push(T.SavePipelineCommentEnable);break;case 1:s.push(T.SavePipelineCommentPause);break;default:s.push(T.SavePipelineCommentUnknownStatus)}if(void 0!==e.yamlFilePath){i=!0;const t=Object.assign({},n.process);t.yamlFilename=e.yamlFilePath,n.process=t,s.push((0,o.format)(T.SavePipelineCommentYamlFile,e.yamlFilePath))}if(void 0!==e.witLinkingEnabled||e.witLinkingBranchFilter){n.options||(n.options=[]);let t=n.options.filter((e=>(0,o.equals)(e.definition.id,j.BuildOptionGUIDs.WitLinkingOptionGUID)))[0];e.witLinkingBranchFilter&&(s.push((0,o.format)(T.SavePipelineCommentUpdateAutoLinkBranch,e.witLinkingBranchFilter)),t?t.inputs={branchFilters:JSON.stringify([e.witLinkingBranchFilter])}:(t={definition:{id:j.BuildOptionGUIDs.WitLinkingOptionGUID},inputs:{branchFilters:JSON.stringify([e.witLinkingBranchFilter])},enabled:!0},n.options.push(t))),void 0!==e.witLinkingEnabled&&t&&(s.push((0,o.format)(T.SavePipelineCommentEnableAutoLink,e.witLinkingEnabled)),t.enabled=e.witLinkingEnabled)}n.comment=s.join(". "),this.pipelineService.savePipeline(n).then((e=>{this.showToast(ce.PipelineSavedMessage),i?(0,a.FastPageSwitch)(this.pageContext,window.location.href,!1):(this.viewService.updateSavedDefinition(e),this.isSaving.value=!1,t())}),(e=>{this.panelErrorMessage.value=e&&e.message||T.SavePipelineErrorMessage,this.isSaving.value=!1}))}onSavePipelineVariables(e,t){const i=Object.assign(Object.assign({},this.viewService.getDefinition()),{variables:e,comment:ce.VariablesPanelSaveComment});this.isSaving.value=!0,this.panelErrorMessage.value="",this.pipelineService.savePipeline(i).then((e=>{this.showToast(ce.PipelineSavedMessage),this.viewService.updateSavedDefinition(e),this.isSaving.value=!1,t()}),(e=>{this.panelErrorMessage.value=e&&e.message||T.SavePipelineErrorMessage,this.isSaving.value=!1}))}showToast(e){this.pageContext.getService("IGlobalMessagesService").addToast({message:e,duration:de.EditorConstants.ToastDuration})}getRecommendedServiceConnection(){const e=this.pageContext.getService("IVssContributionService"),t="ms.vss-build-web.app-serviceconnections-recommendation-data-provider",i=this.viewService.getConnection(),s={sourceProvider:this.viewService.getSourceProvider().getKey(),repositoryId:this.viewService.getRepository().id,repositoryName:this.viewService.getRepository().name,connectionId:i.connectionId,strongBoxKey:"useWellKnownStrongBoxLocation",createOAuthConnectionIfNeeded:!1,login:i.login};return e.getDataAsync(t,s,!0).then((i=>{if(!i){const i=e.getDataProviderExceptions()[t];throw new Error(i&&i.message)}return i}))}}const c="IPipelineEditorActionsViewService";t[e].getPipelineEditorActionsViewService=function(e){return e.getService(c)},s.Services.add(c,{serviceFactory:n})}("ServicesPipelineEditorActionsViewService"),function(){t.NewEditorView={};class e extends v.VssComponent{constructor(e,t){super(e,t),this._ttiRecorded=!1,this._onEditorCreated=e=>{e&&(this.actionsService.setEditor(e),e.focus(),this._editor=e,this.forceUpdate(),this._markTimeToInteractive())},this._onEditorDisposing=()=>{this.actionsService.setEditor(void 0)},this._markTimeToInteractive=()=>{this._ttiRecorded||(this._ttiRecorded=!0,this.context.pageContext.getService("IVssPerformanceService").markTimeToInteractive(he.PerformanceConstants.Area,he.PageLoadScenarios.YamlEditor))},this.viewService=(0,Te.getPipelineEditorViewService)(t.pageContext),this.actionsService=(0,De.getPipelineEditorActionsViewService)(t.pageContext)}componentDidMount(){super.componentDidMount(),(0,z.prefetch)(this.context.pageContext),this.breadcrumbService.setPipeline(this.viewService.getDefinition());const e=this.viewService.getAuthentication();e.isLoginRequired&&!e.shouldShowLandingPage&&e.loginUrl?(0,S.openLinkSecurely)(e.loginUrl):(this.actionsService.checkForAppConnectionUpgrade(),this.actionsService.validateAndUpdateSchema())}componentWillUnmount(){super.componentWillUnmount(),this.breadcrumbService.clearPipeline(),(0,H.clearTreeStateOnUnmount)(this.context.pageContext)}render(){return this.viewService.getDefinition()?this.viewService.shouldShowLandingPage()?this._getAuthLandingPage():this._getEditorPage():this._getEmptyPage()}_getEmptyPage(){return l.createElement(K.Page,{className:i},this._getHeader())}_getAuthLandingPage(){return l.createElement(K.Page,{className:i},this._getHeader(),l.createElement(Se.EditorAuthLandingPage,{loginUrl:this.viewService.getAuthentication().loginUrl,yamlFileLink:this.viewService.getYamlFileUrl(),repository:this.viewService.getRepository(),sourceProvider:this.viewService.getSourceProvider()}))}_getEditorPage(){return l.createElement(K.Page,{className:i},this._getHeader(),l.createElement($.Observer,{content:this.viewService.getYamlContent()},(({content:e})=>l.createElement(Fe.NewYamlTab,{content:e,editor:this._editor,onContentUpdated:e=>this.viewService.setYamlContent(e),onEditorCreated:this._onEditorCreated,onEditorDisposing:this._onEditorDisposing,sidePanelInitiallyOpen:!0,codeLensOptions:this.actionsService.canValidate()?{onOpenTemplate:this.actionsService.openTemplate,onValidate:()=>this.actionsService.showValidationPanel(),checkTemplate:this.actionsService.checkTemplate}:{}}))))}_getHeader(){return l.createElement(l.Fragment,null,l.createElement($.Observer,{error:this.viewService.getEditorError(),isRunning:this.actionsService.getIsRunning(),isSaving:this.actionsService.getIsSaving(),isYamlDirty:this.viewService.getIsYamlDirty()},(({error:e,isRunning:t,isSaving:i,isYamlDirty:s})=>{var a;return l.createElement(Ne.NewEditorHeader,{definition:this.viewService.getDefinition(),isYamlDirty:s,actionButtonLabel:this.viewService.getIsTemplate()?ce.SaveButtonLabel:s?ce.ValidateAndSaveButtonLabel:ce.RunButtonLabel,actionDisabled:!!e||t||i,onActionClick:this.viewService.getIsTemplate()?()=>this.actionsService.showSavePanel():s?()=>this.actionsService.showValidateAndSavePanel():()=>this.actionsService.showQueuePanel(),onSaveWithoutValidationClick:()=>this.actionsService.showSavePanel(),onFullYaml:()=>this.actionsService.downloadYaml(),onRunWithParameters:()=>this.actionsService.runBuildWithParameters(),onSettingsOpen:()=>this.actionsService.showSettingsPanel(),onValidateYaml:()=>this.actionsService.showValidationPanel(),onVariablesOpen:()=>this.actionsService.showVariablesPanel(),buildMessageInfo:this.actionsService.getBuildMessage(),onBuildMessageDismissed:()=>this.actionsService.dismissBuildMessage(),errorMessage:null==e?void 0:e.message,errorActions:e&&this.getErrorActions(e),onErrorMessageDismissed:(null==e?void 0:e.isDismissable)?()=>this.viewService.clearEditorError():void 0,title:(null===(a=this.viewService.getDefinition())||void 0===a?void 0:a.name)||ce.EditorDefaultTitle})})),l.createElement($.Observer,{canSwitch:this.actionsService.canSwitchToAppConnection(),canInstall:this.actionsService.canInstallApp()},(()=>{const e=[];let t;if(this.actionsService.canSwitchToAppConnection().value)t=T.PreferAppConnectionChange,e.push({text:T.ChangeToAppConnection,onClick:()=>this.actionsService.switchToAppConnection()});else{if(!this.actionsService.canInstallApp().value)return null;t=T.PreferAppConnectionInstall,e.push({text:T.InstallApp,onClick:()=>this.actionsService.installApp()})}const i=this.viewService.getConnection();return l.createElement("div",{className:"page-content flex-row flex-noshrink"},l.createElement(P.MessageCard,{className:"flex-grow",severity:"Info",onDismiss:()=>this.actionsService.dismissAppConnectionRecommendations(),buttonProps:e},l.createElement(f.FormatComponent,{format:t},l.createElement(b.FPSLink,{href:i.appHelpLink},i.appName))))})))}getErrorActions(e){if(e.proposeClassicDesigner){const e=Number(this.historyService.getState().pipelineId),t=this.buildLinkingService.getDefinitionEditUrl(e,de.LegacyDesignerTabKeys.Yaml);return[{text:ce.EditInOldDesigner,href:t}]}return e.proposeAuthorizeAndRun?[{primary:!0,text:ce.AuthorizeAndRunButtonText,onClick:()=>{this.actionsService.authorizeAndRun()}}]:[]}get breadcrumbService(){return this.context.pageContext.getService("pipeline-editor-breadcrumb-service")}get buildLinkingService(){return this.context.pageContext.getService("IBuildLinkingService")}get historyService(){return this.context.pageContext.getService("IVssHistoryService")}}const i="pipeline-editor-view bolt-page-grey flex-column flex-grow";v.Components.add("new-ci-designer-editor-view",e)}(),function(e){Ve=t[e]={},t[e].WizardList=function(e){const t=(i,s,a,n)=>{const r=s.children&&0!==s.children.length;return l.createElement(d.ListItem,{key:n||"list-item"+i,index:i,details:a},l.createElement("div",{className:(0,v.css)("flex-row flex-grow cursor-pointer scroll-hidden",r&&"flex-center")},(e=>e.iconUrl?l.createElement(E.Image,{className:(0,v.css)("list-image",e.iconClass),src:e.iconUrl,alt:e.iconAltText||""}):e.iconName?l.createElement(c.Icon,{className:(0,v.css)("list-icon",e.iconClass),iconName:e.iconName}):null)(s),l.createElement("div",{className:"list-content flex-column flex-grow scroll-hidden"},l.createElement("div",{className:"flex-row flex-grow flex-center"},l.createElement("span",{className:"body-m text-ellipsis"},s.name),(e=>{if(e&&e.labels)return l.createElement(X.PillGroup,null,e.labels.map(((e,t)=>l.createElement(Q.Pill,{className:(0,v.css)("list-item-label",0===t&&"list-item-label-first"),size:0,key:t,excludeTabStop:!0,excludeFocusZone:!0},e))))})(s)),s.renderDescription?s.renderDescription():l.createElement("span",{className:"body-s secondary-text"},s.description)),r&&((o=s.children)&&0!==o.length?l.createElement("div",{className:"flex-column"},l.createElement(C.ExpandableButton,{text:ce.MoreOptions,renderCallout:(i,s,a,n,r,c,p)=>{const m=new h.ArrayItemProvider(o);return l.createElement(O.Callout,{anchorElement:a,anchorOffset:n,anchorOrigin:r,anchorPoint:c,calloutOrigin:p,onDismiss:i.collapse,escDismiss:!0,blurDismiss:!0,lightDismiss:!0,contentShadow:!0},l.createElement(d.List,{className:"wizard-list-children",itemProvider:m,onActivate:(t,i)=>{t.preventDefault(),e.onClick(t,i)},singleClickActivation:!0,renderRow:t,id:"children-list-id"}))}})):null),s.isFavorite&&l.createElement(c.Icon,{className:"favorite-icon",iconName:"FavoriteStarFill"})));var o},i=new h.ArrayItemProvider(e.wizardListItems);return l.createElement(d.List,{className:"wizard-list",itemProvider:i,onActivate:e.onClick,singleClickActivation:!0,renderRow:t,renderLoadingRow:(t,i)=>(e.loadMore&&e.loadMore(),l.createElement(d.ListItem,{className:"bolt-list-row-loading",details:i,index:t},l.createElement("div",{className:"flex-grow margin-16"},l.createElement(g.Spinner,{size:"large"})))),width:"100%",id:"parent-list-id"})}}("WizardList"),function(e){t[e]={};class s extends v.VssComponent{constructor(e,t){super(e,t),this._filterBarRef=l.createRef(),this._ttiMarked=!1,this.renderRepositoryList=()=>{const e=this._getFilteredRepositories();return l.createElement(Ve.WizardList,{wizardListItems:this._mapToWizardListItems(e),loadMore:this.loadMore,onClick:(t,i)=>{const s=e[i.index];this._onRepoSelected(s,a(s.properties))}})},this._mapToWizardListItems=e=>{var t;const s=e.map((e=>{const t=[];let i;n(e,"isFork")&&t.push(ce.RepositorySelectorTagFork),n(e,"isPrivate")&&t.push(ce.RepositorySelectorTagPrivate);const s=e.properties&&e.properties.lastUpdated;if(s){!isNaN(Date.parse(s))?i=new Date(s):(0,ee.traceWarning)(this.context.pageContext,"vss-build-web.designer","RepositorySelector",(0,o.format)("{0} repository lastUpdated property '{1}' is not a recognized date string",this.props.sourceProvider,s))}return{name:e.fullName,iconUrl:this.getRepositoryIconUrl(e),iconName:this.getRepositoryIconName(),iconClass:(0,v.css)("rounded-corners",this.getRepositoryIconClass()),labels:t,isFavorite:n(e,"isFavorite"),renderDescription:()=>i?l.createElement(te.Ago,{className:"body-s secondary-text",date:i,format:0}):l.createElement(l.Fragment,null)}}));return(null===(t=this.state.repositoryList)||void 0===t?void 0:t.continuationToken)&&s.push(new i.ObservableValue(void 0)),s},this._onFilterChanged=(e,t)=>{if(e.hasOwnProperty("filterText")){const t=e.filterText&&e.filterText.value||"",i=this._filterNoReposFound(this.state.repositories||[],t);this.setState({filterText:t,filterNoReposFound:i,footerText:this.getFooter(i,!(!this.state.repositoryList||!this.state.repositoryList.continuationToken))},(()=>this.props.onRepositoryListUpdate("ReposFilter",{repoCount:this._getFilteredRepositories().length,filterText:t})))}if(e.hasOwnProperty("filterType")&&e.filterType&&e.filterType.value){const t=e.filterType&&e.filterType.value&&e.filterType.value[0];t&&t.key!==this.state.resultSet&&this.setState({resultSet:t.key,footerText:void 0},(()=>{this._fetchRepositories()}))}},this._getFilterItems=()=>this.state.filterTypes||this.getFilterItems(),this._getFilterItem=e=>({name:e.displayName,key:e.key}),this._onRepositoryListReceived=(e,t)=>{if(this._mounted&&t===this.state.resultSet&&e){if(e.repositories&&this.props.autoSelectRepositoryId){const t=e.repositories.find((e=>e.id===this.props.autoSelectRepositoryId));if(t)return this.props.onSelectRepository(t,a(t.properties)),void this._markTTI()}const i={},s=(this.state.repositories||[]).concat(e.repositories);let n;this._updateFilterDropdown(t)&&(i.filterTypes=e.resultSets||this.getFilterItems(),i.filterTypes&&i.filterTypes.length>0&&(n=()=>{const t=e.currentResults&&e.currentResults.key,s=i.filterTypes.find((e=>e.key===t))||this.state.resultSet,a={value:s&&[s]};this._filter.setDefaultState({filterType:a}),this._filter.setFilterItemState("filterType",a)})),s.sort(this.compareRepositories);const r=this._filterNoReposFound(s,this.state.filterText||"");i.filterNoReposFound=r,i.footerText=this.getFooter(r,!1),this.props.onRepositoryListUpdate("ReposLoaded",{resultSet:t&&t.toString(),repoCount:s.length,duration:this._timer?(new Date).getTime()-this._timer.getTime():-1}),i.repositoryList=e,i.repositories=s,this.setState(i,n),this._markTTI()}},this.loadMore=()=>{const{repositoryList:e,resultSet:t}=this.state;(null==e?void 0:e.continuationToken)&&this.listRepositories(this.state.projectId,this.props.sourceProvider,this.props.connectionId,t,!0,null==e?void 0:e.continuationToken).then((e=>this._onRepositoryListReceived(e,t)))},this._onRepoSelected=(e,t)=>{this.props.onSelectRepository(e,t)},this._getFilteredRepositories=()=>this.state.repositories?this.state.filterText?this._filterRepositories(this.state.repositories,this.state.filterText):this.state.repositories:[],this._markTTI=()=>{this.props.onTTI&&!this._ttiMarked&&(this._ttiMarked=!0,this.props.onTTI())},this._client=this.context.pageContext.getRestClient("IBuildRestClient");const s=this.context.pageContext.getService("ITfsPageService").getData();this.state={projectId:s.project.id,projectName:s.project.name,filterText:void 0,filterTypes:void 0,footerText:void 0,filterNoReposFound:!1,repositories:[],repositoryList:void 0,resultSet:1};const r=this.getFilterItems()[0];this._filter=new ne.Filter({defaultState:{filterType:{value:r?[r]:void 0}}}),this._filter.subscribe(this._onFilterChanged,ne.FILTER_CHANGE_EVENT)}render(){return l.createElement("div",{className:this.getClassName("repository-selection")},l.createElement("div",{className:"header-section"},l.createElement("div",{className:"subheader body-m secondary-text"},ce.NewPipeline),l.createElement("div",{className:"header title-l"},ce.RepositorySelectorTitle)),l.createElement(ie.FilterBar,{filter:this._filter,ref:this._filterBarRef},l.createElement(ae.KeywordFilterBarItem,{filterItemKey:"filterText",placeholder:ce.RepositorySelectorFilterPlaceholder,throttleWait:400}),this._showFilterDropdown()&&l.createElement(se.PickListFilterBarItem,{filterItemKey:"filterType",getListItem:this._getFilterItem,getPickListItems:this._getFilterItems,selectionMode:Z.SelectionMode.single})),this.state.repositoryList&&this.renderRepositoryList(),this.state.footerText&&l.createElement("div",{className:"repository-picker-footer flex-row flex-start"},l.createElement("div",{className:"flex-self-start"},l.createElement(c.Icon,{iconName:"Error",className:"repository-picker-footer-icon"})),l.createElement("div",{className:"repository-picker-footer-text flex-grow scroll-hidden"},this.state.footerText)))}componentDidMount(){this._mounted=!0,this._fetchRepositories()}componentWillUnmount(){this._mounted=!1}getClassName(e){return e}getFilterItems(){return[]}getFooter(e,t){if(e){const e=this.getFooterLink();return l.createElement(l.Fragment,null,l.createElement("span",null,ce.RepositorySelectorNoneFoundDescription," "),e&&l.createElement(f.FormatComponent,{format:ce.RepositorySelectorProvideAccessDescription},l.createElement(D.Link,{href:e},ce.RepositorySelectorProvideAccessDescriptionLink)))}}getFooterLink(){}getRepositoryIconUrl(e){return e&&e.properties&&e.properties.ownerAvatarUrl}getRepositoryIconName(){return"GitLogo"}getRepositoryIconClass(){}compareRepositories(e,t){const i=Date.parse(e.properties.lastUpdated),s=Date.parse(t.properties.lastUpdated)-i;return isNaN(s)?0:s}getRepositories(e,t,i,s,a){throw new Error("getRepositories() not implemented")}checkIsMounted(){return this._mounted}autoSelectConnection(){return!0}_showFilterDropdown(){return this.getFilterItems().length>0||Boolean(this.state.filterTypes&&this.state.filterTypes.length>0)}_updateFilterDropdown(e){return this.autoSelectConnection()&&void 0!==e&&!this.isCustomResultSetFilter(e)}_fetchRepositories(){this._timer=new Date,this.setState({footerText:void 0,repositories:[],resultSet:this.state.resultSet});const e=this.state.resultSet;this.listRepositories(this.state.projectId,this.props.sourceProvider,this.props.connectionId,e,!0).then((t=>{this._onRepositoryListReceived(t,e)}),(e=>{this.props.onErrorMessage(ce.InvalidServiceConnection),this.setState({footerText:this.getFooter(!0,!1)})}))}listRepositories(e,t,i,s,a,n){return this.autoSelectConnection()||void 0!==s&&this.isCustomResultSetFilter(s)?this.getRepositories(i,void 0,s,a,n):this._client.listRepositories(e,t,i,void 0,s,a,n)}isCustomResultSetFilter(e){return"string"==typeof e}_filterRepositories(e,t){if(e){const i=t.trim().toLowerCase();return e.filter((e=>-1!==e.fullName.toLowerCase().indexOf(i)))}return e}_filterNoReposFound(e,t){return 0===this._filterRepositories(e,t).length}}function a(e){const t=t=>e&&e[t];return{isFork:t("isFork"),isPrivate:t("isPrivate"),externalOwnerId:t("ownerId"),externalOwnerName:t("orgName"),externalOwnerIsAUser:t("ownerIsAUser"),repositoryUrl:t("manageUrl"),safeRepository:t("safeRepository"),hasAdminPermissions:t("hasAdminPermissions")}}function n(e,t){const i=e&&e.properties&&e.properties[t];return!(!i||"true"!==i.toLowerCase())}t[e].RepositorySelector=s}("RepositorySelector"),function(e){Be=t[e]={};const i="bringYourOwn";class a extends v.VssComponent{constructor(e,t){super(e,t),this._selectTemplate=(e,t,s)=>{const a=e&&e.parameters&&e.parameters.filter((e=>!!e))||[];a.length>0?(e.parameters=a,this.setState({progress:0,incompleteTemplate:{template:e,repoAnalysis:t,configuration:s},requiredInfoPanelIsOpen:!0})):(null==e?void 0:e.id)===i?this._onTemplateSelected(e,t,void 0):this.setState({progress:0,incompleteTemplate:{template:e,repoAnalysis:t,configuration:s}},(()=>this._completeTemplate({})))},this._completeTemplate=async e=>{if(this.state.incompleteTemplate){const t=this.state.incompleteTemplate,i=this._getTemplateParameters(t.template);this.setState({renderingTemplate:!0}),this._creatingResources=!0,this.monitorAndUpdateProgress(),this._recordTelemetryInfo("CreatingResources");const s=this._parseResponse(await this._createRequiredResources(e));this._createdResources=!0,this._recordTelemetryInfo("WaitingForEndpointsToBeReady");const a=(t.template.parameters||[]).filter((e=>e.type.startsWith("endpoint")||e.type.toLocaleLowerCase()===de.TemplateParameterTypes.KubernetesResource.toLocaleLowerCase())),n=[];a.forEach((e=>{e.type.toLocaleLowerCase()===de.TemplateParameterTypes.KubernetesResource.toLocaleLowerCase()?n.push(re.EndpointHelper.getEndpointStatus(s[de.TemplateConstants.K8sConnectionKey].Id,this.context.pageContext)):n.push(re.EndpointHelper.getEndpointStatus(s[e.name].Id,this.context.pageContext))}));try{await Promise.all(n),this.setState({progress:.8})}catch(e){const t=JSON.parse(e);this._recordTelemetryInfo("WaitingForEndpointsToBeReadyFailed",{endpoint:t.endpointId}),this._handleError(t.error)}try{this._recordTelemetryInfo("RenderingTemplateWithValues"),this._endpointStatusCompleted=!0,await this._renderAndSelectTemplate(Object.assign(Object.assign(Object.assign({},e),i),s),t.template,t.repoAnalysis,t.configuration),this._recordTelemetryInfo("RenderingTemplateWithValuesSucceeded")}catch(e){this._recordTelemetryInfo("RenderTemplateWithValuesFailed",{error:e}),this._handleError(e)}}},this._renderAndSelectTemplate=async(e,t,i,s)=>{const a=this.context.pageContext.getService("IBuildTemplateService"),n=await a.renderTemplate(this.props.wizardState,e);if(n.exception)return this.setState({renderingTemplate:!1}),this._recordTelemetryInfo("RenderTemplateWithValuesFailed",{error:n.exception}),void this._handleError(n.exception);t.content=n.content,t.assets=n.assets,this._fetchedCustomizedTemplates=!0,this._onTemplateSelected(t,i,s)},this._createRequiredResources=async e=>{let t={},i={};const s=this.state.incompleteTemplate&&this.state.incompleteTemplate.template.parameters?this.state.incompleteTemplate.template.parameters:[];let a=!1;if(s.forEach((i=>{i.type.toLocaleLowerCase().startsWith("endpoint:")?t[i.name]={resourcetocreate:e[i.name],type:i.type}:i.type.toLocaleLowerCase()===de.TemplateParameterTypes.KubernetesResource.toLocaleLowerCase()&&(t[de.TemplateConstants.K8sConnectionKey]={resourcetocreate:e[i.name],type:de.TemplateRequiredConstants.KubernetesEndpoint},a=!0)})),!t)return Promise.resolve({});const n=this.context.pageContext.getService("IVssContributionService"),r="ms.vss-build-web.create-resources-data-provider";try{const e=await n.getDataAsync(r,t)||{};if(Object.keys(e).forEach((t=>i[t]=e[t])),a){const t=await re.EndpointHelper.generateAuxillaryResourcesForEndpoints(s,e,this.props.wizardState);if(t){const e=await n.getDataAsync(r,t)||{};Object.keys(e).forEach((t=>i[t]=e[t]))}}}catch(e){this._handleError(e)}return Promise.resolve(i)},this._parseResponse=e=>{const t=this.context.pageContext.getService("IVssContributionService").getDataProviderExceptions()["ms.vss-build-web.create-resources-data-provider"];return t?(this._handleError(t),{}):e},this._getTemplateParameters=e=>({[de.TemplateConstants.TemplateIdKey]:e.id,[de.TemplateConstants.RepositoryNameKey]:this.props.wizardState.repositoryName}),this._onTemplatesRetrieved=(e,t)=>{t!==n.templatesRetrieved||this._templatesFetched?t===n.templatesRetrievedFail&&this._handleError(e&&e.exception):(this._templatesFetched=!0,this._recommendedConfigPath=e.configurationPath,this._mounted&&this.setState({progress:this.state.progress+a.s_progressBarTemplateResults}))},this._showFileSelectPanel=()=>{this.setState({fileSelectPanelIsOpen:!0})},this._dismissFileSelectPanel=()=>{this.setState({fileSelectPanelIsOpen:!1})},this._dismissRequiredInfoPanel=()=>{this.setState({requiredInfoPanelIsOpen:!1})},this._onTemplateSelected=(e,t,s,a)=>{e&&e.id===i?this._showFileSelectPanel():!this.state.errorMessage&&this.props.onTemplateSelected(e,t,s,a,this._recommendedConfigPath)},this._normalizeHTML=async e=>this._markdownPromise.then((()=>this.context.pageContext.getService("IHtmlNormalizerService").normalizeStripAttributes(e))),this._recordTelemetryInfo=(e,t)=>{let i="";this.state.incompleteTemplate&&(i=this.state.incompleteTemplate.template.id);const s=Object.assign({action:e,template:i},t);this.context.pageContext.getService("IVssTelemetryService").publishEvent("Build","CreatePipeline",s)},this.state={progress:0,loadComplete:!1,errorMessage:"",fileSelectPanelIsOpen:!1,requiredInfoPanelIsOpen:!1,renderingTemplate:!1},this._progressTicker=this._getPromiseTicker(),this._existingConfigFileFetched=!1,this._creatingResources=!1,this._createdResources=!1,this._endpointStatusCompleted=!1,this._fetchedCustomizedTemplates=!1,this.context.pageContext.getService("IVssPerformanceService").startScenario(he.PageLoadScenarios.Templates,!1)}render(){const e=this.context.pageContext.getService("IBuildTemplateService"),t=!!this.state.incompleteTemplate&&!!this.state.incompleteTemplate.template.parameters&&this.state.incompleteTemplate.template.parameters;return l.createElement("div",{className:"template-selector"},l.createElement("div",{className:"header-section"},l.createElement("div",{className:"subheader body-m secondary-text"},ce.NewPipeline),l.createElement("div",{className:"header title-l"},ce.ConfigureYourPipeline)),!this.state.renderingTemplate&&l.createElement(l.Fragment,null,this.state.errorMessage&&this.state.loadComplete&&l.createElement(P.MessageCard,{severity:"Error"},l.createElement("span",{dangerouslySetInnerHTML:{__html:this.state.errorMessage}})),l.createElement($.UncheckedObserver,{templateData:e},l.createElement(o,{sourceProvider:this.props.wizardState.sourceProvider,templateData:void 0,loadComplete:this.state.loadComplete,onTemplateSelected:this._selectTemplate,progress:this.state.progress})),this.state.fileSelectPanelIsOpen&&l.createElement(v.WrappedComponent,{wrappedType:"designer-file-select-panel",dependencies:["ms.vss-build-web.designer-extensions.file-select-panel"],wrappedProps:{wizardState:this.props.wizardState,isOpen:this.state.fileSelectPanelIsOpen,onDismiss:this._dismissFileSelectPanel,onTemplateSelected:this._onTemplateSelected}}),!!t&&t.length>0&&this.state.incompleteTemplate&&l.createElement(v.WrappedComponent,{wrappedType:"designer-required-template-info-panel",dependencies:["ms.vss-build-web.designer-extensions.required-template-info-panel"],wrappedProps:{template:this.state.incompleteTemplate.template,requires:t,isOpen:this.state.requiredInfoPanelIsOpen,onRequiredTemplateInfoCompleted:this._completeTemplate,onDismiss:this._dismissRequiredInfoPanel,onError:this._handleError}})),this.state.renderingTemplate&&l.createElement(l.Fragment,null,this.state.errorMessage&&l.createElement(P.MessageCard,{severity:"Error"},l.createElement("span",{dangerouslySetInnerHTML:{__html:this.state.errorMessage}})),!this.state.errorMessage&&l.createElement(l.Fragment,null,l.createElement("div",null,ce.ConfiguringYourPipelineAndGeneratingYaml),l.createElement(oe.ProgressIndicator,{className:"progress",percentComplete:this.state.progress}))))}componentDidMount(){this._mounted=!0,this._existingConfigFileFetched=!1;const e=this.context.pageContext.getService("IVssContributionService");e.getDataAsync("ms.vss-build-web.existing-configuration-data-provider",this.props.wizardState).then((e=>{this._existingConfigFileFetched=!0,e?(this.props.onTemplateSelected(void 0,void 0,e),this._progressTicker=Promise.resolve()):this._mounted&&this.setState({progress:this.state.progress+a.s_progressBarExistingResults,loadComplete:this._existingConfigFileFetched})})),this._templatesFetched=!1;const t=this.context.pageContext.getService("IBuildTemplateService");t.subscribe(this._onTemplatesRetrieved),t.getTemplates(this.props.wizardState),this._markdownPromise=e.getContributionAsync("ms.vss-features.markdown")}componentWillUnmount(){super.componentWillUnmount();this.context.pageContext.getService("IBuildTemplateService").unsubscribe(this._onTemplatesRetrieved),this._mounted=!1}monitorAndUpdateProgress(){let e;return e=this._fetchedCustomizedTemplates?a.s_progressBarMax:this._endpointStatusCompleted?.75:this._createdResources?.5:.25,!this.state.errorMessage&&this.state.progress<a.s_progressBarMax?new Promise((()=>setTimeout((()=>{let t=this.state.progress+a.s_progressBarStep;t=t<e?t:e,this._mounted&&(this.setState({progress:t}),this.monitorAndUpdateProgress())}),100))):Promise.resolve()}_getPromiseTicker(){return this._existingConfigFileFetched&&this._templatesFetched||!(this.state.progress<a.s_progressBarMax)?Promise.resolve():new Promise((()=>setTimeout((()=>{this._mounted&&this.setState({progress:this.state.progress+a.s_progressBarStep}),this._progressTicker=this._getPromiseTicker()}),100)))}_handleError(e){let t="";this._mounted&&e&&(e.message?t=e.message:"string"==typeof e&&(t=e),this._normalizeHTML(t).then((e=>{this.setState({errorMessage:e})})))}}var n;t[e].TemplateSelector=a,a.s_progressBarMax=.99,a.s_progressBarExistingResults=.3*a.s_progressBarMax,a.s_progressBarTemplateResults=.3*a.s_progressBarMax,a.s_progressBarStep=(a.s_progressBarMax-a.s_progressBarExistingResults)/55,function(e){e.templatesRetrieved="templatesRetrieved",e.templatesRetrievedFail="templatesRetrievedFail"}(n||(n={}));class r extends s.VssObservableService{getTemplates(e){const t=this.pageContext.getService("IVssContributionService"),i="ms.vss-build-web.recommended-configuration-data-provider";t.getDataAsync(i,e).then((e=>{if(e)this._notify(e,n.templatesRetrieved,!1);else{const e={templates:[],configurationPath:"",exception:t.getDataProviderExceptions()[i]};this._notify(e,n.templatesRetrievedFail,!1)}}))}renderTemplate(e,t){const i=this.pageContext.getService("IVssContributionService"),s="ms.vss-build-web.customized-template-data-provider",a={templateParameters:t,validateAssets:!0,sourceProviderType:e.sourceProvider,repositoryId:e.repositoryId||e.repositoryName,connectionId:e.connectionId,branch:e.branch};return i.getDataAsync(s,a).then((e=>e||{content:"",exception:i.getDataProviderExceptions()[s]}))}}t[e].TemplateService=r;class o extends v.VssComponent{constructor(e,t){super(e,t),this._ttiMarked=!1,this._showAllTemplates=()=>{this.setState({showAllTemplates:!0})},this.state={showAllTemplates:!1}}render(){let e,t=[],s=[];const a={content:"",id:i,name:ce.BringYourOwnYamlTitle,description:ce.BringYourOwnYamlDesc,recommendedWeight:0};if(this.props.templateData){for(let i=0;i<this.props.templateData.templates.length;++i){const n=this.props.templateData.templates[i];n.id!==o.s_empty?n.recommendedWeight>0?s.push(n):t.push(n):(e=n,a.iconUrl=e.iconUrl)}t=this._sortTemplatesByName(t),s=this._sortTemplatesByWeight(s),e&&s.push(e),s.length>0&&s.push(a)}if(!this.props.templateData||!this.props.loadComplete)return l.createElement("div",{className:"analyzing-container"},l.createElement("div",null,ce.RepositoryAnalyzing),l.createElement("div",null,l.createElement(oe.ProgressIndicator,{className:"progress",percentComplete:this.props.progress})));const n=this.state.showAllTemplates?s.concat(t):s,r={recommendTemplate:n[0],suggestedTemplates:s};return n.length>0?l.createElement("div",{className:"template-view flex-column"},l.createElement(Ve.WizardList,{wizardListItems:this._mapToWizardListItems(n),onClick:(e,t)=>{this.props.onTemplateSelected(n[t.index],r)}}),!this.state.showAllTemplates&&l.createElement(C.Button,{className:"all-templates-button flex-self-start",onClick:this._showAllTemplates},ce.ShowMore)):l.createElement("div",null)}componentDidMount(){super.componentDidMount(),this._ttiMarked||(this._ttiMarked=!0,this.context.pageContext.getService("IVssPerformanceService").endScenario(he.PerformanceConstants.Area,he.PageLoadScenarios.Templates,!1))}_sortTemplatesByName(e){return e&&e.length>0?e.sort(((e,t)=>{const i=e&&e.name?e.name:"",s=t&&t.name?t.name:"";return i.localeCompare(s,navigator.language)})):e}_sortTemplatesByWeight(e){return e&&e.length>0?e.sort(((e,t)=>{const i=e&&e.recommendedWeight?e.recommendedWeight:0,s=t&&t.recommendedWeight?t.recommendedWeight:0;if(i==s){const i=e&&e.name?e.name:"",s=t&&t.name?t.name:"";return i.localeCompare(s,navigator.language)}return s-i})):e}_mapToWizardListItems(e){return e.map((e=>({name:e.name,description:e.description,iconUrl:e.iconUrl,iconName:"FileCode"})))}}o.s_empty="empty",s.Services.add("IBuildTemplateService",{serviceFactory:r,options:2})}("TemplateSelector"),function(e){Le=t[e]={};class i extends v.VssComponent{constructor(e,t){super(e,t),this._renderHeader=()=>{const e=this._isDirty()||this._isNewFile();return l.createElement("div",{className:"ci-editor-header header-section flex-row"},l.createElement("div",{className:"scroll-hidden"},l.createElement("div",{className:"subheader body-m secondary-text"},ce.NewPipeline),l.createElement("div",{className:"title-l text-ellipsis"},ce.ReviewYourPipelineYAML)),l.createElement("div",{className:"ci-editor-action-buttons flex-self-end"},this.state.isRunning?l.createElement(g.Spinner,{className:"loading-indicator",orientation:0,label:ce.CreatingPipeline}):l.createElement(N.ButtonGroup,null,this._isVariablesPanelEnabled&&l.createElement(C.Button,{className:"ci-editor-action-button",text:ce.CommandVariables,primary:!1,disabled:this.state.isRunning,onClick:this._showPipelineVariablesPanel}),l.createElement(G.SplitButton,{primary:!0,disabled:!this.state.isEditorReady||!this.state.content||this.state.isRunning,buttonProps:{className:(0,m.css)("ci-editor-action-button",de.EditorConstants.ElementToFocusOnEscape),text:e?ce.SaveAndRunButtonLabel:ce.RunButtonLabel,onClick:this._onSaveAndRunClick},menuButtonProps:{contextualMenuProps:{menuProps:{id:"saveSubmenu",items:[{id:"saveOnly",text:ce.SaveButtonLabel,disabled:this.state.isRunning,onActivate:this._onSaveOnlyClick}]}}}}))))},this._navigateAwayHandler=e=>{this._isDirty()&&(e.returnValue=ce.ConfirmLosingUnsavedChange)},this._onHistoryChanged=e=>{this._isDirty()&&!confirm(ce.ConfirmLosingUnsavedChange)||(this._switchHistoryChangeHandler(this._onHistoryChanged,this.props.onHistoryChanged),this.props.onHistoryChanged(e))},this._onEditorCreated=e=>{e&&(this._editor=e,e.focus(),this.setState({isEditorReady:!0}))},this._onYamlContentUpdated=e=>{e!==this.state.content&&this.setState({content:e})},this._onFileNameChanged=e=>{e!==this.state.fileName&&this.setState({fileName:e})},this._showPipelineVariablesPanel=()=>{this.setState({variablesPanelIsOpen:!0})},this._dismissPipelineVariablesPanel=()=>{this.setState({variablesPanelIsOpen:!1})},this._onSavePipelineVariables=e=>{this.setState({variables:e}),this._dismissPipelineVariablesPanel()},this._showSavePanel=()=>{const e=this._editor&&this._editor.getValue()||"";this.setState({content:e,savePanelIsOpen:!0,isSaving:!1},(()=>this.props.onAction("ShowSavePanel")))},this._saveAndRunPipeline=()=>{this._ensureEditorIsReadOnly(!0),this.setState({isRunning:!0,errorMessage:""});const e={sourceProviderType:this.props.wizardState.sourceProvider,connectionId:this.props.wizardState.connectionId,id:this.props.wizardState.repositoryId,name:this.props.wizardState.repositoryName,defaultBranch:this.props.wizardState.branch},t=this.state.sourceBranch,i=this.state.savedFileInfo,s=this.state.fileName,a=this.props.wizardState.pipelinePath,n=this.state.variables,r=!this._runAfterSaving;let l=(0,w.isFeatureFlagEnabled)(this.context.pageContext,"Build2.NewDefaultQueue",!1)?"Azure Pipelines":"Hosted Ubuntu 1604";const c=this.context.pageContext.getService("IPipelineService");c.createAndRunPipeline(e,s,t,i,a,n,r,l).then((e=>{if(e){if(e.pipeline){const i=this.context.pageContext.getService("ITfsPageService").getData().project.id||o.EmptyGuidString,s=(0,o.format)("{0}:{1}",i,e.pipeline.id);this.props.onAction("PipelineCreated",{ProjectAndPipelineId:s}),this.props.onAction("Run",{yamlWasEdited:this._lastSavedContent!==this.props.content}),this.setState({pipelineCreated:e.pipeline}),r&&this._gotoEmptySummaryPage(e.pipeline.id,t)}e.pipelineBuildWebUrl&&this.props.redirectToPipeline(e.pipelineBuildWebUrl),e.queuePipelineErrorMessage&&this._handleRunError(e.queuePipelineErrorMessage)}const i=c.getPipelineErrorMessage();i&&this._handleRunError(i)}))},this._onDataProviderQueryEnd=e=>{if(e.dataProviderExceptions){const t=e.dataProviderExceptions["ms.vss-build-web.create-and-run-pipeline-data-provider"];t&&this._handleRunError(t.message)}},this._onSaveAndRunClick=()=>{this._save(!0)},this._onSaveOnlyClick=()=>{this._save(!1)},this._save=e=>{this._runAfterSaving=e;this._isDirty()||this._isNewFile()?this._showSavePanel():this._saveAndRunPipeline()},this._saveYamlAndPipeline=e=>{this._ensureEditorIsReadOnly(!0),this.setState({saveErrorMessage:"",isSaving:!0},(()=>this.props.onAction(e.createNewBranch?"SavePR":"SaveCommit")));const t=this._editor&&this._editor.getValue()||"",i={connectionId:this.props.wizardState.connectionId,sourceProviderType:this.props.wizardState.sourceProvider,id:this.props.wizardState.repositoryId,projectId:this.props.wizardState.repositoryProjectId};e.skipCi=!0;const s=this.context.pageContext.getService("IYamlFileService"),a=this._isNewFile()?"":this._lastSavedSha;if(this.props.additionalFiles){const n=[{path:this.state.fileName,content:t,oldObjectId:a},...this._mapToCommitFileInfo(this.props.additionalFiles)];s.commitFiles(i,this.props.wizardState.branch,n,e).then((e=>{this._onYamlSaved(e,t)}),(e=>{this._handleSaveError(e.message)}))}else s.commitFile(i,this.props.wizardState.branch,this.state.fileName,t,e,a).then((e=>{this._onYamlSaved(e,t)}),(e=>{this._handleSaveError(e.message)}))},this._onYamlSaved=(e,t)=>{this._lastSavedContent=t,this._lastSavedSha=e.objectId,this._lastSavedFileName=this.state.fileName,this.setState({isSaving:!1,sourceBranch:e.branch,savedFileInfo:e},(()=>{this._saveAndRunPipeline()}))},this._dismissSavePanel=()=>{this.state.isSaving||this.setState({saveErrorMessage:"",savePanelIsOpen:!1})},this._handleRunError=e=>{this.setState({isRunning:!1,savePanelIsOpen:!1,errorMessage:e})},this._handleSaveError=e=>{this.setState({saveErrorMessage:e,isSaving:!1,isRunning:!1,savePanelIsOpen:!0}),this._ensureEditorIsReadOnly(!1)},this._mapToFileListItems=e=>e.map((e=>({name:e.destinationPath,description:e.description,type:this._getFileType(e.path)}))),this._getFileType=e=>(0,o.endsWith)(e,"yml",!0)?ue.FileType.Yaml:ue.FileType.Other,this._mapToCommitFileInfo=e=>e.map((e=>({path:e.destinationPath,content:e.content,oldObjectId:""}))),this._editorIsReadOnly=!1,this._lastSavedContent=e.content||"",this._lastSavedSha=e.contentSha||"",this._lastSavedFileName=this._trimPath(this.props.path),this._runAfterSaving=!0,this._isVariablesPanelEnabled=!(0,w.isFeatureFlagEnabled)(t.pageContext,"Build2.DisableYamlEditorVariables",!1),this.state={content:this._lastSavedContent,fileName:this._lastSavedFileName,sourceBranch:"",isEditorReady:!1,isRunning:!1,savePanelIsOpen:!1,isSaving:!1,saveErrorMessage:"",errorMessage:"",variables:{},variablesPanelIsOpen:!1,pipelineCreated:void 0,savedFileInfo:void 0}}componentDidMount(){window.addEventListener("beforeunload",this._navigateAwayHandler);this.context.pageContext.getService("IVssContributionService").subscribe(this._onDataProviderQueryEnd,"dpqCompleted"),this._switchHistoryChangeHandler(this.props.onHistoryChanged,this._onHistoryChanged)}componentWillUnmount(){window.removeEventListener("beforeunload",this._navigateAwayHandler);this.context.pageContext.getService("IVssHistoryService").unsubscribe(this._onHistoryChanged);this.context.pageContext.getService("IVssContributionService").unsubscribe(this._onDataProviderQueryEnd,"dpqCompleted")}render(){const e=this._getSourceProvider(),t=!(0,o.equals)(this.props.wizardState.sourceProvider,r.RepositoryTypes.Bitbucket,!0)||(0,w.isFeatureFlagEnabled)(this.context.pageContext,"Build2.BitbucketAzurePipelinesOAuthClient",!1);return l.createElement("div",{className:"ci-yaml-wizard-view flex-column flex-grow"},this._renderHeader(),this.state.errorMessage&&""!==this.state.errorMessage&&l.createElement(P.MessageCard,{className:"ci-editor-error",severity:"Error"},this.state.errorMessage),l.createElement(xe.YamlTab,{content:this.state.content,editor:this._editor,onContentUpdated:this._onYamlContentUpdated,onEditorCreated:this._onEditorCreated,sidePanelInitiallyOpen:!1,repositoryName:this.props.wizardState.repositoryName,repositoryIconName:e&&e.getRepoIconName(),repositoryUrl:"",branchName:"",fileName:this.state.fileName,fileUrl:"",supportFPS:(0,o.equals)(this.props.wizardState.sourceProvider,r.RepositoryTypes.TfsGit,!0),isYamlDirty:this._isDirty()||this._isNewFile(),definition:void 0,onBranchSelected:()=>{},onFileNameChanged:this._onFileNameChanged}),this.state.variablesPanelIsOpen&&l.createElement(Ce.PipelineVariablesPanel,{variables:this.state.variables,isSaving:!1,onSave:this._onSavePipelineVariables,onDismiss:this._dismissPipelineVariablesPanel}),l.createElement(Ee.SavePanel,{errorMessage:this.state.saveErrorMessage,fileName:this.state.fileName,defaultBranch:this.props.wizardState.branch||ce.DefaultBranch,isOpen:this.state.savePanelIsOpen,isSaving:this.state.isSaving,isRunning:this.state.isRunning,saveAndRun:this._runAfterSaving,canCreatePr:t,onSave:this._saveYamlAndPipeline,onDismiss:this._dismissSavePanel,filesAdded:this.props.additionalFiles&&[{name:this.state.fileName,description:ce.YamlFileDescription,type:ue.FileType.Yaml},...this._mapToFileListItems(this.props.additionalFiles)]}))}_switchHistoryChangeHandler(e,t){const i=this.context.pageContext.getService("IVssHistoryService");i.unsubscribe(e),i.subscribe(t)}_isDirty(){return!!this._editor&&this._editor.getValue()!==this._lastSavedContent}_trimPath(e){return e&&(e=(e=e.startsWith("./")?e.slice(2):e).startsWith("/")?e.slice(1):e),e}_isNewFile(e){if(!this._lastSavedSha)return!0;return(e||this.state.fileName)!==this._lastSavedFileName}_ensureEditorIsReadOnly(e){this._editor&&this._editorIsReadOnly!==e&&(this._editorIsReadOnly=e,this._editor.updateOptions({readOnly:e}))}_getSourceProvider(){return this.context.pageContext.getService("ISourceProviderService").getSourceProvider(this.props.wizardState.sourceProvider)}_gotoEmptySummaryPage(e,t){const i=this.buildLinkingService.getPipelinesUrl(e);(0,a.onClickFPS)(this.context.pageContext,i,!0)}get buildLinkingService(){return this.context.pageContext.getService("IBuildLinkingService")}}t[e].YamlWizardPage=i}("YamlWizardPage"),function(e){t[e]={};class s extends v.VssComponent{constructor(e,t){super(e,t),this._ttiMarked=!1,this._gitHubProximaInstallationFlowEnabled="Pipelines.GitHubProximaInstallationFlowEnabled",this._mapToWizardListItems=(e,t)=>(0,w.isFeatureFlagEnabled)(this.context.pageContext,this._gitHubProximaInstallationFlowEnabled,!1)?e.filter((e=>void 0===e.parentKey||!t)).map((i=>{const s=[];return i.supportsYaml&&s.push(ce.Yaml),i.newLabel&&s.push(ce.NewLabel),{key:i.key,name:i.name,description:i.description,iconUrl:i.iconAsset?(0,y.getAssetLocation)(this.context.pageContext,i.iconAsset):void 0,iconAltText:i.iconAssetAltText,iconName:i.iconName,labels:s,children:t&&i.childrenKeys?this._mapToWizardListItems(e.filter((e=>{var t,s;return(null===(t=i.childrenKeys)||void 0===t?void 0:t.includes(null!==(s=e.key)&&void 0!==s?s:""))&&i.key===e.parentKey})),!1):[]}})):e.map((e=>{const t=[];return e.supportsYaml&&t.push(ce.Yaml),{name:e.name,description:e.description,iconUrl:e.iconAsset?(0,y.getAssetLocation)(this.context.pageContext,e.iconAsset):void 0,iconAltText:e.iconAssetAltText,iconName:e.iconName,labels:t}})),this._onHistoryChanged=e=>{this.setState(this._readStateFromHistory(e.newState.state))},this._getBuildPipelineCreationValue=()=>{var e,t,i,s;return(0,w.isFeatureFlagEnabled)(this.context.pageContext,"Build2.NewTogglesToDisableClassicPipelineCreation",!1)?!(null===(e=this._projectSettingsService.data)||void 0===e?void 0:e.value.disableClassicBuildPipelineCreation)||(null===(t=this._projectSettingsService.data)||void 0===t?void 0:t.value.disableClassicBuildPipelineCreation.enabled):!(null===(i=this._projectSettingsService.data)||void 0===i?void 0:i.value.disableClassicPipelineCreation)||(null===(s=this._projectSettingsService.data)||void 0===s?void 0:s.value.disableClassicPipelineCreation.enabled)},this._getReleasePipelineCreationValue=()=>{var e,t,i,s;return(0,w.isFeatureFlagEnabled)(this.context.pageContext,"Build2.NewTogglesToDisableClassicPipelineCreation",!1)?!(null===(e=this._projectSettingsService.data)||void 0===e?void 0:e.value.disableClassicReleasePipelineCreation)||(null===(t=this._projectSettingsService.data)||void 0===t?void 0:t.value.disableClassicReleasePipelineCreation.enabled):!(null===(i=this._projectSettingsService.data)||void 0===i?void 0:i.value.disableClassicPipelineCreation)||(null===(s=this._projectSettingsService.data)||void 0===s?void 0:s.value.disableClassicPipelineCreation.enabled)},this._onProjectSettingsChanged=e=>{this.setState({isClassicBuildPipelineCreationDisabled:this._getBuildPipelineCreationValue(),isClassicReleasePipelineCreationDisabled:this._getReleasePipelineCreationValue()})},this._onSourceProviderClick=e=>{if(e.isClassic){const t=this._getClassicEditorLink(e.key),i="new-pipeline-wizard.old-designer",s={telemetrySession:this.state.wizardState.telemetrySession,sourceProvider:e.key};(0,a.onClickFPS)(this.context.pageContext,t,!0,void 0,{telemetrySource:i,telemetryProperties:s})}else{const t=this.context.pageContext.getService("IVssHistoryService"),i=t.generateUrl({sourceProvider:e.key,telemetrySession:this.state.wizardState&&this.state.wizardState.telemetrySession||this._createTelemetrySession()},2);t.pushState(void 0,i),this.setState({sourceProviderKey:e.key,repositorySubheader:"",templateSubheader:"",stepNumber:2,wizardState:t.getState()},(()=>this._recordTelemetryInfo()))}},this._onSourceProviderComplete=(e,t)=>{e||(e={}),e.sourceProviderComplete="true",e.telemetrySession=this.state.wizardState&&this.state.wizardState.telemetrySession||this._createTelemetrySession();const i=this.context.pageContext.getService("IVssHistoryService"),s=i.generateUrl(e,2);i.pushState(void 0,s),t||(t={}),this.setState({stepNumber:3,repositorySubheader:e.repositoryName||"",repositoryUrl:e.repositoryUrl,templateSubheader:"",wizardState:Object.assign(Object.assign(Object.assign({},this.state.wizardState),e),t)},(()=>this._recordTelemetryInfo()))},this._onTemplateSelected=(e,t,i,s,a)=>{if(e||s){const t={branch:s||this.state.wizardState&&this.state.wizardState.branch||"",template:e?e.name:this.state.template?this.state.template.name:"",telemetrySession:this.state.wizardState&&this.state.wizardState.telemetrySession||this._createTelemetrySession()},i=this.context.pageContext.getService("IVssHistoryService"),a=i.generateUrl(t,2);i.pushState(void 0,a)}this._onTemplateSelectionComplete(4,e,t,i,s,a)},this._getSourceProviderTile=e=>this._sourceProviders.find((t=>o.equals(t.key,e,!0))),this._recordTelemetryInfo=(e,t)=>{const i=(e,t,i)=>{this.state.wizardState&&this.state.wizardState[t]?e[t]=this.state.wizardState[t]:i&&(e[t]=i)},s=(e,t)=>{this.state.wizardState&&this.state.wizardState[t]&&(e[t]="true"===this.state.wizardState[t].toLowerCase())},a={};if(e)a.action=e;else switch(this.state.stepNumber){case 1:a.action="ChooseConnection";break;case 2:a.action="ChooseRepo";break;case 3:a.action="ChooseTemplate";break;case 4:a.action="EditYaml";break;default:a.action="unknown"}i(a,"externalOwnerId"),i(a,"externalOwnerName"),s(a,"externalOwnerIsAUser"),i(a,"entryPoint"),s(a,"repositoryIsFork"),s(a,"repositoryIsPrivate"),i(a,"telemetrySession",this._createTelemetrySession()),this.state.wizardState&&this.state.wizardState.safeRepository&&(a.repositoryName=this.state.wizardState.safeRepository);const n=this._getSourceProviderTile(this.state.sourceProviderKey||"");if(a.repositoryType=n&&n.name||"",this.state.template&&this.state.template.name&&(a.templateName=this.state.template.name),this.state.repoAnalysis&&this.state.repoAnalysis.recommendTemplate&&(a.recommendedTemplateName=this.state.repoAnalysis.recommendTemplate.name,a.suggestedTemplateNames=this.state.repoAnalysis.suggestedTemplates.map((e=>e.name))),t)for(const e in t)a[e]=t[e];this.context.pageContext.getService("IVssTelemetryService").publishEvent("Build","CreatePipeline",a)},this._markRepositoryTTI=()=>{this._markTTI(he.PageLoadScenarios.Repository)},this._markTTI=e=>{this._ttiMarked||(this._ttiMarked=!0,this.context.pageContext.getService("IVssPerformanceService").markTimeToInteractive(he.PerformanceConstants.Area,e))},this._getWizardItems=e=>[ce.Connect,ce.Select,ce.Configure,ce.Review].map(((t,s)=>({title:t,itemState:new i.ObservableValue(e>s+1?"Complete":"None")}))),this._getFallbackLink=()=>this.context.pageContext.getService("IBuildLinkingService").getNewDefinitionEditUrl(this.state.wizardState.pipelinePath)+"&id=0",this._getClassicEditorLink=e=>this._getFallbackLink()+"&repositoryType="+e,this._redirectToPipeline=e=>{4==this.state.stepNumber&&(0,S.openLinkSecurely)(e)},this._normalizeBranchName=e=>{const t="refs/heads/";return e&&o.startsWith(e,t,!0)?e.substring(11):e},this._getAdditionalFilesForTemplate=e=>{if(e&&e.assets)return e.assets.filter((e=>e&&o.equals(e.type,de.TemplateAssetTypes.File,!0)))},this._configurationPath="/azure-pipelines.yml";const s=this.context.pageContext.getService("IVssHistoryService").getState();this._projectSettingsService=this.context.pageContext.getService("IGeneralSettingsService");const n=this.context.pageContext.getService("IVssContributionService").getContributionsByType("ms.vss-build-web.acquisition-source-provider-tile");if((0,w.isFeatureFlagEnabled)(this.context.pageContext,this._gitHubProximaInstallationFlowEnabled,!1)){const e=e=>"bitbucket"===e.key?Object.assign(Object.assign({},e),{name:`GitHubX${e.name}`}):e;this._sourceProviders=Object.keys(n).map((e=>n[e])).sort(((t,i)=>{const s=e(t),a=e(i);return s.name.localeCompare(a.name,navigator.language)}))}else this._sourceProviders=Object.keys(n).map((e=>n[e])).sort(((e,t)=>e.name.localeCompare(t.name,navigator.language)));this.state=s?this._readStateFromHistory(s):{stepNumber:1,showSaveAndRun:!0,wizardState:{},isClassicBuildPipelineCreationDisabled:this._getBuildPipelineCreationValue(),isClassicReleasePipelineCreationDisabled:this._getReleasePipelineCreationValue()},this._recordTelemetryInfo()}componentDidMount(){this.context.pageContext.getService("IVssHistoryService").subscribe(this._onHistoryChanged),this._projectSettingsService.data&&this._projectSettingsService.data.subscribe(this._onProjectSettingsChanged),1==this.state.stepNumber&&this._markTTI(he.PageLoadScenarios.Sources)}componentWillUnmount(){this.context.pageContext.getService("IVssHistoryService").unsubscribe(this._onHistoryChanged),this._projectSettingsService.data&&this._projectSettingsService.data.unsubscribe(this._onProjectSettingsChanged)}render(){const e=4===this.state.stepNumber;return l.createElement(K.Page,{className:(0,v.css)("ci-designer-wizard-view flex-column flex-grow",e?"bolt-page-grey":"")},l.createElement(le.Wizard,{className:"wizard-view-step-list page-content page-content-top flex-noshrink",items:this._getWizardItems(this.state.stepNumber),selectedIndex:this.state.stepNumber-1}),l.createElement("div",{className:(0,v.css)("wizard-view-detail flex-column flex-grow",e?"":"page-content")},this._renderDetail()))}_renderDetail(){switch(this.state.stepNumber){default:case 1:return this._renderSourceProviderSelector();case 2:return this._getSourceProviderWizard();case 3:return l.createElement(Be.TemplateSelector,{wizardState:this.state.wizardState,onTemplateSelected:this._onTemplateSelected});case 4:return this._renderYamlWizardPage()}}_renderSourceProviderSelector(){const e=this.state.isClassicBuildPipelineCreationDisabled;var t=[...this._sourceProviders];return e&&(t=t.filter((e=>"git"!=e.key&&"svn"!=e.key))),l.createElement("div",{className:"source-provider-selector"},l.createElement("div",{className:"header-section"},l.createElement("div",{className:"subheader  body-m secondary-text"},ce.NewPipeline),l.createElement("div",{className:"header title-l"},ce.WhereIsYourCode)),l.createElement(Ve.WizardList,{wizardListItems:this._mapToWizardListItems(t,!0),onClick:(e,i)=>{if((0,w.isFeatureFlagEnabled)(this.context.pageContext,this._gitHubProximaInstallationFlowEnabled,!1)){const e=t.find((e=>e.key===i.data.key));e&&this._onSourceProviderClick(e)}else this._onSourceProviderClick(t[i.index])}}),!e&&l.createElement("div",{className:"old-designer-fallback"},l.createElement(f.FormatComponent,{format:ce.OldDesignerFallbackFormat},l.createElement(b.FPSLink,{href:this._getFallbackLink(),telemetrySource:"new-pipeline-wizard.old-designer",telemetryProperties:{telemetrySession:this.state.wizardState.telemetrySession}},ce.OldDesignerLinkText))))}_renderYamlWizardPage(){const e=this.state.configuration?this.state.configuration.path:this.state.wizardState.configPath?this.state.wizardState.configPath:this._configurationPath;return l.createElement(Le.YamlWizardPage,{wizardState:this.state.wizardState,content:this.state.template?this.state.template.content:this.state.configuration.content,path:e,url:this.state.configuration?this.state.configuration.webUrl:void 0,onAction:this._recordTelemetryInfo,onHistoryChanged:this._onHistoryChanged,contentSha:this.state.configuration?this.state.configuration.objectId:"",redirectToPipeline:this._redirectToPipeline,additionalFiles:this._getAdditionalFilesForTemplate(this.state.template)})}_readStateFromHistory(e){let t,i,s,a=1;const n=e.sourceProvider;n&&(t=this._getSourceProviderTile(n),t&&(a=2));return"true"===e.sourceProviderComplete&&(a=3,i=e.repositoryName,s=e.repositoryUrl),{stepNumber:a,sourceProviderKey:n,repositorySubheader:i,repositoryUrl:s,showSaveAndRun:!0,templateSubheader:"",wizardState:Object.assign(Object.assign({},e),{branch:this._normalizeBranchName(e.branch)}),isClassicBuildPipelineCreationDisabled:this._getBuildPipelineCreationValue(),isClassicReleasePipelineCreationDisabled:this._getReleasePipelineCreationValue()}}_onTemplateSelectionComplete(e,t,i,s,a,n){this.setState({stepNumber:e,template:t,repoAnalysis:i,configuration:s,templateSubheader:t?t.name:ce.ExistingFileFound,showSaveAndRun:!!t,wizardState:Object.assign(Object.assign({},this.state.wizardState),{branch:a||this.state.wizardState.branch,configPath:n||""})},(()=>this._recordTelemetryInfo()))}_getSourceProviderWizard(){const e=this.context.pageContext.getService("IVssLayoutManager").getComponentsForRegion("sourceProviderWizard").value.find((e=>{const t=e.componentProperties.key;return!!t&&o.equals(t.toString(),this.state.sourceProviderKey,!0)}));return e?l.createElement(v.WrappedComponent,Object.assign({wrappedType:e.componentType},e.componentProperties,{wizardState:this.state.wizardState,onComplete:this._onSourceProviderComplete,onUpdate:this._recordTelemetryInfo,onTTI:this._markRepositoryTTI})):l.createElement("div",null,"The source provider key '",this.state.sourceProviderKey,"' was not recognized.")}_createTelemetrySession(){return o.newGuid()}}t[e].DesignerWizardContent=s,v.Components.add("ci-designer-wizard-view",s)}("Wizard")}),["Resources","Constants","Performance","PipelineEditorBreadcrumbService","Util/File","WarningBanner","VisibilityMismatchWarning","YamlFileService","YamlResourcesService","Components/FileList","Components/ValidationErrors","Components/ValidationPanel","EditorAuthLandingPage","EditorHeader","LoseChangesDialog","PipelineVariableEditPanel","PipelineVariablesPanel","SavePanel","YamlEditor","YamlEditorHeader","YamlSidePanel","YamlTab","EditorView","Services/PipelineEditorViewService","NewEditorHeader","NewYamlEditorHeader","NewYamlTab","Services/PipelineEditorActionsViewService","NewEditorView","WizardList","RepositorySelector","TemplateSelector","YamlWizardPage","Wizard"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-build-web.designer"}}));
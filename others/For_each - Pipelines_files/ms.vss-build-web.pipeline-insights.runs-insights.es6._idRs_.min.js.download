"use strict";define("Build/PipelineInsights/RunsInsights",["require","exports","Analytics/Shared/Common/PipelineEntities","Analytics/Shared/Common/Sources/AnalyticsODataClientBase","Analytics/Shared/Common/Types","Analytics/Shared/Common/Utils/DateAdjuster","Analytics/Shared/FilterExpression","Analytics/Shared/QueryBuilder","Analytics/Shared/Utils/Number","Analytics/Shared/Common/Utils/TrendCalculator","react","Tfs/Platform/Page","VSS/Core/Util/String","VSS/Platform/Components/Format","VSS/Platform/Feature","VSS/Platform/Layout","VSS/Platform/Location","VSSUI/Icon","VSSUI/Util","Pipeline/Analytics/PipelineInsights/ControllerView/PipelineInsightsDialog","VSS/Platform/FPS","VSSUI/Observer","VSS/Core/Observable","VSS/Platform/UserClaims","Analytics/Shared/Utils/DateUtils"],(function(e,t,s,i,n,a,r,o,l,h,c,d,p,u,g,m,I,T,y,S,P,C,f,x,R){var D,v,w,V;D=t[V="Resources"]={},t[V].InContextButtonText="View Report",t[V].InContextTrendText="This pipeline has a pass rate of {0}% ({1} {2}%) in the last 14 days.",t[V].InContextText="This pipeline has a pass rate of {0}% in the last 14 days.",t[V].DialogTitle="Pipeline Insights",function(e){v=t[e]={},t[e].PipelineInsightsClientSettings="pipelines/runs/insights",function(e){e.Area="PipelineInsights",e.RunsInsightsViewReport="RunsInsightsViewReport",e.RunsInsightsOnDismiss="RunsInsightsOnDismiss",e.RunsInsightsOnError="RunsInsightsOnError",e.RunsInsightsTriggerData="RunsInsightsTriggerData"}(t[e].Telemetry||(t[e].Telemetry={})),t[e].serviceInstanceId="0000003c-0000-8888-8000-000000000000"}("Constants"),function(e){w=t[e]={};class h extends i.AnalyticsODataClientBase{constructor(e){super("Pipelines.RunInsights",e),this._buildEntityName=`${s.PipelineRuns}`}async queryPipelineInsightsData(e,t){const s=this._getProjectId(),i={entityType:this._buildEntityName,project:s},l=(new o.ODataQuery).filter((0,r.expr)(this._getPipelineContextFilter(e)).and.expr((0,a.getDateFilter)(n.TrendBy.Days,t.period)).and.expr("CanceledCount ne 1")).groupBy("CompletedDateSK").aggregate("$count as TotalCount","PartiallySucceededCount with sum as PartiallySucceededCount","SucceededCount with sum as SucceededCount").orderBy("CompletedDateSK","asc");i.$apply=l.apply,i.$orderby=l.orderby;return await this._queryPassRateTrendData(i)}_getPipelineContextFilter(e){return`${`${s.PipelineId}`} eq ${e.definitionId}`}async _queryPassRateTrendData(e){const t=await this.queryOData(e);if(!t||!t.value)throw new Error("Data is empty");let s,i=0,n=0,a=0;const r=[];let o;const h=t.value;if(0===h.length)return{passPercentage:0,initialValue:0,finalValue:0};for(o of h){const e=o.TotalCount||0,t=o.SucceededCount||0,s=o.PartiallySucceededCount||0,h=(0,l.getPercentage)(e,t+s);a+=e,i+=t,n+=s,r.push({PassPercentage:h})}return s={passPercentage:(0,l.getPercentage)(a,i+n),initialValue:r[0].PassPercentage||0,finalValue:r[r.length-1].PassPercentage||0},s}}t[e].RunsInsightsSource=h}("SourcesRunsInsightsSource"),function(e){t[e]={};class i extends m.VssComponent{constructor(e,t){super(e,t),this._pipelineReportRouteId="ms.vss-pipelineanalytics-web.pipeline-outcome-route",this._showInsights=new f.ObservableValue(!1),this.PipelineInsightsTimeOffsetInSeconds=46656e4,this.onClick=()=>{(0,P.onClickFPS)(this.context.pageContext,this.getPipelineReportPageRoute(),!1),this.publishTelemetry(v.Telemetry.Area,v.Telemetry.RunsInsightsViewReport)},this.onDismiss=()=>{if(this.props.onDismiss,this._showInsights.value=!1,null!=this.props.definitionId){const e={},t=R.shiftToUTC(R.getDate()).getTime();e[v.PipelineInsightsClientSettings+"/"+this.props.definitionId+"/dismissed"]=t;this.context.pageContext.getRestClient("ISettingsRestClient").setEntries(e,"me")}this.publishTelemetry(v.Telemetry.Area,v.Telemetry.RunsInsightsOnDismiss)},this.state={definitionId:this.props.definitionId},(0,g.isFeatureFlagEnabled)(t.pageContext,s.RenameBuildEntitiesFeatureFlag)&&s.switchEntityAndAttributeNames(),this._runsInsightsSource=new w.RunsInsightsSource(this.context.pageContext),this._telemetryService=this.context.pageContext.getService("IVssTelemetryService")}render(){return(0,g.isFeatureFlagEnabled)(this.context.pageContext,"WebAccess.Pipeline.Analytics.PipelineInsightsPopup",!1)?this.state.errorText?(this._telemetryService.publishEvent(v.Telemetry.Area,v.Telemetry.RunsInsightsOnError,{PipelineId:this.state.definitionId,error:this.state.errorText}),null):this.areInsightsValuable()?c.createElement("div",{className:"runs-incontext-view"},c.createElement(C.Observer,{showInsights:this._showInsights},(e=>e.showInsights?c.createElement(S.PipelineInsightsDialog,{insightsMessage:this.getInsights(),cardTitle:D.DialogTitle,onDismiss:this.onDismiss,onViewReportClick:this.onClick}):null))):null:null}componentDidMount(){super.componentDidMount(),!this.state.errorText&&this.state.definitionId&&this.fetchData(),this.evaluateShowInsights()}componentDidUpdate(e,t){this.props.definitionId&&this.props.definitionId!==this.state.definitionId&&this.setState({definitionId:this.props.definitionId,passPercentage:void 0,passRateTrend:void 0},(()=>{this.fetchData()})),super.componentDidUpdate(e,t)}getTrendElement(e){return c.createElement(T.Icon,{className:(0,y.css)("font-size-xs font-weight-semibold",e.trendType===n.TrendType.Increased?"positive-color":"negative-color"),iconName:e.trendType===n.TrendType.Increased?"TriangleSolidUp12":"TriangleSolidDown12"})}getInsights(){if(this.publishTelemetry(v.Telemetry.Area,v.Telemetry.RunsInsightsTriggerData),this.state.passRateTrend){const e=this.state.passRateTrend,t=e.trendType===n.TrendType.Increased?"increased":"decreased",s=(0,p.localeFormat)(D.InContextTrendText,this.state.passPercentage,t,e.percentageVariation);return c.createElement("div",{"aria-label":s},c.createElement(u.FormatComponent,{format:D.InContextTrendText},this.state.passPercentage,this.getTrendElement(e),e.percentageVariation))}return c.createElement("div",{tabIndex:0},c.createElement(u.FormatComponent,{format:D.InContextText},this.state.passPercentage))}areInsightsValuable(){const e=this.state.passRateTrend;return null!=this.state.passPercentage&&null!=e&&e.trendType==n.TrendType.Decreased&&e.percentageVariation>=5}async fetchData(){const e={contextType:n.ContextType.Build,definitionId:this.state.definitionId},t={trendBy:n.TrendBy.Days,period:n.Period.Days_14};try{const s=this.context.pageContext.getService("IVssLocationService"),i=(await s.getServiceLocationAsync(v.serviceInstanceId,4),await this._runsInsightsSource.queryPipelineInsightsData(e,t));this.setState({passPercentage:i.passPercentage,passRateTrend:(0,h.getTrendFromData)(i.initialValue,i.finalValue,!1)})}catch(e){this.onError(e)}}getPipelineReportPageRoute(){const e=(0,d.getTFSPageData)(this.context.pageContext),t={};return t.project=e&&e.project?e.project.name:"",t.definitionId=this.state.definitionId?this.state.definitionId.toString():"",(0,I.routeUrl)(this.context.pageContext,this._pipelineReportRouteId,t)}onError(e){const t=e.toString();this.setState({errorText:t})}publishTelemetry(e,t){const s=this.state.passRateTrend;this._telemetryService.publishEvent(e,t,{PipelineId:this.state.definitionId,PassPercentage:this.state.passPercentage,PercentageVariation:s?s.percentageVariation:"",Trend:s?s.trendType===n.TrendType.Increased?"increased":"decreased":""})}async evaluateShowInsights(){const e=this.context.pageContext.getRestClient("ISettingsRestClient"),t=(0,x.userHasClaim)(this.context.pageContext,"member")&&await e.getEntries("me",v.PipelineInsightsClientSettings+"/"+this.props.definitionId);t&&t.dismissed?this._showInsights.value=this.hasUserDismissalPeriodExpired(t.dismissed):this._showInsights.value=!0}hasUserDismissalPeriodExpired(e){return R.shiftToUTC(R.getDate()).getTime()-e>=this.PipelineInsightsTimeOffsetInSeconds}}t[e].RunsInsights=i,m.Components.add("pipelines-runs-insights",i)}("ControllerViewsRunsInsights")}),["Resources","Constants","Sources/RunsInsightsSource","ControllerViews/RunsInsights"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-build-web.pipeline-insights.runs-insights"}}));
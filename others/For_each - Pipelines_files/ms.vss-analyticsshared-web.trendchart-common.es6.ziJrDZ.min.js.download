"use strict";define("Analytics/Shared/TrendChart/Common",["require","exports","Analytics/Shared/Common/Utils/DateAdjuster","VSS/Core/Util/String","VSS/Features/Charts/Contracts"],(function(e,t,a,r,n){var o,s,l;o=t[l="Resources"]={},t[l].UnitInSeconds="seconds",t[l].UnitInMinutes="minutes",t[l].UnitInHours="hours",t[l].OthersArtifactWithCountText="Others ({0})",t.Types={},function(e){t[e]={};class a{static _shallowEquals(e,t){if(e===t)return!0;if(null==e||null==t||e.length!==t.length)return!1;for(let a=0,r=e.length;a<r;++a)if(e[a].id!==t[a].id)return!1;return!0}static areConfValuesEqual(e,t){return!e&&!t||!(!e||!t)&&(e.trendBy===t.trendBy&&(e.period===t.period&&!!a._shallowEquals(e.branchItems,t.branchItems)))}}t[e].ConfigurationUtility=a}("ConfigurationUtility"),function(e){s=t[e]={};t[e].DurationConverter=class{static convertSecondsToMinutes(e){return e/60}static convertSecondsToHours(e){return e/3600}}}("DurationConverter"),function(e){t[e]={};t[e].DurationNormalizer=class{normalizeDurations(e,t=!1){let a,r;if(t){let t;t=[].concat(...e),a=t}else{a=e.map((e=>this._calculateAverageIgnoringZeros(e)))}let n=o.UnitInSeconds,l=!1;return this._shouldNormalizeDurationsToHours(a)?(r=s.DurationConverter.convertSecondsToHours,n=o.UnitInHours,l=!0):this._shouldNormalizeDurationsToMinutes(a)&&(r=s.DurationConverter.convertSecondsToMinutes,n=o.UnitInMinutes,l=!0),l&&(e=e.map((e=>e.map((e=>r(e)))))),{durationUnitString:n,durationValues:e}}normalizeDuration(e){let t;return t=s.DurationConverter.convertSecondsToHours(e),t>2?{durationUnitString:o.UnitInHours,durationValues:[[t]]}:(t=s.DurationConverter.convertSecondsToMinutes(e),t>10?{durationUnitString:o.UnitInMinutes,durationValues:[[t]]}:{durationUnitString:o.UnitInSeconds,durationValues:[[e]]})}_shouldNormalizeDurationsToHours(e){return this._normalizeDurationOnFrequency(e,2,50,s.DurationConverter.convertSecondsToHours)}_shouldNormalizeDurationsToMinutes(e){return this._normalizeDurationOnFrequency(e,10,50,s.DurationConverter.convertSecondsToMinutes)}_normalizeDurationOnFrequency(e,t,a,r){const n=e.filter((e=>e>0)),o=Math.floor(n.length*(a/100));let s=0;return n.forEach((e=>{const a=r(e);return a>t&&s++,a})),s>o}_calculateAverageIgnoringZeros(e){if(!e||0===e.length)return 0;let t=0,a=0;return e.forEach((e=>{e&&a++,t+=e})),0!==a?t/a:0}}}("DurationNormalizer"),function(e){t[e]={};t[e].TrendChartHelper=class{getCommonChartOptions(e,t,a,r,o,s,l,u,i=10){const c=[];let d=[];const h=[];1===Object.keys(e).length&&e[""]?Object.keys(e).forEach((a=>{const r={aggrValues:[],dates:[]};e[a].forEach((e=>(r.aggrValues.push(e.aggrValue),r.dates.push(e.date)))),c.push({name:t.name,color:t.color,data:r.aggrValues,customData:u}),d=r.dates,h.push(n.ChartTypesConstants.StackedColumn)})):d=this.getStackedChartData(e,u,c,h,i),o&&o.values&&o.values.length>0&&(c.push({name:o.name,color:o.color,useSecondaryAxis:!0,data:o.values}),h.push(n.ChartTypesConstants.Line),0==d.length&&r&&(d=r.map((e=>e.date))));const m=this._getMaxSecondaryYAxisLabel(a,o);return{chartType:n.ChartTypesConstants.Hybrid,specializedOptions:{chartTypes:h,includeMarkers:!0},xAxis:{labelFormatMode:n.LabelFormatModes.Textual,labelsEnabled:!0,labelValues:d},yAxis:{allowDecimals:t.allowDecimal,labelFormatMode:n.LabelFormatModes.Linear,labelsEnabled:!0,markingsEnabled:!1,title:t.name,min:t.minValue,max:t.maxValue},yAxisSecondary:r?{allowDecimals:!!o&&o.allowDecimal,labelFormatMode:a,labelsEnabled:!0,markingsEnabled:!1,startOnTick:s,endOnTick:!m&&l,title:o?o.name:"name",max:m}:null,series:c}}adjustDataForAllStackBySeries(e,t,a){return e?(Object.keys(e).forEach((r=>{e[r]=this._adjustDataForAllPeriod(e[r],t,a)})),e):e}getStackedChartData(e,t,a,n,o,s){let l=[];const u=[],i={};return Object.keys(e).forEach((t=>{i[t]={aggrValues:[],accumulatedValue:0,dates:[]},e[t].sort(((e,t)=>r.localeComparer(e.date,t.date))),e[t].forEach((e=>(i[t].aggrValues.push(e.aggrValue),i[t].dates.push(e.date),i[t].accumulatedValue+=e.aggrValue))),u.push({stackBy:t,value:i[t].accumulatedValue}),0===l.length&&(l=i[t].dates)})),this._reduceAndCombineStackedChartSeries(i,u,l.length,t,a,n,o,s),l}_getMaxSecondaryYAxisLabel(e,t){if(e!==n.LabelFormatModes.Percentage||!t)return;const a=t.values.filter((e=>null!=e));return Math.max(...a)>=80?t.maxValue:void 0}_adjustDataForAllPeriod(e,t,r){if(!e||e.length<=0)return e;let n=e.map((e=>({date:e.date,data:e.aggrValue,customData:e.customData})));n=(0,a.adjustDataForAllPeriod)(n,t,r,null);return n.map((e=>({date:e.date,aggrValue:e.data,customData:e.customData})))}_reduceAndCombineStackedChartSeries(e,t,a,s,l,u,i,c){t.sort(((e,t)=>t.value-e.value));let d=0;const h=t.length;for(;d<h&&d<i;d++){const a=t[d].stackBy;c?l.push({name:a,data:e[a].aggrValues,customData:s,color:c[d]}):l.push({name:a,data:e[a].aggrValues,customData:s}),delete e[a],u.push(n.ChartTypesConstants.StackedColumn)}if(d<t.length){const t=new Array(a).fill(0);let i=0;Object.keys(e).forEach((a=>{i++;for(let r=0;r<e[a].dates.length;r++)t[r]+=e[a].aggrValues[r]||0})),l.push({name:r.format(o.OthersArtifactWithCountText,i),data:t,customData:s}),u.push(n.ChartTypesConstants.StackedColumn)}}}}("TrendChartHelper")}),["Resources","Types","ConfigurationUtility","DurationConverter","DurationNormalizer","TrendChartHelper"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-analyticsshared-web.trendchart-common"}}));
"use strict";define("Build/Common/Artifacts",["require","exports","Build/Common/Library/ErrorHandler","Build/Flux/Action","react","Build/Common/Library/Navigation","VSS/Legacy/Legacy","VSS/Core/Util/String","VSS/Platform/Context","Build/Flux/Store","Build/Common/Library/Stores/Permissions","Build/Common/Library/Security","Build/Shared/Components/DetailsSection/DetailsSection","VSSUI/Icon","VSSUI/Link","VSSUI/TooltipEx","VSSUI/Menu"],(function(t,e,i,r,a,s,o,n,c,l,d,p,u,f,h,m,A){var y,v,S,C,b,g,_,x,w,T,B,L,E,P,D;y=e[D="Resources"]={},e[D].AriaBuildArtifactDetailsChevron="Show build artifact details",e[D].AriaBuildArtifactsList="List of build artifacts",e[D].BuildArtifacts="Build artifacts published",e[D].BuildArtifactFormat="Artifact {0}",e[D].BuildArtifactLabelFormat="Label {0}",e[D].ContainerType="File container",e[D].Download="Download",e[D].DownloadFormat="Download {0}",e[D].PipelineArtifact="Pipeline artifact",e[D].FilePathType="File share",e[D].GitRefType="GitRef",e[D].MoreOptions="More options",e[D].SymbolRequestType="SymbolRequest",e[D].SymbolStoreType="SymbolStore",e[D].TfvcLabelType="TfvcLabel",e[D].UnknownType="Unknown",e[D].VersionControlType="VersionControl",e[D].ViewContents="View contents",function(t){v=e[t]={};class i{constructor(t){this._client=t.client,this._projectId=t.projectId}getArtifacts(t){return this._client.getArtifacts(this._projectId,t).then(i.sortArtifacts)}getArtifact(t,e){return this._client.getArtifact(this._projectId,t,e)}}e[t].ArtifactsSource=i,i.sortArtifacts=t=>(t||[]).sort(((t,e)=>t.name>e.name?1:t.name<e.name?-1:0))}("Source"),function(t){S=e[t]={};e[t].ArtifactsActionCreator=class{constructor(t){this._actionHub=t.actionHub||new a,this._source=new v.ArtifactsSource({client:t.client,projectId:t.projectId})}fetchArtifacts(t){this._source.getArtifacts(t).then((t=>this._actionHub.artifactsAvailable.invoke(t))).catch(i.handleError)}fetchArtifact(t,e){this._source.getArtifact(t,e).then((t=>this._actionHub.artifactAdded.invoke(t))).catch(i.handleError)}};class a{constructor(){this._artifactAdded=new r.Action,this._artifactsAvailable=new r.Action}get artifactAdded(){return this._artifactAdded}get artifactsAvailable(){return this._artifactsAvailable}}e[t].ArtifactsActionHub=a}("Action"),function(t){C=e[t]={},function(t){t.FilePath="FilePath".toLowerCase(),t.SymbolStore="SymbolStore".toLowerCase(),t.VersionControl="VersionControl".toLowerCase(),t.Container="Container".toLowerCase(),t.GitRef="GitRef".toLowerCase(),t.TfvcLabel="TfvcLabel".toLowerCase(),t.SymbolRequest="SymbolRequest".toLowerCase(),t.PipelineArtifact="PipelineArtifact".toLowerCase(),t.Unknown="Unknown".toLowerCase()}(e[t].BuildArtifactTypes||(e[t].BuildArtifactTypes={}))}("Common"),function(t){b=e[t]={};e[t].Base=class{constructor(t,e,i){this.pageContext=t,this.artifact=e,this.providerContext=i}getArtifact(){return this.artifact}getProviderContext(){return this.providerContext}supportsDownload(){return!1}supportsExploring(){return!1}getDisplayOptions(){return{text:this.artifact.name,iconName:"ZipFolder",tooltip:(0,n.format)(y.BuildArtifactFormat,this.artifact.name),type:this.getType()}}onDownload(){this.supportsDownload()&&this.openLink(this.getDownloadURL())}onExplore(){this.pageContext.getService("IVssLayoutManager").renderCallout((t=>{const e={modules:["Build/Scripts/ArtifactExplorerDialogLWP"],wrappedType:"ci-artifacts-explorer-dialog",artifact:this.artifact,buildId:this.providerContext.buildId,projectId:this.providerContext.projectId};return a.createElement(o.LegacyComponent,e)}))}getDownloadURL(){return this.supportsDownload()?this.artifact.resource.downloadUrl:""}showCopyDialog(){this.pageContext.getService("IVssLayoutManager").renderCallout((t=>{const e={modules:["Build/Scripts/ArtifactExplorerDialogLWP"],wrappedType:"ci-artifacts-copy-dialog",content:this.artifact.resource.downloadUrl};return a.createElement(o.LegacyComponent,e)}))}getType(){switch(this.getKey()){case C.BuildArtifactTypes.Container:return y.ContainerType;case C.BuildArtifactTypes.PipelineArtifact:return y.PipelineArtifact;case C.BuildArtifactTypes.FilePath:return y.FilePathType;case C.BuildArtifactTypes.GitRef:return y.GitRefType;case C.BuildArtifactTypes.SymbolRequest:return y.SymbolRequestType;case C.BuildArtifactTypes.SymbolStore:return y.SymbolStoreType;case C.BuildArtifactTypes.TfvcLabel:return y.TfvcLabelType;case C.BuildArtifactTypes.VersionControl:return y.VersionControlType}return y.UnknownType}openLink(t){(0,s.openLinkSecurely)(t)}}}("providersBase"),function(t){g=e[t]={};class i extends b.Base{getKey(){return C.BuildArtifactTypes.Container}supportsDownload(){return!0}supportsExploring(){return!0}}e[t].Container=i}("providersContainer"),function(t){_=e[t]={};class i extends b.Base{constructor(t,e,i){super(t,e,i)}getKey(){return C.BuildArtifactTypes.PipelineArtifact}supportsDownload(){return!0}supportsExploring(){return!0}getDownloadURL(){return this.artifact.resource.downloadUrl}}e[t].PipelineArtifact=i}("providersPipelineArtifact"),function(t){x=e[t]={};class i extends b.Base{getKey(){return C.BuildArtifactTypes.FilePath}supportsDownload(){return!0}supportsExploring(){return!1}onDownload(){this.showCopyDialog()}}e[t].FilePath=i}("providersFilepath"),function(t){w=e[t]={};class i extends b.Base{getKey(){return C.BuildArtifactTypes.GitRef}getDisplayOptions(){return{text:this.artifact.name,iconName:"GitLogo",tooltip:(0,n.format)(y.BuildArtifactLabelFormat,this.artifact.name),type:this.getType()}}}e[t].GitRef=i}("providersGitRef"),function(t){T=e[t]={};class i extends b.Base{getKey(){return C.BuildArtifactTypes.TfvcLabel}supportsDownload(){return!1}getDisplayOptions(){return{text:this.artifact.name,iconName:"TFVCLogo",tooltip:(0,n.format)(y.BuildArtifactLabelFormat,this.artifact.name),type:this.getType()}}}e[t].TfvcLabel=i}("providersTfvcLabel"),function(t){B=e[t]={};class i extends b.Base{getKey(){return C.BuildArtifactTypes.VersionControl}getDisplayOptions(){return{text:this.artifact.name,iconName:"TFVCLogo",tooltip:(0,n.format)(y.BuildArtifactLabelFormat,this.artifact.name),type:this.getType()}}}e[t].VersionControl=i}("providersVersionControl"),function(t){L=e[t]={};class i extends b.Base{getKey(){return C.BuildArtifactTypes.SymbolRequest}}e[t].SymbolRequest=i}("providersSymbolRequest"),function(t){E=e[t]={};class i extends b.Base{getKey(){return C.BuildArtifactTypes.SymbolStore}}e[t].SymbolStore=i}("providersSymbolStore"),function(t){P=e[t]={};class i extends b.Base{getKey(){return C.BuildArtifactTypes.Unknown}}e[t].Unknown=i}("providersUnknown"),function(t){e[t]={};class i extends c.VssService{getArtifactProvider(t,e){switch(t.resource.type.toLowerCase()){case C.BuildArtifactTypes.Container:return new g.Container(this.pageContext,t,e);case C.BuildArtifactTypes.PipelineArtifact:return new _.PipelineArtifact(this.pageContext,t,e);case C.BuildArtifactTypes.FilePath:return new x.FilePath(this.pageContext,t,e);case C.BuildArtifactTypes.GitRef:return new w.GitRef(this.pageContext,t,e);case C.BuildArtifactTypes.TfvcLabel:return new T.TfvcLabel(this.pageContext,t,e);case C.BuildArtifactTypes.VersionControl:return new B.VersionControl(this.pageContext,t,e);case C.BuildArtifactTypes.SymbolRequest:return new L.SymbolRequest(this.pageContext,t,e);case C.BuildArtifactTypes.SymbolStore:return new E.SymbolStore(this.pageContext,t,e);default:return new P.Unknown(this.pageContext,t,e)}}}e[t].ArtifactProviderService=i,c.Services.add("IArtifactProviderService",{serviceFactory:i})}("providersArtifactProvider"),function(t){e[t]={};class i extends l.Store{constructor(t){super(),this._artifacts=[],this._artifactProviders=[],this._fetchingArtifacts={},this._setArtifacts=t=>{this._artifacts=t;const e={buildId:this._buildId,projectId:this._projectId};this._artifactProviders=(t||[]).map((t=>this._providerService.getArtifactProvider(t,e))),this._storeChanged()},this._onArtifactAdded=t=>{this._artifacts.push(t),this._artifacts=v.ArtifactsSource.sortArtifacts(this._artifacts),this._setArtifacts(this._artifacts)},this._storeChanged=()=>{this.emitChanged()},this._buildClient=t.pageContext.getRestClient("IBuildRestClient"),this._providerService=t.pageContext.getService("IArtifactProviderService"),this._actionHub=t.actionHub||new S.ArtifactsActionHub,this._projectId=t.projectId,this._actionCreator=t.actionCreator||new S.ArtifactsActionCreator({actionHub:this._actionHub,client:this._buildClient,projectId:this._projectId}),this._permissionsStore=t.permissionsStore?t.permissionsStore:new d.PermissionsStore({pageContext:t.pageContext}),this._security=new p.Security({projectId:this._projectId,store:this._permissionsStore}),this._actionHub.artifactsAvailable.addListener(this._setArtifacts),this._actionHub.artifactAdded.addListener(this._onArtifactAdded),this._permissionsStore.addListener(this._storeChanged),this._buildId=t.buildId}dispose(){this._actionHub.artifactsAvailable.removeListener(this._setArtifacts),this._actionHub.artifactAdded.removeListener(this._onArtifactAdded),this._permissionsStore.removeListener(this._storeChanged),this._fetchingArtifacts={}}getArtifactProviders(){return this._artifactProviders}canExploreArtifacts(){return!(this._security.isAnonymousUser()||this._security.isPublicUser())}addArtifact(t,e){this._buildId!==t||this._fetchingArtifacts[e]||(this._actionCreator.fetchArtifact(t,e),this._fetchingArtifacts[e]=!0)}updateBuild(t){this._buildId!==t&&(this._buildId=t,this._buildId?this._actionCreator.fetchArtifacts(this._buildId):this._setArtifacts([]))}}e[t].ArtifactsStore=i,i.key="build-artifacts-store"}("Store"),function(t){e[t]={};class i extends a.Component{constructor(t,e){super(t),this._updateArtifactsState=()=>{this.setState({providers:this._store.getArtifactProviders(),canExploreArtifacts:this._store.canExploreArtifacts()})},this._store=t.store,this.state={providers:this._store.getArtifactProviders(),canExploreArtifacts:this._store.canExploreArtifacts()}}componentDidMount(){this._store.addListener(this._updateArtifactsState)}componentWillUnmount(){this._store.removeListener(this._updateArtifactsState)}render(){return a.createElement(u.DetailsSection,{className:"details-timeline-left b-details-timeline ci-hover-behavior",sectionKey:"build-artifacts-timeline",chevronProps:{ariaLabel:y.AriaBuildArtifactDetailsChevron},isExpandedByDefault:!0},a.createElement(u.DetailsSectionHeader,{renderAsHeading:!0},a.createElement("span",null,y.BuildArtifacts)),a.createElement(u.DetailsSectionSecondaryHeader,null,a.createElement("span",null)),a.createElement(u.DetailsSectionContent,null,a.createElement(r,{providers:this.state.providers,canExploreArtifacts:this.state.canExploreArtifacts})))}}e[t].ArtifactSnapshotContent=i;class r extends a.Component{render(){return a.createElement("div",{className:"build-artifacts-details-content"},a.createElement("ul",{className:"artifacts-list","aria-label":y.AriaBuildArtifactsList},this.props.providers.map((t=>a.createElement("li",{key:t.getArtifact().id},a.createElement(s,{provider:t,canExploreArtifacts:this.props.canExploreArtifacts}))))))}}class s extends a.Component{constructor(t){super(t),this._onDownload=()=>{this.props.provider.onDownload()},this._onExplore=()=>{this.props.provider.onExplore()},this.state={}}render(){const t=this.props.provider,e=t.getDisplayOptions(),i=t.getDownloadURL();let r=[];this.props.canExploreArtifacts&&t.supportsExploring()&&r.push({id:"artifact-explore",text:y.ViewContents,onActivate:this._onExplore,iconProps:{iconName:"DocumentSet"}}),t.supportsDownload()&&r.push({id:"artifact-download",text:y.Download,onActivate:this._onDownload,iconProps:{iconName:"Download"}});const s=this.state.target?"":"hidden";return a.createElement("div",{className:"build-artifact-item flex flex-center"},a.createElement("div",{className:"artifact-name-area flex flex-grow"},a.createElement(f.Icon,{className:"artifact-icon fontSizeL",iconName:e.iconName}),a.createElement("span",null,"Â "),a.createElement(m.Tooltip,{text:(0,n.format)(y.DownloadFormat,e.text)},a.createElement("div",{className:"artifact-data flex flex-column relative"},i&&a.createElement(h.Link,{className:"artifact-name",href:i},e.text),!i&&a.createElement("div",{className:"artifact-name"},e.text),a.createElement("div",{className:"artifact-info"},e.type)))),a.createElement("div",{className:`button-area ${s} relative flex-self-end`},r.length>0?a.createElement(A.MenuButton,{hideDropdownIcon:!0,className:"subtle",contextualMenuProps:{menuProps:{id:"timeline-menu",items:r}},iconProps:{iconName:"More"}}):null))}}}("Timeline")}),["Resources","Source","Action","Common","providers/Base","providers/Container","providers/PipelineArtifact","providers/Filepath","providers/GitRef","providers/TfvcLabel","providers/VersionControl","providers/SymbolRequest","providers/SymbolStore","providers/Unknown","providers/ArtifactProvider","Store","Timeline"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-build-web.common-artifacts"}}));
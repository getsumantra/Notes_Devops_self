"use strict";define("VSS/Msal",["require","exports","VSS/Platform/Context","VSS/Platform/Util/Storage","VSS/Platform/Feature","VSS/Platform/Trace","@azure/msal-browser","VSS/Core/Observable","VSS/Platform/Authentication","VSS/Platform/FPS","VSS/Platform/Telemetry","VSS/Platform/Util/Claims","VSS/Platform/Util/Cookie","react","VSS/Platform/Layout","VSS/Platform/Resources"],(function(e,t,i,o,r,n,a,s,c,l,d,v,u,h,g,p){var S;!function(){t.MsalClaimsService={};class e extends i.VssService{getMsalClaims(e,t){return(0,o.tryGetLocalStorageValue)(this._getClaimsKey(e,t),null)||void 0}storeMsalClaims(e,t,i){return(0,o.trySetLocalStorageValue)(this._getClaimsKey(e,t),i)}clearMsalClaims(e,t){const i=this._getClaimsKey(e,t);for(const e in localStorage)e.startsWith(i)&&(0,o.trySetLocalStorageValue)(e,void 0)}_getClaimsKey(e,t){return`webplatform.claims..${e}.${t}`}}i.Services.add("IMsalClaimsService",{serviceFactory:e})}(),function(e){t[e]={},t[e].DatabaseName="msal-token-cache",t[e].ObjectStoreName="tokenCache";class o extends i.VssService{async writeToken(i,o){try{if((0,r.isFeatureFlagEnabled)(this.pageContext,"WebPlatform.ServiceWorker.IndexedDB.Disabled",!1))return;if(i===this._lastToken)return;this._lastToken=i;const n=await this._getTokenKey();if(n){const r=await this._openTokenCache(),a=new Promise(((a,s)=>{const c=r.transaction([t[e].ObjectStoreName],"readwrite").objectStore(t[e].ObjectStoreName).put({key:n,token:i,expiresOn:o});c.onerror=e=>{s(e)},c.onsuccess=e=>{a()}}));await a}}catch(e){(0,n.traceException)(this.pageContext,"vss-msal","ServiceWorkerTokenStore.writeToken",e)}}async deleteToken(){try{const i=await this._getTokenKey();if(i){const o=await this._openTokenCache(),r=new Promise(((r,n)=>{const a=o.transaction([t[e].ObjectStoreName],"readwrite").objectStore(t[e].ObjectStoreName).delete(i);a.onerror=e=>{n(e)},a.onsuccess=e=>{r(e)}}));await r}}catch(e){(0,n.traceException)(this.pageContext,"vss-msal","ServiceWorkerTokenStore.deleteToken",e)}}async clear(){const i=await this._findTokenCache(),o=new Promise(((o,r)=>{const n=null==i?void 0:i.transaction([t[e].ObjectStoreName],"readwrite");if(n||o(),n){n.oncomplete=e=>{o()},n.onerror=e=>{r(n.error)};n.objectStore(t[e].ObjectStoreName).clear()}}));await o}async _getTokenKey(){const e=this.pageContext.getService("IVssServiceWorkerService");return await e.getScope()}_openTokenCache(){return new Promise(((i,o)=>{const r=indexedDB.open(t[e].DatabaseName,1);r.onerror=e=>{console.log(e),o()},r.onupgradeneeded=i=>{i.target.result.createObjectStore(t[e].ObjectStoreName,{keyPath:"key"}).createIndex("key","key",{unique:!0})},r.onsuccess=e=>{const t=e.target.result;i(t)}}))}async _findTokenCache(){if((await window.indexedDB.databases()).find((i=>i.name===t[e].DatabaseName))){const i=new Promise(((i,o)=>{const r=self.indexedDB.open(t[e].DatabaseName);r.onsuccess=e=>{i(e.target.result)},r.onerror=e=>{o(e)}}));return await i}}}i.Services.add("IServiceWorkerTokenStore",{serviceFactory:o})}("ServiceWorkerTokenStore"),function(e){t[e]={};const n="MsalTokenProviderService",h="MsalTokenProvider.initialize",g="MsalTokenProvider.acquireTokenPopup",p="webPlatform.tokenProvider.activeAccount.",S="webPlatform.tokenProvider.acquireTokenRedirect",_="webPlatform.tokenProvider.cacheWatermark";function k(e){const t=e.getService("IVssContributionService").getData("ms.vss-web.msal-config-data");if(t){const e=parseInt((0,u.getCookie)("tfs-msaljs-cachelookuppolicy"));isNaN(e)||(t.cacheLookupPolicy=e);const i=t.configuration;if(i){i.cache||(i.cache={cacheLocation:"localStorage",storeAuthStateInCookie:!1}),i.system||(i.system={}),i.system.loggerOptions||(i.system.loggerOptions={});const e=parseInt((0,u.getCookie)("tfs-msaljs-loglevel"));if(isNaN(e)||(i.system.loggerOptions.logLevel=e),i.auth){const e=(0,u.getCookie)("tfs-msaljs-navigatetologinrequesturl");"1"===e?i.auth.navigateToLoginRequestUrl=!0:"0"===e&&(i.auth.navigateToLoginRequestUrl=!1)}}}return t}t[e].getMsalConfiguration=k;const m=new class{constructor(){this._lkgQueryResourceAreaByInstanceIdFlag=!1}getMsalState(e,t,i,o){let n=!1;try{n=(0,r.isFeatureFlagEnabled)(e,"VisualStudio.Services.WebPlatform.RedirectFlow.QueryResourceAreaByInstanceId",!1),this._lkgQueryResourceAreaByInstanceIdFlag=n}catch(e){n=this._lkgQueryResourceAreaByInstanceIdFlag}const a=(()=>{let t;try{t=k(e),this._lkgConfiguration=t}catch(e){t=this._lkgConfiguration}return t})();if(!i){if(!a)return"";i=a.accessMapping}const s=this.getPageData(e);let c;4===(null==s?void 0:s.hostType)?c=s.hostName:n&&3===(null==s?void 0:s.hostType)&&"ServiceDomainMapping"!==i&&(c=s.hostId);const l={host:c,hostType:null==s?void 0:s.hostType,service:(null==s?void 0:s.serviceInstanceType)||"tfs",isLegacyDomain:"VstsAccessMapping"===i||"00000029-0000-8888-8000-000000000000"==(null==s?void 0:s.serviceInstanceType)&&"PublicAccessMapping"==i,accessMapping:i,type:t,redirectResponseMode:null==a?void 0:a.redirectResponseMode,additionalProperties:o};return JSON.stringify(l)}getPageData(e){let t;try{t=e.getService("IVssPageService").getData(),this._lkgPageData=t}catch(e){t=this._lkgPageData}return t}};function T(e,t,i,o){return m.getMsalState(e,t,i,o)}let C;t[e].getMsalState=T;class f extends i.VssService{getPublicClientApplication(e){return C||(C=new a.PublicClientApplication(e)),C}}i.Services.add("IPublicClientApplicationFactory",{serviceFactory:f});class y extends i.VssService{constructor(){super(...arguments),this._disabled=!1,this._initialized=new s.Observable,this._msalCallbackId=null,this._telemetryDisabled=!1,this._channel=void 0,this._eventCallback=e=>{var t,i;if(e.eventType==a.EventType.ACQUIRE_TOKEN_FAILURE&&e.interactionType==a.InteractionType.Silent)this._telemetryDisabled=!0;else if(e.eventType==a.EventType.ACQUIRE_TOKEN_SUCCESS){const t=e.payload;this._informServiceWorker(t.accessToken,t.expiresOn||void 0),this._telemetryDisabled=!1}if(e.eventType==a.EventType.POPUP_OPENED){this.pageContext.getService("IVssPerformanceService").addSplitTiming("popupOpened",g)}else if(e.interactionType==a.InteractionType.Popup&&(e.eventType==a.EventType.ACQUIRE_TOKEN_SUCCESS||e.eventType==a.EventType.ACQUIRE_TOKEN_FAILURE||e.eventType==a.EventType.LOGIN_FAILURE||e.eventType==a.EventType.LOGIN_SUCCESS)){this.pageContext.getService("IVssPerformanceService").addSplitTiming("popupClosed",g)}this._shouldReportEvent(e)&&this._publishEvent({eventType:e.eventType,interactionType:e.interactionType,error:null===(t=e.error)||void 0===t?void 0:t.message,msalCorrelationId:null===(i=e.payload)||void 0===i?void 0:i.correlationId})}}_serviceStart(e){super._serviceStart(e),this._initializationPromise=new Promise(((e,t)=>{this._resolveInitialization=e}));const t=this.pageContext.getService("IVssPageService").getData();t&&(E=t.sessionId);const i=(0,o.tryGetSessionStorageObject)(S);(0,o.trySetSessionStorageObject)(S,void 0),(null==i?void 0:i.previousSessionId)&&(E=i.previousSessionId);const r=this.pageContext.getService("IVssPerformanceService"),n=w(r,h,null==i?void 0:i.startEpochMilliseconds,{location:null==i?void 0:i.location});window.self!==window.top&&(console.log("iframe detected; MSAL token provider is disabled"),this._disabled=!0),"true"==(0,u.getCookie)("tfs-aad-token-disabled")&&(console.log("MSAL token provider disabled via tfs-aad-token-disabled cookie"),this._disabled=!0);const a=this._getProvider();a?((null==i?void 0:i.startEpochMilliseconds)&&n.splitTimings.push({name:"backFromInteractive",timestamp:r.getNavigationStartTime()-n.startTime}),M(r,"MsalTokenProviderService.initializePromise.start"),r.addSplitTiming("MsalTokenProviderService.initializePromise.start",h),this._pca.initialize().then((()=>{M(r,"MsalTokenProviderService.initializePromise.end"),this._spaAuthorizationCode?(console.log("MSAL.js acquiring token with SPA authorization code"),M(r,"MsalTokenProviderService.acquireTokenByCode.start"),this._pca.acquireTokenByCode({code:this._spaAuthorizationCode,scopes:this._scopes}).then((e=>{M(r,"MsalTokenProviderService.acquireTokenByCode.end"),a.setActiveAccount(e.account),console.log("MSAL.js token provider initialization completed via acquireTokenByCode"),this._completeInitialization().then((()=>{this._reportLoginTrackingId(),this._fpsTarget&&(console.log("MSAL.js token provider starting FPS to "+this._fpsTarget),(0,l.FastPageSwitch)(this.pageContext,this._fpsTarget,!1))}))})).catch((e=>{console.log("MSAL.js acquireTokenByCode failed: "+e),this._initialize(a)}))):(M(r,"MsalTokenProviderService.handleRedirectPromise.start"),this._pca.handleRedirectPromise().then((e=>{var t,i;if(M(r,"MsalTokenProviderService.handleRedirectPromise.end"),e){if(e.state){const o=JSON.parse(e.state);if(null===(t=null==o?void 0:o.additionalProperties)||void 0===t?void 0:t.redirectHandler){console.log("MSAL.js token provider initialization completed for proof of presence"),this._completeInitialization();const t=this.pageContext.getService("IVssContributionService"),r=t.getContributionChildren("ms.vss-web.msal-redirect-callback-handlers");if(r&&r.length>0)for(const n of r){const r=t.getServiceSync(n);if((null==r?void 0:r.name)===(null===(i=null==o?void 0:o.additionalProperties)||void 0===i?void 0:i.redirectHandler)){null==r||r.invoke(e,o.additionalProperties);break}}return}}a.setActiveAccount(e.account),console.log("MSAL.js token provider initialization completed via handleRedirectPromise"),this._completeInitialization().then((()=>{this._fpsTarget&&(0,l.FastPageSwitch)(this.pageContext,this._fpsTarget,!1)}))}else console.log("MSAL.js token provider init: no in-flight redirect promise"),this._initialize(a)})).catch((e=>{console.log("MSAL.js token provider init: handling in-flight redirect promise failed: "+e),this._initialize(a)})))})).catch((e=>{M(r,"MsalTokenProviderService.initializePromise.end"),console.log("PublicClientApplication.initialize failed: "+e),this._disabled=!0,this._completeInitialization()}))):(console.log("MSAL.js token provider disabled"),M(r,"MsalTokenProviderService.disabled"),setTimeout((()=>this._completeInitialization()),0))}_initialize(e){var t;const i=this.pageContext.getService("IVssContributionService");try{if((i.getContributionChildren("ms.vss-web.msal-signout-signal-container")||[]).length>0)return console.log("MSAL.js token provider detected signout; not acquiring any more tokens"),this._disabled=!0,void e.acquireTokenSilent(a.CacheLookupPolicy.AccessToken).finally((()=>{this._completeInitialization()}))}catch(e){console.log("MSAL.js token provider init: error checking for signout signal: "+e)}const r=this.pageContext.getService("IVssPerformanceService");let n;try{n=e.getActiveAccount()}catch(t){return console.log(t),void this._logout(e)}if(n)console.log("MSAL.js token provider init: acquireTokenSilent"),M(r,"MsalTokenProviderService.acquireTokenSilent.start"),e.acquireTokenSilent().then((t=>{var i;M(r,"MsalTokenProviderService.acquireTokenSilent.end"),t.interactionRequired?(console.log("MSAL.js token provider init: interaction required"),(0,o.trySetSessionStorageObject)(S,{startEpochMilliseconds:(null===(i=r.getActiveScenario(h))||void 0===i?void 0:i.startTime)||r.getNavigationStartTime(),location:window.location.href}),e.acquireTokenRedirect().catch((t=>{console.log("MSAL.js token provider init: acquireTokenRedirect failed with "+t),this._logout(e)}))):(t.error&&console.log(t.error),console.log("MSAL.js token provider initialization complete"),this._completeInitialization())}));else{try{const e=this.pageContext.getService("IMsalLoginProviderService");if(e&&!e.loginRequired)return console.log("MSAL.js login provider service says no login is necessary; disabling MSAL.js; initialization complete"),this._disabled=!0,void this._completeInitialization()}catch(e){console.log(e)}(0,o.trySetSessionStorageObject)(S,{startEpochMilliseconds:(null===(t=r.getActiveScenario(h))||void 0===t?void 0:t.startTime)||r.getNavigationStartTime(),previousSessionId:E,location:window.location.href}),console.log("MSAL.js token provider init: loginRedirect"),e.loginRedirect()}}async _logout(e){var t,i;await x(this.pageContext);const o=null===(i=null===(t=e.getActiveAccount())||void 0===t?void 0:t.idTokenClaims)||void 0===i?void 0:i.oid;if(o){this.pageContext.getService("IMsalClaimsService").clearMsalClaims(e.clientId,o)}console.log("MSAL.js token provider init: calling logoutRedirect"),await this._pca.logoutRedirect({onRedirectNavigate:()=>!1}),await e.loginRedirect()}get initialized(){return this._initialized}async clearCache(){if(this._pca)return await this._pca.clearCache()}async logout(){var e,t,i,o,n;try{const e=new Promise(((e,t)=>{setTimeout((()=>{t("Initialization timed out")}),2e3)}));await Promise.race([this._initializationPromise,e])}catch(e){this._storeEvent({error:e}),console.log(e)}try{const o=null===(i=null===(t=null===(e=this._provider)||void 0===e?void 0:e.getActiveAccount())||void 0===t?void 0:t.idTokenClaims)||void 0===i?void 0:i.oid;if(o){this.pageContext.getService("IMsalClaimsService").clearMsalClaims(this._provider.clientId,o)}}catch(e){this._storeEvent({error:e}),console.log(e)}if(!this._pca)try{if((0,r.isFeatureFlagEnabled)(this.pageContext,"WebPlatform.Authentication.AllowMsalInIFramesForSignout",!1)){console.log("iframe detected; creating PCA for signout");const e=k(this.pageContext),t=null==e?void 0:e.configuration;t?this._pca=this._createPca(t):console.log("no MSAL configuration found, cannot create PCA")}}catch(e){this._storeEvent({error:e}),console.log(e)}if(this._pca){try{await this._pca.logoutRedirect({onRedirectNavigate:e=>!1})}catch(e){this._storeEvent({error:e}),console.log(e)}try{this._pca.clearCache()}catch(e){this._storeEvent({error:e}),console.log(e)}}else console.log("not clearing MSAL.js cache because PCA is unavailable");try{if(null===window||void 0===window?void 0:window.sessionStorage){const e=Object.keys(window.sessionStorage);for(let t=0;t<e.length;++t)e[t].startsWith(p)&&sessionStorage.removeItem(e[t])}}catch(e){this._storeEvent({error:e}),console.log(e)}try{const e=this.pageContext.getService("IServiceWorkerTokenStore");await e.clear()}catch(e){this._storeEvent({error:e}),console.log(e)}try{null===(n=null===(o=navigator.serviceWorker)||void 0===o?void 0:o.controller)||void 0===n||n.postMessage({type:"logout",version:1})}catch(e){this._storeEvent({error:e}),console.log(e)}}getDefaultProvider(){return this.getPopupProvider()}getSilentProvider(){if(!this._silentTokenProvider){const e=this._getProvider();if(!e)return;this._silentTokenProvider=new P(e,(()=>this._telemetryDisabled=!1),(()=>this._telemetryDisabled=!0))}return this._silentTokenProvider}getPopupProvider(){if(!this._popupTokenProvider){let e=!0;(0,r.isFeatureFlagEnabled)(this.pageContext,v.ClaimsFeatureName,!1)&&(e=!1);const t=this._getProvider();if(!t)return;this._popupTokenProvider=new b(t,e)}return this._popupTokenProvider}getRedirectProvider(e){const t=this._getProvider();if(t)return new A(t,e)}_getProvider(){if(!this._disabled){if(!this._provider){if(!this.pageContext.getService("IVssContributionService").getContribution("ms.vss-web.msal-js-token-provider"))return console.log("msal-js-token-provider is not available. MSAL token provider is disabled"),void(this._disabled=!0);const e=k(this.pageContext),t=null==e?void 0:e.configuration;if(!t)return console.log("no MSAL configuration found. MSAL token provider is disabled"),void(this._disabled=!0);const i=parseInt((0,o.tryGetLocalStorageValue)(_,"0")||"0");e.cacheWatermark&&(isNaN(i)||e.cacheWatermark>i)&&(this._publishEvent({eventType:"clearCache",description:"clearing localStorage because the watermark is out of date"}),localStorage.clear(),(0,o.trySetLocalStorageValue)(_,Math.max((new Date).getTime(),e.cacheWatermark).toString())),this._pca=this._createPca(t),this._provider=new I(this.pageContext,this._pca,e),this._spaAuthorizationCode=e.spaAuthorizationCode,this._fpsTarget=e.fpsTarget,this._loginTrackingId=e.loginTrackingId,this._scopes=e.scopes,this._msalCallbackId=this._pca.addEventCallback(this._eventCallback)}return this._provider}}_createPca(e){e.system.loggerOptions.loggerCallback=(e,t,i)=>{if(!i)switch(this._recordMsalLogs(e,t),e){case a.LogLevel.Error:return void console.error(t);case a.LogLevel.Info:return void console.info(t);case a.LogLevel.Verbose:return void console.debug(t);case a.LogLevel.Warning:return void console.warn(t);case a.LogLevel.Trace:return void console.trace(t)}};return this.pageContext.getService("IPublicClientApplicationFactory").getPublicClientApplication(e)}_serviceEnd(e){this._msalCallbackId&&this._pca.removeEventCallback(this._msalCallbackId)}_informServiceWorker(e,t){var i,o;if(L(this.pageContext)||(0,l.isCookielessFlowEnabled)(this.pageContext)){if(t){this.pageContext.getService("IServiceWorkerTokenStore").writeToken(e,t)}null===(o=null===(i=navigator.serviceWorker)||void 0===i?void 0:i.controller)||void 0===o||o.postMessage({type:"acquireTokenSuccess",version:1,token:e,expiresOn:t})}}_shouldReportEvent(e){return e.eventType==a.EventType.ACQUIRE_TOKEN_BY_CODE_SUCCESS||e.eventType==a.EventType.ACQUIRE_TOKEN_BY_CODE_FAILURE||e.eventType==a.EventType.ACQUIRE_TOKEN_FAILURE||e.eventType==a.EventType.ACQUIRE_TOKEN_NETWORK_START||e.eventType==a.EventType.LOGIN_FAILURE||e.eventType==a.EventType.LOGIN_START||e.eventType==a.EventType.LOGIN_SUCCESS||e.eventType==a.EventType.POPUP_OPENED||e.eventType==a.EventType.ACQUIRE_TOKEN_SUCCESS&&(e.interactionType==a.InteractionType.Popup||e.interactionType==a.InteractionType.Redirect)}_recordMsalLogs(e,t){e>=a.LogLevel.Info||this._publishEvent({eventType:"logging",level:e,message:t})}async _completeInitialization(){const e=this.pageContext.getService("IVssPerformanceService");if(this._disabled||!L(this.pageContext)&&!(0,l.isCookielessFlowEnabled)(this.pageContext)||this._setupBroadcastChannel(),!this._disabled&&(L(this.pageContext)||(0,l.isCookielessFlowEnabled)(this.pageContext))){M(e,"MsalTokenProviderService.waitForServiceWorker.start");const t=this.pageContext.getService("IVssServiceWorkerService");await t.waitForActive(),M(e,"MsalTokenProviderService.waitForServiceWorker.end")}M(e,"MsalTokenProviderService.initializationComplete"),e.endScenario(n,h,!1,void 0,{isDisabled:this._disabled}),document.dispatchEvent(new CustomEvent("authenticationInitialized",{})),this._initialized.notify(!0,"initialized",!0),this._resolveInitialization&&this._resolveInitialization()}_publishEvent(e){this._telemetryDisabled||(0,d.publishEvent)(this.pageContext,"WebPlatform","MsalTokenProviderService",R(e))}_storeEvent(e){(0,d.storeEvent)(this.pageContext,"WebPlatform","MsalTokenProviderService",R(e))}_reportLoginTrackingId(){this._loginTrackingId&&this._publishEvent({eventType:"loginTracking",loginTrackingId:this._loginTrackingId})}_setupBroadcastChannel(){try{this._channel=new BroadcastChannel("msalTokenRequest"),this._channel.onmessage=e=>{"tokenRequest"===e.data.type&&1===e.data.version&&this._provider.acquireTokenSilent()}}catch(e){console.error("msalTokenRequest channel setup failed: "+e),this._channel&&(this._channel.close(),this._channel=void 0)}}}t[e].MsalTokenProviderService=y,i.Services.add("IMsalTokenProviderService",{serviceFactory:y,options:6});class P{constructor(e,t,i){this._reportedSilentError=!1,this._provider=e,this._onSuccess=t,this._onError=i}get providerName(){return this._provider.providerName}async getAuthorizationHeader(e){var t;const i=await this._provider.acquireTokenSilent(a.CacheLookupPolicy.AccessToken);if(i.token)return this._reportedSilentError=!1,this._onSuccess&&this._onSuccess(),(0,c.getBearerTokenAuthHeaderValue)(i.token);if(i.error instanceof a.ClientAuthError){if(i.error.errorCode===a.ClientAuthErrorCodes.tokenRefreshRequired)return""}if(this._onError&&this._onError(),!this._reportedSilentError){this._reportedSilentError=!0;const e={eventType:"SilentMsalTokenProvider.error",error:null===(t=i.error)||void 0===t?void 0:t.message,interactionRequired:i.interactionRequired};i.error instanceof a.AuthError&&(e.msalCorrelationId=i.error.correlationId,e.errorCode=i.error.errorCode,e.subError=i.error.subError),this._provider.publishEvent(e)}return""}handleClaimsChallenge(e){return this._provider.handleClaimsChallenge(e)}}class A{constructor(e,t){this._provider=e,this._targetLocation=t}get providerName(){return this._provider.providerName}async getAuthorizationHeader(e){if(e)try{return await this._provider.acquireTokenRedirect(this._targetLocation)}catch(e){console.log(e)}else{const e=await this._provider.acquireTokenSilent();if(e.token)return(0,c.getBearerTokenAuthHeaderValue)(e.token);if(e.interactionRequired)try{return await this._provider.acquireTokenRedirect(this._targetLocation)}catch(e){console.log(e)}}return""}handleClaimsChallenge(e){return this._provider.handleClaimsChallenge(e)}}class b{constructor(e,t){this._provider=e,this._suppressRedirect=t}get providerName(){return this._provider.providerName}get skipFedAuthRedirectHeader(){return this._suppressRedirect}async getAuthorizationHeader(e){let t="";if(e)t=await this._provider.acquireTokenPopup();else{const e=await this._provider.acquireTokenSilent();e.token?t=e.token:e.interactionRequired&&(t=await this._provider.acquireTokenPopup())}return t?(0,c.getBearerTokenAuthHeaderValue)(t):""}handleClaimsChallenge(e){return this._provider.handleClaimsChallenge(e)}}class I{constructor(e,t,i){this._cacheLookupPolicy=i.cacheLookupPolicy||a.CacheLookupPolicy.Default,this._configuration=i,this._fatalErrorCodes=i.fatalErrorCodes||[],this._pageContext=e,this._pca=t,this._scopes=i.scopes,this._bypassPcaActiveAccount=(0,r.isFeatureFlagEnabled)(this._pageContext,"VisualStudio.WebPlatform.MsalConfig.BypassPcaActiveAccount",!1)}get providerName(){return"MsalTokenProvider"}get clientId(){return this._configuration.configuration.auth.clientId}async acquireTokenSilent(e=this._cacheLookupPolicy){const t=await this._acquireToken((async()=>{try{const t=await this._acquireTokenSilent(e);return{token:this._handleAuthenticationResult(t),expiresOn:t.expiresOn||void 0}}catch(e){return this._isFatalError(e)&&await this._handleFatalError(e),{error:e}}}));return{error:t.error,interactionRequired:this._isInteractionRequiredError(t.error),token:t.token,expiresOn:t.expiresOn}}async acquireTokenPopup(){var e;return null!==(e=(await this._acquireToken((async()=>{try{return{token:(await this._acquireTokenPopup()).accessToken}}catch(e){return{error:e}}}))).token)&&void 0!==e?e:""}async acquireTokenRedirect(e){var t;return null!==(t=(await this._acquireToken((async()=>((0,o.tryGetSessionStorageObject)(S)||(0,o.trySetSessionStorageObject)(S,{startEpochMilliseconds:(new Date).getTime(),location:e,previousSessionId:E}),await this._acquireTokenRedirect(e),{token:""})))).token)&&void 0!==t?t:""}async loginRedirect(e){await this._acquireToken((async()=>((0,o.tryGetSessionStorageObject)(S)||(0,o.trySetSessionStorageObject)(S,{startEpochMilliseconds:(new Date).getTime(),previousSessionId:E,location:window.location.href}),console.log("calling loginRedirect"),await this._pca.loginRedirect(this._getRedirectRequest(e)),{token:""})))}handleClaimsChallenge(e){var t,i;if((0,r.isFeatureFlagEnabled)(this._pageContext,v.ClaimsFeatureName,!1)){const o=(0,v.parseChallenges)(e),r=null===(i=null===(t=this.getActiveAccount())||void 0===t?void 0:t.idTokenClaims)||void 0===i?void 0:i.oid;if(r){return this._pageContext.getService("IMsalClaimsService").storeMsalClaims(this._configuration.configuration.auth.clientId,r,o.claims)}}return!1}publishEvent(e){(0,d.publishEvent)(this._pageContext,"WebPlatform","MsalTokenProviderService",R(e))}setActiveAccount(e){this._bypassPcaActiveAccount?(0,o.trySetSessionStorageObject)(this._getActiveAccountStorageKey(),e):this._pca.setActiveAccount(e)}getActiveAccount(){var e,t;if(this._bypassPcaActiveAccount){let i=(0,o.tryGetSessionStorageObject)(this._getActiveAccountStorageKey());if(!i){const o=(null===(e=this._configuration.authenticatedUser)||void 0===e?void 0:e.tenantId)||"",r=(null===(t=this._configuration.authenticatedUser)||void 0===t?void 0:t.oid)||"",n=this._pca.getAllAccounts();if(o&&r&&(i=n.find(((e,t)=>e.tenantId.toLowerCase()==o&&e.localAccountId.toLowerCase()==r)),!i))return;i?this.setActiveAccount(i):i=this._pca.getActiveAccount()||n[0]}return i}return this._pca.getActiveAccount()||this._pca.getAllAccounts()[0]}_getActiveAccountStorageKey(){var e,t;const i=null!==(t=null===(e=m.getPageData(this._pageContext))||void 0===e?void 0:e.hostId)&&void 0!==t?t:"";return p+i}_acquireToken(e){return this._activePromise||(this._activePromise=e()),this._activePromise.finally((()=>{delete this._activePromise})),this._activePromise}async _acquireTokenSilent(e){const t="MsalTokenProvider.acquireTokenSilent",i=Date.now(),o=await this._pca.acquireTokenSilent({account:this.getActiveAccount(),scopes:this._scopes,cacheLookupPolicy:e,state:T(this._pageContext,"popup"),claims:this._getMsalClaims()});if(!o.fromCache){const e=this._pageContext.getService("IVssPerformanceService");w(e,t,i),e.endScenario(n,t,!1)}return o}async _acquireTokenPopup(){const e=this._pageContext.getService("IVssNavigationService"),t=this._pageContext.getService("IVssPerformanceService");w(t,g,void 0,{currentRoute:e.getCurrentRoute().routeId});try{return await this._pca.acquireTokenPopup({account:this.getActiveAccount(),scopes:this._scopes,state:T(this._pageContext,"popup"),claims:this._getMsalClaims()})}finally{t.endScenario(n,g,!1)}}_acquireTokenRedirect(e){const t=this._getRedirectRequest(e);return console.log("calling acquireTokenRedirect with targetLocation "+e),this._pca.acquireTokenRedirect(t)}_getRedirectRequest(e){return{account:this.getActiveAccount(),scopes:this._scopes,state:T(this._pageContext,"redirect"),redirectStartPage:e,claims:this._getMsalClaims()}}_handleAuthenticationResult(e){var t,i;if(e.accessToken&&!e.fromCache&&(0,r.isFeatureFlagEnabled)(this._pageContext,v.ClaimsFeatureName,!1)){const e=null===(i=null===(t=this.getActiveAccount())||void 0===t?void 0:t.idTokenClaims)||void 0===i?void 0:i.oid;if(e){this._pageContext.getService("IMsalClaimsService").clearMsalClaims(this._configuration.configuration.auth.clientId,e)}}return this.setActiveAccount(e.account),e.accessToken}_getMsalClaims(){var e,t;if((0,r.isFeatureFlagEnabled)(this._pageContext,v.ClaimsFeatureName,!1)){const i=null===(t=null===(e=this.getActiveAccount())||void 0===e?void 0:e.idTokenClaims)||void 0===t?void 0:t.oid;if(i){const e=this._pageContext.getService("IMsalClaimsService").getMsalClaims(this._configuration.configuration.auth.clientId,i);if(e)return window.atob(e)}}}_isFatalError(e){return this._fatalErrorCodes.some((t=>{var i;return null===(i=e.message)||void 0===i?void 0:i.includes(t)}))}async _handleFatalError(e){console.log(e),await x(this._pageContext),await this._pca.logoutRedirect({onRedirectNavigate:()=>!1}),await this._pca.loginRedirect(this._getRedirectRequest())}_isInteractionRequiredError(e){if(!e)return!1;if(e instanceof a.InteractionRequiredAuthError||e instanceof a.BrowserAuthError)return!0;if(e instanceof a.ServerError){return"invalid_grant"===e.errorCode}return!1}}let E="";function w(e,t,i,o){return e.startScenario(t,!1,i,R(o))}function M(e,t){e.addSplitTiming(t,h),e.addSplitTiming(t)}function R(e){return e||(e={}),e.msalTokenProviderSessionId=E,e}function L(e){return e.getService("IVssServiceWorkerService").enabled}async function x(e){var t,i;try{if(L(e)||(0,l.isCookielessFlowEnabled)(e)){const o=e.getService("IServiceWorkerTokenStore");await o.deleteToken();try{null===(i=null===(t=navigator.serviceWorker)||void 0===t?void 0:t.controller)||void 0===i||i.postMessage({type:"logout",version:1})}catch(e){console.log(e)}}}catch(e){console.log(e)}}}("MsalAuthentication"),t[S="MsalSignout"]={},t[S].signout=async function(){const e=(0,i.getService)("ITokenProviderService");e&&await e.logout()},function(){t.LoadingComponent={};class e extends h.Component{render(){return h.createElement(g.WrappedComponent,{className:"flex flex-grow absolute-fill",wrappedType:"spinner",size:"large",label:p.Loading})}}g.VssComponent.register("msal.loadingSpinner",e)}()}),["MsalClaimsService","ServiceWorkerTokenStore","MsalAuthentication","MsalSignout","LoadingComponent"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-web.msal-content"}}));
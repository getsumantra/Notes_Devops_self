"use strict";define("PipelinesUI",["require","exports","react","VSSUI/Icon","VSS/Core/Observable","VSSUI/Button","VSSUI/Intersection","VSSUI/Measure","VSSUI/Observer","VSSUI/Spinner","VSSUI/Status","VSSUI/TooltipEx","VSSUI/TreeEx","VSSUI/Util","VSSUI/Utilities/TreeItemProvider"],(function(e,t,n,s,i,o,r,l,a,c,h,d,u,g,p){var _,m,f,y,v,x;_=t[x="Resources"]={},t[x].Copied="Copied to clipboard",t[x].CopyLink="Copy permalink",t[x].ExpandGroup="Expand group on line {0}",t[x].LogSection="Logs section",t[x].SpinnerLabel="Loading...",t[x].SearchKeyword="Type a keyword to search..",function(e){m=t[e]={};t[e].TimestampRegex=/^.{27}Z /gm,t[e].BrightClassPostfix=" bright",t[e].RegexToIdentify=/\u200C/;const n=/(?:\u001b\[)(?:[\?|#])?(?:(?:[0-9]{1,3})?(?:(?:;[0-9]{0,3})*)?[A-Z|a-z])/;t[e].ansiEscapeCodeRegexString="(?:\\[)(?:[?|#])?(?:(?:[0-9]{1,3})?(?:(?:;[0-9]{0,3})*)?[A-Z|a-z])";const s=/https?\:\/\/([^\]\):\s]*([\]\):](?!\s))*)+/;var i;!function(e){e.Reset="0",e.Bold="22",e.Italic="23",e.Underline="24",e.Fg="39",e.Bg="49"}(i||(i={}));const o={1:"bold",3:"italic",4:"underline"};var r;t[e].bgColors={40:"b",41:"r",42:"g",43:"y",44:"bl",45:"m",46:"c",47:"w",100:"gr"},t[e].fgColors={30:"b",31:"r",32:"g",33:"y",34:"bl",35:"m",36:"c",37:"w",90:"gr"},t[e].plain="plain",t[e].command="command",t[e].debug="debug",t[e].error="error",t[e].info="info",t[e].section="section",t[e].verbose="verbose",t[e].warning="warning",t[e].group="group",t[e].endGroup="endgroup",t[e].icon="icon",t[e].commandToType={command:1,debug:2,error:3,info:4,section:5,verbose:6,warning:7,group:8,endgroup:9,icon:10},function(e){e[e.Group=0]="Group",e[e.Icon=1]="Icon"}(r=t[e].RenderType||(t[e].RenderType={})),t[e].commandToRenderType={group:r.Group,icon:r.Icon},t[e].typeToCommand={0:t[e].plain,1:t[e].command,2:t[e].debug,3:t[e].error,4:t[e].info,5:t[e].section,6:t[e].verbose,7:t[e].warning,8:t[e].group,9:t[e].endGroup,10:t[e].icon};const l=[t[e].command,t[e].debug,t[e].error,t[e].info,t[e].section,t[e].verbose,t[e].warning,t[e].group,t[e].endGroup,t[e].icon];function a(e){let t="";e=e||"";for(let n=0;n<e.length;n++){const s=e.charAt(n);t+="&"===s?"&amp;":"<"===s?"&lt;":">"===s?"&gt;":'"'===s?"&quot;":"'"===s?"&#x27;":"/"===s?"&#x2F;":s}return t}function c(e){return(e||"").toLocaleLowerCase()}t[e].getType=function(n){return t[e].typeToCommand[n.type]},t[e].escape=a,t[e].getText=c;const h=-1;t[e].Parser=class{parse(e,t,n,s,i){let o="";return this.getStates(e).forEach((e=>{let r="";const l=e.output;if(e.style){let t=e.style.fg,n=e.style.bg;t&&(r+=`ansifg-${t} `),n&&(r+=`ansibg-${n} `),e.style.bold&&(r+="fontWeightHeavy "),e.style.italic&&(r+=" italic"),e.style.underline&&(r+=" underline")}let a="<span";r&&(a+=` class='${r}'`),i&&(a+=` id='${i}'`),a+=">";let h="",d=-1,u=0,g=[];if(n){const e=n.selectedLine;let t=!1;n.lines.slice(0,100).forEach((n=>{n.line===e&&(t=!0),g.push(n.line)})),e&&!t&&g.push(n.selectedLine)}if(n&&-1!==g.indexOf(t)){const e=n.text;let i=1;const o=c(l);for(;-1!==(d=o.indexOf(c(e),d+1))&&!(i>=50);){const o=l.substring(u,d);o&&(h+=this._escape(o,!1)),u=d+e.length;const r=l.substring(d,u);h+=`<span class="dt-fm ${t===n.selectedLine?"select":""}">`+this._escape(r,!!s)+"</span>",i++}if(u>0&&l.length>u){const e=l.substring(u,l.length);h+=this._escape(e,!1)}1===i&&(h=this._escape(l,!0))}else h=this._getLink(l,s);o+=a+h+"</span>"})),o}parseLines(n,s,i){let o=[],r=[],a=s||0,c=a,d=h,u=!0,g="",p="",_=h;const m=()=>{p="",g=""},f=()=>{d=h},y=()=>{if(-1!==l.indexOf(g)){if(u=!1,f(),_=t[e].commandToType[g],g===t[e].section||g===t[e].group||g===t[e].endGroup||g===t[e].command){if(!(n.substring(c,c+29)||"").match(t[e].TimestampRegex)){const e="##"===n.substring(c,c+2)?4:2;c=c+e+g.length}}g===t[e].group&&(x=!0),g===t[e].endGroup&&v&&(L=!0)}m()};let v,x=!1,L=!1,w=i||0;"\n"===n.charAt(a)&&(a+=1,c+=1);for(let s=a;s<n.length;s++){const l=n.charAt(s);if(u=!0,"\n"===l||s===n.length-1){"]"===l&&y();let e={type:_,start:c,end:s,lineIndex:o.length+(i||0)},t=!1;0!==_?(t=!0,x&&(v=e,x=!1),L&&v&&(t=!1,v.isGroup=!0,L=!1,v=void 0)):0===_&&(t=!0),t&&(e.index=w++,r.push(e)),v&&e!==v&&(e.group={lineIndex:v.lineIndex,nodeIndex:v.index});const n=o.length+1+(i||0);r.length>0&&o.push({nodes:r,lineNumber:n}),r=[],c=s+1,f(),_=h,m(),u=!1}else if("#"===l)""!==p&&"#"!==p||(u=!1,p+="#");else if("["===l)("##"===p||0===p.length)&&(u=!1,p+="[");else if("]"===l){if(g===t[e].icon){let e=s+1,t=e;for(let s=e;s<n.length;s++){if(" "===n[s]){t=s;break}}r.push({type:10,lineIndex:o.length,start:e,end:t,index:w++}),s=t+1,c=s;continue}y()}u&&("##["!==p&&"["!==p||(g+=l.toLowerCase()),g.length>8&&m(),d===h&&(d=c,_===h&&(_=0)))}return o}getStates(s){let r=[];if(!n.test(s))return[{output:s}];let l="",a="",c="",h={},d=!1,u=[];for(let n=0;n<s.length;n++){const g=s[n];d?";"===g?c&&(u.push(c),c=""):"m"===g?(c?(d=!1,u.push(c),h.style=h.style||{},u.forEach((n=>{const s=h.style,r=parseInt(n);t[e].fgColors[n]?s.fg=t[e].fgColors[n]:t[e].bgColors[n]?s.bg=t[e].bgColors[n]:n===i.Fg?s.fg="":n===i.Bg?s.bg="":r>=91&&r<=97?s.fg=t[e].fgColors[r-60]+t[e].BrightClassPostfix:r>=101&&r<=107?s.bg=t[e].bgColors[r-60]+t[e].BrightClassPostfix:o[n]?s[o[n]]=!0:n===i.Bold?s.bold=!1:n===i.Italic?s.italic=!1:n===i.Underline&&(s.underline=!1)})),l="",a="",c=""):(d=!1,l=""),u=[]):isNaN(parseInt(g))?(c="",d=!1,l=""):4===c.length?(c="",d=!1,""!==g&&(l="",a+=g)):c+=g:l?""===l&&"["===g&&(d=!0,a&&(h.output=a,r.push(h),h={},a="")):""===g?l=g:a+=g}return a&&(h.output=a+(l||""),r.push(h)),r}_escape(e,t){return t?e:a(e)}_wrapLink(e){return`<a class="is-link" href= ${e}>`+e+"</a>"}_getLink(e,t){const n=e.match(s);if(n){const s=e.split(n[0])[0],i=this._escape(n[0],!!t),o=e.indexOf(n[0])+n[0].length;let r=e.slice(o);return"\n"!==r&&"\r\n"!==r&&(r=this._getLink(r,t)),this._escape(s,!!t)+this._wrapLink(i)+r}return this._escape(e,!!t)}}}("UtilitiesParser"),function(e){f=t[e]={};const i=e=>n.createElement("span",{dangerouslySetInnerHTML:{__html:e.data}});class o extends n.Component{render(){const e=this.props;return n.createElement(n.Fragment,null,e.line.nodes.map((t=>{const o=(e.raw||"").substring(t.start,t.end+1),r=e.subParser.parse(o,e.lineNumber,e.findResult,e.pureHTML,e.contentId);switch(t.type){case 10:return n.createElement("span",{key:t.index},n.createElement(s.Icon,{iconName:o.trim(),className:"line-icon"}));case 8:return n.createElement("span",{key:t.index},n.createElement("span",{className:"group-expand"},n.createElement(s.Icon,{iconName:"TriangleSolidRight12 "+(e.expanded?"rotate":""),className:"group-icon",role:"button",ariaExpanded:!!e.expanded,ariaLabel:e.expanded?"collapse":"expand"}),n.createElement(i,{data:r})));default:return n.createElement("span",{key:t.index,className:`pl-${(0,m.getType)(t)}`},n.createElement(i,{data:r}))}})))}}t[e].LineTransform=o}("ComponentsLogViewerLineTransform"),function(e){y=t[e]={};t[e].LogParser=class{constructor(){this._parser=new m.Parser}parse(e,t,n){return this._parser.parseLines(e,t,n)}}}("UtilitiesLogParser"),function(e){v=t[e]={};const x="data-line",L="data-sec",w="data-lsec",b=e=>{const t=e.copy&&e.copy.key===e.sectionKey&&e.copy.line===e.line,i=e.onClick?o.Button:"span";return n.createElement(i,Object.assign({key:e.index,className:(0,g.css)("line-area flex-center flex-row flex-grow justify-start",e.className,e.onClick&&"cursor-pointer"),role:"group"},e.onClick?{onClick:e.onClick}:{}),n.createElement("span",Object.assign({className:"flex-noshrink flex-self-start line","data-lsec":e.sectionKey,"data-line":e.line,role:"treeitem"},e.isSnap?{"data-snap":"1"}:{},e.onCopyLink?{onClick:e.onCopyLink}:{})),e.content&&n.createElement("span",{className:"content"},e.content),e.onCopyLink&&n.createElement(d.Tooltip,{text:t?_.Copied:_.CopyLink},n.createElement("span",{className:"link","data-lsec":e.sectionKey,"data-line":e.line,onClick:e.onCopyLink},n.createElement(s.Icon,{iconName:"Link",className:"fontSizeM"}))))};class k extends n.Component{constructor(e){super(e),this._subParser=new m.Parser,this._container=n.createRef(),this._viewerWidth=new i.ObservableValue(0),this._largestRowWidth=new i.ObservableValue(0),this._findLine=new i.ObservableValue(void 0),this._find=new I,this._findText="",this._scrollPending=!1,this._autoScroll=!0,this._maxHeight=85e5,this._showLog={},this._data={},this._sections={},this._selectionChanged={},this._copyChanged={},this._pending={},this._sectionTreeRef={},this.toHome=()=>{this._noScroll(),this._jump(!0)},this.toEnd=()=>{this._jump()},this._containerKeyDown=e=>{if(this._toSelectAll&&(e.ctrlKey||e.metaKey)&&"a"===e.key){const t=document.querySelector(`[${L}="${this._toSelectAll}"]`);if(t){const n=window.getSelection(),s=document.createRange();s.selectNodeContents(t),n.removeAllRanges(),n.addRange(s),e.preventDefault()}}},this._getTreeRef=e=>(this._sectionTreeRef[e]||(this._sectionTreeRef[e]=n.createRef()),this._sectionTreeRef[e]),this._bindKeys=e=>{const t=e.target;t&&"INPUT"===t.tagName||("Home"===e.key?(e.preventDefault(),this.toHome()):"End"===e.key&&(e.preventDefault(),this.toEnd()))},this._onMeasureContainer=(e,t)=>{this._viewerWidth.value!==e&&(this._viewerWidth.value=e,this._viewerWidth.value>this._largestRowWidth.value&&(this._largestRowWidth.value=this._viewerWidth.value))},this._onSectionsChanged=e=>{(e.removedItems||[]).forEach((e=>{delete this._showLog[e.key],delete this._data[e.key],delete this._selectionChanged[e.key],delete this._copyChanged[e.key],delete this._sections[e.key]}));const t=e.addedItems||[],n=e.changedItems||[];return this._initializeSections(t.concat(n),!0),t.length>0},this._findFromIndex=(e,t)=>{if(t&&t.length>0)for(let n=0;n<t.length;n++){if(t[n].data.nodes[0].lineIndex===e)return t[n];if(!t[n+1]||t[n+1].data.nodes[0].lineIndex>e)return this._findFromIndex(e,t[n].childItems)}},this._reFind=()=>{this._findText&&requestAnimationFrame((()=>{this._find.find(this._findText,this._getFindProps())}))},this._getFindContent=e=>this._data[e]?this._data[e].value.content:"",this._onFind=e=>{if(e&&e.lines.length>0){const t=e.lines[e.toScrollIndex],n=this._data[t.key]&&this._data[t.key].value;n&&(this._findLine.value={key:t.key,line:t.line},this._scrollPending=!0,n.findResult=e,this._scrollToLine())}else this._findLine.value=void 0,Object.keys(this._showLog).forEach((e=>{let t=Object.assign({},this._data[e].value);t.findResult=void 0,this._data[e].value=t}))},this._onScroll=()=>{const e=this._container.current;if(this._scrollPending)return;let t=!1;if(this._autoScrollLine){const e=this._getTreeRef(this._autoScrollLine.key).current,n=e&&e.getStats();t=this._autoScrollLine.line===(n&&n.lastMaterialized+1)}this._autoScroll=t||!!this._sections&&!!e&&e.scrollHeight-e.offsetHeight-e.scrollTop<25},this._onSnapLineClick=e=>{if(e){const t=e.currentTarget;if(t){e.stopPropagation();const n=t.querySelector(".link");if(n){const e=n.getAttribute(w)||"";this._sections[e].value.isExpanded=!1;const t=parseInt(n.getAttribute(x)||"");this.select(e,t)}}}},this._copyLink=e=>{var t;if(e){const n=null===(t=e.target)||void 0===t?void 0:t.closest(".link");if(n){e.stopPropagation();const t=n.getAttribute(w)||"",s=parseInt(n.getAttribute(x)||""),i=this.props.sections.value.find((e=>e.key===t));if(i&&i.getLineLink){const e=i.getLineLink(i,s);window.clipboardData&&window.clipboardData.setData("text",e);const n=t=>{t.clipboardData&&t.clipboardData.setData("text",e),t.preventDefault()};document.addEventListener("copy",n);const o=document.execCommand("copy");document.removeEventListener("copy",n),o&&(this._copy={key:t,line:s},this._copyChanged[t].value=!this._copyChanged[t].value,window.history.replaceState(window.history.state,document.title,e))}}}},this._parser=new y.LogParser,this.state={findActive:!1},this._initializeSections(this.props.sections.value)}render(){return n.createElement(a.Observer,{sections:{observableValue:this.props.sections,filter:this._onSectionsChanged},find:this._find.result},(e=>{const t=e.sections;return n.createElement(r.Intersection,null,n.createElement("div",{"aria-label":_.LogSection,className:`pl-reader fontSize ${this.props.className}`,onScroll:this._onScroll,ref:this._container,onKeyDown:this._containerKeyDown},n.createElement(l.Measure,{onMeasure:this._onMeasureContainer},n.createElement("div",{className:"reader-main-content flex-grow"},n.createElement("ol",null,t.map((e=>{const t=e.key;return n.createElement("li",{key:t,"data-sec":t},n.createElement(a.Observer,{findLine:this._find.result,showLog:this._showLog[t],data:this._data[t],section:this._sections[t],largestRowWidth:this._largestRowWidth,viewerWidth:this._viewerWidth},(e=>{const s=e.section,i=e.data.lines||[],r=e.data.lines||[],l=e.showLog&&r.length>0,d=!(!this._showLog[t]||!this._showLog[t].value||0!=r.length),m=s.hasData||i.length>0,y=s.statusProps&&s.statusProps===h.Statuses.Failed;let v;const x=e.findLine;if(x){if(x.markers[t]){v=Object.assign({},x),v.lines=x.lines;const e=x.lines[x.toScrollIndex];e&&e.key===t&&(v.selectedLine=e.line)}}const L=t+"-log",w=e.largestRowWidth<=e.viewerWidth?"100%":`${e.largestRowWidth}px`;let k=e.viewerWidth-50;return n.createElement("div",{className:(0,g.css)("flex-column content-area",s.getLineLink&&"linkable",s.className),style:{width:w}},n.createElement("div",{className:"flex-row sec-sticky"},n.createElement(o.Button,Object.assign({className:(0,g.css)("flex flex-row sec-area",m&&"cursor-pointer",l&&"expand",s.hidden&&"hide"),ariaControls:L,disabled:!m,ariaExpanded:l},m?{onClick:e=>this._onToggleLog(t)}:{}),n.createElement("div",{className:"status-area flex flex-grow",style:{width:k+"px"}},n.createElement("div",{className:"flex-grow flex-self-center flex flex-row sec-content"},n.createElement(S,{iconProps:s.iconProps,statusProps:s.statusProps,spinner:d,noStatusFaint:y}),n.createElement("span",{className:"title text-ellipsis body-m"},s.title)),s.getFarRight&&n.createElement("div",{className:"far-right body-s flex-self-center"},s.getFarRight(s)))),n.createElement("div",{className:"flex-row flex-grow"})),d?n.createElement(c.Spinner,{size:"large",label:_.SpinnerLabel}):n.createElement(u.FixedHeightTree,{id:L,className:(0,g.css)(!l&&"hide"),focuszoneProps:{activateOnEnter:!!s.getLineLink},itemProvider:l?e.data.treeProvider:new p.TreeItemProvider([]),maxHeight:this._maxHeight,onToggle:(t,n)=>{n.underlyingItem.childItems&&e.data.treeProvider&&!t.defaultPrevented&&(e.data.treeProvider.toggle(n.underlyingItem),t.preventDefault())},pageSize:60,renderLoadingRow:(t,s)=>{const i=e.section.asyncInfo;return i?(i.getMore(i.payload),n.createElement("div",{className:"flex-row flex-grow"},n.createElement("div",{className:"shimmer shimmer-line log-async-loading"}))):n.createElement("div",null)},renderRow:(i,o,r)=>n.createElement(a.Observer,{findResult:this._find.result,x:this._copyChanged[t]},(r=>{const l=o.underlyingItem.data.lineNumber,a=this._selection&&this._selection.key===t&&this._selection.lineToScroll===l,c=this._copy&&this._copy.line===l,h=a||c?"highlight":"",d=r.findResult;let u;if(d){if(d.markers[t]){u=Object.assign({},d),u.lines=d.lines;const e=d.lines[d.toScrollIndex];e&&e.key===t&&(u.selectedLine=e.line)}}const p=n.createElement(f.LineTransform,{expanded:o.underlyingItem.expanded,section:t,line:o.underlyingItem.data,pureHTML:s.showHtml,subParser:this._subParser,raw:e.data.content,lineNumber:l,findResult:u,contentId:`rowContent-${i}`});return n.createElement("div",{className:(0,g.css)("line-row flex-row flex-grow",o.underlyingItem.childItems&&"group-item")},n.createElement(b,{index:l,sectionKey:t,className:h,line:l,content:p,onCopyLink:s.getLineLink&&this._copyLink,copy:this._copy}))})),rowHeight:20,ref:e.data.treeRef}),!l&&s.snaps&&s.snaps.length>0&&n.createElement("div",{className:"lines-content"},s.snaps.map(((e,i)=>{const o=this._parser.parse(e.content)[0],r=n.createElement(f.LineTransform,{section:t,line:o,subParser:this._subParser,raw:e.content,lineNumber:e.line,findResult:v});return r&&n.createElement(b,{index:i,sectionKey:t,key:t+i,className:"snap",isSnap:!0,line:e.line,content:r,onClick:this._onSnapLineClick,onCopyLink:s.getLineLink&&this._copyLink,copy:this._copy})}))))})))})))))))}))}componentDidMount(){const e=this._selection&&this._selection.key;e&&this._setContent(e),this._container.current&&this._container.current.focus(),this._find.result.subscribe(this._onFind)}componentWillUnmount(){this._unregisterScrollable(),this._find.result.unsubscribe(this._onFind)}initializeScrollable(e){this._scrollable=e,this._scrollable.addEventListener("keydown",this._bindKeys)}select(e,t){this._showLog[e]&&(t?(this._selection={key:e,lineToScroll:t},this._toLine={key:e,line:t},this._scrollPending=!0):this._selection=void 0,this._setContent(e),this._selectionChanged[e].value=!this._selectionChanged[e].value,this._toSelectAll=e)}updateContent(e){const t=this._showLog[e]&&this._showLog[e].value;void 0!==t&&!0!==t||this._setContent(e,!0)}focus(){this._container.current&&this._container.current.focus()}find(e){this._noScroll(),this._findText=e,this._find.find(this._findText,this._getFindProps())}findNext(){this._findText&&this._find.down()}clearFind(){this._find.result&&(this._find.result.value=void 0)}findPrev(){this._findText&&this._find.up()}getFindResult(){return this._find.result}_noScroll(){this._autoScroll=!1,delete this._autoScrollLine}_getTreeItemsFromLines(e){let t={},n=-1,s=[];for(let i=0;i<e.length;i++){const o=e[i],r=o.nodes[0];if(o.nodes.some((e=>!!e.isGroup)))-1!=n&&(s.push(t[n]),n=-1),n=o.nodes[0].lineIndex,t[n]={data:o};else if(r.group&&t[r.group.lineIndex]){const e=t[r.group.lineIndex];e.childItems?e.childItems.push({data:o}):e.childItems=[{data:o}]}else-1!=n&&(s.push(t[n]),n=-1),s.push({data:o})}return-1!=n&&s.push(t[n]),s}_jump(e=!1){const t=this.props.sections.value||[],n=e?t[0]:t[t.length-1];this._goTo(n,e)}_goTo(e,t){if(this._container.current&&e){let n=this._container.current.querySelector(`[${L}="${e.key}"]`);const s=this.props.sections.value||[];n&&(s.length>1&&n.scrollIntoView({behavior:"auto",block:"center"}),1==s.length&&n.scrollIntoView(t))}}_unregisterScrollable(){this._scrollable&&this._scrollable.removeEventListener("keydown",this._bindKeys)}_initializeSections(e,t=!1){const n=this._selection?this._selection.key:null;e.forEach((e=>{if(this._sections[e.key]){if(this._sections[e.key].value=e,t)return void(this._showLog[e.key].value&&this._setContent(e.key,!0))}else this._sections[e.key]=new i.ObservableValue(e);const s=!(n!==e.key&&!e.isExpanded)||void 0;this._showLog[e.key]?this._showLog[e.key].value=s:this._showLog[e.key]=new i.ObservableValue(s),this._data[e.key]?this._data[e.key].value={}:this._data[e.key]=new i.ObservableValue({}),this._selectionChanged[e.key]?this._selectionChanged[e.key].value=!1:this._selectionChanged[e.key]=new i.ObservableValue(!1),this._copyChanged[e.key]?this._copyChanged[e.key].value=!1:this._copyChanged[e.key]=new i.ObservableValue(!1),e.isExpanded&&this._setContent(e.key)}))}_scroll(e,t,n="center",s){if(e&&e.treeItems&&e.treeRef&&e.treeRef.current){let s,i;if(this.props.scrollToLogLineWhenGroupLogsArePresent){let[n,o]=this._findTreeItemAndLineIndex(t,e.treeItems);s=n,i=o-1}else i=t-1,s=this._findFromIndex(i,e.treeItems);s&&e.treeProvider&&e.treeProvider.expand(s,!0),e.treeRef.current.scrollIntoView(i,{block:n})}requestAnimationFrame((()=>{s&&s()}))}_findTreeItemAndLineIndex(e,t,n){if(t&&t.length>0)for(let s=0;s<t.length;s++){if(t[s].data.lineNumber===e)return[t[s],n?n+s:s];if(!t[s+1]||t[s+1].data.lineNumber>e)return this._findTreeItemAndLineIndex(e,t[s].childItems,s)}return[void 0,e]}_recountLineIndexIfHasGroups(e,t){var n=t.split("\r\n");for(let t=0;t<n.length&&e>t;t++)"##[endgroup]"==n[t]&&e--;return e}_getFindProps(){let e=[],t=[],n=[],s=[];return Object.keys(this._sections).forEach((i=>{const o=this._showLog[i]&&this._showLog[i].value&&this._data[i]&&this._data[i].value;if(o){s.push(i);const r=o.treeRef&&o.treeRef.current&&o.treeRef.current.getStats();r&&n.push({startIndex:r.firstMaterialized,endIndex:r.lastMaterialized});const l=Math.max(e.length-1,0);e=e.concat(o.lines);const a=Math.max(e.length-1,0);t.push({startIndex:l,endIndex:a})}})),{getContent:this._getFindContent,lines:e,sectionKeys:s,sectionMarkers:t,sectionLimits:n}}_onToggleLog(e){this._showLog[e].value=!this._showLog[e].value,this._showLog[e].value&&(this._setContent(e),requestAnimationFrame((()=>{this._scroll(this._data[e].value,0,"nearest")})));let t=this._viewerWidth.value-20;this.props.sections.value.forEach((e=>{let n=this._data[e.key].value;this._showLog[e.key].value&&n.largestRowWidth&&(t=Math.max(t,n.largestRowWidth))})),this._largestRowWidth.value=t,this._reFind()}_setContent(e,t=!1){const n=this.props.sections.value.find((t=>t.key===e));if(n){this._showLog[e].value||(this._showLog[e].value=!0);const s=this._data[e]&&this._data[e].value;if(t||!s.content){this._pending[n.key]=!0;const s=n.getData();s&&(s.then?s.then((s=>{this._onData(n,e,s,t)})):this._onData(n,e,s,t))}else this._onData(n,e,s.content)}}_onData(e,t,n,s){if(!this._data[t])return void console.error("section data can't be null",t);const i=this._data[t].value;let o=0,r=n||"";const l=e.parser||this._parser;let a,c=i.showTimestamps!=this.props.showTimestamps;if(!c&&r.indexOf(i.content)>0&&(c=!0),r=this.props.showTimestamps?r:r.replace(m.TimestampRegex,""),r=r.replace(/[â€œâ€]/g,""),c)a=l.parse(r);else{const e=i.content?i.content.length:0;o=i.lines?i.lines.length:0,a=l.parse(r,e,o)}let h=0;a.forEach((e=>{const t=e.nodes.length;if(t>0){const n=e.nodes[0].start,s=e.nodes[t-1].end;h=Math.max(h,8*(s-n))}}));const d=this._getTreeItemsFromLines(a),u=i.treeItems&&!c?i.treeItems.concat(d):d,g=new p.TreeItemProvider(u),_=e.asyncInfo;_&&_.hasMore&&g.value.unshift({underlyingItem:{data:void 0}});const f=this._getTreeRef(t);this._largestRowWidth.value<h&&(this._largestRowWidth.value=h);let y={lines:o?i.lines.concat(a):a,content:r,findResult:i.findResult,treeProvider:g,treeItems:u,treeRef:f,largestRowWidth:h,showTimestamps:!!this.props.showTimestamps};this._data[t].value=y,!s&&this._reFind(),delete this._pending[e.key],s&&!e.noAutoScroll&&this._autoScroll&&i&&i.lines&&i.lines.length<y.lines.length?(this._autoScrollLine={key:t,line:y.lines.length},this._scrollPending=!0):delete this._autoScrollLine,this._scrollToLine()}_deferScroll(){requestAnimationFrame((()=>{this._scrollToLine()}))}_scrollToLine(){let e=this._toLine||this._findLine.value||this._autoScrollLine;if(!e||this._pending[e.key])return;const t=e&&this._data[e.key]&&this._data[e.key].value;if(this._scrollPending&&e&&t&&t.lines&&this._container.current&&t.lines.length>0){const n=this._container.current.querySelector(`[${L}="${e.key}"]`);if(n){if(n.querySelector('[data-snap="1"]'))return void this._deferScroll();const s=()=>{this._scrollPending=!1,e===this._toLine&&(this._toLine=void 0),e===this._findLine.value&&(this._findLine.value=void 0)};let i="nearest";e!==this._toLine&&e!==this._findLine.value||(i="center"),e===this._autoScrollLine&&(i="end"),this.props.scrollToLogLineWhenGroupLogsArePresent||(e.line=this._recountLineIndexIfHasGroups(e.line,t.content)),t&&this._scroll(t,e.line,i,s)}}}}function S(e){const[t,i]=n.useState(!1);return n.useLayoutEffect((()=>{if(e.spinner){const t=setTimeout((()=>{e.spinner&&i(!0)}),150);return()=>{clearTimeout(t)}}i(!1)}),[e.spinner]),n.createElement(n.Fragment,null,t&&n.createElement(c.Spinner,{size:"xsmall",className:"status-spinner"}),!t&&n.createElement(n.Fragment,null,e.statusProps&&n.createElement(h.Status,Object.assign({},e.statusProps,{className:"flex-self-center fontSizeM "+(e.noStatusFaint?"":"faint"),size:"16"})),e.iconProps&&n.createElement(s.Icon,Object.assign({},e.iconProps,{className:"fontSizeML status-icon"}))))}t[e].LogViewer=k;class I{constructor(){this._toScrollIndex=0,this._value="",this._result=new i.ObservableValue(void 0),this._onChange=(e,t,n)=>{let s;this._value=t,this._value===this._prevValue&&n.sectionKeys===this._prevSearchSectionKeys||(this._toScrollIndex=0),this._prevValue=t,this._prevSearchSectionKeys=n.sectionKeys;let i=[],o={};if(t){const e=n.lines;for(let s=0;s<n.sectionMarkers.length;s++){const r=Math.max(i.length-1,-1),l=n.sectionKeys[s],a=n.sectionMarkers[s].startIndex,c=Math.max(n.sectionLimits[s].startIndex,0),h=n.sectionMarkers[s].endIndex;for(let o=a+c;o<=h;o++){const r=e[o],c=s>0?Math.max(o-a,0):o+1;this._match(t,l,r,c,i,n)}if(c!==a)for(let o=a;o<=c;o++){const r=e[o],c=s>0?Math.max(o-a,0):o+1;this._match(t,l,r,c,i,n)}const d=Math.max(i.length-1,0);i.length>0&&(o[l]={startIndex:r+1,endIndex:d})}}i.length>0&&(s={lines:i,text:t,toScrollIndex:this._toScrollIndex,scrollCount:i.length,markers:o}),this._result.value=s}}find(e,t){this._onChange(null,e,t)}get result(){return this._result}down(){if(this._result.value){const t=this._toScrollIndex+1;this._toScrollIndex=t>this._result.value.lines.length-1?0:t;var e=Object.assign({},this._result.value);e.toScrollIndex=this._toScrollIndex,this._result.value=e}}up(){if(this._result.value){const t=this._toScrollIndex-1;this._toScrollIndex=t<0?this._result.value.lines.length-1:t;var e=Object.assign({},this._result.value);e.toScrollIndex=this._toScrollIndex,this._result.value=e}}_match(e,t,n,s,i,o){let r=!1;const l=n.nodes.length;if(l>0){const s=n.nodes[0].start,i=n.nodes[l-1].end,a=o.getContent(t);-1!==(0,m.getText)(a.substring(s,i)).indexOf((0,m.getText)(e))&&(r=!0)}r&&i.push({key:t,line:s})}}}("ComponentsLogViewerLogViewer"),function(e){t[e]={},Object.defineProperty(t[e],"LogViewer",{enumerable:!0,get:function(){return v.LogViewer}})}("LogViewer")}),["Resources","Utilities/Parser","Components/LogViewer/LineTransform","Utilities/LogParser","Components/LogViewer/LogViewer","LogViewer"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-distributedtask-web.run-logs"}}));
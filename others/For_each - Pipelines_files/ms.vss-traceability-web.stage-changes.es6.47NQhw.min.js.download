"use strict";define("Traceability/StageChanges",["require","exports","react","VSSUI/Table","VSS/Core/Observable","VSS/Platform/Layout","VSSUI/VssPersona","VSSUI/Link","VSSUI/TooltipEx","Wit/UI/WorkItemTypeIcon","Wit/UI/WorkItemState","Build/Common/Library/Components/CommitLink","Wit/Clients/Wit/RestClient/WorkItemTracking","VSS/Platform/Context","VSSUI/Panel","VSSUI/Tabs","VSSUI/Observer","VSSUI/Dropdown","VSS/Core/Util/String","Tfs/Platform/Page","VSSUI/Spinner","VSSUI/MessageCard","VSSUI/Utilities/DropdownSelection"],(function(e,t,a,s,i,o,r,n,l,m,c,d,h,u,g,p,b,f,C,I,v,_,T){var w,S,k,y;w=t[y="Resources"]={},t[y].RollbackCommitFormatMessage="{0} {1} rolled back commit",t[y].RollbackCommitsFormatMessage="{0} {1} rolled back commits",t[y].RollbackWorkItemFormatMessage="{0} {1} rolled back work item",t[y].RollbackWorkItemsFormatMessage="{0} {1} rolled back work items",t[y].CommitsTabName="Commits",t[y].WorkItemsTabName="Work items",t[y].CommitsTabCommitColumnName="Commit",t[y].CommitsTabMessageColumnName="Message",t[y].CommitsTabAuthorColumnName="Author",t[y].WorkItemsTabTitleColumnName="Title",t[y].WorkItemsTabStateColumnName="State",t[y].WorkItemsTabAssignedToColumnName="Assigned to",t[y].WorkItemsTabUnassignedText="Unassigned",t[y].StageRunCompareToText="Compared to: #{0} - {1}",t[y].LoadingText="Loading...",t[y].NoCommitsFoundText="There are no new commits in this artifact version, compared to previous version.",t[y].NoWorkItemsFoundText="There are no workitems referenced in this artifact version, compared to previous version.",function(e){S=t[e]={};class d extends o.VssComponent{constructor(e,t){super(e,t),this._onColumnSize=(e,t,a,s)=>{s.width.value=a},this._renderTitle=(e,t,i,o)=>a.createElement(s.SimpleTableCell,{key:"col-"+t,columnIndex:t,tableColumn:i,contentClassName:"bolt-table-cell-content-with-link"},a.createElement(n.Link,{href:o.url,className:"bolt-list-cell-child flex-row flex-center scroll-hidden bolt-link subtle"},a.createElement(m.WorkItemTypeIcon,{data:o.icon}),a.createElement(l.Tooltip,{overflowOnly:!0},a.createElement("span",{className:"text-ellipsis body-m"},o.title)))),this._renderState=(e,t,i,o)=>a.createElement(s.SimpleTableCell,{key:"col-"+t,columnIndex:t,tableColumn:i},a.createElement(c.WorkItemState,{data:o.state})),this._renderAssignedToColumn=(e,t,i,o)=>{let n=o.assignedTo;return n&&0!==Object.keys(n).length||(n={id:"",displayName:w.WorkItemsTabUnassignedText,uniqueName:""}),a.createElement(s.SimpleTableCell,{key:"col-"+t,columnIndex:t,tableColumn:i},a.createElement(r.VssPersona,{size:"small",className:"icon-large-margin",identityDetailsProvider:{getIdentityImageUrl:e=>n.imageUrl,getDisplayName:()=>n.displayName}}),a.createElement("div",{className:"flex-row scroll-hidden"},a.createElement(l.Tooltip,{overflowOnly:!0,text:n.displayName},a.createElement("span",{className:"body-m text-ellipsis"},n.displayName))))},this._columns=[{id:"title",name:w.WorkItemsTabTitleColumnName,minWidth:350,width:new i.ObservableValue(350),renderCell:this._renderTitle,onSize:this._onColumnSize},{id:"state",name:w.WorkItemsTabStateColumnName,minWidth:100,width:new i.ObservableValue(100),renderCell:this._renderState,onSize:this._onColumnSize},{id:"assignedTo",name:w.WorkItemsTabAssignedToColumnName,minWidth:150,width:new i.ObservableValue(150),renderCell:this._renderAssignedToColumn,onSize:this._onColumnSize}],this._tableItemProvider=e.data}render(){return a.createElement("div",{className:"flex-grow flex-row"},a.createElement(s.Table,{columns:this._columns,itemProvider:this._tableItemProvider,spacerWidth:0,className:"work-items-grid"}))}}t[e].WorkItemsGrid=d}("WorkItemsGrid"),function(e){k=t[e]={};class n extends o.VssComponent{constructor(e,t){super(e,t),this._onColumnSize=(e,t,a,s)=>{s.width.value=a},this._renderCommitColumn=(e,t,i,o)=>a.createElement(s.SimpleTableCell,{key:"col-"+t,columnIndex:t,tableColumn:i},a.createElement(d.CommitLink,{commitId:o.commit.id,repositoryId:this.props.repository.id,repositoryName:this.props.repository.name,repositoryType:this.props.repository.type,monospace:!0,showIcon:!1,excludeTabStop:!1})),this._renderMessageColumn=(e,t,i,o)=>a.createElement(s.SimpleTableCell,{key:"col-"+t,columnIndex:t,tableColumn:i},a.createElement(l.Tooltip,{overflowOnly:!0},a.createElement("span",{className:"text-ellipsis body-m"},o.commit.message))),this._renderAuthorColumn=(e,t,i,o)=>a.createElement(s.SimpleTableCell,{key:"col-"+t,columnIndex:t,tableColumn:i},a.createElement(r.VssPersona,{size:"small",className:"icon-large-margin",identityDetailsProvider:{getIdentityImageUrl:e=>o.commit.author._links.avatar.href,getDisplayName:()=>o.commit.author.displayName}}),a.createElement("div",{className:"flex-row scroll-hidden"},a.createElement(l.Tooltip,{overflowOnly:!0,text:o.commit.author.displayName},a.createElement("span",{className:"body-m text-ellipsis"},o.commit.author.displayName)))),this._columns=[{id:"commit",name:w.CommitsTabCommitColumnName,minWidth:100,width:new i.ObservableValue(100),renderCell:this._renderCommitColumn,onSize:this._onColumnSize},{id:"message",name:w.CommitsTabMessageColumnName,minWidth:350,width:new i.ObservableValue(350),renderCell:this._renderMessageColumn,onSize:this._onColumnSize},{id:"author",name:w.CommitsTabAuthorColumnName,minWidth:150,width:new i.ObservableValue(150),renderCell:this._renderAuthorColumn,onSize:this._onColumnSize}],this._tableItemProvider=e.data}render(){return a.createElement("div",{className:"flex-grow flex-row"},a.createElement(s.Table,{className:"commits-grid",columns:this._columns,itemProvider:this._tableItemProvider,spacerWidth:0}))}}t[e].CommitsGrid=n}("CommitsGrid"),function(e){t[e]={};class a extends u.VssService{constructor(){super(...arguments),this._commitsDataProviderId="ms.vss-build-web.traceability-stagerun-changes-data-provider",this._workItemsDataProviderId="ms.vss-build-web.traceability-stagerun-workitems-data-provider"}_serviceStart(e){super._serviceStart(e)}_serviceEnd(e){super._serviceEnd(e)}async fetchCommits(e){const t=this.pageContext.getService("IVssContributionService"),a=await t.getDataAsync(this._commitsDataProviderId,e);return a||{artifactsData:[],baseRunId:0,currentRunId:0,baseRunAttempt:null,baseRunNumber:null,baseRunMessage:null}}async fetchWorkItems(e){const t=this.pageContext.getService("IVssContributionService"),a=await t.getDataAsync(this._workItemsDataProviderId,e);return a||{artifactsData:[],baseRunId:0,currentRunId:0,baseRunAttempt:null,baseRunNumber:null,baseRunMessage:null}}getWorkItemTypes(e,t){return t&&0!==t.length||Promise.resolve([]),this._witClient||(this._witClient=(0,h.getWorkItemTrackingClient)(e)),this._typesPromise=this._witClient.getWorkItemTypes(t),this._typesPromise.then((e=>this._types=e)),this._typesPromise}getStateAndColor(e,t){var a;let s;const i=null===(a=this._types)||void 0===a?void 0:a.find((t=>t.name===e)),o=null==i?void 0:i.states.find((e=>e.name==t));return s=o,s.fill=o.color,s}getIcon(e){var t;const a=null===(t=this._types)||void 0===t?void 0:t.find((t=>t.name===e));return{color:null==a?void 0:a.color,icon:null==a?void 0:a.icon.id}}transformRawWorkItemData(e){const t=[];return null==e||e.forEach((e=>{const a=this.getIcon(e.type),s=this.getStateAndColor(e.type,e.currentState);t.push({icon:a,assignedTo:e.assignedTo,state:s,title:e.title,url:e.url})})),t}transformRawCommitData(e){const t=[];return null==e||e.forEach((e=>{t.push({commit:e})})),t}}t[e].StagesUpcomingChangesService=a,u.Services.add("ms.vss-traceability-web-stage-changes.upcoming-changes-service",{serviceFactory:a})}("StagesUpcomingChangesService"),function(e){var s;t[e]={},function(e){e[e.Commits=0]="Commits",e[e.WorkItems=1]="WorkItems"}(s=t[e].UpcomingChangesPanelTabId||(t[e].UpcomingChangesPanelTabId={}));const r="Commits",n="WorkItems";class l extends o.VssComponent{constructor(e,t){var a,o;super(e,t),this._artifactsDropDownItems=[],this._artifactSelection=new T.DropdownSelection,this._onArtifactSelected=async(e,t)=>{const a=this._artifactsData.find((e=>e.artifactVersion.id===t.id));if(a){this._selectedRepository=a.repository,this.setState({isLoading:!0});try{await this._fetchAndSetNewData(a)}catch(e){console.error("Error fetching data for UpcomingChangesPanel",e)}finally{this.setState({isLoading:!1})}}},this._selectedTabId=new i.ObservableValue(s[e.selectedTabId]),this._commitsTableRows=new i.ObservableArray([]),this._workItemsTableRows=new i.ObservableArray([]),this.state={isLoading:!1,isRollback:!1,compareToBuildText:""},this._stagesUpcomingChangesService=this.context.pageContext.getService("ms.vss-traceability-web-stage-changes.upcoming-changes-service"),this._projectId=null===(o=null===(a=(0,I.getTFSPageData)(this.context.pageContext))||void 0===a?void 0:a.project)||void 0===o?void 0:o.id}componentDidMount(){this._initializePanelData()}async _initializePanelData(){var e;this.setState({isLoading:!0});try{const[t,a]=await Promise.all([this._stagesUpcomingChangesService.fetchCommits({artifactAlias:"self",currentRunId:this.props.buildId,stageId:this.props.stageId}),this._stagesUpcomingChangesService.fetchWorkItems({artifactAlias:"self",currentRunId:this.props.buildId,stageId:this.props.stageId}),this._stagesUpcomingChangesService.getWorkItemTypes(this.context.pageContext,this._projectId)]),s=null!==(e=null==t?void 0:t.artifactsData)&&void 0!==e?e:[];this._artifactsData=s,this._artifactsDropDownItems=this._prepareArtifactsDropDownItems(s);const i=this._selectDefaultArtifact(s);if(!i)return void this.setState({isLoading:!1});this._selectedRepository=i.repository,this._selectArtifactInDropdown(i),await this._loadArtifactData(i,a),this._loadBuildComparisonDropdown(t)}catch(e){console.error("Error fetching data for UpcomingChangesPanel",e)}finally{this.setState({isLoading:!1})}}_selectDefaultArtifact(e){return e.find((e=>"Pipeline"===e.artifactVersion.type))||e.find((e=>"self"===e.artifactVersion.alias))||e[0]}_selectArtifactInDropdown(e){const t=this._artifactsData.findIndex((t=>t.artifactVersion.id===e.artifactVersion.id));t>=0&&this._artifactSelection.select(t)}async _loadArtifactData(e,t){var a,s;if("self"===e.artifactVersion.alias&&e.data){const i=null!==(s=null===(a=t.artifactsData.find((t=>t.artifactVersion.id===e.artifactVersion.id)))||void 0===a?void 0:a.data)&&void 0!==s?s:[];this._commitsTableRows.value=this._stagesUpcomingChangesService.transformRawCommitData(e.data),this._workItemsTableRows.value=this._stagesUpcomingChangesService.transformRawWorkItemData(i)}else await this._fetchAndSetNewData(e)}async _loadBuildComparisonDropdown(e){void 0!==(null==e?void 0:e.baseRunNumber)&&null!==(null==e?void 0:e.baseRunNumber)&&void 0!==(null==e?void 0:e.baseRunMessage)&&null!==(null==e?void 0:e.baseRunMessage)&&this.setState((t=>Object.assign(Object.assign({},t),{compareToBuildText:(0,C.format)(w.StageRunCompareToText,e.baseRunNumber,e.baseRunMessage)})))}_getIconName(e){let t;return t="Pipeline"===e.artifactVersion.type?"Rocket":"GitLogo",t}_prepareArtifactsDropDownItems(e){return e.map((e=>{const t=this._getIconName(e);return{id:e.artifactVersion.id,text:"self"===e.artifactVersion.alias?e.repository.name:e.artifactVersion.alias,iconProps:{iconSize:"medium",iconName:t}}}))}render(){return a.createElement(g.CustomPanel,{size:2,onDismiss:this.props.onDismiss},a.createElement(g.PanelHeader,{titleProps:{text:this.props.stageName,size:1},description:a.createElement(a.Fragment,null,this.props.buildName),onDismiss:this.props.onDismiss}),a.createElement(g.PanelContent,null,a.createElement("div",{className:"flex-column upcoming-changes-panel"},a.createElement(f.Dropdown,{items:this._artifactsDropDownItems,placeholder:this._artifactsDropDownItems.length>0?this._artifactsDropDownItems[0].text:"",onSelect:this._onArtifactSelected,selection:this._artifactSelection}),a.createElement(f.Dropdown,{disabled:!0,items:[],placeholder:this.state.compareToBuildText}),this.state.isRollback&&!this.state.isLoading?a.createElement(b.Observer,{selectedTabId:this._selectedTabId},(e=>a.createElement(_.MessageCard,{className:"flex-self-stretch margin-top-16 margin-bottom-16 rollback-message",severity:"Warning"},a.createElement("span",null,this._getRollbackMessage())))):a.createElement(a.Fragment,null),this.state.isLoading?a.createElement(v.Spinner,{size:"large",label:w.LoadingText}):a.createElement(a.Fragment,null,a.createElement(p.TabBar,{className:"full-width flex",selectedTabId:this._selectedTabId,tabsClassName:"upcoming-changes-tabbar",onSelectedTabChanged:this._onSelectedTabChanged.bind(this),tabSize:"compact"},a.createElement(p.Tab,{id:r,name:w.CommitsTabName,className:"first-tab"}),a.createElement(p.Tab,{id:n,name:w.WorkItemsTabName})),a.createElement(p.TabContent,null,a.createElement(b.Observer,{selectedTabId:this._selectedTabId,workItemsTableRows:this._workItemsTableRows},(e=>this._renderTab(e.selectedTabId))))))))}_onSelectedTabChanged(e){this._selectedTabId.value=e}_getRollbackMessage(){switch(this._selectedTabId.value){case r:if(!this._commitsTableRows)return"";if(1===this._commitsTableRows.length)return(0,C.format)(w.RollbackCommitFormatMessage,1);if(this._commitsTableRows.length>1)return(0,C.format)(w.RollbackCommitsFormatMessage,this._commitsTableRows.length);case n:if(!this._workItemsTableRows)return"";if(1===this._workItemsTableRows.length)return(0,C.format)(w.RollbackWorkItemFormatMessage,1);if(this._workItemsTableRows.length>1)return(0,C.format)(w.RollbackWorkItemsFormatMessage,this._workItemsTableRows.length)}return""}_renderTab(e){switch(e){case r:return this.state.isLoading||0!==this._commitsTableRows.length?a.createElement(k.CommitsGrid,{data:this._commitsTableRows,repository:this._selectedRepository}):a.createElement("div",{className:"flex-column flex-grow no-data-found"},w.NoCommitsFoundText);case n:return this.state.isLoading||0!==this._workItemsTableRows.length?a.createElement(S.WorkItemsGrid,{data:this._workItemsTableRows}):a.createElement("div",{className:"flex-column flex-grow no-data-found"},w.NoWorkItemsFoundText)}}_getDataFromPayload(e,t,a){var s,i,o,r;const n=null!==(i=null===(s=null==t?void 0:t.artifactsData.find((e=>e.artifactVersion.id===a.artifactVersion.id&&e.artifactVersion.alias===a.artifactVersion.alias)))||void 0===s?void 0:s.data)&&void 0!==i?i:[];return{commits:null!==(r=null===(o=null==e?void 0:e.artifactsData.find((e=>e.artifactVersion.id===a.artifactVersion.id&&e.artifactVersion.alias===a.artifactVersion.alias)))||void 0===o?void 0:o.data)&&void 0!==r?r:[],workItems:n}}async _fetchAndSetNewData(e){const t={currentRunId:this.props.buildId,artifactAlias:e.artifactVersion.alias||"",stageId:this.props.stageId},[a,s]=await Promise.all([this._stagesUpcomingChangesService.fetchCommits(t),this._stagesUpcomingChangesService.fetchWorkItems(t)]),{commits:i,workItems:o}=this._getDataFromPayload(a,s,e);this._commitsTableRows.value=this._stagesUpcomingChangesService.transformRawCommitData(i),this._workItemsTableRows.value=this._stagesUpcomingChangesService.transformRawWorkItemData(o)}}t[e].UpcomingChangesPanel=l}("UpcomingChangesPanel")}),["Resources","WorkItemsGrid","CommitsGrid","StagesUpcomingChangesService","UpcomingChangesPanel"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-traceability-web.stage-changes"}}));
"use strict";define("TFS/GlobalBanner",["require","exports","react","VSS/Platform/Components/Format","VSS/Platform/Layout","VSS/Ext/ExternalContent","VSSUI/Link","VSS/Features/PlatformUI/ContributedButton","VSS/Features/PlatformUI/FPSLink","VSSUI/Icon","VSS/Platform/Feature","VSS/Platform/Context","VSS/Platform/Fetch","VSS/Platform/UserClaims"],(function(e,t,s,n,a,o,i,r,l,c,g,d,m,p){var h,u,b,C,f;h=t[f="Resources"]={},t[f].Dismiss="Dismiss",t[f].LearnMore="Learn more",function(e){u=t[e]={};class r extends a.VssComponent{constructor(e,t){super(e,t),this.onCornerDialogClose=()=>{this.globalMessageService.closeDialog()},this.onDialogChanged=e=>{this.setState({dialog:e})},this.globalMessageService=t.pageContext.getService("IGlobalMessagesService");const s=this.globalMessageService.getDialog();this.state={dialog:s}}componentDidMount(){this.globalMessageService.subscribe(this.onDialogChanged,"DIALOG_CHANGED")}render(){const{dialog:e}=this.state;if(!e)return null;const t=e.buttonProps||[];return e.closeButtonProps&&t.push(Object.assign(Object.assign({},e.closeButtonProps),{onClick:this.onCornerDialogClose})),e.contributionId?s.createElement(a.WrappedComponent,Object.assign({wrappedType:"customDialog",dependencies:["ms.vss-features.ui-layer-content"]},Object.assign({onDismiss:()=>{e.onDismiss&&e.onDismiss(),this.onCornerDialogClose()}},e.contentProperties)),s.createElement(o.ExternalContent,{contributionId:e.contributionId,initialHandshakeData:Object.assign({},e.contributionConfiguration)})):e.componentType?s.createElement(a.WrappedComponent,Object.assign({wrappedType:e.componentType,dependencies:e.contentDependencies},Object.assign({onDismiss:this.onCornerDialogClose},e.contentProperties))):s.createElement(a.WrappedComponent,{wrappedType:"cornerDialog",dependencies:["ms.vss-features.ui-layer-content"],onDismiss:this.onCornerDialogClose,footerButtonProps:t.length>0?t:void 0,titleProps:{text:e.title}},e.message||e.messageFormat&&e.messageLinks?e.messageFormat&&e.messageLinks?s.createElement(n.FormatComponent,{className:"message",format:e.messageFormat},e.messageLinks.map(((e,t)=>s.createElement(i.Link,{href:e.href,target:"_blank",rel:"noopener noreferrer",key:t},e.name)))):s.createElement("div",{className:"message"},e.message):null)}componentWillUnmount(){this.globalMessageService.unsubscribe(this.onDialogChanged,"DIALOG_CHANGED"),super.componentWillUnmount()}}t[e].GlobalDialogComponent=r,r.componentType="globalDialog",a.VssComponent.register(r.componentType,r)}("ComponentsGlobalDialog"),function(e){b=t[e]={};class o extends a.VssComponent{constructor(e,t){super(e,t),this.onMessageBannerClose=()=>{this.globalMessagesService.closeBanner()},this.onMessageBannerChanged=e=>{this.setState({messageBanner:e},d)},this.onLearnLinkClicked=e=>{if(e.settingId){this.context.pageContext.getService("IVssTelemetryService").publishEvent("GlobalMessageBanner","bannerLearnMoreClicked",{settingId:e.settingId})}},this.globalMessagesService=t.pageContext.getService("IGlobalMessagesService"),this.globalMessagesService.subscribe(this.onMessageBannerChanged,"MESSAGE_CHANGED");const s=this.globalMessagesService.getBanner();this.state={messageBanner:s}}render(){const{messageBanner:e}=this.state;if(!e)return null;const{level:t}=e;let o="Info";3===t?o="Success":2===t?o="Error":1===t&&(o="Warning");const g=this.getLinkContainerLinkId();return s.createElement("div",{className:"global-message-banner flex-row flex-grow"},s.createElement(a.WrappedComponent,{dependencies:["ms.vss-features.ui-messagebar-content"],wrappedType:"messageBar",buttonProps:e.buttons?e.buttons.map((e=>(0,r.contributedButtonToButtonProps)(this.context.pageContext,e))):void 0,className:"flex-grow",messageClassName:e.componentType?"flex-grow":"",iconProps:e.customIcon?{iconName:e.customIcon}:void 0,onDismiss:!1!==e.dismissable?this.onMessageBannerClose:void 0,severity:o},e.componentType?s.createElement(a.WrappedComponent,Object.assign({wrappedType:e.componentType,dependencies:e.contentDependencies},Object.assign({onDismiss:this.onMessageBannerClose},e.contentProperties))):s.createElement("div",{className:"flex-grow"},e.message||e.messageFormat&&e.messageLinks?e.messageFormat&&e.messageLinks?s.createElement(n.FormatComponent,{id:g,elementType:"span",format:e.messageFormat},e.messageLinks.map(((e,t)=>e.supportsFPS?s.createElement(l.FPSLink,{href:e.href},e.name):s.createElement(i.Link,{href:e.href,target:"_blank",rel:"noopener noreferrer",key:t,ariaLabelledBy:g},e.name)))):s.createElement("span",null,e.message):null,e.helpInfo?s.createElement(i.Link,{className:"help-link font-size-ml",href:e.helpInfo.href,role:e.helpInfo.href?void 0:"presentation",tooltipProps:e.helpInfo.tooltip?{text:e.helpInfo.tooltip}:void 0},s.createElement(c.Icon,{iconName:"Unknown",className:"v-align-middle"})):null,e._links&&e._links.learn?s.createElement(i.Link,{className:"learn-link",href:e._links.learn.href,onClick:()=>this.onLearnLinkClicked(e)},h.LearnMore):null)))}componentWillUnmount(){this.globalMessagesService.unsubscribe(this.onMessageBannerChanged,"MESSAGE_CHANGED"),super.componentWillUnmount()}getLinkContainerLinkId(){return(0,g.isFeatureFlagEnabled)(this.context.pageContext,"GlobalMessageBanner.AccessibleMessageLinks",!1)?"global-messagebar-link-container":void 0}}function d(){const e=document.createEvent("Event");e.initEvent("resize",!1,!0),window.dispatchEvent(e)}t[e].GlobalBannerComponent=o,o.componentType="globalBanner",a.VssComponent.register(o.componentType,o);class m extends a.VssComponent{constructor(e,t){if(super(e,t),this.globalMessagesService=t.pageContext.getService("IGlobalMessagesService"),this.layoutManager=t.pageContext.getService("IVssLayoutManager"),this.actions=this.globalMessagesService.getActions(),this.actions&&this.actions.length)for(const e of this.actions)this.layoutManager.renderCallout((t=>s.createElement(a.WrappedComponent,Object.assign({wrappedType:e.componentType,dependencies:e.contentDependencies},Object.assign({onClose:t},e.contentProperties)))))}render(){return null}}m.componentType="globalActions",a.VssComponent.register(m.componentType,m)}("ComponentsGlobalMessageBanner"),function(e){C=t[e]={};class n extends a.VssComponent{constructor(e,t){super(e,t),this.toastRef=s.createRef(),this.toastQueue=[],this.toastExpiresTimeoutId=-1,this.keyId=0,this.onNewToast=e=>{e.forceOverrideExisting?this.fadeOutAndRenderNew(e):this.state.toast?this.toastQueue.push(e):this.updateCurrentToast(e)},this.onToastExpires=()=>{const e=this.toastQueue.shift();e?this.fadeOutAndRenderNew(e):this.clearToast()},this.globalMessagesService=t.pageContext.getService("IGlobalMessagesService"),this.state={}}render(){const{toast:e}=this.state;return e?s.createElement(a.WrappedComponent,Object.assign({wrappedType:"toast",dependencies:["ms.vss-features.ui-layer-content"],key:"globalToast"+this.keyId,wrappedRef:this.toastRef},e)):null}componentDidMount(){this.globalMessagesService.subscribe(this.onNewToast,"TOAST_CHANGED")}componentWillUnmount(){this.fadeOutPromiseCancelable&&this.fadeOutPromiseCancelable.cancel(),clearTimeout(this.toastExpiresTimeoutId),this.globalMessagesService.unsubscribe(this.onNewToast,"TOAST_CHANGED")}fadeOutAndRenderNew(e){this.toastRef.current?(this.fadeOutPromiseCancelable=this.toastRef.current.fadeOut(),this.fadeOutPromiseCancelable.promise.then((()=>{this.updateCurrentToast(e)})).catch((e=>{if(!e.isCanceled)throw e}))):this.updateCurrentToast(e)}updateCurrentToast(e){this.keyId+=1,clearTimeout(this.toastExpiresTimeoutId),this.setState({toast:e},(()=>{this.toastExpiresTimeoutId=setTimeout(this.onToastExpires,e.duration)}))}clearToast(){this.toastRef.current&&(this.fadeOutPromiseCancelable&&this.fadeOutPromiseCancelable.cancel(),this.fadeOutPromiseCancelable=this.toastRef.current.fadeOut(),this.fadeOutPromiseCancelable.promise.then((()=>{this.setState({toast:void 0})})).catch((e=>{if(!e.isCanceled)throw e})))}}t[e].GlobalToastComponent=n,n.componentType="globalToast",a.VssComponent.register(n.componentType,n)}("ComponentsGlobalToast"),function(){t.ComponentsGlobalMessages={};class e extends a.VssComponent{render(){return s.createElement(s.Fragment,null,s.createElement(b.GlobalBannerComponent,null),s.createElement(u.GlobalDialogComponent,null),s.createElement(C.GlobalToastComponent,null))}}e.componentType="globalMessages",a.VssComponent.register(e.componentType,e)}(),function(){t.GlobalMessagesService={};const e="GlobalDialog/Dismissed",s="globalMessageData",n="GlobalMessage/Dismissed";class a extends d.VssObservableService{constructor(){super(...arguments),this.handleEndRequest=e=>{if(e.response&&e.response.headers){const t=e.response.headers.get("X-VSS-GlobalMessage");if(t)try{const e=JSON.parse(t);this.addBanner(e,!1,!0)}catch(e){console.warn("Failed to deserialize X-VSS-GlobalMessage header: "+e)}}},this.handleLegacyGlobalMessage=e=>{this.addBanner(e.detail,!1,!0)}}_serviceStart(e){super._serviceStart(e);const t=this.pageContext.getService("IVssContributionService"),n=t.getSharedData(s);this.currentMessageBanners=n&&n.banners?n.banners:[];const a=t.getSharedData("globalDialogData");this.currentDialogs=a&&a.dialogs?a.dialogs:[],m.requestListeners.subscribe(this.handleEndRequest,"afterRequest"),document.body.addEventListener("legacyGlobalMessage",this.handleLegacyGlobalMessage)}_serviceEnd(e){m.requestListeners.unsubscribe(this.handleEndRequest,"afterRequest"),document.body.removeEventListener("legacyGlobalMessage",this.handleLegacyGlobalMessage)}addToast(e){this._notify(e,"TOAST_CHANGED")}getDialog(){return this.currentDialogs[0]}addDialog(e,t,s){if(s){const t=this.currentDialogs[0];if(t&&(t.priority||0)>=(e.priority||0))return}(0,g.isFeatureFlagEnabled)(this.pageContext,"VisualStudio.Services.GlobalMessages.CheckDismissedBeforeAdd",!1)?this.addDialogIfNotDismissed(e,t):this.addDialogInternal(e,t)}async addDialogIfNotDismissed(t,s){try{if(t.settingId){const s=this.pageContext.getRestClient("ISettingsRestClient"),n=await s.getEntries("me",e);if(n&&n[t.settingId])return}}catch(e){}this.addDialogInternal(t,s)}addDialogInternal(e,t){t&&this.currentDialogs.shift(),this.currentDialogs.unshift(e),this._notify(e,"DIALOG_CHANGED")}closeDialog(){const t=this.getDialog();if(t&&t.settingId){const s={};if(s[e+"/"+t.settingId]=!0,(0,p.userHasClaim)(this.pageContext,"member")){this.pageContext.getRestClient("ISettingsRestClient").setEntries(s,"me")}}this.currentDialogs.shift(),this._notify(this.currentDialogs[0],"DIALOG_CHANGED")}getBanner(){return this.currentMessageBanners[0]}addBanner(e,t,s){if(s){const t=this.currentMessageBanners[0];if(t&&(t.level||0)>=(e.level||0))return}(0,g.isFeatureFlagEnabled)(this.pageContext,"VisualStudio.Services.GlobalMessages.CheckDismissedBeforeAdd",!1)?this.addBannerIfNotDismissed(e,t):this.addBannerInternal(e,t)}async addBannerIfNotDismissed(e,t){try{if(e.settingId){const t=this.pageContext.getRestClient("ISettingsRestClient"),s=await t.getEntries("me",n);if(s&&s[e.settingId])return}}catch(e){}this.addBannerInternal(e,t)}addBannerInternal(e,t){t&&this.currentMessageBanners.shift(),this.currentMessageBanners.unshift(e),this._notify(e,"MESSAGE_CHANGED")}getActions(){const e=this.pageContext.getService("IVssContributionService").getSharedData(s);return e&&e.actions?e.actions:void 0}closeBanner(){const e=this.getBanner();if(e&&e.settingId){const t={};t[n+"/"+e.settingId]=!0;this.pageContext.getRestClient("ISettingsRestClient").setEntries(t,"me")}this.currentMessageBanners.shift(),this._notify(this.currentMessageBanners[0],"MESSAGE_CHANGED")}}d.Services.add("IGlobalMessagesService",{serviceFactory:a});class o extends d.VssService{addBanner(e){this.pageContext.getService("IGlobalMessagesService").addBanner(e)}addDialog(e){this.pageContext.getService("IGlobalMessagesService").addDialog(e)}addToast(e){const t=this.pageContext.getService("IGlobalMessagesService"),s=Object.assign(Object.assign({},e),{onCallToActionClick:()=>{e.onCallToActionClick&&e.onCallToActionClick()}});t.addToast(s)}setGlobalMessageBanner(e){this.addBanner(e)}closeBanner(){this.pageContext.getService("IGlobalMessagesService").closeBanner()}closeDialog(){this.pageContext.getService("IGlobalMessagesService").closeDialog()}}d.Services.add("ms.vss-tfs-web.tfs-global-messages-service",{serviceFactory:o,options:1})}()}),["Resources","Components/GlobalDialog","Components/GlobalMessageBanner","Components/GlobalToast","Components/GlobalMessages","GlobalMessagesService"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-tfs-web.global-banner-content"}}));
"use strict";define("Build/DesignerExtensions/YamlAssistant",["require","exports","Build/Flux/Store","VSS/Core/TimerManagement","Build/DesignerExtensions/YamlSnippetForm/Stores/SnippetFormStore","react","VSS/Core/Observable","VSS/Core/Util/String","VSS/Platform/Layout","VSSUI/HeaderCommandBar","VSSUI/Image","VSSUI/Intersection","VSSUI/List","VSSUI/Observer","VSSUI/Spinner","VSSUI/Tabs","VSSUI/TextField","VSSUI/TooltipEx","VSSUI/Utilities/Provider","Build/DesignerExtensions/YamlAssistantLibrary/Contracts/Constants","VSS/Platform/Context","Build/DesignerExtensions/YamlAssistantLibrary/Components/ContributedSnippetForm"],(function(e,t,s,i,n,a,r,o,l,p,c,d,S,h,m,u,_,g,v,b,x,T){var C,f,E,L,w;C=t[w="Resources"]={},t[w].FailedToLoadSnippet="Error loading task: {0}",t[w].SearchSnippetsLabel="Search tasks",t[w].SnippetsTabLabel="Tasks",t[w].VariablesTabLabel="Variables",t[w].CloseAssistant="Hide assistant",function(e){f=t[e]={};const s="ms.vss-build-web.yaml-assistant-data-provider";t[e].SnippetListSource=class{constructor(e){this._hiddenSnippets=[],this.getSnippets=()=>(this._snippetList||(this._snippetList=this._contributionService.getData(s)||[]),this._snippetList),this._contributionService=e.getService("IVssContributionService")}async getSnippet(e,t){const i=[...this.getSnippets(),...this._hiddenSnippets].find((s=>s.version.major.toFixed()===t&&(s.name===e||s.contributionIdentifier&&`${s.contributionIdentifier}.${s.name}`===e)));if(i)return i;const n=await this._contributionService.getDataAsync(s,{taskName:e,taskVersion:t});return n&&this._hiddenSnippets.push(n),n}}}("SourcesSnippetListSource"),function(e){E=t[e]={};class n extends s.Store{constructor(){super(...arguments),this._searchText="",this._snippets=[],this._filteredSnippets=[],this._timerManagement=new i.TimerManagement}loadSnippets(e){this._throttledSearch=this._timerManagement.debounce((e=>this._searchSnippets(e)),250),this._snippets=this._filteredSnippets=e,this.emitChanged()}getFilteredSnippets(){return this._filteredSnippets}getSearchText(){return this._searchText}filter(e){this._searchText=e,this._throttledSearch(e),this.emitChanged()}isLoading(){return 0===this._snippets.length}_searchSnippets(e){if(e){const t=(e=e.toLocaleLowerCase()).split(" ");this._filteredSnippets=this._snippets.filter((e=>t.every((t=>e.friendlyName.toLocaleLowerCase().indexOf(t)>=0||e.description.toLocaleLowerCase().indexOf(t)>=0))))}else this._filteredSnippets=this._snippets;this.emitChanged()}}t[e].FilteredSnippetListStore=n}("StoresFilteredSnippetListStore"),function(e){L=t[e]={};class s extends l.VssComponent{constructor(e){super(e),this._listRef=a.createRef(),this._isScrolled=new r.ObservableValue(!1),this._unallowedTaskIdList=["F1E4B0E6-017E-4819-8A48-EF19AE96E289"],this._onScroll=e=>{if(this._listRef&&this._listRef.current){const e=0!==this._listRef.current.scrollTop;this._isScrolled.value!==e&&(this._isScrolled.value=e)}},this._renderRow=(e,t,s,i)=>a.createElement(S.ListItem,{key:i||"list-item"+e,index:e,details:s},a.createElement(g.Tooltip,{text:t.description},a.createElement("div",{className:"yaml-snippet-row"},a.createElement("div",{className:"flex-row h-scroll-hidden"},a.createElement(c.Image,{className:"yaml-snippet-icon",src:t.iconUrl,alt:""}),a.createElement("div",{className:"snippet-row-main-column flex-column h-scroll-hidden"},a.createElement("span",{className:"text-ellipsis"},t.friendlyName),a.createElement("span",{className:"fontSize text-ellipsis secondary-text"},t.description)))))),this._getStateFromStore=()=>{this.setState({searchText:this._store.getSearchText(),loading:this._store.isLoading()})},this._selectSnippet=(e,t)=>{e.stopPropagation(),e.preventDefault();const s=this._getFilteredSnippets().value[t.index];this.props.onSnippetSelected(s);const i=this.context.pageContext.getService("IVssTelemetryService");i&&i.publishEvent(b.TelemetryConstants.Area,b.TelemetryConstants.SnippetSelected,{name:s.friendlyName,version:s.version,isTemplate:Boolean(s.content)})},this._onSelectedTabChanged=e=>{this.setState({selectedTabId:e});const t=this.context.pageContext.getService("IVssTelemetryService");t&&t.publishEvent(b.TelemetryConstants.Area,b.TelemetryConstants.TabSwitch,{selectedTabId:e})},this._tabCommands=()=>a.createElement(p.HeaderCommandBar,{items:[{id:"hide-tasks",className:b.YamlAssistantToggleElement,onActivate:this.props.onDismiss,important:!0,iconProps:{iconName:"ClosePane"},ariaLabel:C.CloseAssistant,subtle:!0,tooltipProps:{text:C.CloseAssistant}}]}),this.state={searchText:"",loading:!0,selectedTabId:"snippets"}}componentDidMount(){super.componentDidMount(),this._store=new E.FilteredSnippetListStore,this._store.addListener(this._getStateFromStore),this._loadSnippets()}componentWillUnmount(){super.componentWillUnmount(),this._store.dispose()}render(){return a.createElement("div",{className:"yaml-snippet-list flex-column flex-grow relative"},a.createElement(u.TabBar,{className:"snippet-list-tab-bar",tabSize:"compact",renderAdditionalContent:this._tabCommands,selectedTabId:this.state.selectedTabId,onSelectedTabChanged:this._onSelectedTabChanged},a.createElement("div",{role:"tab",className:"static-tab"},C.SnippetsTabLabel)),this._content())}_content(){return this.state.error&&this.state.error.message?a.createElement("span",null,(0,o.format)(C.FailedToLoadSnippet,this.state.error.message)):this.state.loading?a.createElement(m.Spinner,{size:"large"}):a.createElement(a.Fragment,null,a.createElement(h.Observer,{isScrolled:this._isScrolled},(e=>a.createElement("div",{className:e.isScrolled?"scroll-decoration":void 0,role:"presentation","aria-hidden":"true"}))),a.createElement(d.Intersection,{rootMargin:window.innerHeight/2},a.createElement("div",{className:"flex-grow scroll-auto",onScroll:this._onScroll,ref:this._listRef},a.createElement("div",{className:"snippet-search-container"},a.createElement(_.TextField,{value:this.state.searchText,className:"snippet-search-input flex-grow",placeholder:C.SearchSnippetsLabel,ariaLabel:C.SearchSnippetsLabel,prefixIconProps:{iconName:"Search"},onChange:(e,t)=>this._onSearchTextChanged(t),style:1})),a.createElement(S.List,{itemProvider:this._getFilteredSnippets(),renderRow:this._renderRow,selection:new S.ListSelection,singleClickActivation:!0,onActivate:this._selectSnippet,width:"100%"}))))}_getFilteredSnippets(){const e=this._store.getFilteredSnippets().filter((e=>-1===this._unallowedTaskIdList.findIndex((t=>(0,o.equals)(t,e.id,!0)))));return new v.ArrayItemProvider(e)}_loadSnippets(){try{const e=this.props.getSnippets();this._store.loadSnippets(e)}catch(e){this.setState({error:e});const t=this.context.pageContext.getService("IVssTelemetryService");t&&t.publishEvent(b.TelemetryConstants.Area,b.TelemetryConstants.Error,{location:"loadSnippets",error:e})}}_onSearchTextChanged(e){this._store.filter(e)}}t[e].SnippetList=s}("ComponentsSnippetList"),function(e){t[e]={};class s extends l.VssComponent{constructor(e){super(e),this._onYamlGenerated=e=>{const t={yamlString:e,eventType:0};this.props.onYamlGenerated(t)},this._getSnippets=()=>(this._source||(this._source=new f.SnippetListSource(this.context.pageContext)),this._source.getSnippets()),this._onSnippetSelected=e=>{this.setState({snippet:e,startingParameters:void 0})},this._clearSnippet=()=>{this.setState({snippet:void 0,startingParameters:void 0})},this.state={}}render(){return a.createElement("div",{className:"yaml-assistant-view flex-column flex-grow"},this.state.snippet?a.createElement(T.ContributedSnippetForm,{onYamlGenerated:this._onYamlGenerated,onDismiss:this._clearSnippet,snippet:this.state.snippet,startingParameters:this.state.startingParameters}):a.createElement(L.SnippetList,{getSnippets:this._getSnippets,onDismiss:this.props.onDismiss,onSnippetSelected:this._onSnippetSelected}))}componentDidMount(){super.componentDidMount();this.context.pageContext.getService("YamlAssistantViewService").setView(this)}async onStartTask(e,t,s){const i=await this._source.getSnippet(e,t);i&&this.setState({snippet:void 0},(()=>{this.setState({snippet:i,startingParameters:s})}))}}t[e].YamlAssistantView=s;class i{constructor(){this._serviceStart=e=>{}}setView(e){this._view=e}onStartTask(e,t,s){this._view&&this._view.onStartTask(e,t,s)}_serviceEnd(){}}t[e].YamlAssistantViewService=i,x.Services.add("YamlAssistantViewService",{serviceFactory:i}),l.Components.add("yaml-assistant-view",s)}("YamlAssistantView")}),["Resources","Sources/SnippetListSource","Stores/FilteredSnippetListStore","Components/SnippetList","YamlAssistantView"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-build-web.designer-extensions.yaml-assistant"}}));
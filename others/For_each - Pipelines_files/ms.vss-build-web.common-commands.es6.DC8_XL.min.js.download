"use strict";define("Build/Common/Commands",["require","exports","react","VSSUI/Dialog","VSS/Platform/Layout","Build/Common/Library/ErrorHandler","VSSUI/FormItem","VSSUI/TextField","VSS/Core/Observable","VSS/Core/Util/String","VSS/Legacy/Legacy","Build/Common/Library/Components/StagesPanel","Build/Queue-Panel/QueuePanel","Build/Common/Library/Legacy/Stores/Queue","Build/Common/Library/SingletonManager","VSSUI/Button"],(function(e,t,o,i,s,n,a,r,l,p,d,m,h,c,u,f){var g,C,D;g=t[D="Resources"]={},t[D].Cancel="Cancel",t[D].Create="Create",t[D].CannotEndWithPeriodErrorMessage="Cannot end with a '.'.",t[D].ChooseFolder="Choose folder...",t[D].DefinitionDescriptionTextboxLabel="Description",t[D].DefinitionFolderTextboxLabel="Select folder",t[D].DefinitionNameTextboxLabel="Name",t[D].Delete="Delete",t[D].DeleteDefinitionDialogMessage="Are you sure? This action cannot be undone. This will permanently delete the pipeline '{0}'. Deletion includes all builds and associated artifacts.",t[D].DeleteDraftDefinitionDialogMessage="Are you sure? This action cannot be undone. This will permanently delete the draft pipeline '{0}'.",t[D].DeleteFolderDialogMessage="Are you sure? This action cannot be undone. This will permanently delete the folder '{0}'. Deletion includes all pipelines and associated builds and artifacts.",t[D].DeleteDefinitionDialogTitle="Delete '{0}'?",t[D].DeleteDraftDefinitionDialogTitle="Delete draft of '{0}'?",t[D].DeleteFolderDialogTitle="Delete '{0}'?",t[D].DeleteDefinitionTextboxLabel="Please type the name of the pipeline to confirm.",t[D].DeleteDraftDefinitionTextboxLabel="Please type the name of the draft pipeline to confirm.",t[D].DeleteFolderTextboxLabel="Please type the complete folder path to confirm.",t[D].FolderCannotBeEmptyErrorMessage="Folder cannot be empty.",t[D].FolderCannotEndWithPeriodErrorMessage="Folder cannot end with a '.'.",t[D].FolderNameLabel="Folder name",t[D].FolderNamePlaceholder="Type a folder name",t[D].FolderPathTextboxLabel="Path",t[D].NameCannotBeEmptyErrorMessage="Name cannot be empty.",t[D].NewFolderDialogTitle="New folder",t[D].No="No",t[D].OK="OK",t[D].RenameDefinitionDialogTitle="Rename/move pipeline",t[D].RenameFolderDialogTitle="Rename folder",t[D].Save="Save",t[D].SaveAsTemplateDefinitionDialogTitle="Save as a template...",t[D].SelectFolder="Select folder",t[D].UnallowedFolderCharactersErrorMessage="{0} are not allowed in folder names.",t[D].UnallowedNameCharactersErrorMessage="{0} are not allowed in pipeline names.",t[D].UnallowedFolderPathLength="The following path contains more than the allowed {0} characters",t[D].Yes="Yes",t[D].Run="Run",function(e){C=t[e]={},function(e){e.DisallowedPipelineNameCharacters='<>|\\:$@"/',e.DisallowedFolderPathCharacters='<>|:$@"/%+*?',e.DisallowedFolderNameCharacters=e.DisallowedFolderPathCharacters+"\\"}(t[e].DisallowedCharacters||(t[e].DisallowedCharacters={})),function(e){e.MaxPathNameLength=248}(t[e].CharacterLimits||(t[e].CharacterLimits={}))}("Constants"),t.confirmpipelineactionCommandtypes={},function(){t.confirmpipelineactionCommand={};class e extends s.VssComponent{constructor(e){super(e),this._onCommit=()=>{this.props.onClose(),this.props.onConfirm()},this._onDismiss=()=>{this.props.onClose()}}render(){return o.createElement(i.Dialog,{calloutContentClassName:"ci-dialog",onDismiss:this._onDismiss,showCloseButton:!0,footerButtonProps:[{onClick:this._onDismiss,text:this.props.cancelLabel||g.No},{onClick:this._onCommit,primary:!this.props.isDanger,danger:this.props.isDanger,text:this.props.confirmLabel||g.Yes}],titleProps:{text:this.props.title,size:1}},o.createElement("div",null,this.props.message))}}e.componentType="ciDConfirmPipelineComponent",s.VssComponent.register(e.componentType,e)}(),t.deletedefinitionCommandtypes={},function(){t.deletedefinitionCommand={};class e extends s.VssComponent{constructor(e){super(e),this.deleteText=new l.ObservableValue(""),this._onCommit=()=>{if(!this.state.deletionConfirmed)return;this.props.onClose();let e=this.props.pageContext.getRestClient("IBuildRestClient");if(this.props.definition){let t=this.props.definition;e.deleteDefinition(t.project.id,t.id).then((()=>{this.props.onDefinitionDeleted&&this.props.onDefinitionDeleted(t)}),n.handleError)}else if(this.props.path){let t=this.props.path;e.deleteFolder(this.props.projectId,t).then((()=>{this.props.onFolderDeleted&&this.props.onFolderDeleted(t)}),n.handleError)}},this._onDismiss=()=>{this.props.onClose()},this._onTextChanged=(e,t)=>{this.deleteText.value=t,this.props.definition&&this.props.definition.name===t||this.props.path&&this.props.path===t?this.setState({deletionConfirmed:!0}):this.setState({deletionConfirmed:!1})},this.state={deletionConfirmed:!1}}render(){let e="",t="",s="";if(this.props.definition)2===this.props.definition.quality?(e=(0,p.format)(g.DeleteDraftDefinitionDialogTitle,this.props.definition.name),t=(0,p.format)(g.DeleteDraftDefinitionDialogMessage,this.props.definition.name),s=g.DeleteDraftDefinitionTextboxLabel):(e=(0,p.format)(g.DeleteDefinitionDialogTitle,this.props.definition.name),t=(0,p.format)(g.DeleteDefinitionDialogMessage,this.props.definition.name),s=g.DeleteDefinitionTextboxLabel);else if(this.props.path){const o=this.props.path.split("\\"),i=o[o.length-1];e=(0,p.format)(g.DeleteFolderDialogTitle,i),t=(0,p.format)(g.DeleteFolderDialogMessage,this.props.path),s=g.DeleteFolderTextboxLabel}return o.createElement(i.Dialog,{calloutContentClassName:"ci-dialog",onDismiss:this._onDismiss,footerButtonProps:[{onClick:this._onDismiss,text:g.Cancel},{disabled:!this.state.deletionConfirmed,onClick:this._onCommit,primary:!0,text:g.Delete}],titleProps:{text:e,size:1},defaultActiveElement:".delete-definition-name"},o.createElement("div",null,t),o.createElement("br",null),o.createElement(a.FormItem,{label:s},o.createElement(r.TextField,{onChange:this._onTextChanged,value:this.deleteText,inputClassName:"delete-definition-name"})))}}e.componentType="ciDeleteDefinitionComponent",s.VssComponent.register(e.componentType,e)}(),function(){t.importdefinitionCommand={};class e extends s.VssComponent{constructor(e){super(e)}render(){return o.createElement(d.LegacyComponent,{modules:["Build/Scripts/Components/ImportDefinitionDialog"],wrappedType:"ci-import-dialog"})}}e.componentType="ciImportDefinitionComponent",s.VssComponent.register(e.componentType,e)}(),t.newfolderCommandtypes={},function(){t.newfolderCommand={};class e extends s.VssComponent{constructor(e){super(e),this._onCommit=()=>{this.props.onClose();let e=this.props.pageContext.getRestClient("IBuildRestClient"),t={path:this.props.parentPath+"\\"+this.state.name.trim()};e.createFolder(t,this.props.projectId,t.path).then((e=>{this.props.onFolderCreated&&this.props.onFolderCreated(e)}),n.handleError)},this._onDismiss=()=>{this.props.onClose()},this._checkInvalidCharacters=(e,t)=>{for(let o=0;o<t.length;o++)if(-1!==e.indexOf(t[o]))return!0;return!1},this._onNameChanged=(e,t)=>{let o="";if(0===t.trim().length)o="";else{const e=C.DisallowedCharacters.DisallowedFolderNameCharacters,i=this.props.parentPath+"\\"+this.state.name.trim();this._checkInvalidCharacters(t,e)?o=(0,p.format)(g.UnallowedNameCharactersErrorMessage,e):i.length>C.CharacterLimits.MaxPathNameLength&&(o=(0,p.format)(g.UnallowedFolderPathLength,C.CharacterLimits.MaxPathNameLength))}this.setState({name:t,nameErrorMessage:o})},this.state={name:"",description:"",nameErrorMessage:""}}render(){const e="\\"===this.props.parentPath?void 0:this.props.parentPath+"\\";return o.createElement(i.Dialog,{defaultActiveElement:".folderNameField",calloutContentClassName:"ci-dialog",footerButtonProps:[{onClick:this._onDismiss,text:g.Cancel},{disabled:this.state.nameErrorMessage.length>0||0===this.state.name.trim().length,onClick:this._onCommit,primary:!0,text:g.Create}],onDismiss:this._onDismiss,titleProps:{text:g.NewFolderDialogTitle,size:1}},o.createElement(a.FormItem,{message:this.state.nameErrorMessage,error:this.state.nameErrorMessage.length>0},o.createElement(r.TextFieldWithMessage,{textFieldProps:{ariaLabel:g.FolderNameLabel,inputClassName:"folderNameField",value:this.state.name,onChange:this._onNameChanged,placeholder:g.FolderNamePlaceholder},message:e,messageClassName:"pipelines-new-folder-dialog-name"})))}}e.componentType="ciNewFolderComponent",s.VssComponent.register(e.componentType,e)}(),t.permissionsCommandtypes={},function(){t.permissionsCommand={};class e extends s.VssComponent{constructor(e){super(e)}render(){return o.createElement(d.LegacyComponent,{modules:["Build/Scripts/Components/DefinitionPermissionsDialog"],wrappedType:"ci-permissions-dialog",definition:this.props.definition,path:this.props.path})}}e.componentType="ciPermissionsComponent",s.VssComponent.register(e.componentType,e)}(),t.stagesCommandtypes={},function(){t.stagesCommand={};class e extends s.VssComponent{constructor(e){super(e)}render(){return o.createElement(m.StagesPanel,Object.assign({onDismiss:this.props.onDismis},this.props))}}e.componentType="ciStagesComponent",s.VssComponent.register(e.componentType,e)}(),t.queuebuildCommandtypes={},function(){t.queuebuildCommand={};class e extends s.VssComponent{constructor(e){super(e),this._storeChanged=()=>{this.setState({queues:this._queueStore.getQueues()})},this._onSuccess=(e,t,o)=>{this.props.onSuccess(o)};let t=(0,u.getSingletonManager)().get(c.QueueStore.key);t||(t=new c.QueueStore({pageContext:e.pageContext,project:e.project}),(0,u.getSingletonManager)().add(c.QueueStore.key,t)),this._queueStore=t,this.state={queues:this._queueStore.getQueues()}}componentDidMount(){this._queueStore.addListener(this._storeChanged)}componentWillUnmount(){this._queueStore.removeListener(this._storeChanged)}render(){const e=this.props.definition;let t={agentQueues:this.state.queues,defaultAgentQueue:null,defaultSourceBranch:this.props.defaultSourceBranch||"",definitionId:e.id,definitionName:e.name,processType:this.props.processType,repository:this.props.repository,queueDialogSource:this.props.source,onSuccess:this._onSuccess,onClosed:this.props.onClosed,definitionQueueStatus:e.queueStatus,runTimeVariables:this._getRuntimeVariables(this.props.definitionVariables,this.props.previousRunVariables),previousTemplateParameters:this.props.previousTemplateParameters,addDefinitionDemands:!0};const i=this.props.queue;return i&&(t.defaultAgentQueue={projectId:this.props.project,id:i.id,name:i.name,pool:i.pool}),o.createElement(h.QueuePanel,{showPanel:!0,pageContext:this.props.pageContext,projectId:this.props.project,definitionId:this.props.definition.id,buildRepository:this.props.repository,sourceBranch:this.props.defaultSourceBranch||"",runtimeVariables:t.runTimeVariables,previousTemplateParameters:t.previousTemplateParameters,definitionVariables:this.props.definitionVariables,onDismiss:this.props.onDismiss})}_getRuntimeVariables(e,t){const o=[];e=e||{},t=t||{};for(let i in e)if(e.hasOwnProperty(i)&&!t.hasOwnProperty(i)){let t=e[i];t.allowOverride&&o.push({name:i,variable:{value:t.value,isSecret:t.isSecret,allowOverride:!0,disableDelete:!0}})}for(let i in t)if(t.hasOwnProperty(i)){let s=t[i],n=e.hasOwnProperty(i)&&!0===e[i].allowOverride;o.push({name:i,variable:{value:s,isSecret:!1,allowOverride:!0,disableDelete:n}})}return o}}e.componentType="ciQueueBuildComponent",s.VssComponent.register(e.componentType,e)}(),t.savedefinitionCommandtypes={},function(){t.savedefinitionCommand={};class e extends s.VssComponent{constructor(e){super(e),this._onCommit=(e,t,o)=>{this.props.onClose();const i=e.trim(),s=t.trim();let a=this.props.pageContext.getRestClient("IBuildRestClient");if(this.props.definition)a.getDefinition(this.props.definition.project.id,this.props.definition.id).then((e=>{if(e.comment="",this.props.saveAsTemplate){e.quality=1;let t={name:i,description:o,template:e};a.saveTemplate(t,e.project.id,t.name.replace(/[^0-9a-zA-Z-_.]/g,"")).then((e=>{}),n.handleError)}else e.name=i,e.description=o,e.path=s,a.updateDefinition(e,e.project.id,e.id).then((e=>{this.props.onDefinitionSaved&&this.props.onDefinitionSaved(e)}),n.handleError)}),n.handleError);else if(this.props.folder){let e={path:s+"\\"+i,description:o},t=this.props.folder.path;a.updateFolder(e,this.props.projectId,t).then((e=>{this.props.onFolderSaved&&this.props.onFolderSaved(e,t)}),n.handleError)}},this._onDismiss=()=>{this.props.onClose()},this._onNameChanged=(e,t)=>{let o="";if(0===t.trim().length)o=g.NameCannotBeEmptyErrorMessage;else{const e=this.props.definition?C.DisallowedCharacters.DisallowedPipelineNameCharacters:C.DisallowedCharacters.DisallowedFolderNameCharacters;for(let i=0;i<e.length;i++)-1!==t.indexOf(e[i])&&(o=(0,p.format)(g.UnallowedNameCharactersErrorMessage,e))}this.setState({name:t,nameErrorMessage:o})},this._onPathChanged=(e,t)=>{let o="";if(0===t.trim().length)o=g.FolderCannotBeEmptyErrorMessage;else if((0,p.endsWith)(t,"."))o=g.FolderCannotEndWithPeriodErrorMessage;else{const e=C.DisallowedCharacters.DisallowedFolderPathCharacters;for(let i=0;i<e.length;i++)-1!==t.indexOf(e[i])&&(o=(0,p.format)(g.UnallowedFolderCharactersErrorMessage,e))}this.setState({definitionPath:t,pathErrorMessage:o})},this._onShowFolderDialog=()=>{this.setState({showFolderDialog:!0})},this._onDismissFolderDialog=()=>{this.setState({showFolderDialog:!1})},this._onFolderDialogResult=e=>{this.setState({definitionPath:e.path})};let t="",o="";e.definition?(t=e.definition.name,o=e.definition.path):e.folder&&(t=this._getName(e.folder),o=this._getParentPath(e.folder)),this.state={name:t,definitionPath:o,description:"",nameErrorMessage:"",pathErrorMessage:"",showFolderDialog:!1}}render(){let e={title:g.SelectFolder,okManageDialogCallBack:this._onFolderDialogResult,onManageDialogDissmiss:this._onDismissFolderDialog,showDialogActions:!1,defaultPath:this.state.definitionPath,showDialog:this.state.showFolderDialog},t=g.RenameDefinitionDialogTitle;return this.props.saveAsTemplate?t=g.SaveAsTemplateDefinitionDialogTitle:this.props.definition||(t=g.RenameFolderDialogTitle),o.createElement(i.Dialog,{calloutContentClassName:"ci-dialog",footerButtonProps:[{onClick:this._onDismiss,text:g.Cancel},{disabled:this.state.nameErrorMessage.length>0||this.state.pathErrorMessage.length>0,onClick:this._onCommit.bind(this,this.state.name,this.state.definitionPath,this.state.description),primary:!0,text:g.Save}],onDismiss:this._onDismiss,titleProps:{text:t,size:1}},o.createElement(d.LegacyComponent,Object.assign({modules:["Build/Scripts/Components/FolderManageDialog"],wrappedType:"ci-folder-manage-dialog"},e)),o.createElement(a.FormItem,{label:g.DefinitionNameTextboxLabel,message:this.state.nameErrorMessage,error:this.state.nameErrorMessage.length>0},o.createElement(r.TextField,{value:this.state.name,onChange:this._onNameChanged,required:!0})),!this.props.saveAsTemplate&&this.props.definition&&o.createElement("div",{className:"ci-folder-picker-container flex"},o.createElement(a.FormItem,{className:"flex-grow",label:g.DefinitionFolderTextboxLabel,message:this.state.pathErrorMessage,error:this.state.pathErrorMessage.length>0},o.createElement(r.TextField,{value:this.state.definitionPath,onChange:this._onPathChanged,required:!0})),o.createElement(f.Button,{subtle:!0,className:"flex-self-end",iconProps:{iconName:"More"},disabled:!1,onClick:this._onShowFolderDialog,ariaLabel:g.ChooseFolder})))}_getName(e){let t=e.path.lastIndexOf("\\");return e.path.substring(t+1)}_getParentPath(e){let t=e.path.lastIndexOf("\\");return e.path.substring(0,t)}}e.componentType="ciSaveDefinitionComponent",s.VssComponent.register(e.componentType,e)}()}),["Resources","Constants","confirmpipelineaction/Command.types","confirmpipelineaction/Command","deletedefinition/Command.types","deletedefinition/Command","importdefinition/Command","newfolder/Command.types","newfolder/Command","permissions/Command.types","permissions/Command","stages/Command.types","stages/Command","queuebuild/Command.types","queuebuild/Command","savedefinition/Command.types","savedefinition/Command"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-build-web.common-commands"}}));
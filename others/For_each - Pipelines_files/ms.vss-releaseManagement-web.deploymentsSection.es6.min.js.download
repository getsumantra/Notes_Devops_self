"use strict";define("Release/DeploymentsSection",["require","exports","VSS/Reflux/Action","VSS/Reflux/Store","Release/SignalR/SignalRHubProxies","VSS/Features/SignalR/Hub","VSS/Core/Util/String","Release/Helpers/ReleaseContractsStatusConverter","VSS/Platform/Layout","VSS/Features/PlatformUI/FPSLink","react","VSSUI/Button","VSSUI/Util","OfficeFabric/FocusZone","VSSUI/Link","VSSUI/List","VSSUI/Utilities/Provider","VSSUI/Icon","Release/EnvironmentNode/EnvironmentChain","VSSUI/Card","VSSUI/Table","VSS/Core/Observable","VSS/Platform/Context"],(function(e,t,s,n,i,o,a,r,l,c,m,d,h,u,p,g,_,y,S,C,v,D,R){var b,f,I,x,w,E,L,N,U,A,P;b=t[P="Resources"]={},t[P].AriaReleasesTable="Releases",t[P].ColumnName="Name",t[P].DeploymentsCountLabel="{0} {1}",t[P].DeploymentsNotFoundError="Deployments data couldn't be found",t[P].Failed="Failed",t[P].InProgress="In Progress",t[P].IssuesHeaderText="Release/s not created ({0})",t[P].NoDeploymentsMessage="No deployments were found for this build.",t[P].PartiallySucceeded="Partially Succeeded",t[P].Releases="Releases",t[P].ShowLess="Show Less",t[P].ShowMore="Show More",t[P].Succeeded="Succeeded",t[P].Title="Deployments",t[P].ViewAll="View All ({0})",function(e){f=t[e]={};t[e].DeploymentsComponentActions=class{constructor(){this.initialize()}static getKey(){return"deployments-section-actions"}initialize(e){this._setReleases=new s.Action,this._setReleases2=new s.Action,this._setAutoTriggerIssues=new s.Action,this._fetchFavorites=new s.Action,this._incrementRenderIndex=new s.Action,this._maximizeRenderIndex=new s.Action,this._resetView=new s.Action,this._setDeploymentsData=new s.Action,this._toggleExpandIssues=new s.Action}get setRelease(){return this._setReleases}get setReleases(){return this._setReleases2}get fetchFavorites(){return this._fetchFavorites}get incrementRenderIndex(){return this._incrementRenderIndex}get maximizeRenderIndex(){return this._maximizeRenderIndex}get resetView(){return this._resetView}get setAutoTriggerIssues(){return this._setAutoTriggerIssues}get setDeploymentsData(){return this._setDeploymentsData}get toggleExpandIssues(){return this._toggleExpandIssues}}}("ActionsDeploymentsComponentActions"),function(e){I=t[e]={};t[e].DeploymentsSignalRActionCreator=class{constructor(e){this._actionHub=e.actionHub}environmentUpdated(e,t,s,n,i,o,a){const r={definitionId:t,environmentId:n,environmentStatus:i,projectId:e,releaseId:s,latestDeploymentStatus:o,latestDeploymentOperationStatus:a};this._actionHub.environmentUpdated.invoke(r)}get actionHub(){return this._actionHub}};t[e].DeploymentsSignalRActionHub=class{constructor(){this._environmentUpdated=new s.Action}get environmentUpdated(){return this._environmentUpdated}}}("ActionsSignalR"),function(e){x=t[e]={};class s extends n.Store{constructor(e){super("DeploymentsSignalRStoreChangedEvent"),this._environmentsUpdatedListeners=[],this._onEnvironmentUpdated=e=>{this._environmentsUpdatedListeners.forEach((t=>t(e)))},this._actionCreator=e.actionCreator,this._actionCreator.actionHub.environmentUpdated.addListener(this._onEnvironmentUpdated)}addEnvironmentsUpdatedListener(e){this._environmentsUpdatedListeners.push(e)}removeEnvironmentsUpdatedListener(e){const t=this._environmentsUpdatedListeners.indexOf(e);t>-1&&this._environmentsUpdatedListeners.splice(t,1)}dispose(){this._actionCreator.actionHub.environmentUpdated.removeListener(this._onEnvironmentUpdated),this._environmentsUpdatedListeners=[]}}t[e].SignalRStore=s,s.s_maxCount=25}("StoresSignalR"),function(e){w=t[e]={};class s extends o.SignalRHub{constructor(e){super({pageContext:e.pageContext,hostInformation:e.hostInformation,name:i.HubNames.releaseHub,listener:e.listener||new n(e.actionCreator),userInactivityTimeoutMs:s.s_userInactivityTimeoutMs}),this._initializeClient=e=>{e.client.onReleaseEnvironmentStatusUpdated=(e,t,s,n,i,o,a)=>{this._options.actionCreator.environmentUpdated(e,t,s,n,i,o,a)}},this._options=e,this.watchedReleases=new Set,this.initializeProxy(i.getReleaseProxyToRegister,this._initializeClient)}watchRelease(e,t){var s=a.format("{0}/{1}",e,t);this.watchedReleases.has(s)||this.start().then((()=>{const n=this.hub;n&&n.server.watchRelease(e,t).then((()=>{console.log("DeploymentsSignalRHub: watching release "+t),this.watchedReleases.add(s)}))})).catch((e=>{console.log(e)}))}stopWatchingRelease(e,t){const s=this.hub;var n=a.format("{0}/{1}",e,t);s&&this.watchedReleases.has(n)&&(s.server.stopWatchingRelease(e,t),console.log("DeploymentsSignalRHub: Stopped watching release "+t),this.watchedReleases.delete(n))}}t[e].DeploymentsSignalRHub=s,s.s_userInactivityTimeoutMs=36e5;class n{constructor(e){this._isDisconnectivityTriggered=!1,this._isUserInactivityTriggered=!1,this._actionCreator=e}isConnecting(){}isConnected(){}isDisconnected(){this._isUserInactivityTriggered||this._isDisconnectivityTriggered||(this._isDisconnectivityTriggered=!0)}isReconnected(){}isReconnecting(){}isSlow(){}isUserActive(){}isUserInactive(){this._isDisconnectivityTriggered||(this._isUserInactivityTriggered=!0)}}}("SignalRHub"),function(e){E=t[e]={};t[e].Deployments=class{};t[e].TriggerIssue=class{};class s extends n.Store{constructor(e,t){super("deploymentsStoreChanged"),this._maximizeRenderIndex=()=>{this._state.renderCount=this._state.deployments.length,this._state.isShowMoreVisible=!1,this.emitChanged()},this._incrementRenderIndex=()=>{this._state.renderCount+=s._defaultIncrementRenderCount,this._state.renderCount>=this._state.deployments.length&&(this._state.isShowMoreVisible=!1),this.emitChanged()},this._resetView=()=>{this._state.renderCount=this._state.defaultRenderCount,this._state.renderCount<=this._state.deployments.length&&(this._state.isShowMoreVisible=!0),this.emitChanged()},this._loadDeploymentsData=e=>{this._setFavorites(e.favoriteDefinitionIds),this._setTriggerIssues(e.autoTriggerIssues),this._setDeploymentsData(e.releases),this.emitChanged()},this._toggleExpandIssues=()=>{this._state.expandIssues=!this._state.expandIssues,this.emitChanged()},this._environmentUpdated=e=>{if(!e)return;e.environmentStatus=r.ReleaseContractsStatusConverter.toEnvironmentStatus(e.environmentStatus.toString());let t=e.releaseId,s=this._state.deployments.findIndex((e=>e.id===t));if(s>=0){let t=this._state.deployments[s].environments.findIndex((t=>t.id===e.environmentId));if(t>=0){let n=r.ReleaseContractsStatusConverter.toDeploymentStatus(e.latestDeploymentStatus.toString()),i=r.ReleaseContractsStatusConverter.toDeploymentOperationStatus(e.latestDeploymentOperationStatus.toString());this._updateDeploymentsCount(this._state.deployments[s].environments[t],n);let o=this._state.deployments[s].environments[t].deploySteps;const a=Math.max(...o.map((e=>e.attempt)));let l=o.find((e=>e.attempt===a));l||(l=this._createDummyDeployment(),o.push(l)),l.status=n,l.operationStatus=i,this._state.deployments[s].environments[t].status=e.environmentStatus,1!==l.status&&(this._state.deployments[s].environments[t].preDeployApprovals=[]),4!=l.status&&16!=l.status&&8!=l.status||(this._state.deployments[s].environments[t].postDeployApprovals=[]),this._state.deployments[s].environments[t].status=e.environmentStatus,this._state.deployments=this._state.deployments.slice(0),this.emitChanged()}}},this._allFavoriteDefinitions={},this._actions=e,this._signalRStore=t,this._initializeState(),this._actions.maximizeRenderIndex.addListener(this._maximizeRenderIndex),this._actions.incrementRenderIndex.addListener(this._incrementRenderIndex),this._actions.resetView.addListener(this._resetView),this._actions.setDeploymentsData.addListener(this._loadDeploymentsData),this._actions.toggleExpandIssues.addListener(this._toggleExpandIssues),this._signalRStore.addEnvironmentsUpdatedListener(this._environmentUpdated)}dispose(){this._actions.maximizeRenderIndex.removeListener(this._maximizeRenderIndex),this._actions.incrementRenderIndex.removeListener(this._incrementRenderIndex),this._actions.resetView.removeListener(this._resetView),this._actions.setDeploymentsData.removeListener(this._loadDeploymentsData),this._actions.toggleExpandIssues.removeListener(this._toggleExpandIssues),this._signalRStore.removeEnvironmentsUpdatedListener(this._environmentUpdated)}static getKey(){return"deployments-section-store"}static getDefaultState(){return{failedDeploymentsCount:0,inProgressDeploymentsCount:0,succeededDeploymentsCount:0,partiallySucceededCount:0,deployments:[],renderCount:0,defaultRenderCount:0,isShowMoreVisible:!0,triggerIssues:[],expandIssues:!1,noDeployments:!0,signalRHubByProject:{}}}getState(){return this._state}_setFavorites(e){e&&e.map((e=>{this._allFavoriteDefinitions[e]=!0}))}_initializeState(){this._allFavoriteDefinitions={},this._state=s.getDefaultState()}_setDeploymentsData(e){if(this._state.deployments=[],!e)return;let t=[],s=[],n=[];this._state.succeededDeploymentsCount=0,this._state.inProgressDeploymentsCount=0,this._state.failedDeploymentsCount=0,this._state.partiallySucceededCount=0,this._state.noDeployments=!(e.length>0),e.forEach((e=>{this._countDeploymentsStatus(e),this._isFavoriteDefinition(e.projectReference.id,e.releaseDefinition.id.toString())?t.push(e):this._consistsFailedDeployments(e.environments)?n.push(e):s.push(e)}));let i=this._getDeployments(t,!0),o=this._getDeployments(n),a=this._getDeployments(s);this._state.renderCount=e.length-s.length,this._state.defaultRenderCount=this._state.renderCount,this._state.deployments=i.concat(o).concat(a),this._state.renderCount<this._state.deployments.length?this._state.isShowMoreVisible=!0:this._state.isShowMoreVisible=!1}_isFavoriteDefinition(e,t){return e+"/"+t in this._allFavoriteDefinitions}_consistsFailedDeployments(e){return e.filter((e=>16===e.status||8===e.status)).length>0}_getDeployments(e,t=!1){return e.map((e=>({environments:e.environments,id:e.id,rdName:e.releaseDefinition.name,rdUrl:e.releaseDefinition._links.web.href,rdId:e.releaseDefinition.id,releaseName:e.name.toString(),releaseUrl:e._links.web.href,isFavorite:t,projectId:e.projectReference.id})))}_countDeploymentsStatus(e){e.environments.forEach((e=>{let t=e.deploySteps;if(t.length>0){const e=Math.max(...t.map((e=>e.attempt)));let s=t.find((t=>t.attempt===e));this._incrementStatusCount(s.status)}}))}_setTriggerIssues(e){this._state.triggerIssues=[],e&&e.length>0&&(e.sort(((e,t)=>a.localeIgnoreCaseComparer(e.releaseDefinitionReference.name,t.releaseDefinitionReference.name))),e.forEach((e=>{this._state.triggerIssues.push(this._getReleaseTriggerIssue(e))})))}_getReleaseTriggerIssue(e){e.project.name||e.project.id;let t=e.releaseDefinitionReference.name,n=e.issue.message,i=e.releaseDefinitionReference._links.web.href,o=!1,r=!1,l=!1;return 0===a.localeIgnoreCaseComparer(e.issueSource.toString(),"System")&&(o=!0),0===a.localeIgnoreCaseComparer(e.issue.issueType,s._errorIssueType)?r=!0:0===a.localeIgnoreCaseComparer(e.issue.issueType,s._warningIssueType)&&(l=!0),{releaseDefinitionUrl:i,releaseDefinitionName:t,issueMessage:n,isSystemIssue:o,isError:r,isWarning:l}}_updateDeploymentsCount(e,t){let s=e.deploySteps;if(s.length>0){const e=Math.max(...s.map((e=>e.attempt)));let t=s.find((t=>t.attempt===e));this._decrementStatusCount(t.status)}this._incrementStatusCount(t)}_incrementStatusCount(e){switch(e){case 4:this._state.succeededDeploymentsCount++;break;case 2:this._state.inProgressDeploymentsCount++;break;case 16:this._state.failedDeploymentsCount++;break;case 8:this._state.partiallySucceededCount++}}_decrementStatusCount(e){switch(e){case 4:this._state.succeededDeploymentsCount--;break;case 2:this._state.inProgressDeploymentsCount--;break;case 16:this._state.failedDeploymentsCount--;break;case 8:this._state.partiallySucceededCount--}}_createDummyDeployment(){return{attempt:1,deploymentId:0,hasStarted:!1,id:0,errorLog:"",issues:[],job:null,lastModifiedBy:null,lastModifiedOn:null,operationStatus:null,postDeploymentGates:null,preDeploymentGates:null,queuedOn:null,reason:null,releaseDeployPhases:null,requestedBy:null,requestedFor:null,runPlanId:null,status:null,tasks:[]}}}t[e].DeploymentsComponentStore=s,s._defaultIncrementRenderCount=10,s._errorIssueType="Error",s._warningIssueType="Warning"}("StoresDeploymentsComponentStore"),function(e){L=t[e]={};t[e].DeploymentsSource=class{constructor(e){this._pageContext=e}loadDeploymentsData(e){let t=this._pageContext.getService("IVssContributionService"),s=t.getData("ms.vss-releaseManagement-web.build-summary-deployments-data-privateProvider");return s||(s=t.getData("ms.vss-releaseManagement-web.build-summary-deployments-data-provider")),new Promise((function(t,n){s?s.buildId===e.toString()?t(s):t({autoTriggerIssues:[],buildId:"",favoriteDefinitionIds:[],releases:[]}):n(b.DeploymentsNotFoundError)}))}getReleaseEnviroment(e,t,s){return this._pageContext.getRestClient("IReleaseRestClient").getReleaseEnvironment(e,t,s)}}}("DeploymentsSource"),function(e){N=t[e]={};t[e].DeploymentsComponentActionsCreator=class{constructor(e,t){this._actions=e,this._source=t}static getKey(){return"deployments-section-actionscreator"}initializeData(e){return new Promise((t=>{this._source.loadDeploymentsData(e.id).then((e=>{this._actions.setDeploymentsData.invoke(e),t()}))}))}incrementRenderIndex(){this._actions.incrementRenderIndex.invoke(void 0)}maximizeRenderIndex(){this._actions.maximizeRenderIndex.invoke(void 0)}resetView(){this._actions.resetView.invoke(void 0)}toggleExpandIssues(){this._actions.toggleExpandIssues.invoke(void 0)}}}("ActionsDeploymentsComponentActionsCreator"),function(e){U=t[e]={};class s extends l.VssComponent{constructor(e,t){super(e,t),this._onStoreChanged=()=>{this.setState(this._store.getState()),this._attachSignalRListener()},this._onRenderCell=(e,t,s)=>e>=this.state.renderCount?m.createElement("div",null):this._getDeploymentsComponent(t,t.isFavorite,e,s),this._showDeploymentsCountSeparator=!1,this._envChainWidth=96,this._store=e.store,this._actionsCreator=e.actionsCreator,this._signalRHub=e.signalRHub,this._store?this.state=this._store.getState():this.state=E.DeploymentsComponentStore.getDefaultState()}componentDidMount(){if(this._store.addChangedListener(this._onStoreChanged),this._attachSignalRListener(),!this.loggedPerfEvent){this.context.pageContext.getService("IVssPerformanceService").endScenario("ReleaseManagement","ReleaseManagement.DeploymentsSection.Load",!1),this.loggedPerfEvent=!0}}componentWillReceiveProps(e){this._signalRHub=this._signalRHub?this._signalRHub:e.signalRHub}render(){return this._showDeploymentsCountSeparator=!1,m.createElement("div",{className:"deployments-section"},m.createElement("h3",{className:"deployments-title"},b.Title),m.createElement("div",{className:"deployments-summary-count"},this._getDeploymentsCountComponent(this.state.failedDeploymentsCount,b.Failed),this._getDeploymentsCountComponent(this.state.inProgressDeploymentsCount,b.InProgress),this._getDeploymentsCountComponent(this.state.partiallySucceededCount,b.PartiallySucceeded),this._getDeploymentsCountComponent(this.state.succeededDeploymentsCount,b.Succeeded)),0===this.state.deployments.length&&m.createElement("div",null,m.createElement("span",{className:"no-deployments-text summary-secondary-text"},b.NoDeploymentsMessage)),m.createElement(u.FocusZone,{direction:u.FocusZoneDirection.vertical},m.createElement("div",{"data-is-scrollable":!0},m.createElement(g.List,{className:"deployments-list",itemProvider:new _.ArrayItemProvider(this.state.deployments),renderRow:this._onRenderCell}))),this.state.deployments.length>0&&this.state.isShowMoreVisible&&m.createElement("div",{className:"deployments-list-expand-buttons"},m.createElement(p.Link,{href:"#",className:"summary-secondary-text",onClick:()=>{this._actionsCreator.incrementRenderIndex()}},b.ShowMore),m.createElement("span",{className:"separator"}," | "),m.createElement(p.Link,{href:"#",className:"summary-secondary-text",onClick:()=>{this._actionsCreator.maximizeRenderIndex()}},(0,a.localeFormat)(b.ViewAll,this.state.deployments.length))),this.state.deployments.length>0&&!this.state.isShowMoreVisible&&this.state.deployments.length!==this.state.defaultRenderCount&&m.createElement("div",{className:" deployments-list-expand-buttons"},m.createElement(p.Link,{href:"#",className:"summary-secondary-text",onClick:()=>{this._actionsCreator.resetView()}},b.ShowLess)),this._getIssuesComponent(this.state.triggerIssues,this.state.expandIssues))}componentWillUnmount(){this._store.removeChangedListener(this._onStoreChanged),this._store.dispose()}_attachSignalRListener(){this.state.deployments.forEach((e=>{let t=e.environments.filter((e=>{if(8!=e.status&&128!=e.status&&16!=e.status&&4!=e.status)return e}));this._signalRHub&&(t.length>0?this._signalRHub.watchRelease(e.projectId,e.id):this._signalRHub.stopWatchingRelease(e.projectId,e.id))}))}_getDeploymentsCountComponent(e,t){if(0===e)return null;let s=m.createElement("span",{className:"summary-secondary-text"},this._showDeploymentsCountSeparator&&m.createElement("span",{className:"separator"},"/"),m.createElement("span",{className:this._getClassNameByDeploymentStatus(t)},(0,a.localeFormat)(b.DeploymentsCountLabel,e,t)));return this._showDeploymentsCountSeparator=!0,s}_getDeploymentsComponent(e,t=!1,s,n){return m.createElement(g.ListItem,{details:n,index:s,key:"list-item"+s},m.createElement("div",{className:"deployments-list-element"},m.createElement("div",{"data-is-focusable":!0},t&&m.createElement(y.Icon,{iconName:"FavoriteStarFill",className:(0,h.css)("favorite-icon","favorite-icon-filled")}),m.createElement("div",{className:"release-definition-header"},m.createElement(c.FPSLink,{href:e.rdUrl,className:"defintion-name",telemetrySource:"deployments-summary-view-definition-link"},e.rdName),"/",m.createElement(c.FPSLink,{href:e.releaseUrl,className:"release-name",telemetrySource:"deployments-summary-view-release-link"},e.releaseName))),this._renderActiveReleaseEnvironmentsChain(e)))}_getIssuesComponent(e,t){return 0===this.state.triggerIssues.length?null:m.createElement("div",{className:"issues-section"},m.createElement("div",{className:"issues-section-header"},m.createElement("h4",{className:"summary-secondary-text"},(0,a.localeFormat)(b.IssuesHeaderText,e.length)),m.createElement(d.Button,{subtle:!0,className:"expand-issues",iconProps:{iconName:t?"ChevronUp":"ChevronDown",className:"chevron-icon"},onClick:()=>{this._toggleExpandIssues()}})),t&&e.map(((e,t)=>m.createElement("div",{key:t,className:"issues-section-content"},m.createElement("div",{className:"release-definition-header"},m.createElement(c.FPSLink,{href:e.releaseDefinitionUrl,className:"defintion-name",telemetrySource:"deployments-summary-view-issue-definition-link"},e.releaseDefinitionName)),e.isError&&m.createElement("span",{className:"error-icon bowtie-icon bowtie-status-failure"}),e.isWarning&&m.createElement("span",{className:"warning-icon bowtie-icon bowtie-status-warning"}),m.createElement("span",{className:"summary-secondary-text"},e.issueMessage)))))}_toggleExpandIssues(){this._actionsCreator.toggleExpandIssues()}_renderActiveReleaseEnvironmentsChain(e){let t={cssClass:"deployments-rel-env-chain",environments:e.environments,releaseEnvironmentNodeCss:"deployments-rel-env-node",definitionEnvironmentCurrentReleaseMap:this._createMap(e.environments),releaseId:e.id,definitionId:e.rdId,envNodeWidth:this._envChainWidth,projectId:e.projectId,onExpandClick:e=>{}};return m.createElement(S.EnvironmentsChain,Object.assign({},t))}_createMap(e){let t={};return e?(e.map((e=>{t[e.definitionEnvironmentId]=e.releaseId})),t):t}_getClassNameByDeploymentStatus(e){switch(e){case b.Failed:return"failed";case b.InProgress:return"inprogress";case b.PartiallySucceeded:return"partiallysucceeded";case b.Succeeded:return"succeeded";default:return""}}}t[e].DeploymentsComponent=s}("DeploymentComponent"),function(e){A=t[e]={};class s extends l.VssComponent{constructor(e,t){super(e,t),this._onChange=()=>{this.forceUpdate()},this._onStoreChanged=()=>{let e=this._store.getState(),t=e.succeededDeploymentsCount+e.inProgressDeploymentsCount+e.failedDeploymentsCount+e.partiallySucceededCount;this.setState({deploymentsCount:t})},this._actions=new f.DeploymentsComponentActions,this._initializeFlux(),this._initializeSignalRHub(this.props.build)}render(){let e={store:this._store,actionsCreator:this._actionsCreator,signalRHub:this._signalRHub};return m.createElement(i,Object.assign({},e))}componentDidMount(){this._store.addChangedListener(this._onStoreChanged),this._actions.setDeploymentsData.addListener(this._onChange),this.trackPromise(this._actionsCreator.initializeData(this.props.build))}componentWillUnmount(){this._actions.setDeploymentsData.removeListener(this._onChange),this._store.removeChangedListener(this._onStoreChanged),this._store.dispose()}_initializeFlux(){this._deploymentsSignalRActionHub=new I.DeploymentsSignalRActionHub,this._deploymentsSignalRActionCreator=new I.DeploymentsSignalRActionCreator({actionHub:this._deploymentsSignalRActionHub}),this._signalRStore=new x.SignalRStore({actionCreator:this._deploymentsSignalRActionCreator}),this._store=new E.DeploymentsComponentStore(this._actions,this._signalRStore);let e=new L.DeploymentsSource(this.context.pageContext);this._actionsCreator=new N.DeploymentsComponentActionsCreator(this._actions,e),this.state={deploymentsCount:0}}_initializeSignalRHub(e){const t=this.context.pageContext.getService("IVssPageService");let s=this.context.pageContext.getService("IVssContributionService").getData("ms.vss-releaseManagement-web.rm-signalr-data-provider-new");const n=t.getData();if(n&&s&&s.connectionUrl){const t=n.hostId,i=n.isHosted;this._signalRHub=new w.DeploymentsSignalRHub({actionCreator:this._deploymentsSignalRActionCreator,hostInformation:{hostId:t,isHosted:i,hostPath:s.connectionUrl.split("_apis")[0],projectId:e.project.id},pageContext:this.context.pageContext,projectId:e.project.id})}}}t[e].DeploymentsTabLauncher=s;const n=[{columnLayout:2,id:"name",name:b.ColumnName,readonly:!0,renderCell:function(e,t,s,n){return m.createElement(v.SimpleTableCell,{className:"bolt-table-cell-primary",columnIndex:t,contentClassName:"text-ellipsis body-m",key:t,tableColumn:s},m.createElement(c.FPSLink,{href:n.rdUrl,className:"defintion-name",telemetrySource:"deployments-summary-view-definition-link"},n.rdName),m.createElement("span",null,"/"),m.createElement(c.FPSLink,{href:n.releaseUrl,className:"release-name",supportsFPS:!1,telemetrySource:"deployments-summary-view-release-link"},n.releaseName))},width:-40},{id:"stages",name:"",readonly:!0,renderCell:function(e,t,s,n){return m.createElement(v.SimpleTableCell,{className:"bolt-table-cell-primary",columnIndex:t,contentClassName:"text-ellipsis body-m",key:t,tableColumn:s},function(e){const t=e=>{let t={};return e?(e.map((e=>{t[e.definitionEnvironmentId]=e.releaseId})),t):t};let s={cssClass:"deployments-rel-env-chain flex-row",environments:e.environments,releaseEnvironmentNodeCss:"deployments-rel-env-node",definitionEnvironmentCurrentReleaseMap:t(e.environments),releaseId:e.id,definitionId:e.rdId,envNodeWidth:96,projectId:e.projectId,onExpandClick:e=>{}};return m.createElement(S.EnvironmentsChain,Object.assign({},s))}(n))},width:-60}];class i extends l.VssComponent{constructor(e,t){super(e,t),this._onStoreChanged=()=>{this.setState(this.props.store.getState()),this._items=new _.ArrayItemProvider(this.state.deployments.map(this._getTableItem)),this._attachSignalRListener()},this._getTableItem=e=>e,this.state=e.store.getState(),this._items=new _.ArrayItemProvider(this.state.deployments.map(this._getTableItem))}render(){return m.createElement(C.Card,{className:"flex-grow bolt-table-card",contentProps:{contentPadding:!1}},m.createElement(v.Table,{columns:n,ariaLabel:b.AriaReleasesTable,itemProvider:this._items,role:"table",tableBreakpoints:[{breakpoint:1,columnWidths:[-100,0]},{breakpoint:600,columnWidths:[-100,0]}]}))}componentDidMount(){this.props.store.addChangedListener(this._onStoreChanged),this._attachSignalRListener()}componentWillUnmount(){this.props.store.removeChangedListener(this._onStoreChanged),this.props.store.dispose()}_attachSignalRListener(){this.state.deployments.forEach((e=>{let t=e.environments.filter((e=>{if(8!=e.status&&128!=e.status&&16!=e.status&&4!=e.status)return e}));const s=this.props.signalRHub;s&&(t.length>0?s.watchRelease(e.projectId,e.id):s.stopWatchingRelease(e.projectId,e.id))}))}}}("DeploymentsTab"),function(e){t[e]={};class s extends R.VssService{constructor(){super(...arguments),this._showTab=async()=>{if(!this._contextualData)return;if(2!==this._contextualData.status.value)return;if(this._tabs.value.length>0)return;const e=this._contextualData.projectId.value,t=this.pageContext.getRestClient("IBuildRestClient"),s=await t.getBuild(e,this._contextualData.runId.value);if(2!==s.result&&4!==s.result)return;const n=this.pageContext.getService("IVssContributionService");await n.getContributionAsync("ms.vss-releaseManagement-web.deployments-tab-for-pipeline-loader");0!==(await this._releaseDefinitionProvider.getReleaseDefinitionsByBuild(e,this._contextualData.pipelineId.value)).length&&(this._tab.render=()=>m.createElement("div",null,m.createElement(A.DeploymentsTabLauncher,{build:s})),this._tabs.push(this._tab))},this._tabs=new D.ObservableArray,this._tab={id:"ms.vss-releaseManagement-web.deployments-tab",name:b.Releases,order:3}}_serviceStart(e){super._serviceStart(e),this._releaseDefinitionProvider=e.getService("IBuildReleaseDefinitionProvider")}getTabs(e,t){return t&&(this._contextualData=t,this._showTab(),this._contextualData.notifyUpdated.subscribe(this._showTab)),this._tabs}_serviceEnd(e){this._contextualData.notifyUpdated.unsubscribe(this._showTab)}}t[e].DeploymentsTabProviderService=s,R.Services.add("deployments-tab-provider-service",{serviceFactory:s})}("DeploymentsTabProviderService"),function(e){t[e]={};class s extends l.VssComponent{constructor(e,t){super(e,t),this._onStoreChanged=()=>{let e=this._store.getState(),t=e.succeededDeploymentsCount+e.inProgressDeploymentsCount+e.failedDeploymentsCount+e.partiallySucceededCount;this.setState({deploymentsCount:t})},this._initializeSnapshot=(e,t)=>{this._initializeSignalRHub(e);this.context.pageContext.getService("IVssPerformanceService").startScenario("ReleaseManagement.DeploymentsSection.Load",!1),this._actionsCreator.initializeData(e).then((()=>{t(new Date)}))},this._initializeFlux()}render(){let e={store:this._store,actionsCreator:this._actionsCreator,signalRHub:this._signalRHub};return m.createElement(n,{className:"build-sample-snapshot",snapshotKey:this.props.snapshotKey,iconProps:{name:"Rocket",type:0},statusIconProps:this.state.deploymentsCount,initializeSnapshot:this._initializeSnapshot,ref:this.props.snapshotRef},m.createElement(U.DeploymentsComponent,Object.assign({},e)))}componentDidMount(){this._store.addChangedListener(this._onStoreChanged)}componentWillUnmount(){this._store.removeChangedListener(this._onStoreChanged),this._store.dispose()}_initializeFlux(){this._deploymentsSignalRActionHub=new I.DeploymentsSignalRActionHub,this._deploymentsSignalRActionCreator=new I.DeploymentsSignalRActionCreator({actionHub:this._deploymentsSignalRActionHub}),this._signalRStore=new x.SignalRStore({actionCreator:this._deploymentsSignalRActionCreator});const e=new f.DeploymentsComponentActions;this._store=new E.DeploymentsComponentStore(e,this._signalRStore);let t=new L.DeploymentsSource(this.context.pageContext);this._actionsCreator=new N.DeploymentsComponentActionsCreator(e,t),this.state={deploymentsCount:0}}_initializeSignalRHub(e){const t=this.context.pageContext.getService("IVssPageService");let s=this.context.pageContext.getService("IVssContributionService").getData("ms.vss-releaseManagement-web.rm-signalr-data-provider-new");const n=t.getData();if(n&&s&&s.connectionUrl){const t=n.hostId,i=n.isHosted;this._signalRHub=new w.DeploymentsSignalRHub({actionCreator:this._deploymentsSignalRActionCreator,hostInformation:{hostId:t,isHosted:i,hostPath:s.connectionUrl.split("_apis")[0],projectId:e.project.id},pageContext:this.context.pageContext,projectId:e.project.id})}}}t[e].SnapshotSample=s;class n extends l.VssComponent{render(){return m.createElement("div",null,"Note! This is just a holder, this text would never show up!")}}l.Components.add("buildTimelineDeploymentsView",s)}("Timeline")}),["Resources","Actions/DeploymentsComponentActions","Actions/SignalR","Stores/SignalR","SignalRHub","Stores/DeploymentsComponentStore","DeploymentsSource","Actions/DeploymentsComponentActionsCreator","DeploymentComponent","DeploymentsTab","DeploymentsTabProviderService","Timeline"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-releaseManagement-web.deploymentsSection"}}));
"use strict";define("DistributedTask/Subscriptions",["require","exports","react","VSSUI/Button","VSSUI/MessageBar","VSSUI/RadioButton","VSSUI/Spinner","VSSUI/Util","VSS/Core/Util/String","VSSUI/Dropdown","VSSUI/Utilities/DropdownSelection","VSS/Platform/Util/Url","VSS/Platform/Feature"],(function(i,t,e,s,r,n,o,a,c,u,p,d,b){var l,S,h,m,g;l=t[g="Resources"]={},t[g].NewAzureSubscription="New Azure subscription",t[g].NewAzureSubscriptionAriaLabel="Redirect to create a new azure subscription",t[g].NoAzureSubscriptionsMessage="You donâ€™t appear to have an active Azure subscription.",t[g].SubscriptionPickerTitle="Subscription",t[g].LoadingSubscriptions="Loading subscriptions ...",t[g].CannotSetOrganizationSubscription="Failed to set organization subscription.",t[g].FailedSetNoSubscriptionFound="The selected subscription was not found.",t[g].FailedSetSubscriptionInvalid="The selected subscription is not a valid subscription to be linked to the organization.",t[g].ValidatingSubscription="Validating subscription ...",t[g].WaitingToValidate="Waiting for subscription to validate ...",t[g].SubscriptionValid="Subscription is valid",t[g].SubscriptionInvalid="Subscription is not valid",t[g].SubscriptionCannotBeUsedForPurchases="This subscription cannot be used for purchases.",t[g].SubscriptionHasSpendingLimit="This subscription has a spending limit and cannot be used for purchases.",t[g].NeedsToBeAdminOrCoAdminOnSubscription="Requestor must be a service admin or service co-admin on the subscription which is required to be used for purchases",t[g].SubscriptionNotAvailableInRegion="This subscription is not valid for Azure DevOps organizations in this organization's current region.",t[g].SubscriptionNeedsCreditCard="This subscription cannot be used because it does not have a credit card on file.",t[g].SubscriptionNoLongerActive="This subscription is no longer active.",t[g].SubscriptionDeprecatedBilling="This subscription is on a deprecated billing system and cannot be used for purchases.",t[g].SubscriptionThroughCloudSolutionProvider="This subscription was created through the Cloud Solution Provider program and cannot be used for purchases.",t[g].SubscriptionTempSpendingLimit="This subscription has a temporary spending limit for this billing cycle. A subscription with a spending limit cannot be used for purchases.",function(i){S=t[i]={};t[i].Subscription=class{constructor(i,t){this.internalSubscriptionAccount=i,this.internalHasBeenValidated=!!t}get id(){return this.subscriptionAccount.subscriptionId}get displayName(){return this.subscriptionAccount.subscriptionName}get isUsable(){return!this.hasBeenValidated||void 0===this.invalidReason}get hasBeenValidated(){return this.internalHasBeenValidated}get invalidReason(){switch(this.internalSubscriptionAccount.failedPurchaseReason){case 0:return;case 1:return l.SubscriptionHasSpendingLimit;case 3:case 10:return l.NeedsToBeAdminOrCoAdminOnSubscription;case 6:return l.SubscriptionNotAvailableInRegion;case 5:return l.SubscriptionNeedsCreditCard;case 8:return l.SubscriptionNoLongerActive;case 7:return l.SubscriptionDeprecatedBilling;case 11:return l.SubscriptionThroughCloudSolutionProvider;case 12:return l.SubscriptionTempSpendingLimit;default:return l.SubscriptionCannotBeUsedForPurchases}}get subscriptionAccount(){return Object.assign({},this.internalSubscriptionAccount)}}}("ModelsSubscription"),function(i){h=t[i]={};class d extends e.Component{constructor(i,t){super(i,t),this.mounted=!1,this.onCreateSubscriptionButtonClick=()=>{const{createSubscriptionReplyTo:i,createSubscriptionReplyToQueryParams:t}=this.props,{redirectToCreateSubscription:e}=this.props.subscriptionContext.actions;e(i,t)},this.onChoiceGroupChange=async i=>{const{subscriptionIdToSubscription:t}=this.props.subscriptionContext.state;this.props.onSubscriptionChoiceChanged(t[i])},this._subscriptionDropdownSelection=new p.DropdownSelection,this.state={}}get selectedSubscriptionId(){const{selectedSubscriptionId:i,defaultOrganizationLinkedSubscription:t}=this.props,{organizationSubscription:e}=this.props.subscriptionContext.state;return i||(t&&e?e.id:"noneselected")}static getDerivedStateFromProps(i,t){const{selectedSubscriptionId:e,validateSubscriptionChoices:s}=i,{currentlySubscriptionId:r}=t;if(e!==r){return{currentlySubscriptionId:e,selectedSubscroptionIsValidPromise:s?d.getValidateSubscriptionPromise(i):void 0,selectedSubscriptionIsValid:void 0}}return null}static getValidateSubscriptionPromise(i){const{organizationSubscription:t}=i.subscriptionContext.state,{hostId:e,selectedSubscriptionId:s}=i,{validateSubscription:r}=i.subscriptionContext.actions;if(!s||t&&s===t.id)return Promise.resolve(!0);{const i=this.subscriptionIdToIsValidPromise[s]||r(s,e);return this.subscriptionIdToIsValidPromise[s]=i,i}}async componentDidUpdate(){if(this.props.useDropdown&&this.props.selectedSubscriptionId){const i=this._subscriptionDropdownSelection.value[0],t=i&&i.beginIndex,e=(this.props.subscriptionContext.state.subscriptions||[]).map((i=>i.id)).indexOf(this.props.selectedSubscriptionId);e!==t&&e>=0&&this._subscriptionDropdownSelection.select(e)}const{selectedSubscroptionIsValidPromise:i,currentlySubscriptionId:t}=this.state,{subscriptionIdToSubscription:e}=this.props.subscriptionContext.state;if(t&&i){this.setState({selectedSubscroptionIsValidPromise:void 0});const e=await i;this.props.onSubscriptionValidated&&this.props.onSubscriptionValidated(t,e),this.mounted&&this.setState((i=>i.currentlySubscriptionId===this.state.currentlySubscriptionId?{selectedSubscriptionIsValid:e}:null))}}componentDidMount(){this.mounted=!0,this.componentDidUpdate()}componentWillUnmount(){this.mounted=!1}render(){const{className:i}=this.props;return e.createElement("div",{className:(0,a.css)("flex-column flex-noshrink",i)},this.renderSubscriptionChoiceGroup(),this.renderCreateSubscriptionButton())}renderSubscriptionChoiceGroup(){const{loadedAllSubscriptions:i,subscriptions:t}=this.props.subscriptionContext.state,{label:s,titleClassName:r}=this.props;if(i&&t){if(0===t.length)return e.createElement("div",{className:(0,a.css)(this.props.useDropdown?"subscription-picker-dropdown-title bolt-formitem-label body-m":"bolt-formitem-label body-m",r)},l.NoAzureSubscriptionsMessage);{const{subscriptionIdToSubscription:i}=this.props.subscriptionContext.state;i[this.state.currentlySubscriptionId];return e.createElement(e.Fragment,null,e.createElement("div",{className:(0,a.css)(this.props.useDropdown?"subscription-picker-dropdown-title":"",r)},s||l.SubscriptionPickerTitle),this.props.useDropdown?e.createElement("div",{className:"subscription-picker-dropdown-holder"},e.createElement(u.Dropdown,{ariaLabel:s||l.SubscriptionPickerTitle,className:(0,a.css)("subscription-picker-dropdown",this.props.dropdownClassName),calloutContentClassName:(0,a.css)("subscription-picker-dropdown-callout",this.props.dropdownCalloutClassName),actions:[{text:l.NewAzureSubscription,ariaLabel:l.NewAzureSubscription,iconProps:{iconName:"Add"},onClick:this.onCreateSubscriptionButtonClick}],selection:this._subscriptionDropdownSelection,items:t.filter((i=>i.isUsable)).map((i=>{const t=(0,c.localeFormat)("{0} ({1})",i.displayName,i.id);return i&&{id:i.id,text:t,tooltipText:t,data:i}})),onSelect:(i,t)=>{this.props.onSubscriptionChoiceChanged(t.data)},filterThrottleWait:200})):e.createElement("div",{className:"flex-column flex-noshrink"},e.createElement("div",{className:"subscription-picker-choiceGroupContainer"},e.createElement(n.RadioButtonGroup,{selectedButtonId:this.selectedSubscriptionId,onSelect:this.onChoiceGroupChange},t.map((i=>{const{id:t,isUsable:s,displayName:r}=i,o=`subscription-picker-${t}`;return e.createElement(n.RadioButton,{className:"subscription-picker-radiobutton body-m",id:t,key:`radioButton-${t}-key`,ariaLabelledBy:o,disabled:!s||this.props.disabled},e.createElement("div",{className:"bolt-radio-button-label subscription-picker-radiobutton-section",id:o},r,e.createElement("span",{className:"subscription-picker-radiobuttonsublabel body-s"},t)))})))),this.renderValidationMessageBar()))}}return e.createElement("div",{className:"subscription-picker-spinner"},e.createElement(o.Spinner,{ariaLive:"assertive",label:l.LoadingSubscriptions,size:"medium"}))}renderValidationMessageBar(){const{validateSubscriptionChoices:i}=this.props,{selectedSubscriptionIsValid:t}=this.state,{subscriptionIdToSubscription:s}=this.props.subscriptionContext.state;if(!i)return null;const n=this.selectedSubscriptionId&&s?s[this.selectedSubscriptionId]:void 0,o={};let a=!1,c="";return n?void 0===t?(a=!0,o.severity="Info",c=l.ValidatingSubscription):t?(o.severity="Success",c=l.SubscriptionValid):(o.severity="Error",c=l.SubscriptionInvalid+". "+n.invalidReason):(o.severity="Info",c=l.WaitingToValidate),e.createElement("div",{className:"subscription-picker-messageBarContainer"},e.createElement(r.MessageBar,Object.assign({},o),this.renderMessageBarContent(c,a)))}renderMessageBarContent(i,t){return e.createElement("div",{className:"subscription-picker-messageBarContent flex-row flex-noshrink"},t&&e.createElement(o.Spinner,{ariaLive:"assertive",label:i,size:"small"}))}renderCreateSubscriptionButton(){if(!this.props.showCreateButtonForNoSubscriptions&&!this.props.showCreateSubscriptionButton)return;const{loadedAllSubscriptions:i,subscriptions:t}=this.props.subscriptionContext.state;return!this.props.showCreateButtonForNoSubscriptions||i&&t&&t.length?e.createElement("div",{className:"subscription-picker-create-button-container"},e.createElement(s.Button,{primary:!0,ariaLabel:l.NewAzureSubscriptionAriaLabel,text:l.NewAzureSubscription,onClick:this.onCreateSubscriptionButtonClick,iconProps:{iconName:"Add"}})):void 0}}t[i].SubscriptionPicker=d,d.subscriptionIdToIsValidPromise={}}("ComponentsSubscriptionPicker"),function(i){m=t[i]={};const s=e.createContext(void 0);class r extends e.Component{constructor(i){super(i),this.getInitPromise=async()=>({allSubscriptions:await this.getSubscriptions(),organizationSubscription:await this.getOrganizationSubscription()}),this.validateSubscription=async(i,t)=>{const e=await this.props.validateSubscription(i,t);return!!e&&(this.setState((t=>{if(t.subscriptions){return{subscriptions:[].concat(t.subscriptions.map((t=>t.id===i&&e?new S.Subscription(Object.assign(Object.assign({},t.subscriptionAccount),{failedPurchaseReason:e.failedPurchaseReason}),!0):t)))}}return{}})),new S.Subscription(e,!0).isUsable)},this.getSubscriptions=async()=>(await this.props.getSubscriptions()).map((i=>new S.Subscription(i))),this.getOrganizationSubscription=async()=>{const i=await this.props.getOrganizationSubscription();if(i)return new S.Subscription(i)},this.redirectToCreateSubscription=(i,t={})=>{const{redirectToCreateSubscription:e}=this.props;return e(i,t,(0,b.isFeatureFlagEnabled)(this.props.pageContext,"DistributedTask.EnableProductionAddNewSubscriptionUrl",!1))},this.state={loadedAllSubscriptions:!1},this.initPromise=this.getInitPromise()}static subscriptionsToDictionary(i=[]){const t={};return i.forEach((i=>t[i.id]=i)),t}async componentDidMount(){this.mounted=!0;const i=await this.initPromise;this.mounted&&this.setState({subscriptions:i.allSubscriptions,organizationSubscription:i.organizationSubscription,loadedAllSubscriptions:!0})}componentWillUnmount(){this.mounted=!1}render(){return e.createElement(s.Provider,{value:{actions:{redirectToCreateSubscription:this.redirectToCreateSubscription,validateSubscription:this.validateSubscription},state:Object.assign(Object.assign({},this.state),{subscriptionIdToSubscription:r.subscriptionsToDictionary(this.state.subscriptions)})}},this.props.children)}}class n extends e.Component{constructor(i){super(i),this.validateSubscription=async(i,t)=>{const e=t||this.pageData&&this.pageData.hostId,s=this.props.pageContext.getService("IVssContributionService");await new Promise((i=>setTimeout(i,3e3)));return await s.getDataAsync("ms.vss-distributedtask-web.dt-validate-subscription-data-provider",{orgId:e,subscriptionId:i},!0)},this.getOrganizationSubscription=async i=>{const t=i||this.pageData&&this.pageData.hostId;return this.props.pageContext.getService("IVssContributionService").getDataAsync("ms.vss-distributedtask-web.dt-get-host-subscription-data-provider",{orgId:t},!0)},this.getSubscriptions=async()=>{const i=this.props.pageContext.getService("IVssContributionService");let t=await i.getDataAsync("ms.vss-distributedtask-web.dt-get-subscriptions-data-provider",{},!0);return t&&(t=t.sort(((i,t)=>i.subscriptionName>t.subscriptionName?1:-1))),t||[]},this.pageData=i.pageContext.getService("IVssPageService").getData()}render(){return e.createElement(r,Object.assign({},this.props,{getSubscriptions:this.getSubscriptions,getOrganizationSubscription:this.getOrganizationSubscription,redirectToCreateSubscription:this.redirectToCreateSubscription,validateSubscription:this.validateSubscription}))}redirectToCreateSubscription(i,t={},e=!1){const s=new d.Uri(i||window.location.href);i||s.addQueryParams(t);let r=new d.Uri("https://account-staging.azure.com/signup");e&&(r=new d.Uri("https://account.azure.com/signup")),r.addQueryParam("appId","101",!0),r.addQueryParam("offer","MS-AZR-0003P",!0),r.addQueryParam("recommend","0",!0),r.addQueryParam("noPrompt","true",!0),r.addQueryParam("redirectURL",encodeURI(s.absoluteUri),!0),window.location.href=r.absoluteUri}}t[i].SubscriptionProvider=n,t[i].SubscriptionConsumer=s.Consumer}("ContextsSubscriptionContext"),function(i){t[i]={},Object.defineProperty(t[i],"SubscriptionPicker",{enumerable:!0,get:function(){return h.SubscriptionPicker}}),__exportStar(S,t[i]),__exportStar(m,t[i])}("SubscriptionPicker")}),["Resources","Models/Subscription","Components/SubscriptionPicker","Contexts/SubscriptionContext","SubscriptionPicker"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-distributedtask-web.subscription-picker"}}));
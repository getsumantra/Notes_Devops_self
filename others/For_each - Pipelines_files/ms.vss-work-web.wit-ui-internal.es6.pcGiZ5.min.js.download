"use strict";define("Wit/UI",["require","exports","VSS/Platform/FPS","VSS/Platform/Context","VSS/Core/Observable","Wit/Common/Constants/CustomerInteligence"],(function(e,t,s,o,r,a){var c,i,n,d,m;t[m="BehaviorsTitleClickFPS"]={},t[m].createTitleClickFpsHandler=function(e){return(t,o)=>{const r=o._links&&o._links.html&&o._links.html.href;return!(t.ctrlKey||t.metaKey||!e||!r||!(0,s.onClickFPS)(e,r,!0))}},function(e){c=t[e]={},t[e].WorkItemStateColorMetadataServiceId="work-item-state-color-metadata-service",t[e].WorkItemStatesColorDataProviderId="ms.vss-work-web.work-item-states-color-data-provider";class s extends o.VssService{constructor(){super(...arguments),this._cachedWorkItemStatesPromises={},this._cachedStateAndColors={}}_serviceStart(s){super._serviceStart(s);const o=s.getService("IVssContributionService").getData(t[e].WorkItemStatesColorDataProviderId),r=s.getService("ITfsPageService").getData();let a="";r&&r.project&&(a=r.project.name),a&&o&&this.setProjectWorkItemTypesData(a,o)}getWorkItemStateColor(e,t,s){if(!t||!s)return{name:"",fill:void 0};const o=this.getProjectWorkItemTypeKey(e,t),r=this.getNormalizedString(s),a={name:s};if(this._cachedStateAndColors[o])return this._cachedStateAndColors[o][r]||a;if(!this._cachedWorkItemStatesPromises[o]){const s=this.pageContext.getRestClient("IWorkItemTrackingRestClient");this._cachedWorkItemStatesPromises[o]=s.getWorkItemTypeStates(e,t)}return this._cachedWorkItemStatesPromises[o].then((e=>(this.setProjectWorkItemTypeData(o,e),delete this._cachedWorkItemStatesPromises[o],this._cachedStateAndColors[o][r]||(this._cachedStateAndColors[o][r]=a),this._cachedStateAndColors[o][r]))).catch((()=>(void 0===this._cachedStateAndColors[o]&&(this._cachedStateAndColors[o]={}),this._cachedStateAndColors[o][r]||(this._cachedStateAndColors[o][r]=a),this._cachedStateAndColors[o][r])))}setProjectWorkItemTypesData(e,t){for(const s in t){const o=this.getProjectWorkItemTypeKey(e,s);this.setProjectWorkItemTypeData(o,t[s])}}setProjectWorkItemTypeData(e,t){this._cachedStateAndColors[e]={};for(const s of t){const t=this.getNormalizedString(s.name),o=this.getNormalizedString(s.color);this._cachedStateAndColors[e][t]=this.parseStateColor(s.name,o)}}parseStateColor(e,t){return{name:e,fill:t.substr(t.length-6)}}getProjectWorkItemTypeKey(e,t){const s=this.getNormalizedString(e),o=this.getNormalizedString(t);return this.getNormalizedString(`${s}_${o}`)}getNormalizedString(e){return(e=e||"").trim().toLocaleLowerCase()}}t[e].WorkItemStateColorMetadataService=s,o.Services.add(t[e].WorkItemStateColorMetadataServiceId,{serviceFactory:s})}("ServicesWorkItemStateColorMetadataService"),function(e){i=t[e]={},t[e].WorkItemTypeIconMetadataServiceId="work-item-type-icon-metadata-service",t[e].WorkItemTypeColorIconDataProviderId="ms.vss-work-web.work-item-type-color-icon-data-provider",t[e].getIconDataObservable=function(s,o,a){const c=new r.ObservableValue({color:"",icon:"",workItemTypeName:o,isDisabled:!1}),i=a.getService(t[e].WorkItemTypeIconMetadataServiceId).getWorkItemIcon(s,o);return i instanceof Promise?i.then((e=>{c.value=e})):c.value=i,c};class s extends o.VssService{constructor(){super(...arguments),this._cachedWorkItemTypePromises={},this._cachedColorAndIcons={}}_serviceStart(s){super._serviceStart(s);const o=s.getService("IVssContributionService"),r=s.getService("ITfsPageService").getData();let a="";if(r&&r.project&&(a=r.project.name),a){const s=o.getData(t[e].WorkItemTypeColorIconDataProviderId);if(s)for(const e of s){const s=this.getProjectWorkItemTypeKey(a,e.workItemTypeName);e.color=e.color||t.WorkItemTypeIcon.DEFAULT_WORKITEMTYPE_COLOR_AND_ICON.color,e.icon=e.icon||t.WorkItemTypeIcon.DEFAULT_WORKITEMTYPE_COLOR_AND_ICON.icon,this._cachedColorAndIcons[s]=e}}}getWorkItemIcon(e,s){if(!e||!s)return t.WorkItemTypeIcon.DEFAULT_WORKITEMTYPE_COLOR_AND_ICON;const o=this.getProjectWorkItemTypeKey(e,s),r=Object.assign(Object.assign({},t.WorkItemTypeIcon.DEFAULT_WORKITEMTYPE_COLOR_AND_ICON),{workItemTypeName:s});if(this._cachedColorAndIcons[o])return this._cachedColorAndIcons[o];if(!this._cachedWorkItemTypePromises[o]){const t=this.pageContext.getRestClient("IWorkItemTrackingRestClient");this._cachedWorkItemTypePromises[o]=t.getWorkItemType(e,s)}return this._cachedWorkItemTypePromises[o].then((e=>{const t={color:e.color,icon:e.icon&&e.icon.id,workItemTypeName:s,isDisabled:e.isDisabled};return this._cachedColorAndIcons[o]=t,delete this._cachedWorkItemTypePromises[o],this._cachedColorAndIcons[o]})).catch((()=>(this._cachedColorAndIcons[o]||(this._cachedColorAndIcons[o]=r),this._cachedColorAndIcons[o])))}getProjectWorkItemTypeKey(e,t){const s=this.getNormalizedString(e),o=this.getNormalizedString(t);return this.getNormalizedString(`${s}_${o}`)}getNormalizedString(e){return(e=e||"").trim().toLocaleLowerCase()}}t[e].WorkItemTypeIconMetadataService=s,o.Services.add(t[e].WorkItemTypeIconMetadataServiceId,{serviceFactory:s})}("ServicesWorkItemTypeIconMetadataService"),function(e){n=t[e]={};t[e].mapToOutcomeMetaData=e=>({id:e.testCaseId,outcomeDetails:e.outcome,completedDate:e.completedDate})}("TestCaseOutcomeTypes"),function(e){d=t[e]={},t[e].TestCaseLatestOutcomeMetadataServiceId="test-case-latest-outcome-metadata-service",t[e].TestCaseLatestOutcomeDataProviderId="ms.vss-work-web.test-case-latest-outcome-data-provider";class s extends o.VssService{constructor(){super(...arguments),this._projectName="",this._topParameter=500,this._cachedOutcomeAndDetails={},this._noResultsTestCaseIds=new Set}_serviceStart(e){super._serviceStart(e),this._telemetryService=e.getService("IVssTelemetryService");const t=e.getService("ITfsPageService").getData();t&&t.project&&(this._projectName=t.project.name)}async getLatestOutcome(o){var r,c,i,d;if(!o||0===o.length)return;const m=[];this._cachedOutcomeAndDetails[this._projectName]||(this._cachedOutcomeAndDetails[this._projectName]={});for(const e of o){this._cachedOutcomeAndDetails[this._projectName][e]||this._noResultsTestCaseIds.has(e)||m.push(e)}if(m.length>0){const o=this.pageContext.getService("IVssContributionService"),l={projectName:this._projectName,testCaseIds:m,top:this._topParameter};try{const h=await o.getDataAsync(t[e].TestCaseLatestOutcomeDataProviderId,l);if(h&&h.testResultsData&&h.testResultsData.length>0)for(const e of h.testResultsData){const t=(0,n.mapToOutcomeMetaData)(e);this._cachedOutcomeAndDetails[this._projectName][e.testCaseId]=t}if(h&&h.testCaseIdsWithNoResults&&h.testCaseIdsWithNoResults.length>0){this._noResultsTestCaseIds||(this._noResultsTestCaseIds=new Set);for(const e of h.testCaseIdsWithNoResults)this._noResultsTestCaseIds.add(e)}this._telemetryService.publishEvent(a.TestManagementCustomerIntelligenceArea,a.TestManagementCustomerIntelligenceFeature.TestedByTestCaseLinks,{projectName:this._projectName,requestedIds:m,fetchedCount:null!==(c=null===(r=null==h?void 0:h.testResultsData)||void 0===r?void 0:r.length)&&void 0!==c?c:0,noResultCount:null!==(d=null===(i=null==h?void 0:h.testCaseIdsWithNoResults)||void 0===i?void 0:i.length)&&void 0!==d?d:0,source:s.name})}catch(e){this._telemetryService.publishEvent(a.TestManagementCustomerIntelligenceArea,a.TestManagementCustomerIntelligenceFeature.ErrorLatestTestOutcomeInLinks,{projectName:this._projectName,requestedIds:m,errorMessage:e.message||e.toString(),source:s.name})}}const l=[];for(const e of o){const t=this._cachedOutcomeAndDetails[this._projectName][e];t&&l.push(t)}return l.length>0?l:void 0}}t[e].TestCaseLatestOutcomeMetadataService=s,o.Services.add(t[e].TestCaseLatestOutcomeMetadataServiceId,{serviceFactory:s})}("ServicesTestCaseLatestOutcomeMetadataService"),function(e){t[e]={},__exportStar(c,t[e]),__exportStar(i,t[e]),__exportStar(d,t[e])}("Servicesindex")}),["Behaviors/TitleClickFPS","Services/WorkItemStateColorMetadataService","Services/WorkItemTypeIconMetadataService","TestCaseOutcome.Types","Services/TestCaseLatestOutcomeMetadataService","Services/index"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-work-web.wit-ui-internal"}}));
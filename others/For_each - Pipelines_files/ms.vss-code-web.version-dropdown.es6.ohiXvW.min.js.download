"use strict";define("Repos/VersionDropdown",["require","exports","VSS/Platform/Context","VSS/Platform/RestClientBase","VSS/Platform/Util/Serialization","VSS/Core/Observable","Repos/Common/Util/Ref","Repos/Common/Util/Version","VSS/Core/Util/String","Favorites/Dropdown/ArtifactDropdownProvider","react","Repos/Common/VCViewModelDataProviderService","VSS/Platform/UserClaims","VSSUI/ListBox","VSSUI/Utilities/GroupedItemProvider","VSS/Platform/Feature","Favorites/Dropdown/ArtifactDropdown","VSS/Platform/Layout","VSSUI/Dropdown","VSSUI/Observer","VSSUI/Util","VSSUI/Utilities/DropdownSelection","VSSUI/FilterBarItem"],(function(e,t,i,s,r,o,a,n,c,h,l,d,p,u,v,g,m,f,y,T,S,b,I){var C,B,R,w,x,F;C=t[F="Resources"]={},t[F].PivotBranches="Branches",t[F].PivotTags="Tags",t[F].PivotCommits="Commits",t[F].MineBranches="Mine",t[F].AllBranches="All",t[F].TargetBranches="Targets",t[F].TagsNoItemsText="No tags in this repository",t[F].BranchesSearchTextPlaceholder="Filter branches",t[F].TagsSearchTextPlaceholder="Filter tags",t[F].CommitsSearchTextPlaceholder="Search commits",t[F].BranchesSearchNoResultsText="No branches matched '{0}'",t[F].TagsSearchNoResultsText="No tags matched '{0}'",t[F].CommitsSearchNoResultsText="No commits matched '{0}'",t[F].CommitsSearchMinimumCharactersError="Enter first 4 characters of a commit ID",t[F].CommitsSearchWrongCharactersError="Commit IDs must be hex digits (0-9 and a-f)",t[F].NewBranch="New branch",t[F].ClearSelection="Clear selection",t[F].DefaultBadge="Default",t[F].BranchAriaLabel="{0} Branch",t[F].TagAriaLabel="{0} Tag",t[F].CommitAriaLabel="{0} Commit",function(e){B=t[e]={};class o extends s.RestClientBase{constructor(e){super(e)}async getCommitsBatch(e,t,i,s,r,o){const a={$skip:s,$top:r,includeStatuses:o};return this.beginRequest({apiVersion:"5.0-preview.1",method:"POST",routeTemplate:"{project}/_apis/git/repositories/{repositoryId}/CommitsBatch",routeValues:{project:i,repositoryId:t},queryParams:a,body:e})}async getRefs(e,t,i,s,o,a,n,c,h,l,d,p){const u={filter:i,includeLinks:s,includeStatuses:o,includeMyBranches:a,latestStatusesOnly:n,peelTags:c,filterContains:h,$top:l,continuationToken:d,includeTargetBranches:p};return this.beginRequest({apiVersion:"5.0-preview.1",routeTemplate:"{project}/_apis/git/repositories/{repositoryId}/refs/{*filter}",routeValues:{project:t,repositoryId:e},queryParams:u,returnRawResponse:!0}).then((async e=>{const t=await e.text().then(r.deserializeVssJsonObject);return t.continuationToken=e.headers.get("x-ms-continuationtoken"),t}))}async createFavorite(e,t){return this.beginRequest({apiVersion:"5.0-preview.1",method:"POST",routeTemplate:"{project}/_apis/git/favorites/refs/{favoriteId}",routeValues:{project:t},body:e})}async deleteRefFavorite(e,t){return this.beginRequest({apiVersion:"5.0-preview.1",method:"DELETE",routeTemplate:"{project}/_apis/git/favorites/refs/{favoriteId}",routeValues:{project:e,favoriteId:t}})}async getRefFavorites(e,t,i){const s={repositoryId:t,identityId:i};return this.beginRequest({apiVersion:"5.0-preview.1",routeTemplate:"{project}/_apis/git/favorites/refs/{favoriteId}",routeValues:{project:e},queryParams:s})}async getRepository(e,t){return this.beginRequest({apiVersion:"5.0-preview.1",routeTemplate:"{project}/_apis/git/Repositories/{repositoryId}",routeValues:{project:t,repositoryId:e}})}}t[e].GitClientName="Repos.VersionDropdown.Git.IGitRestClient",t[e].getGitClient=function(i,s){return i.getRestClient(t[e].GitClientName,s)},i.RestClients.add(t[e].GitClientName,{factory:o,options:{resourceAreaId:"4e080c62-fa21-4fbc-8fef-2a10a2b38049",serviceInstanceType:"00025394-6065-48ca-87d9-7f5672854ef7"}})}("RestClientGit"),function(e){var i;R=t[e]={},function(e){e.artifactType="Microsoft.TeamFoundation.Git.GitRefFavorite",e.artifactScopeType="Repository"}(i=t[e].GitRefFavoriteArtifactConstants||(t[e].GitRefFavoriteArtifactConstants={}));class s extends o.ObservableArray{dispose(){}}function r(e){return{id:e.id.toString(),artifactId:(t=e.name,(0,n.getVersionString)({version:(0,a.refToBranchName)(t),versionOptions:0,versionType:0})),artifactName:(0,a.getFriendlyName)(e.name),artifactScope:{id:e.repositoryId,type:i.artifactScopeType},artifactType:i.artifactType};var t}t[e].GitRefFavoritesService=class{constructor(e,t,i){this.gitRestClient=e,this.canFavorites=t,this.projectId=i,this._favoritesCollection=new s([])}canUseFavorites(){return this.canFavorites}canFetchExtendedDetails(){return!1}async getFavorites(e,t,o){if(e!==i.artifactType)throw new Error(`Type ${e} not valid. GitRefFavoritesService only supports ${i.artifactType}.`);if(t!==i.artifactScopeType)throw new Error(`Scope ${t} not valid. GitRefFavoritesService only supports ${i.artifactScopeType}.`);return this._favoritesPromise||(this._favoritesPromise=this.gitRestClient.getRefFavorites(this.projectId,o)),this._favoritesPromise.then((e=>(this._favoritesCollection=new s(e.filter((e=>2===e.type)).map(r)),this._favoritesCollection)))}getCurrentFolderFavorites(){if(!this._favoritesPromise)throw new Error("Favorites not loading yet.");const e=new o.ReadyableObservableArray;return this._favoritesPromise.then((t=>{e.push(...t.filter((e=>1===e.type)).map((e=>e.name))),e.ready.value=!0})),e}async addFavorite(e){this._favoritesCollection.push(e);const t=await this.gitRestClient.createFavorite(function(e){return{id:e.id&&parseInt(e.id),name:(0,a.branchNameToRef)(e.artifactName),repositoryId:e.artifactScope.id,type:2}}(e),this.projectId);return e.id=t.id.toString(),e}async removeFavorite(e){this._favoritesCollection.removeAll((t=>t.id===e.id)),await this.gitRestClient.deleteRefFavorite(this.projectId,parseInt(e.id))}}}("GitRefFavoritesService"),function(e){t[e]={};const s=200;class r extends i.VssService{constructor(){super(...arguments),this.myBranchesByRepository={},this.myTargetBranchesByRepository={},this.branchesByRepository={},this.tagsByRepository={},this.refsByArea={heads:this.branchesByRepository,tags:this.tagsByRepository},this.branchesCacheListeners=[],this.tagsCacheListeners=[],this.searchBranches=(e,t,i,s,r)=>this.searchPagedRefs(e,t,i,"heads",s,r),this.searchTags=(e,t,i,s)=>this.searchPagedRefs(e,t,i,"tags",s)}flushBranchesCache(e){e?(delete this.branchesByRepository[e],delete this.myBranchesByRepository[e]):(this.branchesByRepository={},this.refsByArea.heads=this.branchesByRepository,this.myBranchesByRepository={})}getBranchByName(e,t,i){const r=(0,a.branchNameToRef)(i);let o=this.getMyBranches(e,t).value.filter((e=>(0,c.equals)(e.name,r,!1)))[0];return o||(o=this.getPagedBranches(e,t).items.value.filter((e=>(0,c.equals)(e.name,r,!1)))[0],o)?Promise.resolve(o):(0,B.getGitClient)(this.pageContext).getRefs(e,t,"heads/"+i,void 0,void 0,void 0,void 0,void 0,void 0,s).then((e=>e.filter((e=>(0,c.equals)(e.name,r,!1)))[0]))}getMyBranches(e,t){if(!this.myBranchesByRepository[e]){const i=new o.ReadyableObservableArray;this.myBranchesByRepository[e]=i,(0,B.getGitClient)(this.pageContext).getRefs(e,t,void 0,!1,!1,!0).then((e=>{i.value=e.filter((e=>(0,a.isBranch)(e.name))),i.ready.value=!0}))}return this.myBranchesByRepository[e]}getTargetBranches(e,t){if(!this.myTargetBranchesByRepository[e]){const i=new o.ReadyableObservableArray;this.myTargetBranchesByRepository[e]=i,(0,B.getGitClient)(this.pageContext).getRefs(e,t,void 0,!1,!1,!1,!1,!1,void 0,void 0,void 0,!0).then((e=>{i.value=e.filter((e=>(0,a.isBranch)(e.name))),i.ready.value=!0}))}return this.myTargetBranchesByRepository[e]}getPagedBranches(e,t){return this.getPagedRefs(e,t,"heads")}getMoreBranches(e,t,i){return this.getMoreRefs(e,t,i,"heads")}getTagByName(e,t,i){const r=(0,a.tagNameToRef)(i),o=this.getPagedTags(e,t).items.value.filter((e=>(0,c.equals)(e.name,r,!0)))[0];return o?Promise.resolve(o):(0,B.getGitClient)(this.pageContext).getRefs(e,t,"tags/"+i,void 0,void 0,void 0,void 0,void 0,void 0,s).then((e=>e.filter((e=>(0,c.equals)(e.name,r,!0)))[0]))}getPagedTags(e,t){return this.getPagedRefs(e,t,"tags")}getMoreTags(e,t,i){return this.getMoreRefs(e,t,i,"tags")}registerBranchesCacheListener(e){this.branchesCacheListeners.push(e)}unregisterBranchesCacheListener(e){const t=this.branchesCacheListeners.indexOf(e);t>=0&&this.branchesCacheListeners.slice(t,1)}registerTagsCacheListener(e){this.tagsCacheListeners.push(e)}unregisterTagsCacheListener(e){const t=this.tagsCacheListeners.indexOf(e);t>=0&&this.tagsCacheListeners.slice(t,1)}getCommitsById(e,t,i){if(!/^[0-9a-fA-F]+$/.test(i)){const e=new o.ReadyableObservableArray([]);return e.ready.value=!0,{continuationToken:null,items:e}}const s=i+"f".repeat(40-i.length),r=i+"0".repeat(40-i.length),a=new o.ReadyableObservableArray;return(0,B.getGitClient)(this.pageContext).getCommitsBatch({$top:100,fromCommitId:r,toCommitId:s},e,t).then((e=>{a.value=e,a.ready.value=!0})),{continuationToken:null,items:a}}getPagedRefs(e,t,i){let r=this.getCachedRefs(i,e);if(!r){const a=new o.ReadyableObservableArray;r={items:a};(0,B.getGitClient)(this.pageContext).getRefs(e,t,i,void 0,void 0,void 0,void 0,void 0,void 0,s).then((e=>{r.continuationToken=e.continuationToken,a.value=e,a.ready.value=!0})),this.cacheRefs(i,e,r)}return r}getMoreRefs(e,t,i,r){const a=this.getCachedRefs(r,e);if(!a)return this.getPagedRefs(e,t,r);if(!a.continuationToken||a.continuationToken!==i)return a;const n=new o.ReadyableObservableArray,c={items:n};return(0,B.getGitClient)(this.pageContext).getRefs(e,t,r,void 0,void 0,void 0,void 0,void 0,void 0,s,a.continuationToken).then((t=>{c.continuationToken=t.continuationToken,n.push(...t),n.ready.value=!0,this.cacheRefs(r,e,c)})),c}searchPagedRefs(e,t,i,r,a,n){const c=this.getCachedRefs(r,e);if(c){const e=c;if(!e.continuationToken){const t=e.items.value.filter((e=>-1!==e.name.toLowerCase().indexOf(i.toLowerCase()))),s=new o.ReadyableObservableArray(t);return s.ready.value=!0,{items:s}}}const h=new o.ReadyableObservableArray,l={items:h};let d,p=r.toString();return null!=n&&"startsWith"==n?p=p.concat("/",i):d=i,(0,B.getGitClient)(this.pageContext).getRefs(e,t,p,void 0,void 0,void 0,void 0,void 0,d,s,a,void 0).then((e=>{l.continuationToken=e.continuationToken,h.value=e,h.ready.value=!0})),l}getCachedRefs(e,t){return this.refsByArea[e][t]}cacheRefs(e,t,i){if(this.refsByArea[e][t]){const s=this.refsByArea[e][t],r=new o.ReadyableObservableArray([...s.items.value,...i.items.value]);r.ready.value=!0,this.refsByArea[e][t]={items:r,continuationToken:i.continuationToken}}else this.refsByArea[e][t]=i;this.refsByArea[e][t]=i}}const n="IGitRefService";t[e].getGitRefService=function(e){return e.getService(n)},i.Services.add(n,{serviceFactory:r})}("GitRefService"),function(e){w=t[e]={};class i extends h.ArtifactDropdownProviderBase{constructor(e,t,i,r,a,h,l){super(),this.pageContext=e,this.versionDropdownOptions=t,this.selection=i,this.searching=r,this.loading=a,this.renderAllBranchesPicker=h,this.onSelect=l,this.continuationTokens={},this.groupToPivotMap={},this.currentIdentityId="",this.commitsFilterText="",this.loadTargetBranchesNext=!1,this.setSearchLoading=(e,t,i)=>{this.setCommitLoading(e,t);const s=Object.keys(this.continuationTokens),r=this.pivots.find((e=>e.id===i));if(t&&e&&this.searchFunctionsByPivot[i||"branches"]){if(this.searching.value||(this.searching.value=!0),this.lastFilterText||s.forEach((e=>{if(this.continuationTokens[e]){const t=this.getItemsForGroup(e);t&&t.setGroupLoading(e,!1)}})),r){const t=1e3,s=this.lastFilterText!==e;this.debounceFunction((t=>{this.removeSearchLoadingItem(r);const s=r.items,o=this.getSearchLoadingItem(e,i,"");!this.isBranchSearchFFEnabled||"branches"!==i||"contains"===this.lastSearchType&&!t||"startsWith"===this.lastSearchType&&""===this.continuationTokens[i]?s.push(o):s.splice(1,0,o)}),t,s)}}else this.searching.value&&(this.searching.value=!1),this.timeout&&clearTimeout(this.timeout),r&&this.removeSearchLoadingItem(r),this.lastFilterText&&s.forEach((e=>{if(this.continuationTokens[e]){const t=this.getItemsForGroup(e);t&&t.setGroupLoading(e,!0,this.getLoadingItem(e))}}));this.lastPivot=i,this.lastFilterText=e},this.removeSearchLoadingItem=e=>{const t=e.items,i=t.value.findIndex((t=>t.id===this.getSearchLoadingItemId(e.id)));i>-1&&t.splice(i,1)},this.setCommitLoading=(e,t)=>{const i=this.pivots.find((e=>"commits"===e.id));i&&(this.commitsFilterText=e,e.length>0&&(this.commitsItemProvider.length&&(this.commitsItemProvider.removeAll(),this.forgetCachedArtifacts("commits")),e.length>3?(this.commitsItemProvider.setGroupLoading("found-commits",t,this.getLoadingItem("found-commits")),i.filteredNoResultsText.value=C.CommitsSearchNoResultsText):i.filteredNoResultsText.value=C.CommitsSearchMinimumCharactersError))},this.getDropdownItems=e=>{if(!e){const e=new o.ReadyableObservableArray;return e.ready.value=!0,e}const t=this.pageContext.getService("IVssPerformanceService").startScenario("branches-dropdown-get-dropdown-items",!1),i="all-branches"===e&&this.loadTargetBranchesNext,r=this.getVersions(e),a=new o.ReadyableObservableArray,n=()=>{this.continuationTokens[e]=r.continuationToken;const o=this.getItemsForGroup(e);o&&o.setGroupLoading(e,!1);const n=o=>{a.push(...r.items.value.map((t=>s(t,e,this.repository,this.currentIdentityId,o,i)))),a.ready.value=!0,t.addProperties({groupKey:e,count:a.length,hasMore:Boolean(r.continuationToken)}),t.complete()};if(this.viewMyBranches&&this.isAuthorizedUser()){const e=this.gitRefFavoritesService.getCurrentFolderFavorites();this.addObserver(e.ready,(t=>{t&&n(e.value)}))}else n([])};return r.items.ready.value?n():this.addObserver(r.items.ready,(e=>{e&&n()})),this.renderAllBranchesPicker&&a.push({friendlyName:"*",versionDescriptor:{version:"*",versionType:0,versionOptions:0},repositoryId:this.repository.id}),a},this.getClearAction=()=>this.versionDropdownOptions&&this.versionDropdownOptions.viewClearButton?e=>{this.selection&&this.selection.clear(),this.onSelect&&this.onSelect(e,null)}:void 0,this.getBranchesActions=()=>function(e,t,i,s,r){const o=[];e&&r&&o.push({text:C.NewBranch,iconProps:{iconName:"Add"},onClick:()=>e()});t&&o.push({text:C.ClearSelection,iconProps:{iconName:"Cancel"},disabled:i,onClick:t});s&&o.push(...s);return o}(this.versionDropdownOptions.onCreateBranchClick,this.getClearAction(),0===this.selection.selectedCount,this.versionDropdownOptions.otherBranchActions,this.isAuthorizedUser()),this.searchBranchRefs=(e,t)=>{var i;return this.isBranchSearchFFEnabled?(i=null==this.lastSearchType||"startsWith"==this.lastSearchType&&""!=t?"startsWith":"contains",this.lastSearchType=i,this.searchRefs(e,t,i,"all-branches",this.getGitRefService().searchBranches)):this.searchRefs(e,t,"contains","all-branches",this.getGitRefService().searchBranches)},this.searchTagRefs=(e,t,i)=>this.searchRefs(e,t,i,"all-tags",this.getGitRefService().searchTags),this.repository=t.repository?t.repository:(0,d.getGitRepository)(e);const p={artifactType:R.GitRefFavoriteArtifactConstants.artifactType,artifactScope:{id:this.repository.id,name:this.repository.name,type:R.GitRefFavoriteArtifactConstants.artifactScopeType}},u={0:"OpenSource",1:"Tag",2:"BranchCommit"},v=e=>(t,i)=>e(t&&t.trim(),i),T=new o.ReadyableObservableArray;T.ready.value=!0;const S=e=>this.reuseIfStrictlyStronger(e,y);this.searchFunctionsByPivot={branches:(e=>(t,i)=>this.isGroupFullyLoaded("all-branches")?{items:T}:e(t,i))(v(S(this.searchBranchRefs))),tags:(e=>(t,i)=>this.isGroupFullyLoaded("all-tags")?{items:T}:e(t,i))(v(S(this.searchTagRefs)))},this.viewMyBranches=void 0===t.viewMyBranches||!!t.viewMyBranches,this.viewTargetBranches=!(!(0,g.isFeatureFlagEnabled)(e,"Git.Server.TargetBranchRefs",!1)||void 0!==t.viewTargetBranches)||!!t.viewTargetBranches,this.viewTagsPivot=void 0===t.viewTagsPivot||!!t.viewTagsPivot,this.groupToPivotMap=function(){const e={default:"branches",favorites:"branches","target-branches":"branches","all-branches":"branches","all-tags":"tags","found-commits":"commits"};return e}();const b=this.createGroups(t,{"all-branches":!0,"all-tags":!0,"found-commits":!1});this.pivots=this.createPivots(t,b,this.groupToPivotMap);const I=this.pageContext.getService("IVssPageService").getData();I&&(this.currentIdentityId=I.user.id);const{id:B}=this.repository.project;this.gitRefFavoritesService=this.getGitRefFavoritesService(B,this.viewMyBranches),this.artifactPickerOptions={pageContext:e,favoritesContext:p,favoritesService:this.gitRefFavoritesService,getArtifacts:this.getDropdownItems,getArtifactId:e=>(0,n.getVersionString)(e.versionDescriptor),getArtifactName:e=>e.friendlyName,getArtifactIcon:e=>({iconName:u[e.versionDescriptor.versionType]}),getArtifactTextNode:f,getFavoriteFromArtifact:c,getArtifactListGroupId:m,groups:b,pivots:this.pivots,groupToPivotMap:this.groupToPivotMap,hideFavoriteSelectedItemIndicator:t.hideFavoriteSelectedItemIndicator},this.isBranchSearchFFEnabled=(0,g.isFeatureFlagEnabled)(e,"VisualStudio.Services.Repos.VersionDropdown.BranchSearchImprovements",!1),this.initialize(this.artifactPickerOptions),this.getGitRefService().registerBranchesCacheListener(this.forgetCachedArtifacts)}getPivots(){return this.pivots[0].actions=this.getBranchesActions(),this.pivots}dispose(){super.dispose(),this.getGitRefService().unregisterBranchesCacheListener(this.forgetCachedArtifacts)}updatePivot(e){if(this.lastPivot&&this.lastFilterText){const t=this.pivots.find((e=>e.id===this.lastPivot));if(t){const i=t.items,s=i.value.findIndex((t=>t.id===this.getSearchLoadingItemId(e)));s>-1&&i.splice(s,1)}this.setSearchLoading(this.lastFilterText,!0,e)}}getVersions(e){const t=this.continuationTokens[e],{id:i,project:{id:s}}=this.repository;if("found-commits"===e){const{id:e,project:{id:t}}=this.repository;return this.getGitRefService().getCommitsById(e,t,this.commitsFilterText)}const r=this.loadTargetBranchesNext;return this.loadTargetBranchesNext=!1,r?this.getTargetBranches():t?"all-tags"===e?this.getGitRefService().getMoreTags(i,s,t):this.getGitRefService().getMoreBranches(i,s,t):"all-tags"===e?this.getGitRefService().getPagedTags(i,s):("all-branches"===e&&this.viewTargetBranches&&(this.loadTargetBranchesNext=!0),"all-tags"===e?this.getGitRefService().getPagedTags(i,s):this.viewMyBranches?this.getMyBranches():this.getGitRefService().getPagedBranches(i,s))}getMyBranches(){const{id:e,project:{id:t}}=this.repository;return{items:this.getGitRefService().getMyBranches(e,t),continuationToken:"!"}}getTargetBranches(){const{id:e,project:{id:t}}=this.repository;return{items:this.getGitRefService().getTargetBranches(e,t),continuationToken:"!"}}getGitRefFavoritesService(e,t){const i=this.pageContext.getService("IFavoritesService"),s=(0,B.getGitClient)(this.pageContext);return new R.GitRefFavoritesService(s,t&&i.canUseFavorites(),e)}getGitRefService(){return this.pageContext.getService("IGitRefService")}getGroupsLoadingState(){return this.artifactPickerOptions&&this.artifactPickerOptions.groups?this.artifactPickerOptions.groups.reduce(((e,t)=>Object.assign(Object.assign({},e),{[t.id]:t.loading||this.continuationTokens[t.id]})),{}):{}}isGroupFullyLoaded(e){return!this.getGroupsLoadingState()[e]}createGroups({viewCommitsPivot:e},t){return[{id:"default",name:void 0},this.viewMyBranches&&{id:"favorites",name:C.MineBranches},this.viewTargetBranches&&{id:"target-branches",name:C.TargetBranches},{id:"all-branches",name:C.AllBranches,loading:t["all-branches"],loadingItem:this.getLoadingItem("all-branches")},this.viewTagsPivot&&{id:"all-tags",name:void 0,loading:t["all-tags"],loadingItem:this.getLoadingItem("all-tags")},e&&{id:"found-commits",name:void 0,loading:t["found-commits"],loadingItem:this.getLoadingItem("found-commits")}].filter(Boolean)}processLoadedItems(e,t){if(e){const i=[...t],s="mine-header",r="target-header",o="all-header";t.some((e=>"favorites"===e.groupId))&&!e.value.some((e=>e.id===s))&&i.push({id:s,type:2,text:C.MineBranches,groupId:"favorites"}),t.some((e=>"target-branches"===e.groupId))&&!e.value.some((e=>e.id===r))&&i.push({id:r,type:2,text:C.TargetBranches,groupId:"target-branches"}),t.some((e=>"all-branches"===e.groupId))&&!e.value.some((e=>e.id===o))&&i.push({id:o,type:2,text:C.AllBranches,groupId:"all-branches"}),e.push(...i)}}getLoadingItem(e){return{id:e+"-loading-item",groupId:e,type:4,render:(t,i,s,r)=>l.createElement(u.LoadingCell,{key:r.id,columnIndex:i,tableColumn:s,tableItem:r,onMount:()=>{this.loading.value||(this.loading.value=!0);const t=t=>{const i=this.getItemsForGroup(e);this.processLoadedItems(i,t),this.continuationTokens[e]&&i&&!this.lastFilterText?i.setGroupLoading(e,!0,this.getLoadingItem(e)):this.loading.value&&(this.loading.value=!1)},i=this.onGroupLoadRequest(e);if(i.ready.value)t(i.value);else{const e=e=>{e&&t(i.value)};this.addObserver(i.ready,e)}}})}}getSearchLoadingItemId(e){return e+"-search-loading-item"}getSearchLoadingItem(e,t,i){return{id:this.getSearchLoadingItemId(t),groupId:"tags"===t?"all-tags":"all-branches",type:4,render:(s,r,o,a)=>l.createElement(u.LoadingCell,{key:a.id,columnIndex:r,tableColumn:o,tableItem:a,onMount:()=>{const s=this.searchFunctionsByPivot[t||"branches"](e,i),r=()=>{const i=this.processResolvedArtifacts(s.items.value,t),r=this.pivots.find((e=>e.id===t));if(r){const o=r.items;this.processLoadedItems(o,i);const a=o.value.findIndex((e=>e.id===t+"-search-loading-item"));a>-1&&o.splice(a,1),this.isBranchSearchFFEnabled&&(s.continuationToken||"startsWith"===this.lastSearchType)?(s.continuationToken=s.continuationToken||"",o.push(this.getSearchLoadingItem(e,t,s.continuationToken))):s.continuationToken?o.push(this.getSearchLoadingItem(e,t,s.continuationToken)):this.searching.value=!1}};if(s.items.ready.value)r();else{const e=e=>{e&&r()};this.addObserver(s.items.ready,e)}}})}}getItemsForGroup(e){const t=this.pivots.findIndex((t=>t.id===this.groupToPivotMap[e]));if(t>-1)return this.pivots[t].items}createPivots(e,t,i){const s={id:"branches",name:C.PivotBranches,actions:this.getBranchesActions(),filterPlaceholderText:C.BranchesSearchTextPlaceholder,filteredNoResultsText:C.BranchesSearchNoResultsText,showFilterBox:!0,items:new v.GroupedItemProvider([],t.filter((e=>"branches"===i[e.id])))},r={id:"tags",name:C.PivotTags,actions:this.versionDropdownOptions.otherTagActions,filterPlaceholderText:C.TagsSearchTextPlaceholder,filteredNoResultsText:C.TagsSearchNoResultsText,noItemsText:C.TagsNoItemsText,showFilterBox:!0,items:new v.GroupedItemProvider([],t.filter((e=>"tags"===i[e.id])))};this.commitsItemProvider=new v.GroupedItemProvider([],t.filter((e=>"commits"===i[e.id])));const a={id:"commits",name:C.PivotCommits,filterByText:!1,filterPlaceholderText:C.CommitsSearchTextPlaceholder,filteredNoResultsText:new o.ObservableValue(C.CommitsSearchMinimumCharactersError),noItemsText:C.CommitsSearchMinimumCharactersError,showFilterBox:!0,items:this.commitsItemProvider};return[s,this.viewTagsPivot&&r,e.viewCommitsPivot&&a].filter(Boolean)}searchRefs(e,t,i,r,a){const n=this.pageContext.getService("IVssPerformanceService");n.startScenario("branches-dropdown-search-refs",!1),t||(t=this.continuationTokens[r]);const{id:c,project:{id:h}}=this.repository,l=()=>{p.push(...d.items.value.map((e=>s(e,r,this.repository,this.currentIdentityId,[])))),n.endScenario("Repos","branches-dropdown-search-refs",!1,void 0,{count:p.length,hasMore:Boolean(d.continuationToken)}),u.continuationToken=d.continuationToken,p.ready.value=!0},d=a(c,h,e,t,i),p=new o.ReadyableObservableArray,u={items:p,continuationToken:d.continuationToken};return d.items.ready.value?l():this.addObserver(d.items.ready,(e=>{e&&l()})),u}reuseIfStrictlyStronger(e,t){let i,s;return(r,o)=>{const a=()=>(i=r,s=e(r,o),s);if(this.isStrictlyStronger(r,i)){const e=e=>{e&&t(e,this.lastSearchType)||a()};return s.items.ready.value?e(s):this.addObserver(s.items.ready,(t=>{t&&e(s)})),s}return a()}}debounceFunction(e,t,...i){this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout((()=>{this.timeout=void 0,e.apply(null,i)}),t)}isStrictlyStronger(e,t){return Boolean(e&&t&&e.toLowerCase().indexOf(t.toLowerCase())>=0)}isAuthorizedUser(){return(0,p.userHasClaim)(this.pageContext,"member")}}function s(e,t,i,s,o,n=!1){if("found-commits"===t)return{friendlyName:a.getShortCommitId(e.commitId),versionDescriptor:{version:e.commitId,versionType:2,versionOptions:0},repositoryId:i.id};{const t=a.isTag(e.name),c=a.getFriendlyName(e.name);return{friendlyName:c,versionDescriptor:{version:c,versionType:t?1:0,versionOptions:0},isMine:e.creator&&e.creator.id===s,isDefault:e.name===i.defaultBranch,isTarget:n,isFavoritedByFolder:!t&&r(e.name,o),repositoryId:i.id}}}function r(e,t){return t.some((t=>e.startsWith(t+"/")))}function c(e){if(0===e.versionDescriptor.versionType&&!e.isDefault)return{artifactId:(0,n.getVersionString)(e.versionDescriptor),artifactName:e.friendlyName,artifactScope:{id:e.repositoryId,type:R.GitRefFavoriteArtifactConstants.artifactScopeType},artifactType:R.GitRefFavoriteArtifactConstants.artifactType}}function m(e){return 2===e.versionDescriptor.versionType?"found-commits":1===e.versionDescriptor.versionType?"all-tags":e.isDefault?"default":e.isMine||e.isFavoritedByFolder?"favorites":e.isTarget?"target-branches":"all-branches"}function f(e){const t=e.data;if(!t)return;const{prefix:i,lastName:s}=2===t.versionDescriptor.versionType?{lastName:e.text}:function(e){const t=e.lastIndexOf("/");return t>0?{prefix:e.substring(0,t+1),lastName:e.substring(t+1)}:{lastName:e}}(e.text||"");return l.createElement("span",null,i&&l.createElement("span",{className:"version-dropdown-prefix-name"},i),s,t.isDefault&&l.createElement("span",{className:"version-dropdown-default-badge"},C.DefaultBadge))}function y(e,t){return!e.continuationToken&&"startsWith"!==t}t[e].VersionDropdownProvider=i,t[e].getItemFromVersion=function(e,t){const i=2===e.versionType;let s=e.version;return i&&(s=a.getShortCommitId(s)),{versionDescriptor:e,friendlyName:s,isDefault:s===a.getFriendlyName(t.defaultBranch),repositoryId:t.id}}}("VersionDropdownProvider"),function(e){x=t[e]={};t[e].VersionDropdownExpandableButton=e=>{const{initiallySelectedItem:t,placeholder:i}=e,s=__rest(e,["initiallySelectedItem","placeholder"]);return l.createElement(y.DropdownExpandableButton,Object.assign({},s,{placeholder:e.initiallySelectedItem?void 0:i,subtle:!0}),e.initiallySelectedItem?(0,m.renderSelectedItem)(e.initiallySelectedItem):null)};t[e].VersionDropdownExpandableTextField=e=>{const{initiallySelectedItem:t,placeholder:i}=e,s=__rest(e,["initiallySelectedItem","placeholder"]);return l.createElement(y.DropdownExpandableTextField,Object.assign({},s,{placeholder:e.initiallySelectedItem?e.initiallySelectedItem.text:i,prefixIconProps:e.initiallySelectedItem&&0===e.selection.selectedCount?e.initiallySelectedItem.iconProps:void 0,renderSelectedItems:(e,t)=>t[e.value[0].beginIndex].text||""}))};class i extends f.VssComponent{constructor(e,t){super(e,t),this.selection=new b.DropdownSelection,this.hasMadeInitialSelection=!1,this.dropdown=l.createRef(),this.selectedPivot=new o.ObservableValue(""),this.searching=new o.ObservableValue(!1),this.loading=new o.ObservableValue(!1),this.resetSelection=()=>{const e=this.props.initiallySelectedVersion&&this.props.initiallySelectedVersion.version;if(this.provider.value.length>0&&e)for(let t=0;t<this.provider.value.length;t++)if(this.provider.value[t].data&&this.provider.value[t].data.versionDescriptor.version===e)return this.selection.select(t),void(this.hasMadeInitialSelection=!0)},this.onItemsUpdated=()=>(this.hasMadeInitialSelection||this.resetSelection(),!1),this.onFilterTextChanged=(e,t)=>{this.provider.setSearchLoading(t,null!==e,this.selectedPivot.value),this.props.onFilterTextChanged&&this.props.onFilterTextChanged(e,t)},this.onSelectedPivotUpdated=()=>{this.provider.updatePivot(this.selectedPivot.value)},this.provider=new w.VersionDropdownProvider(t.pageContext,e.providerOptions||{},this.selection,this.searching,this.loading,e.renderAllBranchesPicker,this.props.onSelect);let i=this.provider.getPivots()[0].id;e.initiallySelectedVersion&&(0===e.initiallySelectedVersion.versionType?i="branches":2===e.initiallySelectedVersion.versionType?i="commits":1===e.initiallySelectedVersion.versionType&&(i="tags")),this.selectedPivot.value=i}render(){const{autoFocus:e,className:t,focusTreatment:i,onSelect:s,initiallySelectedVersion:r,isDropdownFullWidth:o,placeholder:a,providerOptions:n,renderExpandable:c}=this.props;return l.createElement(T.Observer,{selection:this.selection,items:{observableValue:this.provider,filter:this.onItemsUpdated},selectedPivot:{observableValue:this.selectedPivot,filter:this.onSelectedPivotUpdated}},(()=>{var h;this.selection.value.length?this.provider.value[this.selection.value[0].beginIndex].text:null===(h=this.props.initiallySelectedVersion)||void 0===h||h.version;return l.createElement(m.ArtifactDropdown,{ref:this.dropdown,calloutContentClassName:(0,S.css)(!o&&"version-dropdown-callout"),className:(0,S.css)(t,"version-dropdown scroll-hidden"),items:this.provider,loading:this.loading,onFilterTextChanged:this.onFilterTextChanged,onSelect:s,pivots:this.provider.getPivots(),placeholder:a,searching:this.searching,selection:this.selection,selectedPivot:this.selectedPivot,showItemsWhileSearching:!0,startsWithSort:!!this.provider.isBranchSearchFFEnabled&&"branches"===this.selectedPivot.value,renderExpandable:t=>l.createElement(T.Observer,{selection:this.selection},(()=>{const s=Object.assign(Object.assign({},t),{autoFocus:e,focusTreatment:i,initiallySelectedItem:0===this.selection.selectedCount&&r&&!this.hasMadeInitialSelection?this.provider.getListItem((0,w.getItemFromVersion)(r,n&&n.repository?n.repository:(0,d.getGitRepository)(this.context.pageContext))):void 0});return c(s)})),width:o?void 0:480})}))}expand(){this.dropdown.current&&this.dropdown.current.expand()}focus(){this.dropdown.current&&this.dropdown.current.focus()}componentWillUnmount(){this.provider.dispose()}}t[e].VersionDropdown=i,i.defaultProps={renderExpandable:t[e].VersionDropdownExpandableButton}}("ComponentsVersionDropdown"),function(e){t[e]={};class i extends I.FilterBarItem{constructor(){super(...arguments),this.dropdown=l.createRef(),this.onSelectBranch=(e,t)=>{this.setFilterValue({value:t?t.text:null})}}render(){return l.createElement(x.VersionDropdown,{ref:this.dropdown,onSelect:this.onSelectBranch,placeholder:this.props.placeholder,initiallySelectedVersion:this.props.initiallySelectedItem?(0,n.gitVersionStringToVersionDescriptor)(`GB${(0,a.refToBranchName)(this.props.initiallySelectedItem)}`):void 0,providerOptions:{viewClearButton:!0,viewTagsPivot:!1},renderExpandable:e=>l.createElement(x.VersionDropdownExpandableTextField,Object.assign({},e,{className:"repos-version-dropdown-filterbaritem flex-row flex-grow"}))})}focus(){this.dropdown.current&&this.dropdown.current.focus()}}t[e].VersionDropdownFilterBarItem=i}("ComponentsVersionDropdownFilterBarItem"),function(e){t[e]={};t[e].VersionDropdownAsTextField=e=>l.createElement(x.VersionDropdown,Object.assign({},e,{renderExpandable:x.VersionDropdownExpandableTextField})),f.Components.add("ms.vss-code-web.version-dropdown-as-textfield",t[e].VersionDropdownAsTextField)}("ComponentsVersionDropdownAsTextField")}),["Resources","RestClient/Git","GitRefFavoritesService","GitRefService","VersionDropdownProvider","Components/VersionDropdown","Components/VersionDropdownFilterBarItem","Components/VersionDropdownAsTextField"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-code-web.version-dropdown"}}));
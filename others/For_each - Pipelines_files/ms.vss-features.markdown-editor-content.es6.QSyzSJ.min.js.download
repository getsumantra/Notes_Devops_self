"use strict";define("VSS/Features/MarkdownEditor",["require","exports","VSS/Core/Observable","VSS/Core/TimerManagement","VSS/Features/Markdown/MarkdownRendererComponent","VSSUI/Util","react","VSS/Platform/Layout","VSSUI/FormItem","VSSUI/Icon","VSSUI/Link","VSSUI/Observer","VSSUI/TextField","VSS/Features/PlatformUI/ContributedMenu","VSSUI/HeaderCommandBar"],(function(e,t,n,o,r,i,s,a,l,d,c,m,u,h,g){var p,x,S,f,w,b,k,T,M;p=t[M="Resources"]={},t[M].BoldTooltipText="Bold (Ctrl + B)",t[M].BulletedListText="Bulleted List",t[M].CodeTooltipText="Code",t[M].EditorTabText="Editor",t[M].Header1Text="Header 1",t[M].Header2Text="Header 2",t[M].Header3Text="Header 3",t[M].HeaderText="Header",t[M].ItalicTooltipText="Italic (Ctrl + I)",t[M].LinkTooltipText="Link (Ctrl + K)",t[M].LinkWorkItemsMessage="Link work items.",t[M].MarkdownSupportedMessage="Markdown supported.",t[M].NumberedListText="Numbered List",t[M].PreviewTabText="Preview",t[M].TaskListText="Task List",function(e){function n(e,t){const n=e.slice(0,t+1).search(/\S+$/),o=e.slice(t).search(/\s/);let r,i;return r=n<0?t:n,i=o<0?e.length:o+t,r=Math.min(Math.max(0,r),e.length),i=Math.min(Math.max(0,i),e.length),{start:r,end:i}}function o(e,t,n){for(;t<n&&/\s/.test(e[t]);)t++;for(;n>t&&/\s/.test(e[n-1]);)n--;return{end:n,start:t}}x=t[e]={},t[e].newLineChar="\n",function(n){n.Bold="**",n.Italic="_",n.Header1="# ",n.Header2="## ",n.Header3="### ",n.BulletedList="- ",n.NumberedList="1. ",n.TaskList="- [ ] ",n.Code="`",n.CodeBlock=t[e].newLineChar+"```"+t[e].newLineChar}(t[e].MarkdownSigns||(t[e].MarkdownSigns={})),t[e].insertText=function(e,t){const n=e.selectionStart||0,o=e.selectionEnd||0;return{finalSelectionEnd:n+(t=t||e.text.substring(n,o)).length,finalSelectionStart:n+t.length,finalText:e.text.substring(0,n)+t+e.text.substring(o),insertSelectionEnd:o,insertSelectionStart:n,insertText:t}},t[e].insertSignAtLineStart=function(n,o,r=[]){const{text:i=""}=n;let s=Math.min(n.selectionStart||0,i.length);const a=Math.min(n.selectionEnd||0,i.length);s=i.substring(0,s).lastIndexOf(t[e].newLineChar)+1;const l=i.substring(s,a).split(t[e].newLineChar).map((e=>{if(!e&&s!==a)return e;const t=r.filter((t=>0===e.indexOf(t)))[0];return 0===e.indexOf(o)?e.substring(o.length):t?o+e.substring(t.length):o+e})),d=i.substring(0,s),c=i.substring(a),m=l.join(t[e].newLineChar),u=d.length+m.length;return{insertSelectionEnd:a,insertSelectionStart:s,insertText:m,finalSelectionEnd:u,finalSelectionStart:u,finalText:d+m+c}},t[e].wrapWithSign=function(e,t,r=t){const{text:i=""}=e;let s=Math.min(e.selectionStart||0,i.length),a=Math.min(e.selectionEnd||0,i.length),l=s;const d=t.length,c=r.length,m=a>s;if(m){const e=o(i,s,a);s=e.start,a=e.end,s-d>=0&&i.substr(s-d,d)===t&&(s-=d),i.substr(a,c)===r&&(a+=c)}else{const e=n(i,s);s=e.start,a=e.end}const u=i.substring(0,s),h=i.substring(s,a),g=i.substring(a);let p;return t===h.substr(0,d)&&r===h.substr(h.length-c)?(p=h.substr(d,h.length-d-c),l-=d,m?a-=d+c:(s-=d,a-=c)):(p=t+h+r,l+=d,s+=d,a+=d),m||(s=a=l),{insertSelectionEnd:u.length+h.length,insertSelectionStart:u.length,insertText:p,finalSelectionEnd:a,finalSelectionStart:s,finalText:u+p+g}},t[e].expandCursorToWord=n,t[e].getTrimmedSelectionRange=o,t[e].applyTextFormatting=function(e,t){t&&(t.then?t.then((t=>{t&&e.applyFormatting(t)}),(t=>e.showError(t))):e.applyFormatting(t))}}("FormattingCommon"),function(e){S=t[e]={},t[e].wrapWithLinkSign=function(e){const{text:t=""}=e;let n=Math.min(e.selectionStart||0,t.length),o=Math.min(e.selectionEnd||0,t.length),r=o>n;if(r){const e=(0,x.getTrimmedSelectionRange)(t,n,o);n=e.start,o=e.end}else{const e=(0,x.expandCursorToWord)(t,n);n=e.start,o=e.end,r=o>n}const i=t.substring(0,n),s=t.substring(n,o),a=t.substring(o);let l,d;r?(l=`[${t.substring(n,o)}](`,d=")"):(l="[",d="]()");const c=l+d,m=i.length+l.length;return{insertSelectionEnd:i.length+s.length,insertSelectionStart:i.length,insertText:c,finalSelectionEnd:m,finalSelectionStart:m,finalText:i+c+a}}}("FormattingLink"),function(e){t[e]={},t[e].Bold={formatText:(e,t)=>{if(t.ctrlKey&&66===t.which)return(0,x.wrapWithSign)(e,x.MarkdownSigns.Bold)},id:"bold"},t[e].Italic={formatText:(e,t)=>{if(t.ctrlKey&&73===t.which)return(0,x.wrapWithSign)(e,x.MarkdownSigns.Italic)},id:"italic"},t[e].Link={formatText:(e,t)=>{if(t.ctrlKey&&75===t.which)return(0,S.wrapWithLinkSign)(e)},id:"link"},t[e].shortcutCommands=[t[e].Bold,t[e].Italic,t[e].Link]}("CommandsShortcut"),function(e){f=t[e]={},t[e].wrapWithCodeSign=function(e){const{text:t=""}=e,n=Math.min(e.selectionStart||0,t.length),o=Math.min(e.selectionEnd||0,t.length),r=t.substring(n,o).trim().indexOf(x.newLineChar)>=0?x.MarkdownSigns.CodeBlock:x.MarkdownSigns.Code;return(0,x.wrapWithSign)(e,r)}}("FormattingCode"),function(e){t[e]={},t[e].Header1={id:"header-1",formatText:e=>(0,x.insertSignAtLineStart)(e,x.MarkdownSigns.Header1,[x.MarkdownSigns.Header2,x.MarkdownSigns.Header3]),text:p.Header1Text},t[e].Header2={id:"header-2",formatText:e=>(0,x.insertSignAtLineStart)(e,x.MarkdownSigns.Header2,[x.MarkdownSigns.Header1,x.MarkdownSigns.Header3]),text:p.Header2Text},t[e].Header3={id:"header-3",formatText:e=>(0,x.insertSignAtLineStart)(e,x.MarkdownSigns.Header3,[x.MarkdownSigns.Header1,x.MarkdownSigns.Header2]),text:p.Header3Text};const n={id:"header",iconProps:{iconName:"EditStyle"},order:10,tooltipProps:{text:p.HeaderText},subMenuProps:{id:"header-menu",items:[t[e].Header1,t[e].Header2,t[e].Header3]}};t[e].Bold={formatText:e=>(0,x.wrapWithSign)(e,x.MarkdownSigns.Bold),iconProps:{iconName:"SemiboldWeight"},id:"bold",order:20,tooltipProps:{text:p.BoldTooltipText}},t[e].Italic={formatText:e=>(0,x.wrapWithSign)(e,x.MarkdownSigns.Italic),iconProps:{iconName:"Italic"},id:"italic",order:30,tooltipProps:{text:p.ItalicTooltipText}},t[e].Code={formatText:f.wrapWithCodeSign,iconProps:{iconName:"Embed"},id:"code",order:40,tooltipProps:{text:p.CodeTooltipText}},t[e].Link={formatText:S.wrapWithLinkSign,iconProps:{iconName:"Link"},id:"link",order:50,tooltipProps:{text:p.LinkTooltipText}},t[e].BulletedList={formatText:e=>(0,x.insertSignAtLineStart)(e,x.MarkdownSigns.BulletedList,[x.MarkdownSigns.NumberedList,x.MarkdownSigns.TaskList]),iconProps:{iconName:"BulletedList"},id:"bulleted-list",order:60,tooltipProps:{text:p.BulletedListText}},t[e].NumberedList={formatText:e=>(0,x.insertSignAtLineStart)(e,x.MarkdownSigns.NumberedList,[x.MarkdownSigns.BulletedList,x.MarkdownSigns.TaskList]),iconProps:{iconName:"NumberedList"},id:"numbered-list",order:70,tooltipProps:{text:p.NumberedListText}},t[e].TaskList={formatText:e=>(0,x.insertSignAtLineStart)(e,x.MarkdownSigns.TaskList,[x.MarkdownSigns.BulletedList,x.MarkdownSigns.NumberedList]),iconProps:{iconName:"CheckList"},id:"task-list",order:80,tooltipProps:{text:p.TaskListText}},t[e].toolbarCommands=[n,t[e].Bold,t[e].Italic,t[e].Code,t[e].Link,t[e].BulletedList,t[e].NumberedList,t[e].TaskList]}("CommandsToolbar"),function(e){w=t[e]={};t[e].MarkdownPreview=e=>{const{className:t,linkClickHandler:a,onInitialRender:l,options:d,refreshThrottleMs:c,value:m,placeholder:u}=e,[h,g]=s.useState(e.setContentOnInitialRender?m:""),p=new o.TimerManagement,x=c?s.useCallback(p.throttle(g,c,{trailing:!0}),[]):g;s.useEffect((()=>(n.ObservableLike.isObservable(m)?(m.subscribe(x),g(m.value)):x(m),()=>{n.ObservableLike.isObservable(m)&&m.unsubscribe(x)})),[m]);const S=h||"",f=S.trim(),w=e.preserveWhitespaceInHtmlFields&&0!==f.length?S:f;if(S)return s.createElement(r.MarkdownRendererComponent,{className:(0,i.css)("markdown-editor-preview",t),linkClickHandler:a,onInitialRender:l,rawContent:w,options:d,"aria-label":e.ariaLabel,injectExtensionMarkup:e.injectExtensionMarkup,onFocused:e.onFocused});const b=void 0!==e.onFocused;return u?s.createElement("div",{className:"markdown-editor-placeholder",tabIndex:b?0:void 0,onFocus:e.onFocused,role:b?"textbox":void 0,"aria-label":e.ariaLabel},u):null}}("ComponentsMarkdownPreview"),function(e){b=t[e]={},t[e].browserSupportsInsertText=function(){return document.queryCommandSupported("insertText")&&!function(){const e=window.navigator.userAgent.toLowerCase();return!!/mozilla.*rv:([\d+.]+)/i.exec(navigator.userAgent)&&-1===e.indexOf("trident")}()}}("UtilsBrowser"),function(e){k=t[e]={};class o extends a.VssComponent{constructor(e,t){super(e,t),this.textFieldRef=s.createRef(),this.checkWidth=()=>{var e,t,n,o;if(void 0!==this.props.isWideEnough&&(null===(n=null===(t=null===(e=this.textFieldRef)||void 0===e?void 0:e.current)||void 0===t?void 0:t.inputElement.current)||void 0===n?void 0:n.offsetWidth)){const e=(null===(o=this.textFieldRef.current.inputElement.current)||void 0===o?void 0:o.offsetWidth)>540;this.props.isWideEnough.value=e}},this.getFormMessage=()=>{const{error:e,messageText:t,showInfoControls:n,isWideEnough:o}=this.props;return s.createElement(m.Observer,{error:e,showInfoControls:n,isWideEnough:o},(e=>{if(e.error)return e.error.message;{const n=void 0===this.props.isWideEnough||(!!e.showInfoControls||e.isWideEnough);return s.createElement("div",{className:"flex-row markdown-text-container"},s.createElement("div",{className:(0,a.css)("flex flex-center rhythm-horizontal-4 flex-grow",n?void 0:"markdown-info-hidden")},s.createElement(d.Icon,{iconName:"Info"}),s.createElement(c.Link,{href:"http://go.microsoft.com/fwlink/?LinkId=823918",target:"_blank",removeUnderline:!0},p.MarkdownSupportedMessage),t&&s.createElement("span",null,t)),this.props.showInfoLinkForWorkItemLinking&&s.createElement("div",{className:(0,a.css)("flex flex-center rhythm-horizontal-4",n?void 0:"markdown-info-hidden")},s.createElement(d.Icon,{iconName:"Info"}),s.createElement(c.Link,{href:"http://aka.ms/linktoworkitems",target:"_blank",removeUnderline:!0},p.LinkWorkItemsMessage)),this.props.oppositeMessageText&&s.createElement("div",{className:"flex flex-center rhythm-horizontal-4 opposite-message"},this.props.oppositeMessageText))}}))},this.onChange=(e,t)=>{this.props.onChange&&this.props.onChange(t),this.showError(this.getWarningToShow(t))},this.getWarningToShow=e=>{const{isShowWarning:t,warningText:n}=this.props;return t&&t(e)&&n?{message:n,name:n}:null},this.onKeyDown=e=>{const{shortcutCommands:t=[]}=this.props;let n;if(t.length>0){const o=this.getFormattingArgs();for(const r of t)if(n=o&&r.formatText&&r.formatText(o,e),n)break}n?((0,x.applyTextFormatting)(this,n),e.preventDefault(),e.stopPropagation()):this.props.onKeyDown&&this.props.onKeyDown(e)},this.onPaste=e=>{this.props.onPaste&&this.props.onPaste(e,this)},this.state={}}componentDidMount(){this.checkWidth(),window.addEventListener("resize",this.checkWidth)}componentWillUnmount(){window.removeEventListener("resize",this.checkWidth)}applyFormatting(e){const t=this.textFieldRef.current;t&&(t.focus(),(0,b.browserSupportsInsertText)()?(t.setSelectionRange(e.insertSelectionStart,e.insertSelectionEnd),document.execCommand("insertText",!1,e.insertText)):this.props.onChange&&this.props.onChange(e.finalText),this.setState({selection:{end:e.finalSelectionEnd,start:e.finalSelectionStart}}))}getFormattingArgs(){const e=this.textFieldRef.current;if(e){const t=n.ObservableLike.getValue(this.props.value)||"",o=e.selectionStart;return{selectionEnd:e.selectionEnd,selectionStart:o,text:t}}}showError(e){const{onError:t}=this.props;t&&t(e)}render(){const{formItemClassName:e,error:t}=this.props;return s.createElement(m.Observer,{error:t},(t=>s.createElement(s.Fragment,null,s.createElement(l.FormItem,{className:e,error:!!t.error,message:this.getFormMessage()},s.createElement(u.TextField,Object.assign({autoAdjustHeight:!0,multiline:!0},this.props,{onChange:this.onChange,onKeyDown:this.onKeyDown,onPaste:this.onPaste,ref:this.textFieldRef}))))))}componentDidUpdate(){const{selection:e}=this.state;this.textFieldRef.current&&e&&this.textFieldRef.current.setSelectionRange(e.start,e.end)}}t[e].MarkdownTextField=o}("ComponentsMarkdownTextField"),function(e){T=t[e]={};t[e].MarkdownToolbar=e=>{const{className:t,contributionContext:o,contributionId:r,getTextSource:l}=e,d=new n.ObservableCollection,c=(0,a.useComponentContext)().pageContext;r&&d.push((0,h.getMenuItems)(c,r,o));const u=e=>{const t=l&&l();if(t&&e.formatText){const n=t.getFormattingArgs(),o=n&&e.formatText(n,(e=>t.showError(e)));(0,x.applyTextFormatting)(t,o)}},p=e=>{if((e=>{!e.onActivate&&e.formatText&&(e.onActivate=u)})(e),e.subMenuProps&&e.subMenuProps.items){const t=[];for(const o of n.ObservableLike.getValue(e.subMenuProps.items)||[]){const e=Object.assign({},o);o.subMenuProps&&(e.subMenuProps=Object.assign({},o.subMenuProps)),p(e),t.push(e)}e.subMenuProps.items=t}};return s.createElement(m.Observer,{contributedItems:d},(n=>{const o=n.contributedItems.sort(((e,t)=>(e.rank||Number.MAX_VALUE)-(t.rank||Number.MAX_VALUE))),r=[...void 0!==e.commands&&null!==e.commands?e.commands.sort(((e,t)=>(e.order||Number.MAX_VALUE)-(t.order||Number.MAX_VALUE))):[],...o],{isCollapsible:a}=e,l=r.map((e=>{var t;const n=Object.assign(Object.assign({},e),{ariaLabel:e.text||(null===(t=e.tooltipProps)||void 0===t?void 0:t.text),className:"no-margin",important:!a||void 0,subtle:!0,text:void 0,tooltipProps:e.tooltipProps||{text:e.text}});return e.subMenuProps&&(n.subMenuProps=Object.assign({},e.subMenuProps)),p(n),n}));return s.createElement(g.HeaderCommandBar,{className:(0,i.css)(t,"markdown-toolbar  flex-grow rhythm-horizontal-8 no-margin",a?"scroll-hidden":"flex-row flex-wrap"),items:l,useAriaLabelForOverflow:a,buttonCount:a?l.length:void 0,moreButtonMenuClassName:a?"markdown-toolbar-overflow":void 0})}))}}("ComponentsMarkdownToolbar"),function(e){t[e]={},__exportStar(w,t[e]),__exportStar(k,t[e]),__exportStar(T,t[e])}("Components")}),["Resources","Formatting/Common","Formatting/Link","Commands/Shortcut","Formatting/Code","Commands/Toolbar","Components/MarkdownPreview","Utils/Browser","Components/MarkdownTextField","Components/MarkdownToolbar","Components"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-features.markdown-editor-content"}}));
"use strict";define("Build/Common/Library",["require","exports","VSSUI/Status","Build/Flux/Action","VSS/Platform/Context","VSS/Platform/History","VSS/Core/Util/String","VSS/Core/Observable","Build/Flux/Sources/Contribution","Build/Flux/Store","VSS/Features/SignalR/3rdParty/jquery.shimmed","VSS/Platform/Fetch","VSS/Platform/Location","react","VSS/Features/PlatformUI/FPSLink","VSS/Platform/Layout","VSSUI/Icon","VSSUI/TooltipEx","VSSUI/VssPersona","VSSUI/Button","Tfs/Platform/Page","VSS/Platform/Identity","VSSUI/ButtonGroup","VSSUI/Link","VSSUI/Observer","VSSUI/Panel","VSSUI/Table","VSS/Core/Util/Accessibility","VSS/Features/PlatformUI/ContributedMenu","VSS/Platform/FPS","VSSUI/Ago","VSSUI/Dropdown","VSSUI/Duration","VSSUI/List","VSSUI/MessageCard","VSSUI/TextFilterBarItem","VSSUI/Utilities/Date","VSSUI/Utilities/Filter","VSS/Platform/Components/Format"],(function(e,t,i,n,s,r,o,a,l,c,p,u,d,m,h,g,S,b,C,y,v,f,P,I,_,T,k,D,x,N,w,E,R,B,F,A,L,U,M){var V,j,O,H,W,z,q,Q,G,K,J;V=t[J="Resources"]={},t[J].AgoTooltip="Last run: {0}",t[J].AgentPool="Agent pool",t[J].ARIALabelCopyToClipboard="Copy to clipboard",t[J].AutoAuthorizeErrorMessage="An unspecified error occurred while attempting to authorize resources.",t[J].BranchLabelFormat="Branch {0}",t[J].BuildUIDeprecationMessage="In the next few days, we will update this view to our new multi-stage pipelines user experience.",t[J].ChangeToAppConnection="Use app connection",t[J].ClosePanelButton="Close",t[J].CommitLabelFormat="Source version {0}",t[J].CopiedToClipboardText="Copied to clipboard",t[J].CopyToClipboardText="Copy to clipboard",t[J].ConnectionChanged="Connection was successfully changed",t[J].ConfirmRerunStage="Are you sure you want to rerun the stage '{0}'?",t[J].ConfirmRerunStageFailedJobs="Are you sure you want to rerun failed jobs in the stage '{0}'?",t[J].ConfirmRerunPipeline="Are you sure you want to rerun the pipeline's failed jobs?",t[J].DeleteRetentionLeases="Remove all",t[J].DeleteRetentionLeaseMessage="Delete retention lease",t[J].DurationTooltip="Started: {0}",t[J].forever=" (forever)",t[J].InstallApp="Install app",t[J].LearnMore="Learn more",t[J].LeaseOwnerColumnHeader="Retained by",t[J].NoResultsFound="No results found",t[J].OptInNow="Opt-in now",t[J].PreferAppConnectionInstall="Enhance this pipeline by installing the {0}",t[J].PreferAppConnectionChange="This pipeline is using an OAuth-based connection. Switch to the {0} for improved reliability and performance.",t[J].UpdateBitBucketConnection="This pipeline uses an outdated Bitbucket connection. Please edit the pipeline to update the Bitbucket connection.",t[J].ProjectRetentionSettingsLink="View retention settings",t[J].RepoLabelFormat="Repository {0}",t[J].RerunStage="Rerun stage",t[J].RetainedByBranchPolicyPrimaryText="Branch policy",t[J].RetainedByBranchPolicySecondaryText="On branch {0}",t[J].RetainedByPipelineResource="Retained as pipeline resource",t[J].RetainedByPipelineRetentionPolicyPrimaryText="Pipeline retention settings",t[J].RetainedByPipelineRetentionPolicySecondaryText="Retained as recent run of this pipeline",t[J].RetainedByReleaseSecondaryText="Run artifact(s) used by release",t[J].RetainedByUserSecondaryText="Manually retained",t[J].RetentionLeasesPanelHeading="Run retention",t[J].RetentionPanelDescription="Why is this run being retained?",t[J].RetentionTableName="Retention leases",t[J].RerunAll="Rerun all jobs",t[J].RerunFromFailed="Rerun failed jobs",t[J].RetryStage="Retry Stage",t[J].RunNotRetained="This run has not been actively retained.",t[J].SavePipelineCommentEnableCI="Enable YAML pipeline CI",t[J].SavePipelineCommentDisableCI="Disable pipeline CI",t[J].Snooze="Snooze",t[J].StagesHistoryTablePipelineRuns="Pipeline runs",t[J].StagesHistoryTableStageStatus="Stage status",t[J].StagesHistoryTableStartTime="Start time/Time elapsed",t[J].StagesTableDescription="Stage",t[J].StagesTableStarted="Time started",t[J].StagesTableElapsed="Time elapsed",t[J].StagesFilterStatus="State",t[J].StagesFilterName="Filter by stage name",t[J].StageStatusCanceled="Canceled",t[J].StageStatusFailed="Failed",t[J].StageStatusQueued="Queued",t[J].StageStatusWarning="Warning",t[J].StageStatusRunning="Running",t[J].StageStatusSkipped="Skipped",t[J].StageStatusSuccess="Success",t[J].StageStatusWaiting="Action required",t[J].StatusAbandoned="Abandoned",t[J].StatusCanceled="Canceled",t[J].StatusFailed="Failed",t[J].StatusQueued="Queued",t[J].StatusRunning="Running",t[J].StatusSkipped="Skipped",t[J].StatusSuccess="Success",t[J].StatusUnknown="No runs",t[J].StatusWaiting="Waiting",t[J].StatusWarning="Warning",t[J].SaveButtonLabel="Save",t[J].SourceVersionTextboxTitle="Source version",t[J].ConfigFileDataProviderErrorMessage="Error retrieving config files for repository {0}.",t[J].SavePipelineCommentDisable="Disable pipeline",t[J].SavePipelineCommentEnable="Enable pipeline",t[J].SavePipelineCommentEnableAutoLink="Updated automatic work item linking status to {0}",t[J].SavePipelineCommentPause="Pause pipeline",t[J].SavePipelineCommentUnknownStatus="Change pipeline processing status",t[J].SavePipelineCommentUpdateAutoLinkBranch="Updated automatic work item linking branch to {0}",t[J].SavePipelineCommentYamlFile="Change YAML file to {0}",t[J].SavePipelineErrorMessage="An unspecified error occurred while saving the pipeline.",t[J].UnresolvedUser="Unresolved user",t[J].until=" until {0}",t[J].VariableSecretMask="***********",t[J].EditPipeline="Edit",t[J].FilterByRunName="Filter by run name",t[J].StagesPanelDescription="Stage runs history",function(e){t[e]={};t[e].subtract=function(e,t){if(e=e||[],t=t||[],[].includes)return e.filter((e=>!t.includes(e)));{let i={},n=[];for(let e=0;e<t.length;e++){i[(t[e]||"")+""]=!0}for(let t=0;t<e.length;t++){i[(e[t]||"")+""]||n.push(e[t])}return n}},t[e].intersect=function(e,t){return t=t||[],(e=e||[]).filter((e=>-1!==t.indexOf(e)))}}("Array"),function(e){j=t[e]={},function(e){e.Designer=1,e.Yaml=2,e.Docker=3}(t[e].ProcessType||(t[e].ProcessType={})),function(e){e.buildId="buildId",e.changeId="changeId",e.jobId="jobId",e.planId="planId",e.stepId="stepId",e.timelineId="timelineId",e.fullTimeline="fullTimeline",e.update="update",e.jobQueueData="jobQueueData",e.continuationToken="continuationToken",e.job="j",e.line="l",e.stage="s",e.task="t",e.view="view",e.logs="logs",e.artifacts="artifacts",e.treeState="treeState",e.imageUri="imageUri",e.type="type",e.alias="alias",e.tag="tag",e.consumedArtifacts="consumedArtifacts",e.publishedArtifacts="publishedArtifacts",e.stageName="stageName",e.poolId="poolId"}(t[e].NavConstants||(t[e].NavConstants={})),function(e){e.Area="Build",e.RunsOverviewShow="PipelineRunsOverview.Show",e.RunsOverviewLogs="PipelineRunsOverview.ViewLogs",e.StagePanelSearch="PipelineRunsStagePanel.Search",e.StagePanelFilter="PipelineRunsStagePanel.Filter",e.StagePanelShow="PipelineRunsStagePanel.Show",e.StagePanelLogs="PipelineRunsStagePanel.ViewLogs",e.StagePanelAction="PipelineRunsStagePanel.Action",e.StagesHistoryPanelShow="StagesHistoryPanel.Show",e.StagesHistoryPanelSearch="StagesHistoryPanel.Search",e.StagesHistoryPanelFilter="StagesHistoryPanel.Filter",e.StagesHistoryPanelLogs="StagesHistoryPanel.ViewLogs",e.SeeFullYAML="SeeFullYAML"}(t[e].TelemetryConstants||(t[e].TelemetryConstants={})),function(e){e.WitLinkingOptionGUID="5d58cc01-7c75-450c-be18-a388ddb129ec"}(t[e].BuildOptionGUIDs||(t[e].BuildOptionGUIDs={}))}("Constants"),t.Contracts={},t.ContributedExtensiontypes={},function(e){t[e]={},t[e].getDurationStats=function(e){e=Math.abs(e);const t=Math.floor(e/1e3),i=Math.floor(t/60),n=Math.floor(i/60);return{days:Math.floor(n/24),hours:n%24,minutes:i%60,seconds:t%60}},t[e].padZeroes=function(e,t=2){let i=e+"";for(;i.length<t;)i="0"+i;return i}}("Duration"),function(e){var i;t[e]={},i||(i={}),t[e].handleError=function(e){console.error(e),i.registeredHandler&&i.registeredHandler(e)},t[e].registerErrorHandler=function(e){i.registeredHandler=e}}("ErrorHandler"),function(e){O=t[e]={},t[e].getAvatarUrl=function(e){let t="";return e&&(t=e&&e._links&&e._links.avatar&&e._links.avatar.href,t=t||e.imageUrl||""),t}}("Identity"),function(e){var n;function s(e){e=(e=e||"").toLowerCase();const t={statusProps:i.Statuses.Queued,type:n.Queued,label:V.StatusUnknown};switch(e){case n.Cancelled:t.statusProps=i.Statuses.Canceled,t.type=n.Cancelled,t.label=V.StatusCanceled;break;case n.Failed:t.statusProps=i.Statuses.Failed,t.type=n.Failed,t.label=V.StatusFailed;break;case n.InProgress:t.statusProps=i.Statuses.Running,t.type=n.InProgress,t.label=V.StatusRunning;break;case n.Pending:t.statusProps=i.Statuses.Queued,t.type=n.Pending,t.label=V.StatusWaiting;break;case n.Queued:t.statusProps=i.Statuses.Waiting,t.type=n.Waiting,t.label=V.StatusQueued;break;case n.Skipped:t.statusProps=i.Statuses.Skipped,t.type=n.Skipped,t.label=V.StatusSkipped;break;case n.Succeeded:t.statusProps=i.Statuses.Success,t.type=n.Succeeded,t.label=V.StatusSuccess;break;case n.Waiting:t.statusProps=i.Statuses.Waiting,t.type=n.Waiting,t.label=V.StatusWaiting;break;case n.Warning:t.statusProps=i.Statuses.Warning,t.type=n.Warning,t.label=V.StatusWarning}return t}H=t[e]={},function(e){e.Cancelled="cancelled",e.Failed="failed",e.InProgress="inprogress",e.Pending="pending",e.Queued="queued",e.Skipped="skipped",e.Succeeded="succeeded",e.Unknown="unknown",e.Waiting="waiting",e.Warning="warning"}(n=t[e].Status||(t[e].Status={})),t[e].getStatusIndicatorData=s,t[e].getBuildStatusIndicatorData=function(e,t){let i=n.Unknown;switch(e){case 4:i=n.Cancelled;break;case 1:i=n.InProgress;break;case 32:case 8:i=n.Queued;break;case 2:switch(t){case 2:i=n.Succeeded;break;case 4:i=n.Warning;break;case 8:i=n.Failed;break;case 32:i=n.Cancelled}}return s(i)},t[e].getTimelineStatusIndicatorData=function(e,t,i,r){let o=n.Unknown;switch(e){case 0:o=i?n.Waiting:r?n.Queued:n.Pending;break;case 1:o=n.InProgress;break;case 2:switch(t){case 0:o=n.Succeeded;break;case 1:o=n.Warning;break;case 2:o=n.Failed;break;case 3:case 5:o=n.Cancelled;break;case 4:o=n.Skipped;break;case 6:case 7:o=n.Pending}}return s(o)}}("Indicator"),function(e){W=t[e]={},t[e].openLinkSecurely=function(e,t=!1){const i=t?"_blank":"_self",n=window.open(e,i);n&&(n.opener=null)};t[e].NavigationActionHub=class{constructor(){this._navigationChanged=new n.Action}get navigationChanged(){return this._navigationChanged}};class i extends s.VssService{constructor(){super(...arguments),this._onNavigate=e=>{this._actionHub&&this._actionHub.navigationChanged.invoke(e)}}_serviceStart(e){super._serviceStart(e),this._historyService=this.pageContext.getService("IVssHistoryService"),this._historyService.subscribe(this._onNavigate,r.HistoryServiceEventNames.statePopped),this._linkingService=this.pageContext.getService("IBuildLinkingService")}_serviceEnd(e){super._serviceEnd(e),this._historyService&&this._historyService.unsubscribe(this._onNavigate,r.HistoryServiceEventNames.statePopped)}subscribeToNavigationChanges(e){this._actionHub=e}getCurrentState(){return this._historyService&&this._historyService.getState()||{}}getHistoryService(){return this._historyService}getLinkingService(){return this._linkingService}pushState(e){if(this._historyService){let t=this._historyService.getState();Object.keys(e).forEach((i=>{t[i]=e[i]})),this._historyService.pushState(t)}}}s.Services.add("IBuildNavigationService",{serviceFactory:i})}("Navigation"),function(e){t[e]={};class i extends s.VssService{installApp(e){const t=this.pageContext.getService("IVssContributionService"),n=this._getTelemetrySession();t.getDataAsync("ms.vss-build-web.wizard-continuation-data-provider",{telemetrySession:n,host:e},!0).then((()=>{this._logTelemetry("installApp","CreatePipeline",n,"");let t=i._redirectUrl;e&&(t=`https://${e}/apps/external-app/azure-pipelines`),(0,W.openLinkSecurely)(t,!1)}))}installAppForWizard(e,t,n,s,r){let o=i._redirectUrl;if(s.properties&&s.properties.ownerId){const e=s.properties.ownerId,t=s.properties.externalId,i=n.indexOf("?")>0?"&":"?";o=n+i+"suggested_target_id="+e+"&repository_ids[]="+t}const a=this._getTelemetrySession();this.pageContext.getService("IVssContributionService").getDataAsync("ms.vss-build-web.wizard-continuation-data-provider",{sourceProvider:e,repositoryId:s.id,repositoryName:s.name,connectionId:t,telemetrySession:a,host:r},!0).then((()=>{this._logTelemetry("installAppForRepository","CreatePipeline",a,s.id),(0,W.openLinkSecurely)(o,!1)}))}installAppForEdit(e,t,n,s){let r=i._redirectUrl;if(s.properties&&s.properties.ownerId){const e=s.properties.ownerId,t=s.properties.externalId,i=n.indexOf("?")>0?"&":"?";r=n+i+"suggested_target_id="+e+"&repository_ids[]="+t}this.pageContext.getService("IVssContributionService").getDataAsync("ms.vss-build-web.pipeline-edit-continuation-data-provider",{pipelineId:e.toString(),nonce:t,repositoryId:s.id},!0).then((()=>{this._logTelemetry("installAppForRepository","EditPipeline",s.id),(0,W.openLinkSecurely)(r,!1)}))}_getTelemetrySession(){return this.pageContext.getService("IVssHistoryService").getState().telemetrySession}_logTelemetry(e,t,i,n){this.pageContext.getService("IVssTelemetryService").publishEvent("Build",t,{GitHubApp:e,GitHubAppRepo:n,action:"InstallGitHubApp",telemetrySession:i||"unknown"})}}t[e].InstallAppService=i,i._redirectUrl="https://go.microsoft.com/fwlink/?linkid=874367",s.Services.add("IInstallAppService",{serviceFactory:i})}("InstallAppService"),function(){t.PipelineResourcesService={};const e="ms.vss-build-web.authorize-pipeline-resources-data-provider";class i extends s.VssService{updateAuthorizedResource(e,t,i,n){const s=this.pageContext.getService("ITfsPageService").getData();let r="";s&&s.project&&(r=s.project.id);const o=[{authorized:n,id:i,type:t,name:""}];return this.pageContext.getRestClient("IBuildRestClient").authorizeDefinitionResources(o,r,e)}autoAuthorizeResources(t,i){const n={pipelineId:t,sourceBranch:i};return new Promise(((t,i)=>{const s=this.pageContext.getService("IVssContributionService");s.getDataAsync(e,n,!0).then((n=>{if(n)t(n);else{const t=s.getDataProviderExceptions()[e],n=t&&t.message||V.AutoAuthorizeErrorMessage;i(new Error(n))}}))}))}}s.Services.add("IPipelineResourcesService",{serviceFactory:i})}(),function(e){z=t[e]={},t[e].formatPipelineRunName=function(e,t,i=!0){let n;return n=i&&""!==t?(0,o.format)("#{0} â€¢ {1}",e,t):(0,o.format)("#{0}",e),n}}("PipelineRunNameFormatter"),function(){t.PipelineService={};class e extends s.VssService{createAndRunPipeline(t,i,n,s,r,o,a,l){const c=this.pageContext.getService("IVssContributionService");let p={createOnly:a,connectionId:t.connectionId,sourceProvider:t.sourceProviderType,pipelinePath:r,repositoryId:t.id,repositoryName:t.name,branch:t.defaultBranch,sourceBranch:n||t.defaultBranch,filePath:i,queue:l};return s&&(p=Object.assign(Object.assign({},p),{commitId:s.commitId,pullRequestNumber:s.pullRequestNumber,commitDescriptorName:s.commitDescriptorName})),o&&Object.keys(o).length>0&&(p.variables=o),c.getDataAsync(e._pipelineDataProviderId,p,!0)}runPipeline(e,t){const i=this.pageContext.getRestClient("IBuildRestClient"),n={definition:{id:e.id},sourceBranch:t};return i.queueBuild(n,e.project.id)}enablePipelineCI(e,t){if((e=this.shallowCopy(e)).triggers&&(e.triggers=e.triggers.filter((e=>2!==e.triggerType))),t){const t={batchChanges:!1,maxConcurrentBuildsPerBranch:1,pollingJobId:"",pollingInterval:0,pathFilters:[],branchFilters:[],settingsSourceType:2,triggerType:2};e.triggers=e.triggers||[],e.triggers.push(t),e.comment=V.SavePipelineCommentEnableCI}return e.comment=t?V.SavePipelineCommentEnableCI:V.SavePipelineCommentDisableCI,this.savePipeline(e)}enablePipeline(e,t){switch((e=this.shallowCopy(e)).queueStatus=t,t){case 2:e.comment=V.SavePipelineCommentDisable;break;case 0:e.comment=V.SavePipelineCommentEnable;break;case 1:e.comment=V.SavePipelineCommentPause}return this.savePipeline(e)}savePipeline(e){return this.pageContext.getRestClient("IBuildRestClient").updateDefinition(e,e.project.id,e.id)}getPipelineErrorMessage(){const t=this.pageContext.getService("IVssContributionService").getDataProviderExceptions()[e._pipelineDataProviderId];return t&&t.message}deepCopy(e){return JSON.parse(JSON.stringify(e))}shallowCopy(e){return Object.assign({},e)}}e._pipelineDataProviderId="ms.vss-build-web.create-and-run-pipeline-data-provider",s.Services.add("IPipelineService",{serviceFactory:e})}(),function(e){t[e]={};class i extends s.VssService{constructor(){super(...arguments),this.items=new a.ObservableArray}getBreadcrumbItems(e){return this.items.push({key:"Hub",text:"",priority:100,hidden:!0}),this.items}}t[e].PipelinesL2Header=i,s.Services.add("pipelines-l2-breadcrumb-service",{serviceFactory:i})}("PipelinesL2Header"),function(e){q=t[e]={};class i{constructor(){this._treeData=""}get treeData(){return this._treeData}updateTreeData(e){this._treeData=e}dispose(){this._treeData=""}}t[e].PipelinesStateData=i,i.key="PipelinesTreeStateDataStore"}("PipelinesStateData"),function(e){t[e]={},function(e){e.None="None",e.Disabled="Disabled",e.BestPractice="BestPractice",e.Custom="Custom"}(t[e].ForkProtectionOption||(t[e].ForkProtectionOption={})),function(e){e.NonTeamMembersNonContributor="NonTeamMembersNonContributor",e.NonTeamMembers="NonTeamMembers",e.All="All"}(t[e].CommentTriggerOption||(t[e].CommentTriggerOption={})),t[e].DisabledSettings={forkProtectionEnabled:!0,buildsEnabledForForks:!1,enforceJobAuthScopeForForks:!1,enforceNoAccessToSecretsFromForks:!1,isCommentRequiredForPullRequest:!1,requireCommentsForNonTeamMembersOnly:!1,requireCommentsForNonTeamMemberAndNonContributors:!1},t[e].BestPracticeSettings={forkProtectionEnabled:!0,buildsEnabledForForks:!0,enforceJobAuthScopeForForks:!0,enforceNoAccessToSecretsFromForks:!0,isCommentRequiredForPullRequest:!0,requireCommentsForNonTeamMembersOnly:!1,requireCommentsForNonTeamMemberAndNonContributors:!1}}("PipelineTriggerSettings"),function(e){t[e]={},function(e){e.Yaml="yaml",e.Docker="docker"}(t[e].ConfigFileType||(t[e].ConfigFileType={}));class i extends s.VssService{getConfigFiles(e,t){const i={connectionId:e.connectionId,sourceProvider:e.sourceProviderType,repositoryId:e.id,repositoryName:e.name,configFileType:t,branch:e.defaultBranch};return this.getDataProviderResult("ms.vss-build-web.find-config-files-data-provider",e,i,V.ConfigFileDataProviderErrorMessage)}getDataProviderResult(e,t,i,n){const s=(0,o.format)(n,t.name||t.id),r=this.pageContext.getService("IVssContributionService");return r.getDataAsync(e,i,!0).then((t=>{if(t)return t;{const t=r.getDataProviderExceptions()[e],i=t&&t.message||s;throw new Error(i)}}),(e=>{throw new Error(e&&e.message||s)}))}}s.Services.add("IRepositoryService",{serviceFactory:i})}("RepositoryService"),function(e){t[e]={};class i extends c.Store{constructor(e){super();const t=e.source?e.source:new l.ContributionSource({pageContext:e.pageContext});this._permissions=t.getSharedData("_permissions")||{},this._claims=t.getData("ms.vss-web.user-claims-data")||{}}hasPermission(e,t,i){if(this._permissions){const n=this._permissions[e];if(n){const s=n[t];return void 0===s&&console.warn("PermissionsStore: token "+t+", for namespace"+e+", has no permissions defined."),(i&s)>0}console.warn("PermissionsStore: namespace "+e+"has no permissions defined.")}return!1}hasClaim(e){return!(!this._claims||!this._claims[e])}}t[e].PermissionsStore=i}("StoresPermissions"),function(e){var i,n,s,r;t[e]={},function(e){e.BuildNamespaceId="33344d9c-fc72-4d6f-aba5-fa317101a7e9",e.DteSecurityNamespaceId="101eae8c-1709-47f9-b228-0e476c35b3ba",e.AgentPoolToken="AgentPools"}(i=t[e].Constants||(t[e].Constants={})),function(e){e.Manage=8}(n=t[e].AgentPoolPermissions||(t[e].AgentPoolPermissions={})),function(e){e.ViewBuilds=1,e.EditBuildQuality=2,e.RetainIndefinitely=4,e.DeleteBuilds=8,e.ManageBuildQualities=16,e.DestroyBuilds=32,e.UpdateBuildInformation=64,e.QueueBuilds=128,e.ManageBuildQueue=256,e.StopBuilds=512,e.ViewBuildDefinition=1024,e.EditBuildDefinition=2048,e.DeleteBuildDefinition=4096,e.OverrideBuildCheckInValidation=8192,e.AdministerBuildPermissions=16384,e.CreateBuildDefinition=32768,e.EditPipelineQueueConfigurationPermission=65536,e.ManageStageRunOrderPermission=131072,e.AbandonBuilds=262144,e.AllPermissions=524287}(s=t[e].BuildRequiredPermissions||(t[e].BuildRequiredPermissions={})),function(e){e.Anonymous="anonymous",e.Public="public",e.Member="member"}(r=t[e].UserClaims||(t[e].UserClaims={}));const o="/";class a{constructor(e){this._store=e.store,this._projectId=e.projectId}canEditDefinition(e){return this.hasDefinitionPermission(e,s.EditBuildDefinition)}canChangeBuild(e){return this.hasDefinitionPermission(e,s.EditBuildQuality)}canCreateDefinition(e){return this.hasDefinitionPermission(e,s.CreateBuildDefinition)}canEditPipelineQueueConfiguration(e){return this.hasDefinitionPermission(e,s.EditPipelineQueueConfigurationPermission)}canManageStageRunOrder(e){return this.hasDefinitionPermission(e,s.ManageStageRunOrderPermission)}canAbandonBuild(e){return this.hasDefinitionPermission(e,s.AbandonBuilds)}canCancelBuild(e,t){const i=(t.requestedBy&&t.requestedBy.id||"").toLowerCase(),n=(t.requestedFor&&t.requestedFor.id||"").toLowerCase();return(e=e||e.toLowerCase())===i||e===n||this.hasDefinitionPermission(t.definition,s.StopBuilds)}canCancelBuildByUserId(e,t,i,n,r){const o=(r||"").toLowerCase(),a=(n||"").toLowerCase();return(e=e||e.toLowerCase())===o||e===a||this._hasDefinitionPermission(t,i,s.StopBuilds)}canDeleteBuild(e){return this.hasDefinitionPermission(e,s.DeleteBuilds)}canDeleteBuildByDefinitionId(e,t){return this._hasDefinitionPermission(e,t,s.DeleteBuilds)}canQueueBuild(e){return this.hasDefinitionPermission(e,s.QueueBuilds)}canQueueBuildById(e,t){return this._hasDefinitionPermission(e,t,s.QueueBuilds)}canEditTagsByUserId(e,t,i,n,r){const o=(r||"").toLowerCase(),a=(n||"").toLowerCase();return(e=e||e.toLowerCase())===o||e===a||this._hasDefinitionPermission(t,i,s.EditBuildQuality)}canRetainBuild(e){return this.hasDefinitionPermission(e,s.RetainIndefinitely)||this.hasDefinitionPermission(e,s.UpdateBuildInformation)}canRetainBuildByDefinitionId(e,t){return this._hasDefinitionPermission(e,t,s.RetainIndefinitely)||this._hasDefinitionPermission(e,t,s.UpdateBuildInformation)}hasDefinitionPermission(e,t){return this._store.hasPermission(i.BuildNamespaceId,a.getDefinitionSecurityToken(this._projectId,e),t)}hasFolderPermission(e,t){return this._store.hasPermission(i.BuildNamespaceId,a._getDefinitionFolderSecurityToken(this._projectId,e),t)}isAnonymousUser(){return this._store.hasClaim(r.Anonymous)}isPublicUser(){return this._store.hasClaim(r.Public)}isMember(){return this._store.hasClaim(r.Member)}hasManageAgentPoolPermission(e){return this._store.hasPermission(i.DteSecurityNamespaceId,a._getAgentPoolSecurityToken(e),n.Manage)}static getDefinitionSecurityToken(e,t){return a._getDefinitionSecurityToken(e,t.id.toString(),t.path)}static getSecurityTokenPath(e){return(e=e.replace(/\\/g,o))[0]===o&&(e=e.slice(1,e.length)),e}_hasDefinitionPermission(e,t,n){return this._store.hasPermission(i.BuildNamespaceId,a._getDefinitionSecurityToken(this._projectId,e,t),n)}static _getDefinitionSecurityToken(e,t,i){let n=t;return"\\"!==i&&(n=a.getSecurityTokenPath(i)+o+n),e+o+n}static _getDefinitionFolderSecurityToken(e,t){return"\\"===t?e:e+o+a.getSecurityTokenPath(t)+o}static _getAgentPoolSecurityToken(e){let t=i.AgentPoolToken;return e&&(t=t.concat(o,e.toString())),t}}t[e].Security=a}("Security"),function(e){t[e]={},function(e){e.buildDetailHub="buildDetailHub"}(t[e].HubNames||(t[e].HubNames={})),t[e].getBuildProxyToRegister=function(e){const t=p.jqueryShimmed;return e.server={stopWatchingBuild:function(i,n){return e.invoke.apply(e,t.merge(["StopWatchingBuild"],t.makeArray(arguments)))},stopWatchingCollection:function(){return e.invoke.apply(e,t.merge(["StopWatchingCollection"],t.makeArray(arguments)))},stopWatchingProject:function(i){return e.invoke.apply(e,t.merge(["StopWatchingProject"],t.makeArray(arguments)))},watchBuild:function(i,n){return e.invoke.apply(e,t.merge(["WatchBuild"],t.makeArray(arguments)))},watchCollection:function(){return e.invoke.apply(e,t.merge(["WatchCollection"],t.makeArray(arguments)))},watchProject:function(i){return e.invoke.apply(e,t.merge(["WatchProject"],t.makeArray(arguments)))}},e}}("SignalRHubProxies"),function(e){Q=t[e]={};class i{constructor(){this._objects={}}add(e,t){this._objects[e]=t}get(e){return this._objects[e]}remove(e){this._objects[e]&&this._objects[e].dispose(),delete this._objects[e]}dispose(){const e=this._objects||{};Object.keys(e).forEach((t=>{e[t].dispose()})),this._objects={}}}var n;t[e].SingletonManager=i,t[e].getSingletonManager=function(){return n||(n=new i),n}}("SingletonManager"),function(e){t[e]={};t[e].BuildSource=class{constructor(e){this._client=e.pageContext.getRestClient("IBuildRestClient"),this._XAMLclient=e.pageContext.getRestClient("IXAMLBuildRestClient"),this._project=e.project}getBuild(e){return this._client.getBuild(this._project,e)}getBuilds(e){return this._client.getBuilds(e.project||this._project,e.definitions,e.queues,e.buildNumber,e.minTime,e.maxTime,e.requestedFor,e.reasonFilter,e.statusFilter,e.resultFilter,e.tagFilters,e.properties,e.top||50,e.continuationToken,e.maxBuildsPerDefinition,e.deletedFilter,e.queryOrder,e.branchName,e.buildIds,e.repositoryId,e.repositoryType)}getXAMLBuilds(e){return this._XAMLclient.getXAMLBuilds(e.project||this._project,e.definitions,e.queues,e.buildNumber,e.minTime,e.maxTime,e.requestedFor,e.reasonFilter,e.statusFilter,e.resultFilter,e.tagFilters,e.properties,e.top||50,e.continuationToken,e.maxBuildsPerDefinition,e.deletedFilter,e.queryOrder,e.branchName,e.buildIds,e.repositoryId,e.repositoryType,e.type)}getClient(){return this._client}}}("SourcesBuild"),function(e){function i(e){const t=e.getService("IVssHistoryService");let i=t.getState();i.hasOwnProperty(j.NavConstants.treeState)&&(delete i[j.NavConstants.treeState],t.replaceState(i)),(0,Q.getSingletonManager)().remove(q.PipelinesStateData.key)}function n(e,t){const i=e.getService("IVssHistoryService"),n=i.generateUrl({treeState:t});i.replaceState(void 0,n)}function s(e){const t=window.location.href;return t.lastIndexOf("_build")>=0||t.lastIndexOf("build-")>=0}function r(){return(0,Q.getSingletonManager)().get(q.PipelinesStateData.key)}function o(){const e=new q.PipelinesStateData;return(0,Q.getSingletonManager)().add(q.PipelinesStateData.key,e),e}t[e]={},t[e].clearTreeState=i,t[e].updateTreeStateSettings=function(e,t){if(s(e)){(function(){let e=r();e||(e=o());return e})().updateTreeData(t)}},t[e].updateTreeStateUrl=n,t[e].getTreeState=function(e){let t="",s=r();return t=e.getService("IVssHistoryService").getState()[j.NavConstants.treeState]||"",t||s&&(t=s.treeData,t&&n(e,t)),s||t||i(e),s||o(),t},t[e].clearTreeStateOnUnmount=function(e){s(e)||i(e)}}("StateHandler"),function(e){t[e]={},t[e].atou=function(e){return decodeURIComponent(escape(window.atob(e)))},t[e].utoa=function(e){return window.btoa(unescape(encodeURIComponent(e)))}}("String"),function(){t.TaskCheckLogLineService={};class e extends s.VssService{constructor(){super(...arguments),this._logLineCache=new Map}async getLastCheckLogLine(e,t,i,n,s){var r;if(s<=0)return Promise.resolve("");const o=s-1,a=s,l=this._getKey(t,i,n,o.toString(),a.toString());if(this._logLineCache.has(l))return Promise.resolve(this._logLineCache.get(l));const c=await(0,u.issueRequest)(this._getUrl(e,t,i,n,o.toString(),a.toString())).then((e=>e.json()),(e=>"")),p=null===(r=null==c?void 0:c.value)||void 0===r?void 0:r.join("\n");return this._logLineCache.set(l,p),p}_getUrl(e,t,i,n,s,r){return(0,d.routeUrl)(e,"ms.vss-build-web.check-log-line-api-route",{projectId:n,hubName:"checks",planId:t,logId:null==i?void 0:i.toString(),startLine:s,endLine:r})}_getKey(e,t,i,n,s){return`${e}_${t}_${i}_${n}_${s}`}}s.Services.add("ITaskCheckLogLineService",{serviceFactory:e})}(),function(e){t[e]={};class i extends g.VssComponent{constructor(e,t){super(e,t);const i=t.pageContext.getService("ISourceProviderService").getSourceProvider(e.repositoryType),n=i?i.getBranchText(e.branch):e.branch,s=i?i.getBranchIconName(e.branch):"OpenSource";this.state={branchIconName:s,branchLink:"#",branchName:n}}componentDidMount(){super.componentDidMount(),this._refreshStateData()}componentDidUpdate(e,t){super.componentDidUpdate(e,t),e.repositoryId===this.props.repositoryId&&e.branch===this.props.branch||this._refreshStateData()}render(){const{excludeTabStop:e=!0,monospace:t,readonly:i}=this.props;let n="scroll-hidden flex-row flex-baseline branch-link";return t&&(n+=" monospaced-text"),!i&&this.state.branchLink?m.createElement(h.FPSLink,{className:n,excludeTabStop:e,href:this.state.branchLink,subtle:!0,ariaLabel:(0,o.format)(V.BranchLabelFormat,this.state.branchName),removeUnderline:!0},m.createElement(b.Tooltip,{overflowOnly:!0},m.createElement("span",{className:"text-ellipsis"},m.createElement(S.Icon,{iconName:this.state.branchIconName,className:"pipelines-icon-right-margin"}),this.state.branchName))):this.state.branchName?(n+=" pipelines-icon-left-margin pipeline-link",m.createElement("div",{className:n},m.createElement(b.Tooltip,{overflowOnly:!0},m.createElement("span",{className:"text-ellipsis","aria-label":(0,o.format)(V.BranchLabelFormat,this.state.branchName)},m.createElement(S.Icon,{iconName:this.state.branchIconName,className:"pipelines-icon-right-margin"}),this.state.branchName)))):m.createElement("span",null)}_refreshStateData(){const e=this.context.pageContext.getService("ISourceProviderService").getSourceProvider(this.props.repositoryType),t=e?e.getBranchText(this.props.branch):this.props.branch,i=e?e.getBranchIconName(this.props.branch):"OpenSource";!this.props.readonly&&e?this.trackPromise(this.props.projectNamePromise||e.getProjectName(this.props.repositoryId)).promise.then((t=>this.trackPromise(e.fetchBranchLink({branchName:this.props.branch,repositoryName:this.props.repositoryName||this.props.repositoryId,repositoryUrl:this.props.repositoryUrl,links:{}},t||void 0)).promise)).then((e=>{this.setState({branchIconName:i,branchLink:e,branchName:t})}),(e=>{e.isCanceled||console.log(e)})):this.setState({branchIconName:i,branchLink:"#",branchName:t})}}t[e].BranchLink=i}("ComponentsBranchLink"),function(e){G=t[e]={};class i extends g.VssComponent{constructor(e,t){super(e,t),this._getFallbackImageUrl=e=>{if(!this.props.displayName)return e>=40?(0,d.getAssetLocation)(this.context.pageContext,"ms.vss-build-web/common-library/default-user-avatar-large.svg"):(0,d.getAssetLocation)(this.context.pageContext,"ms.vss-build-web/common-library/default-user-avatar-small.svg")},this._onImageError=()=>{this.props.imageUrl&&this.setState({unloadableImageUrls:this.state.unloadableImageUrls.add(this.props.imageUrl)})},this.state={unloadableImageUrls:e.unloadableImageUrls||new Set}}render(){return m.createElement(C.VssPersona,{size:this.props.size,cssClass:this.props.cssClass,identityDetailsProvider:{getIdentityImageUrl:e=>!this.props.imageUrl||this.state.unloadableImageUrls.has(this.props.imageUrl)?this._getFallbackImageUrl(e):this.props.imageUrl,getDisplayName:()=>this.props.displayName?this.props.displayName:V.UnresolvedUser},onImageError:this._onImageError})}}t[e].BuildPersona=i}("ComponentsBuildPersona"),function(e){K=t[e]={};const i=["ms.vss-distributedtask-web.common-library","ms.vss-build-web.common-commands"];class n extends m.Component{render(){return m.createElement(g.WrappedComponent,Object.assign({dependencies:i,wrappedType:this.props.commandType},this.props))}}t[e].CommandComponent=n,t[e].prefetch=function(e){const t=e.getService("IVssContributionService");t.getContributionAsync("ms.vss-build-web.queue-panel"),t.getContributionAsync("ms.vss-build-web.common-commands"),t.getContributionAsync("ms.vss-build-web.common-library-legacy"),t.getContributionAsync("ms.vss-distributedtask-web.common-library")}}("ComponentsCommandComponent"),function(e){t[e]={};class i extends g.VssComponent{constructor(e,t){super(e,t);const i=this.context.pageContext.getService("ISourceProviderService").getSourceProvider(this.props.repositoryType),n=i?i.getCommitText(this.props.commitId):"";this.state={commitLink:"#",commitText:n}}componentDidMount(){super.componentDidMount(),this._refreshStateData()}componentDidUpdate(e,t){super.componentDidUpdate(e,t),e.repositoryId===this.props.repositoryId&&e.commitId===this.props.commitId||this._refreshStateData()}render(){const{excludeTabStop:e=!0,monospace:t,readonly:i}=this.props;let n="scroll-hidden flex-row flex-baseline";return t&&(n+=" monospaced-text"),!i&&this.state.commitLink&&this.state.commitText?m.createElement(h.FPSLink,{className:n,excludeTabStop:e,href:this.state.commitLink,subtle:!0,ariaLabel:(0,o.format)(V.CommitLabelFormat,this.state.commitText),removeUnderline:!0},m.createElement("span",{className:"text-ellipsis"},!1!==this.props.showIcon&&m.createElement(S.Icon,{iconName:"BranchCommit",className:"pipelines-icon-right-margin"}),this.state.commitText)):this.state.commitText?(n+=" bolt-table-link bolt-table-inline-link pipeline-link",m.createElement("div",{className:n},m.createElement("span",{className:"text-ellipsis","aria-label":(0,o.format)(V.CommitLabelFormat,this.state.commitText)},!1!==this.props.showIcon&&m.createElement(S.Icon,{iconName:"BranchCommit",className:"pipelines-icon-right-margin"}),this.state.commitText))):m.createElement("span",null)}_refreshStateData(){const e=this.context.pageContext.getService("ISourceProviderService").getSourceProvider(this.props.repositoryType),t=e?e.getCommitText(this.props.commitId):"";!this.props.readonly&&e?this.trackPromise(this.props.projectNamePromise||e.getProjectName(this.props.repositoryId)).promise.then((t=>this.trackPromise(e.fetchCommitLink({repositoryName:this.props.repositoryName||this.props.repositoryId,commitId:this.props.commitId,displayUri:"",repositoryUrl:this.props.repositoryUrl},t||void 0)).promise)).then((e=>{this.setState({commitLink:e,commitText:t})}),(e=>{e.isCanceled||console.log(e)})):this.setState({commitLink:"#",commitText:t})}}t[e].CommitLink=i}("ComponentsCommitLink"),function(e){t[e]={};class i extends m.Component{constructor(e){super(e),this._buttonWrapper=m.createRef(),this._onShowCopyClicked=e=>{this.setState({isCalloutVisible:!0});const t=this.props.textToCopy();if(window.clipboardData)return window.clipboardData.setData("text",t),void(this.props.onClickStopPropagation&&e.stopPropagation());const i=e=>{e.clipboardData&&(e.clipboardData.setData("text",t),e.preventDefault())};document.addEventListener("copy",i),document.execCommand("copy"),document.removeEventListener("copy",i),this.props.onClickStopPropagation&&e.stopPropagation()},this._onCalloutDismiss=()=>{this.setState({isCalloutVisible:!1})},this.state={isCalloutVisible:!1}}render(){return m.createElement("div",{ref:this._buttonWrapper,className:this.props.className},this._getRenderContents())}_getRenderContents(){return this.state.isCalloutVisible?this._getButton(V.CopiedToClipboardText):this._getButton(V.CopyToClipboardText)}_getButton(e){return m.createElement(y.Button,{subtle:!0,ariaLabel:V.ARIALabelCopyToClipboard,iconProps:{iconName:"Copy"},onClick:this._onShowCopyClicked,onBlur:this._onCalloutDismiss,tooltipProps:{showOnFocus:!0,text:e}})}}t[e].CopyToClipboardButton=i}("ComponentsCopyToClipboardButton"),function(e){t[e]={};class i extends g.VssComponent{constructor(e,t){super(e,t);const i=this.context.pageContext.getService("ISourceProviderService");this._sourceProvider=i.getSourceProvider(this.props.sourceRepositoryType),!1!==e.includeIcon&&(this._repoIconName=this._sourceProvider?this._sourceProvider.getRepoIconName():""),this.state={repoLink:""}}componentDidMount(){super.componentDidMount(),this._sourceProvider&&this.trackPromise(this._sourceProvider.getProjectName(this.props.sourceRepositoryId)).promise.then((e=>this.trackPromise(this._sourceProvider.fetchRepositoryLink({repositoryName:this.props.sourceRepositoryName||this.props.sourceRepositoryId,repositoryUrl:this.props.sourceRepositoryUrl,repositoryId:this.props.sourceRepositoryId},e||void 0)).promise)).then((e=>{this.setState({repoLink:e})}),(e=>{e.isCanceled||console.log(e)}))}render(){const e=this.props.sourceRepositoryName||this.props.sourceRepositoryId;return e?m.createElement(h.FPSLink,{className:"scroll-hidden flex-row flex-baseline",href:this.state.repoLink,subtle:!0,ariaLabel:(0,o.format)(V.RepoLabelFormat,e),removeUnderline:!0},m.createElement("span",{className:"text-ellipsis "},!1!==this.props.includeIcon&&m.createElement(S.Icon,{iconName:this._repoIconName,className:"pipelines-icon-right-margin"}),e)):m.createElement("span",null)}}t[e].RepoLink=i}("ComponentsRepoLink"),function(e){t[e]={};class i extends g.VssComponent{constructor(e,t){super(e,t),this._renderOwnerCell=(e,t,i,a)=>{const p=Math.floor((a.validUntil.getTime()-Date.now())/864e5);let u,d="lease-owner-icon",h=a.ownerDisplayName,g="",C=p>36500?V.forever:o.format(V.until,a.validUntil.toLocaleDateString());if(o.equals(a.leaseType,l,!0)&&a.leaseOwnerIdentityRef){let e=a.leaseOwnerIdentityRef;u=m.createElement(G.BuildPersona,{size:"medium",displayName:e.displayName,imageUrl:this._getAvatarUrl(e)}),g=V.RetainedByUserSecondaryText+C}else o.equals(a.leaseType,n,!0)?(u=m.createElement(S.Icon,{className:d,iconName:"OpenSource",size:"medium"}),h=V.RetainedByBranchPolicyPrimaryText,g=o.format(V.RetainedByBranchPolicySecondaryText,a.ownerDisplayName)+C):o.equals(a.leaseType,s,!0)?(u=m.createElement(S.Icon,{className:d,iconName:"Rocket",size:"medium"}),g=V.RetainedByPipelineResource+C):o.equals(a.leaseType,r,!0)?(u=m.createElement(S.Icon,{className:d,iconName:"Rocket",size:"medium"}),g=V.RetainedByReleaseSecondaryText+C):o.equals(a.leaseType,c,!0)?(u=m.createElement(S.Icon,{className:d,iconName:"Build",size:"medium"}),h=V.RetainedByPipelineRetentionPolicyPrimaryText,g=V.RetainedByPipelineRetentionPolicySecondaryText+C):(u=m.createElement(S.Icon,{className:d,iconName:"Contact",size:"medium"}),g=C);const y=m.createElement("span",{className:"padding-right-8"},u),v=m.createElement(b.Tooltip,{overflowOnly:!0,text:h},m.createElement("span",{className:"text-ellipsis"},h)),f=m.createElement("span",{className:"font-size secondary-text"},g);return m.createElement(k.TwoLineTableCell,{columnIndex:t,iconProps:{render:()=>y},key:"col-"+t+" row-"+e,line1:v,line2:m.createElement("span",{className:"font-size secondary-text"},f)})},this._renderDeleteCell=(e,t,i,n)=>m.createElement(k.SimpleTableCell,{columnIndex:t,tableColumn:i,key:"col-"+t,contentClassName:"scroll-hidden"},m.createElement(y.Button,{ariaLabel:V.DeleteRetentionLeaseMessage,className:"bolt-list-cell-content-reveal",disabled:!this.props.canDeleteLeases,iconProps:{iconName:"Delete"},onClick:e=>{this.props.onDelete([n.id]),e.preventDefault()},subtle:!0,tooltipProps:{text:V.DeleteRetentionLeaseMessage}})),this._getAvatarUrl=e=>{if(e){if(e.imageUrl)return e.imageUrl;const t=(0,O.getAvatarUrl)(e);if(t)return t;if(e.id)return(0,f.getIdentityImageUrl)(this.context.pageContext,e.id)}return""},this._columns=[{id:"lease-owner",width:new a.ObservableValue(413),name:V.LeaseOwnerColumnHeader,renderCell:this._renderOwnerCell,columnStyle:2},{id:"delete-lease",width:new a.ObservableValue(51),renderCell:this._renderDeleteCell,columnStyle:1}];const i=(0,v.getTFSPageData)(this.context.pageContext);i&&i.project&&(this._projectId=i.project.id)}render(){return m.createElement(T.CustomPanel,{onDismiss:this.props.onDismiss},m.createElement(T.PanelHeader,{titleProps:{text:V.RetentionLeasesPanelHeading,size:1},description:V.RetentionPanelDescription,onDismiss:this.props.onDismiss}),m.createElement(T.PanelContent,{className:"no-padding"},m.createElement("div",{className:"custom-scrollbar flex-column flex-grow h-scroll-hidden"},m.createElement("div",{className:"h-scroll-hidden"},m.createElement(k.Table,{ariaLabel:V.RetentionTableName,columns:this._columns,itemProvider:this.props.retentionLeases,selectableText:!0,rowHeight:60})),m.createElement(_.Observer,{leases:this.props.retentionLeases},(e=>0===e.leases.length?m.createElement("span",{className:"no-leases-span font-size-ms secondary-text"},V.RunNotRetained):null)))),m.createElement(_.Observer,{leases:this.props.retentionLeases},(e=>{const t=(0,d.routeUrl)(this.context.pageContext,"ms.vss-build-web.build-settings-route",{projectId:this._projectId});return m.createElement(T.PanelFooter,{className:"flex-row justify-space-between"},m.createElement(I.Link,{className:"a-link",href:t,target:"_blank"},V.ProjectRetentionSettingsLink),m.createElement(P.ButtonGroup,null,m.createElement(y.Button,{text:V.ClosePanelButton,onClick:this.props.onDismiss}),m.createElement(y.Button,{text:V.DeleteRetentionLeases,disabled:0===e.leases.length,onClick:()=>{let e=this.props.retentionLeases.value.map((e=>e.id));this.props.onDelete(e)},primary:!0})))})))}}t[e].RetentionPanel=i;const n="Branch",s="Build",r="RM",l="User",c="Pipeline"}("ComponentsRetentionPanel"),function(e){t[e]={};t[e].getStateFilterItems=()=>{const e=(0,H.getStatusIndicatorData)(H.Status.Queued),t=(0,H.getStatusIndicatorData)(H.Status.InProgress),n=(0,H.getStatusIndicatorData)(H.Status.Succeeded),s=(0,H.getStatusIndicatorData)(H.Status.Failed),r=(0,H.getStatusIndicatorData)(H.Status.Cancelled),o=(0,H.getStatusIndicatorData)(H.Status.Skipped),a=(0,H.getStatusIndicatorData)(H.Status.Waiting),l=(0,H.getStatusIndicatorData)(H.Status.Warning);return[{id:H.Status.Failed,text:V.StageStatusFailed,data:H.Status.Failed,iconProps:{render:()=>m.createElement(i.Status,Object.assign({},s.statusProps,{size:"16",animated:!1}))}},{id:H.Status.Waiting,text:V.StageStatusWaiting,data:H.Status.Waiting,iconProps:{render:()=>m.createElement(i.Status,Object.assign({},a.statusProps,{size:"16",animated:!1}))}},{id:H.Status.Warning,text:V.StageStatusWarning,data:H.Status.Warning,iconProps:{render:()=>m.createElement(i.Status,Object.assign({},l.statusProps,{size:"16",animated:!1}))}},{id:H.Status.InProgress,text:V.StageStatusRunning,data:H.Status.InProgress,iconProps:{render:()=>m.createElement(i.Status,Object.assign({},t.statusProps,{size:"16",animated:!1}))}},{id:H.Status.Succeeded,text:V.StageStatusSuccess,data:H.Status.Succeeded,iconProps:{render:()=>m.createElement(i.Status,Object.assign({},n.statusProps,{size:"16",animated:!1}))}},{id:H.Status.Queued,text:V.StageStatusQueued,data:H.Status.Queued,iconProps:{render:()=>m.createElement(i.Status,Object.assign({},e.statusProps,{size:"16",animated:!1}))}},{id:H.Status.Skipped,text:V.StageStatusSkipped,data:H.Status.Skipped,iconProps:{render:()=>m.createElement(i.Status,Object.assign({},o.statusProps,{size:"16",animated:!1}))}},{id:H.Status.Cancelled,text:V.StageStatusCanceled,data:H.Status.Cancelled,iconProps:{render:()=>m.createElement(i.Status,Object.assign({},r.statusProps,{size:"16",animated:!1}))}}]};class n extends m.Component{constructor(e){var t;super(e),this._sendTelemetryForSearch=!0,this._titleFilterKey="titleFilter",this._statusFilterKey="statusFilter",this._onFilterChanged=()=>{const e=this._stageFilter.getFilterItemState(this._titleFilterKey),t=this._stageFilter.getFilterItemState(this._statusFilterKey);let i=[...this.props.stages.value];(e||t)&&(i=this._performSearch(null==e?void 0:e.value,null==t?void 0:t.value)),this._itemProvider.splice(0,this._itemProvider.length,...i),this.state.foundResultCount!=i.length&&this.setState({foundResultCount:i.length})},this._performSearch=(e,t)=>{let i=[...this.props.stages.value];if(e){const t=null==e?void 0:e.toLowerCase();i=i.filter((e=>-1!==e.name.toLowerCase().indexOf(t))),this._sendTelemetryForSearch&&(this._publishTelemetryEvent(j.TelemetryConstants.StagePanelSearch),this._sendTelemetryForSearch=!1)}return t&&t.length>0&&(i=i.filter((e=>{const i=(0,H.getTimelineStatusIndicatorData)(e.state,e.result,e.stateData?e.stateData.pendingChecks:void 0,e.stateData?!e.stateData.pendingDependencies:void 0);return t.includes(i.type)})),this._currentStatusesSelected!=t&&(this._publishTelemetryEvent(j.TelemetryConstants.StagePanelFilter,{States:t}),this._currentStatusesSelected=t)),e||t&&0!=t.length||this._stageFilter.reset(),i},this._publishTelemetryEvent=(e,t={})=>{const i=this.props.pageContext.getService("IVssTelemetryService"),n={ProjectId:this._projectId,BuildId:this.props.buildId,DefinitionName:this.props.pipelineName},s=Object.assign(n,t);i.publishEvent(j.TelemetryConstants.Area,e,s)},this._onActivateRow=(e,t,i,n)=>{if(!t.data)return;const s=n.getService("IBuildLinkingService"),r={};r[j.NavConstants.stage]=t.data.id;const o=s.getBuildUrl(i,j.NavConstants.logs,void 0,void 0,r),a={ProjectId:this._projectId,BuildId:this.props.buildId,DefinitionName:this.props.pipelineName};(0,N.onClickFPS)(n,o,!0,e,{telemetrySource:j.TelemetryConstants.StagePanelLogs,telemetryProperties:a})},this._renderDescriptionCell=(e,t,i,n,s)=>m.createElement(k.SimpleTableCell,{columnIndex:t,tableColumn:i,key:"col-"+t},m.createElement("span",{className:"stages-panel-status-icon"},this._renderBuildStatus(n)),m.createElement("span",{"aria-label":n.name},n.name)),this._renderTimeStartedCell=(e,t,i,n,s)=>n.startTime?m.createElement(k.SimpleTableCell,{columnIndex:t,tableColumn:i,key:"col-"+t},m.createElement("div",{className:"flex-row flex-center fontSize"},n.startTime&&m.createElement(w.Ago,{date:n.startTime,format:0,tooltipProps:{renderContent:()=>(0,o.format)(V.AgoTooltip,(0,L.tooltipString)(n.startTime))}}))):m.createElement(k.SimpleTableCell,{columnIndex:t,tableColumn:i,key:"col-"+t},m.createElement("div",null)),this._renderTimeElapsedCell=(e,t,i,n,s)=>n.startTime&&n.finishTime?m.createElement(k.SimpleTableCell,{columnIndex:t,tableColumn:i,key:"col-"+t},m.createElement("div",{className:"flex-row flex-center fontSize bolt-table-two-line-cell-item"},n.startTime&&n.finishTime&&m.createElement(R.Duration,{startDate:n.startTime,endDate:n.finishTime,tooltipProps:{renderContent:()=>(0,o.format)(V.DurationTooltip,(0,L.tooltipString)(n.startTime))}}))):m.createElement(k.SimpleTableCell,{columnIndex:t,tableColumn:i,key:"col-"+t},m.createElement("div",null)),this._renderBuildStatus=e=>{const t=(0,H.getTimelineStatusIndicatorData)(e.state,e.result,e.stateData?e.stateData.pendingChecks:void 0,e.stateData?!e.stateData.pendingDependencies:void 0);return m.createElement(b.Tooltip,{text:e.name},m.createElement("span",{className:"flex-row"},m.createElement(i.Status,Object.assign({size:"16"},t.statusProps,{ariaLabel:t.label}))))},this._initTableColumns=()=>{this._columns=[{id:"description",width:-40,ariaLabel:V.StagesTableDescription,name:V.StagesTableDescription,className:"stages-table-cell",renderCell:this._renderDescriptionCell,columnStyle:2},{id:"started",width:-25,ariaLabel:V.StagesTableStarted,name:V.StagesTableStarted,className:"stages-table-cell",renderCell:this._renderTimeStartedCell},{ariaLabel:V.StagesTableElapsed,id:"elapsed",name:V.StagesTableElapsed,width:-25,className:"stages-table-cell",renderCell:this._renderTimeElapsedCell}];const e=new k.ColumnMore(this._getMenuForItem,this._showMenuForItem,void 0,40);e.widthStyle=0,this._columns.push(e)},this._getMenuForItem=e=>{var t;const i=(0,v.getTFSPageData)(this.props.pageContext),n=null===(t=null==i?void 0:i.project)||void 0===t?void 0:t.id,s=[];if(this._canRetry(e)){const t=this._isFailed(e)?V.RerunFromFailed:V.RerunStage;s.push({text:t,id:"re-run-stage",onActivate:()=>{this._onRetryActivate(e,(0,o.format)(this._isFailed(e)?V.ConfirmRerunStageFailedJobs:V.ConfirmRerunStage,e.name),!1,t,n)}}),this._isFailed(e)&&s.push({text:V.RerunAll,id:"re-run-stage-all",onActivate:()=>{this._onRetryActivate(e,(0,o.format)(V.ConfirmRerunStage,e.name),!0,V.RerunAll,n)}})}const r={buildId:this.props.buildId,buildNumber:this.props.buildNumber,pipelineName:this.props.pipelineName,sourceVersionMessage:this.props.sourceVersionMessage,projectId:n,stage:e},a=(0,x.getMenuItems)(this.props.pageContext,"ms.vss-build-web.stages-panel-context-menu",r);return s.push(...a.value),{id:"stage-actions-menu",items:s}},this._confirmAction=(e,t,i)=>{this.props.pageContext.getService("IVssLayoutManager").renderCallout((n=>{const s={title:e,message:t,onClose:n,onConfirm:i};return m.createElement(K.CommandComponent,Object.assign({commandType:"ciDConfirmPipelineComponent"},s),null)}))},this._canRetry=e=>2===e.state&&this.props.canQueueBuild&&(this._isSucceded(e)||this._isFailed(e)),this._isSucceded=e=>0===e.result||1===e.result,this._isFailed=e=>2===e.result||3===e.result,this._showMenuForItem=e=>{const t=(0,x.getMenuItems)(this.props.pageContext,"ms.vss-build-web.stages-panel-context-menu",e);return this._canRetry(e)||t.length>0},this._onRetryActivate=(e,t,i,n,s)=>{const r=this.props.pageContext.getRestClient("IBuildRestClient");this._confirmAction(V.RerunStage,t,(()=>{const t={state:1,forceRetryAllJobs:i};this._publishTelemetryEvent(j.TelemetryConstants.StagePanelAction,{ActionName:n}),r.updateStage(t,this.props.buildId,e.refName?e.refName:e.name,s).catch((e=>this.handleError(e)))}))},this._renderStagesTable=e=>{if(0==this.state.foundResultCount){const e=V.NoResultsFound;return D.announce(e),m.createElement("div",{className:"stages-panel-no-results"},e)}return m.createElement(k.Table,{ariaLabel:e,className:"stages-table sticky-table",columns:this._columns,itemProvider:this._itemProvider,onActivate:(e,t)=>this._onActivateRow(e,t,this.props.buildId,this.props.pageContext),showHeader:e=>e>=1,spacerWidth:8,showScroll:!0,scrollable:!0})},this._itemProvider=new a.ObservableArray([...e.stages.value]),this._initTableColumns(),this._stageFilter=new U.Filter;const n=(0,v.getTFSPageData)(this.props.pageContext);this._projectId=null===(t=null==n?void 0:n.project)||void 0===t?void 0:t.id,this.state={foundResultCount:e.stages.length,showError:!1,errorMessage:"",messageSeverity:"Info"}}componentDidMount(){this.props.stages.subscribe(this._onFilterChanged),this._stageFilter.subscribe(this._onFilterChanged,U.FILTER_CHANGE_EVENT),this._publishTelemetryEvent(j.TelemetryConstants.StagePanelShow)}componentDidUnMount(){this.props.stages.unsubscribe(this._onFilterChanged),this._stageFilter.unsubscribe(this._onFilterChanged,U.FILTER_CHANGE_EVENT)}render(){const i=(0,z.formatPipelineRunName)(this.props.buildNumber,this.props.sourceVersionMessage,this.props.appendCommitMessageToRunName);return m.createElement(T.CustomPanel,{onDismiss:this.props.onDismiss,className:"stages-panel"},m.createElement(T.PanelHeader,{titleProps:{text:i},description:this.props.pipelineName,onDismiss:this.props.onDismiss}),m.createElement(T.PanelContent,{className:"panel-content-container"},m.createElement("div",{className:"stages-panel-filter-bar"},m.createElement(A.KeywordFilterBarItem,{className:"stages-panel-title-filter",placeholder:V.StagesFilterName,filterItemKey:this._titleFilterKey,filter:this._stageFilter}),m.createElement(E.DropdownFilterBarItem,{className:"stages-panel-status-filter",filterItemKey:this._statusFilterKey,placeholder:V.StagesFilterStatus,containerClassName:"status-dropdown",items:(0,t[e].getStateFilterItems)(),filter:this._stageFilter,selection:new B.ListSelection({multiSelect:!0,alwaysMerge:!0,selectOnFocus:!1})})),this.state.showError&&m.createElement("div",{className:"margin-vertical-8 padding-horizontal-20"},m.createElement(F.MessageCard,{severity:this.state.messageSeverity},m.createElement("span",{className:"multiline-error"},this.state.errorMessage))),this._renderStagesTable(i)))}handleError(e){e&&e.message&&this.setState({errorMessage:e.message,showError:!0,messageSeverity:"Error"})}}t[e].StagesPanel=n}("ComponentsStagesPanel"),function(e){t[e]={};class i extends g.VssComponent{constructor(e,t){super(e,t),this._closeConnectionCard=()=>{this.setState({bannerClosed:!0})};const i=t.pageContext.getService("IBuildLinkingService").getDefinitionEditUrl(e.definition.id,"Tab_Tasks"),n={bannerClosed:!1,buttonProps:{text:V.EditPipeline,onClick:()=>(0,N.onClickFPS)(this.context.pageContext,i,!0)}};this.state=n}render(){return this.state.bannerClosed?m.createElement(m.Fragment,null):m.createElement("div",{className:(0,g.css)("page-content","flex-row","flex-noshrink",this.props.className)},m.createElement(F.MessageCard,{className:"flex-grow",severity:"Error",onDismiss:this._closeConnectionCard,buttonProps:[this.state.buttonProps]},m.createElement(M.FormatComponent,{format:V.UpdateBitBucketConnection})))}}t[e].UpdateBitbucketServiceConnectionHeader=i}("ComponentsUpdateBitbucketServiceConnectionHeader"),function(e){t[e]={};class i extends g.VssComponent{constructor(e,t){super(e,t),this._closeConnectionCard=()=>{this.setState({useAppConnectionAction:void 0})},this._switchToAppConnection=async e=>{const t=this.state.definition;t.repository.properties=t.repository.properties||[],t.repository.properties.connectedServiceId=e,this._closeConnectionCard();try{await this.pipelineService.savePipeline(t);const e=this.context.pageContext.getService("IVssContributionService");await e.getDataAsync("ms.vss-build-web.pipeline-edit-continuation-data-provider",{complete:!0},!0),this.setState({definition:t},this._closeConnectionCard);this.context.pageContext.getService("IVssTelemetryService").publishEvent("Build","UpgradeServiceConnectionHeader.AppConnectionUpgradeFromOAuth",{GitHubApp:"AddAppConnection",GitHubAppRepo:t.repository.id,action:"ChangeConnectionToGitHubApp"}),this.state.connection.autoUpgradeToAppConnection||this.globalMessageService.addToast({message:V.ConnectionChanged,duration:this.ToastDuration})}catch(e){this.context.pageContext.getService("IVssTelemetryService").publishEvent("Build","UpgradeServiceConnectionHeader.AppConnectionUpgradeFromOAuthError",{message:e&&e.message,e:e}),this.globalMessageService.addToast({message:V.SavePipelineErrorMessage,duration:this.ToastDuration})}},this._installApp=async(e,t,i,n)=>{this.context.pageContext.getService("IInstallAppService").installAppForEdit(e,t,i,n)},this.ToastDuration=5e3;const i={useAppConnectionAction:void 0,useAppConnectionDescription:V.PreferAppConnectionChange,connection:this.props.connection||{},definition:this.props.definition||{}};this.state=i}componentDidMount(){super.componentDidMount(),this._checkForAppConnectionUpgrade()}render(){return this.state.useAppConnectionAction?m.createElement("div",{className:(0,g.css)("page-content","flex-row","flex-noshrink",this.props.className)},m.createElement(F.MessageCard,{className:"flex-grow",severity:"Info",onDismiss:this._closeConnectionCard,buttonProps:[this.state.useAppConnectionAction]},m.createElement(M.FormatComponent,{format:this.state.useAppConnectionDescription},m.createElement(h.FPSLink,{href:this.state.connection.appHelpLink},this.state.connection.appName)))):m.createElement(m.Fragment,null)}_getRecommendedServiceConnection(e,t){const i=this.context.pageContext.getService("IVssContributionService"),n="ms.vss-build-web.app-serviceconnections-recommendation-data-provider",s={sourceProvider:this._getSourceProvider().getKey(),repositoryId:e.repository.id,repositoryName:e.repository.name,connectionId:this.state.connection.connectionId,strongBoxKey:"useWellKnownStrongBoxLocation",createOAuthConnectionIfNeeded:!1,login:this.state.connection.login};return i.getDataAsync(n,s,!0).then((e=>{if(!e){const e=i.getDataProviderExceptions()[n];throw new Error(e&&e.message)}return e}))}_getSourceProvider(){const e=this.context.pageContext.getService("ISourceProviderService");return this.state.definition&&e.getSourceProvider(this.state.definition.repository.type)}async _checkForAppConnectionUpgrade(){if(!this.state.connection.isAppConnection&&this.state.connection.appName)try{const e=this.state.definition,t=this.state.connection.nonce,i=await this._getRecommendedServiceConnection(e,t),n=i.commonConnectionId;if(n)if(this.state.connection.autoUpgradeToAppConnection)this._switchToAppConnection(n);else{const e={text:V.ChangeToAppConnection,onClick:()=>this._switchToAppConnection(n)};this.setState({useAppConnectionAction:e,useAppConnectionDescription:V.PreferAppConnectionChange})}else if(!i.appInstalledForRepository&&i.userCanInstall){const n={text:V.InstallApp,onClick:()=>this._installApp(e.id,t,i.installAppUrlRoot,e.repository)};this.setState({useAppConnectionAction:n,useAppConnectionDescription:V.PreferAppConnectionInstall})}}catch(e){this.context.pageContext.getService("IVssTelemetryService").publishEvent("Build","UpgradeServiceConnectionHeader.CheckForAppConnectionUpgradeError",{message:e&&e.message,error:e})}}get pipelineService(){return this.context.pageContext.getService("IPipelineService")}get globalMessageService(){return this.context.pageContext.getService("IGlobalMessagesService")}}t[e].UpgradeServiceConnectionHeader=i}("ComponentsUpgradeServiceConnectionHeader")}),["Resources","Array","Constants","Contracts","ContributedExtension.types","Duration","ErrorHandler","Identity","Indicator","Navigation","InstallAppService","PipelineResourcesService","PipelineRunNameFormatter","PipelineService","PipelinesL2Header","PipelinesStateData","PipelineTriggerSettings","RepositoryService","Stores/Permissions","Security","SignalRHubProxies","SingletonManager","Sources/Build","StateHandler","String","TaskCheckLogLineService","Components/BranchLink","Components/BuildPersona","Components/CommandComponent","Components/CommitLink","Components/CopyToClipboardButton","Components/RepoLink","Components/RetentionPanel","Components/StagesPanel","Components/UpdateBitbucketServiceConnectionHeader","Components/UpgradeServiceConnectionHeader"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-build-web.common-library"}}));
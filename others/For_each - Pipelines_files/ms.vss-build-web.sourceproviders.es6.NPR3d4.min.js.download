"use strict";define("Build/SourceProviders",["require","exports","VSS/Core/Util/String","VSS/Platform/Trace","VSS/Platform/Feature","VSS/Platform/UserClaims","VSS/Platform/Context"],(function(e,t,r,i,n,o,s){var a,c,u,m,l,h,g,p,f,y,k,C,N,_,v;a=t[v="Resources"]={},t[v].Bitbucket="Bitbucket",t[v].ExternalGit="External Git",t[v].GitHub="GitHub",t[v].GitHubEnterprise="GitHub Enterprise",t[v].Svn="SVN",t[v].TfsGit="Azure Repos",t[v].TfsVersionControl="Team Foundation Version Control",t[v].ExternalUnknown="External Unknown",t[v].CommitId="commit {0}",function(e){c=t[e]={},function(e){e.TfsVersionControl="TfsVersionControl".toLowerCase(),e.TfsGit="TfsGit".toLowerCase(),e.ExternalUnknown="ExternalUnknown".toLowerCase(),e.ExternalGit="Git".toLowerCase(),e.GitHub="GitHub".toLowerCase(),e.GitHubProxima="GitHubProxima".toLowerCase(),e.GitHubEnterprise="GitHubEnterprise".toLowerCase(),e.Bitbucket="Bitbucket".toLowerCase(),e.Svn="Svn".toLowerCase()}(t[e].RepositoryTypes||(t[e].RepositoryTypes={}))}("Common"),function(e){u=t[e]={};t[e].Base=class{constructor(e){this.pageContext=e,this.emptyNullPromise=Promise.resolve(null)}getName(){return""}getRepoIconName(){return""}getNormalizedBranch(e,t){return e}getNormalizedCommit(e){return e}getCommitIconName(){return"BranchCommit"}getProjectName(e){return this.emptyNullPromise}fetchBranchLink(e,t){return this.emptyNullPromise}fetchContentLinks(e){return this.emptyNullPromise}fetchContentLink(e){return this.emptyNullPromise}fetchRepositoryLink(e,t){return this.emptyNullPromise}fetchPRCommitLink(e,t){return this.emptyNullPromise}fetchCommitDiffLink(e,t){return this.emptyNullPromise}fetchLinks(e){return this.vcNavigationService.then((t=>{let r=[];return(e||[]).forEach((e=>{r.push({originalId:e.commitId,commitId:this.getCommitText(e.commitId),branchLink:this._getBranchLink({branchName:e.branchName,links:e.links,repositoryName:e.repositoryName,repositoryUrl:e.repositoryUrl},t,e.projectName),commitLink:this._getCommitLink({commitId:e.commitId,displayUri:e.displayUri,repositoryName:e.repositoryName},t,e.projectName),repositoryLink:this._getRepositoryLink({repositoryName:e.repositoryName,repositoryUrl:e.repositoryUrl},t,e.projectName)})})),r}))}fetchPullrequestData(e){return this.emptyNullPromise}getBranchText(e){return e}getBranchIconName(e){return"OpenSource"}fetchCommitLink(e,t){return this.emptyNullPromise}getCommitText(e){return e||""}getMaxWorkItems(){}fetchShelvesets(e){return Promise.resolve([])}get vcNavigationService(){return this._vcNavigationService||(this._vcNavigationService=this.getVcCode().then((()=>this.pageContext.getService("IVCNavigationService")))),this._vcNavigationService}getVcCode(){if(!this._vcContributionPromise){const e=this.pageContext.getService("IVssContributionService");this._vcContributionPromise=e.getContributionAsync("ms.vss-code-web.common-content")}return this._vcContributionPromise}_getBuildClient(){return this._buildClient||(this._buildClient=this.pageContext.getRestClient("IBuildRestClient")),this._buildClient}_getBranchLink(e,t,r){return""}_getCommitLink(e,t,r){return""}_getRepositoryLink(e,t,r){return""}}}("Base"),function(e){m=t[e]={},t[e].ShortenedCommitHashLength=8,t[e].GitHubProximaSuffix="ghe.com"}("Constants"),function(e){l=t[e]={};class i extends u.Base{getRepoIconName(){return"ExternalGit"}getBranchText(e){const t=this._normalizeBranchName(e);if((0,r.startsWith)(t,"refs/pull/")){const e=this._getPullRequestId(t);if(e)return e.toString()}return t}getBranchIconName(e){return(0,r.startsWith)(e,"refs/pull/")||(0,r.startsWith)(e,"refs/heads/refs/pull/")?"BranchPullRequest":(0,r.startsWith)(e,"refs/tags")?"Tag":super.getBranchIconName(e)}getCommitText(e){return e?e.slice(0,m.ShortenedCommitHashLength):""}fetchPullrequestData(e){if(e.pullRequestNumber)return this._queryPullRequest(e,e.pullRequestNumber);const t=this._getPullRequestId(e.branchName);return void 0!==t?this._queryPullRequest(e,t.toString()):Promise.resolve(null)}_getPullRequestId(e){if(0===(e=this._normalizeBranchName(e||"")).indexOf("refs/pull/")){const t=e.substring(10).trim().split("/",2);if(2!==t.length)return;if("merge"!==t[1].trim().toLowerCase())return;const r=parseInt(t[0].trim());if(!isNaN(r))return r}}_normalizeBranchName(e){return(0,r.startsWith)(e,"refs/heads/")?e.substring(11):(0,r.startsWith)(e,"refs/tags/")?e.substring(10):e}_queryPullRequest(e,t){return this._getBuildClient().getPullRequest(e.projectId,this.getKey(),t,e.repositoryName,e.serviceEndpointId).then((e=>({id:parseInt(e.id,10),title:e.title,sourceRepositoryOwner:e.sourceRepositoryOwner,sourceBranch:this.getBranchText(e.sourceBranchRef),targetRepositoryOwner:e.targetRepositoryOwner,targetBranch:this.getBranchText(e.targetBranchRef),rawSourceBranch:e.sourceBranchRef,rawTargetBranch:e.targetBranchRef,url:e._links.web.href})))}}t[e].BaseGit=i}("BaseGit"),function(e){h=t[e]={};class r extends u.Base{getKey(){return c.RepositoryTypes.ExternalUnknown}getName(){return a.ExternalUnknown}fetchBranchLink(e){return Promise.resolve(this._getBranchLink(e))}fetchCommitLink(e){return Promise.resolve(this._getCommitLink(e))}getBranchLink(e){return this._getBranchLink(e)}getCommitLink(e){return this._getCommitLink(e)}_getBranchLink(e,t){if(e.links){const t=e.links.sourceVersionDisplayUri;if(t&&t.href)return t.href}return""}_getCommitLink(e,t){return e.displayUri?e.displayUri:""}}t[e].ExternalUnknown=r}("ExternalUnknown"),function(e){g=t[e]={},t[e].area="vss-build-web.common.sourceproviders"}("TraceNames"),function(e){p=t[e]={};class r extends l.BaseGit{constructor(e){super(e),this._externalRepo=new h.ExternalUnknown(e)}getKey(){return c.RepositoryTypes.Bitbucket}getName(){return a.Bitbucket}getRepoIconName(){return"BitbucketLogo32"}fetchRepositoryLink(e,t){return Promise.resolve(this._getRepositoryLinkInternal(e.repositoryName))}fetchBranchLink(e,t){return Promise.resolve(this._getBranchLinkInternal(e))}fetchCommitLink(e,t){return Promise.resolve(this._getCommitLinkInternal(e))}_getRepositoryLink(e,t){return this._getRepositoryLinkInternal(e.repositoryName)}_getBranchLink(e,t){return this._getBranchLinkInternal(e)}_getCommitLink(e,t){return this._externalRepo.getCommitLink(e)}_getRepositoryLinkInternal(e){if(!e)return console.error("Name is required to create a link to the repository"),"";e.indexOf("bitbucket.org")>0&&(0,i.traceWarning)(this.pageContext,g.area,"Bitbucket","Data shape issue: repositoryName may be a URL");const t=e.split("/",3);return 2===t.length&&t[0]&&t[1]?`${r.s_BitbucketPrefix}/${e}`:(console.error(`Repository name "${e}" is not in the expected format ("user/repository")`),"")}_getBranchLinkInternal(e){if(e.repositoryName&&e.branchName){const t=this._normalizeBranchName(e.branchName);return`${this._getRepositoryLinkInternal(e.repositoryName)}/branch/${t}`}return this._externalRepo.getBranchLink(e)}_getCommitLinkInternal(e){return e.repositoryName&&e.commitId?`${this._getRepositoryLinkInternal(e.repositoryName)}/commits/${e.commitId}`:this._externalRepo.fetchCommitLink(e)}}t[e].Bitbucket=r,r.s_BitbucketPrefix="https://bitbucket.org"}("Bitbucket"),function(e){f=t[e]={};class r extends l.BaseGit{getKey(){return c.RepositoryTypes.ExternalGit}getName(){return a.ExternalGit}fetchRepositoryLink(e,t){return Promise.resolve(this._getRepositoryLinkInternal(e.repositoryId))}_getRepositoryLink(e,t){return this._getRepositoryLinkInternal(e.repositoryId)}_getRepositoryLinkInternal(e){return e||""}}t[e].ExternalGit=r}("ExternalGit"),function(e){y=t[e]={};t[e].isProximaRepository=(e,t)=>{if(!(null==t?void 0:t.repositoryUrl))return!1;try{const e=new URL(t.repositoryUrl);if(e.host.endsWith(`.${m.GitHubProximaSuffix}`))return!0}catch(t){(0,i.traceWarning)(e,g.area,"GitHubProxima","Data shape issue: repositoryUrl is not a valid URL")}return!1};class r extends l.BaseGit{constructor(e){super(e),this._externalRepo=new h.ExternalUnknown(e)}getKey(){return c.RepositoryTypes.GitHub}getName(){return a.GitHub}fetchBranchLink(e,t){return Promise.resolve(this._getBranchLinkInternal(e))}fetchCommitLink(e,t){return Promise.resolve(this._getCommitLinkInternal(e))}fetchRepositoryLink(e,t){return Promise.resolve(this._getRepositoryUrl(e))}fetchPRCommitLink(e,t){if(e.repositoryName&&e.branchName){const t=this._getPullRequestId(e.branchName);if(t)return Promise.resolve(`${this._getPullRequestUrl(t,e)}/commits`)}return this.emptyNullPromise}fetchCommitDiffLink(e,t){let r="";return e.repositoryName&&e.baseCommitId&&e.targetCommitId&&(r=`${this._getRepositoryUrl(e)}/compare/${e.baseCommitId}...${e.targetCommitId}`),Promise.resolve(r)}getRepoIconName(){return"GitHubLogo"}getMaxWorkItems(){return 10}_getBranchLink(e,t){return this._getBranchLinkInternal(e)}_getRepositoryLink(e,t){return this._getRepositoryUrl(e)}_getCommitLink(e,t){return this._getCommitLinkInternal(e)}_getBranchLinkInternal(e){if(e.repositoryName&&e.branchName){const t=this._getPullRequestId(e.branchName);if(t)return this._getPullRequestUrl(t,e);const r=this._normalizeBranchName(e.branchName);return`${this._getRepositoryUrl(e)}/tree/${r}`}return this._externalRepo.getBranchLink(e)}_getPullRequestUrl(e,t){return`${this._getRepositoryUrl(t)}/pull/${e}`}_getCommitLinkInternal(e){return e.repositoryName&&e.commitId?`${this._getRepositoryUrl(e)}/commit/${e.commitId}`:this._externalRepo.getCommitLink(e)}_getRepositoryUrl(o){if((0,n.isFeatureFlagEnabled)(this.pageContext,"Pipelines.GitHubProximaInstallationFlowEnabled",!1)&&o.repositoryUrl&&o.repositoryUrl.indexOf(m.GitHubProximaSuffix)>0&&o.repositoryUrl&&(0,t[e].isProximaRepository)(this.pageContext,o)){const e=o.repositoryUrl.replace(/\.git$/g,"");return e.endsWith(m.GitHubProximaSuffix)?`${e}/${o.repositoryName}`:e}const s=o.repositoryName;if(!s)return console.error("Name is required to create a link to the repository"),"";if(s.startsWith(r.s_GitHubPrefix))return(0,i.traceWarning)(this.pageContext,g.area,"GitHub","Data shape issue: repositoryName may be a URL"),s.replace(/\.git$/g,"");const a=s.split("/",3);return 2===a.length&&a[0]&&a[1]?`${r.s_GitHubPrefix}/${s}`:(console.error(`Repository name "${s}" is not in the expected format ("user/repository")`),"")}}t[e].GitHub=r,r.s_GitHubPrefix="https://github.com"}("GitHub"),function(e){k=t[e]={};class r extends l.BaseGit{constructor(e){super(e),this._externalRepo=new h.ExternalUnknown(e)}getKey(){return c.RepositoryTypes.GitHubEnterprise}getName(){return a.GitHubEnterprise}fetchBranchLink(e){return this._externalRepo.fetchBranchLink(e)}fetchCommitLink(e){return this._externalRepo.fetchCommitLink(e)}fetchRepositoryLink(e,t){return Promise.resolve(this._getRepoUrl(e.repositoryUrl))}_getBranchLink(e,t){const r=this._getRepoUrl(e.repositoryUrl);if(r&&e.branchName){return`${r}/tree/${this._normalizeBranchName(e.branchName)}`}return this._externalRepo.getBranchLink(e)}_getRepositoryLink(e,t){return this._getRepoUrl(e.repositoryUrl)}_getCommitLink(e,t){return this._externalRepo.getCommitLink(e)}getRepoIconName(){return"GitHubLogo"}getMaxWorkItems(){return 10}_getRepoUrl(e){return e?e.endsWith(".git")?e.slice(0,e.length-4):e:""}}t[e].GitHubEnterprise=r}("GitHubEnterprise"),function(e){C=t[e]={};class i extends l.BaseGit{constructor(){super(...arguments),this.knownRepositories={}}getKey(){return c.RepositoryTypes.TfsGit}getName(){return a.TfsGit}getRepoIconName(){return"GitLogo"}fetchBranchLink(e,t){return this.vcNavigationService.then((r=>this._getBranchLink(e,r,t)))}fetchCommitLink(e,t){return this.vcNavigationService.then((r=>r.getGitCommitUrl(e.commitId,e.repositoryName||"",t)))}fetchPRCommitLink(e,t){if(e.repositoryName&&e.branchName){const r=this._getPullRequestId(e.branchName);if(r)return this.vcNavigationService.then((i=>`${i.getPullRequestUrl(r,e.repositoryName,t)}?_a=commits`))}return this.emptyNullPromise}fetchCommitDiffLink(e,t){return this.vcNavigationService.then((r=>r.getGitCompareCommitsUrl(e.baseCommitId,e.targetCommitId,e.repositoryName||"",t)))}fetchContentLinks(e){return this.vcNavigationService.then((t=>{const r=[];return(e||[]).forEach((e=>{const i=this._getContentLink(e,t);i&&r.push({id:e.id,link:i})})),r}))}fetchContentLink(e){return e.repositoryName?this.vcNavigationService.then((t=>this._getContentLink(e,t))):this.emptyNullPromise}fetchRepositoryLink(e,t){return e.repositoryName?this.vcNavigationService.then((r=>this._getRepositoryLink(e,r,t))):this.emptyNullPromise}getProjectName(e){return(0,o.userHasClaim)(this.pageContext,"member")?(this.knownRepositories[e]||(this.knownRepositories[e]=this.gitClient.then((t=>t.getRepository(e)))),this.knownRepositories[e].then((e=>e.project&&e.project.name),(()=>null))):Promise.resolve("")}get gitClient(){return this._gitClient||(this._gitClient=this.getVcCode().then((()=>this.pageContext.getRestClient("IGitRestClient")))),this._gitClient}_getBranchLink(e,t,r){const i=this._getPullRequestId(e.branchName);return i?t.getPullRequestUrl(i,e.repositoryName,r):t.getRefUrl(e.branchName,e.repositoryName,r)}_getCommitLink(e,t,r){return t.getGitCommitUrl(e.commitId,e.repositoryName||"",r)}_getRepositoryLink(e,t,r){return t.getRepositoryUrl(e.repositoryName,r)}_getContentLink(e,t){let r="plain";e.isError&&(r="error");return t.getRepositoryUrl(e.repositoryName,void 0,void 0,void 0,{line:e.lineNumber,lineStyle:r,lineTooltip:e.lineTooltip,version:this._getGitVersionSpec(e.version),path:e.path,_a:"contents"})}_getGitVersionSpec(e){return(0,r.startsWith)(e,"GC")||(e="GC"+e),e}}t[e].TfsGit=i}("TfsGit"),function(){N=t.Svn={};class e extends u.Base{getKey(){return c.RepositoryTypes.Svn}getName(){return a.Svn}getRepoIconName(){return"SVNLogo"}getChangeText(e){return e&&e.id?(0,r.format)(a.CommitId,e.id.slice(0,7)):""}}t.Svn.Svn=e}(),function(e){_=t[e]={};class i extends u.Base{getKey(){return c.RepositoryTypes.TfsVersionControl}getName(){return a.TfsVersionControl}getCommitIconName(){return"DocumentSet"}getRepoIconName(){return"TFVCLogo"}getNormalizedBranch(e,t){return(e=e||"").replace(t.id,t.name)}getNormalizedCommit(e){return e&&!isNaN(parseInt(e))&&(e="C"+e),e}fetchBranchLink(e,t){return this.vcNavigationService.then((r=>this._getBranchLink(e,r,t)))}fetchCommitLink(e,t){return this.vcNavigationService.then((r=>this._getCommitLink(e,r,t)))}fetchRepositoryLink(e,t){return this.vcNavigationService.then((r=>this._getRepositoryLink(e,r,t)))}_getBranchLink(e,t,n){const o=e.branchName;return(0,r.startsWith)(o,i.s_tfvcPrefix)?t.getRefUrl(e.branchName,null,n):t.getTfvcCommitUrl(e.branchName)}_getCommitLink(e,t,r){return t.getTfvcCommitUrl(this.getNormalizedCommit(e.commitId),r)}_getRepositoryLink(e,t,r){return t.getRepositoryUrl(null,r)}get tfvcClient(){return this._tfvcClient||(this._tfvcClient=this.getVcCode().then((()=>this.pageContext.getRestClient("ITfvcRestClient")))),this._tfvcClient}fetchShelvesets(e){const t={owner:e};return this.tfvcClient.then((e=>e.getShelvesets(t).then((e=>e))))}}t[e].TfsVersionControl=i,i.s_tfvcPrefix="$/"}("TfsVersionControl"),function(e){t[e]={};class r extends s.VssService{constructor(){super(...arguments),this._sourceProviders={}}_serviceStart(e){super._serviceStart(e);[new p.Bitbucket(e),new f.ExternalGit(e),new y.GitHub(e),new k.GitHubEnterprise(e),new N.Svn(e),new C.TfsGit(e),new _.TfsVersionControl(e),new h.ExternalUnknown(e)].forEach((e=>{this._sourceProviders[e.getKey()]=e}))}getSourceProvider(e){e=(e=e||"").toLocaleLowerCase();const t=this._sourceProviders[e];return t||(console.warn("Provider with type "+e+" is not initialized, fetching a generic external provider"),this._sourceProviders[c.RepositoryTypes.ExternalUnknown])}}t[e].SourceProviderService=r,s.Services.add("ISourceProviderService",{serviceFactory:r})}("SourceProvider")}),["Resources","Common","Base","Constants","BaseGit","ExternalUnknown","TraceNames","Bitbucket","ExternalGit","GitHub","GitHubEnterprise","TfsGit","Svn","TfsVersionControl","SourceProvider"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-build-web.sourceproviders"}}));
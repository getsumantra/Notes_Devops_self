"use strict";define("Build/Admin/Checks",["require","exports","VSS/Reflux/Action","Build/Admin/Common/Actions/NotificationActions","VSS/Reflux/Store","Build/Admin/Common/Constants","Build/Admin/Common/Stores/NotificationStore","Build/Admin/Common/Actions/NotificationActionCreator","Build/Admin/Common/Sources/AgentPoolSource","Build/Admin/Common/Sources/AgentQueueSource","Build/Admin/Common/Sources/SecuritySource","react","Checks/ChecksOverview/ChecksOverview","VSS/Platform/FPS","VSS/Platform/Layout","VSSUI/Header","VSSUI/Page","VSSUI/Surface"],(function(e,t,s,i,o,n,a,c,r,u,h,d,S,l,g,m,p,C){var b,k,A,_,f,H,v,P,y,Q;b=t[Q="Resources"]={},t[Q].Checks="Approvals and checks",function(e){k=t[e]={};t[e].ActionsHub=class{constructor(){this.notificationActions=new i.NotificationActions,this.selectedAgentPoolUpdated=new s.Action,this.selectedAgentQueueUpdated=new s.Action,this.selectedTabUpdated=new s.Action,this.securityStoreStatusUpdated=new s.Action,this.managePermissionUpdated=new s.Action,this.checkStoreStatusUpdated=new s.Action}}}("ActionsActionsHub"),function(e){A=t[e]={};class s extends o.Store{constructor(){super("ChecksStoreChanged"),this.state={status:0},this.updateStatus=e=>{this.state={status:e},this.emitChanged()}}}t[e].ChecksStore=s}("StoresChecksStore"),function(e){_=t[e]={};class s extends o.Store{constructor(){super("SecurityStoreChanged"),this.state={hasManagePermission:!1,status:0},this.updateStatus=e=>{this.state=Object.assign(Object.assign({},this.state),{status:e}),this.emitChanged()},this.updateManagePermission=e=>{this.state=Object.assign(Object.assign({},this.state),{hasManagePermission:e}),this.emitChanged()}}}t[e].SecurityStore=s}("StoresSecurityStore"),function(e){f=t[e]={};class s extends o.Store{constructor(){super("SelectionStoreChanged"),this.state={selectedAgentPool:void 0,selectedAgentQueue:void 0,selectedTabId:n.PoolHubViewKeys.Jobs},this.updateSelectedAgentPool=e=>{this.state=Object.assign(Object.assign({},this.state),{selectedAgentPool:e}),this.emitChanged()},this.updateSelectedAgentQueue=e=>{this.state=Object.assign(Object.assign({},this.state),{selectedAgentQueue:e}),this.emitChanged()},this.updateSelectedTab=e=>{this.state=Object.assign(Object.assign({},this.state),{selectedTabId:e}),this.emitChanged()}}}t[e].SelectionStore=s}("StoresSelectionStore"),function(e){H=t[e]={};t[e].StoresHub=class{constructor(e){this.checksStore=new A.ChecksStore,e.checkStoreStatusUpdated.addListener(this.checksStore.updateStatus),this.notificationStore=new a.NotificationStore,e.notificationActions.addNotification.addListener(this.notificationStore.addNotification),e.notificationActions.dismissNotification.addListener(this.notificationStore.dismissNotification),e.notificationActions.clearNotifications.addListener(this.notificationStore.clearNotifications),this.securityStore=new _.SecurityStore,e.securityStoreStatusUpdated.addListener(this.securityStore.updateStatus),e.managePermissionUpdated.addListener(this.securityStore.updateManagePermission),this.selectionStore=new f.SelectionStore,e.selectedAgentPoolUpdated.addListener(this.selectionStore.updateSelectedAgentPool),e.selectedAgentQueueUpdated.addListener(this.selectionStore.updateSelectedAgentQueue),e.selectedTabUpdated.addListener(this.selectionStore.updateSelectedTab)}}}("StoresStoresHub"),function(e){v=t[e]={};t[e].ChecksActionCreator=class{constructor(e){this._actionsHub=e.actionsHub,this._agentPoolSource=e.agentPoolSource,this._agentQueueSource=e.agentQueueSource,this._securitySource=e.securitySource,this._storesHub=e.storesHub,this._pageContext=e.pageContext,this.notificationActionCreator=new c.NotificationActionCreator({notificationActions:this._actionsHub.notificationActions})}initializeCheckData(){const e=this._agentQueueSource.getCachedSelectedAgentQueue(),t=this._agentPoolSource.getCachedSelectedAgentPool();e&&(this._actionsHub.selectedAgentQueueUpdated.invoke(e),this._actionsHub.selectedAgentPoolUpdated.invoke(t),this._fetchCheckData(e.id),this._fetchSecurityData(e.id))}_fetchCheckData(e){if(0===this._storesHub.checksStore.state.status){this._actionsHub.checkStoreStatusUpdated.invoke(1);this._pageContext.getService("IVssContributionService").getDataAsync("ms.vss-pipelinechecks.checks-data-provider",{queueId:e},!0).then((()=>this._actionsHub.checkStoreStatusUpdated.invoke(2))).catch(this._handleError)}}_fetchSecurityData(e){if(0===this._storesHub.securityStore.state.status){this._actionsHub.securityStoreStatusUpdated.invoke(1);const t=this._securitySource.hasAgentQueuePermission(e,n.Permission.Manage);this._actionsHub.managePermissionUpdated.invoke(t)}}_handleError(e){if(e&&e.message){this.notificationActionCreator.addNotification(e.message,a.NotificationType.error);this._pageContext.getService("IVssTelemetryService").publishEvent(n.Telemetry.Area,n.Telemetry.PoolsAdminFeature,{message:e.message,error:e})}}}}("ActionsChecksActionCreator"),function(e){P=t[e]={};t[e].Flux=class{constructor(e){this.actionsHub=new k.ActionsHub,this.agentPoolSource=new r.AgentPoolSource(e),this.agentQueueSource=new u.AgentQueueSource(e),this.securitySource=new h.SecuritySource(e),this.storesHub=new H.StoresHub(this.actionsHub),this.checksActionCreator=new v.ChecksActionCreator({pageContext:e,actionsHub:this.actionsHub,agentPoolSource:this.agentPoolSource,agentQueueSource:this.agentQueueSource,securitySource:this.securitySource,storesHub:this.storesHub})}}}("Flux"),function(e){y=t[e]={};class s extends g.VssComponent{constructor(e,t){super(e,t),this._getQueueChecksOverview=()=>{if(this.state.agentQueue&&2===this.state.checksDataLoaded)return d.createElement(S.ChecksOverview,{resourceName:this.state.agentQueue.name,resourceType:this._queueResourceType,resourceId:this.state.agentQueue.id.toString(),hasManagePermission:this.state.hasManagePermission,dataProviderRequestParameters:{queueId:this.state.agentQueue.id}})},this._onBackButtonClick=()=>{if(this.state.agentQueue){const e=this.context.pageContext.getService("IPoolAdminLinkingService").getAgentQueueUrl(this.state.agentQueue);(0,l.onClickFPS)(this.context.pageContext,e,!0)}},this._onChanged=()=>{this.setState(this._getStateFromStores())},this._queueResourceType="queue",this.state=this._getStateFromStores()}componentDidMount(){this.props.storesHub.checksStore.addChangedListener(this._onChanged),this.props.storesHub.securityStore.addChangedListener(this._onChanged)}componentWillUnmount(){this.props.storesHub.checksStore.removeChangedListener(this._onChanged),this.props.storesHub.securityStore.removeChangedListener(this._onChanged)}render(){return d.createElement(C.Surface,{background:1},d.createElement(p.Page,{className:"flex-grow"},this._getHeader(),d.createElement("div",{className:"pipelines-environment-checks page-content page-content-top"},this.state.agentQueue&&this._getQueueChecksOverview())))}_getHeader(){const e=this.state.agentQueue?this.state.agentQueue.name:"";return d.createElement(m.Header,{title:b.Checks,titleSize:1,description:e,backButtonProps:{onClick:this._onBackButtonClick}})}_getStateFromStores(){return{checksDataLoaded:this.props.storesHub.checksStore.state.status,agentQueue:this.props.storesHub.selectionStore.state.selectedAgentQueue,hasManagePermission:this.props.storesHub.securityStore.state.hasManagePermission}}}t[e].QueueChecksHub=s}("ComponentsQueueChecksHub"),function(e){t[e]={};class s extends g.VssComponent{constructor(e,t){super(e,t),this._ttiMarked=!1,this._dataReady=!1,this._markDataReady=()=>{this._dataReady=!0,this._markTti()},this._flux=new P.Flux(t.pageContext),this._flux.actionsHub.checkStoreStatusUpdated.addListener(this._markDataReady),this._flux.checksActionCreator.initializeCheckData(),this._breadcrumbService=t.pageContext.getService(n.ServiceIds.HeaderBreadcrumbService),this._breadcrumbService.refresh({agentPool:this._flux.storesHub.selectionStore.state.selectedAgentPool,agentQueue:this._flux.storesHub.selectionStore.state.selectedAgentQueue,agent:void 0})}componentWillUnmount(){this._flux.actionsHub.checkStoreStatusUpdated.removeListener(this._markDataReady)}componentDidUpdate(){this._markTti()}_markTti(){this._dataReady&&!this._ttiMarked&&(this.context.pageContext.getService("IVssPerformanceService").markTimeToInteractive(n.Telemetry.Area,n.Telemetry.QueueChecksView),this._ttiMarked=!0)}render(){return d.createElement(y.QueueChecksHub,{storesHub:this._flux.storesHub})}}t[e].QueueChecksView=s,g.VssComponent.register("ms.vss-build-web.admin-checks-view-component",s)}("QueueChecksView")}),["Resources","Actions/ActionsHub","Stores/ChecksStore","Stores/SecurityStore","Stores/SelectionStore","Stores/StoresHub","Actions/ChecksActionCreator","Flux","Components/QueueChecksHub","QueueChecksView"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-build-web.admin.checks"}}));